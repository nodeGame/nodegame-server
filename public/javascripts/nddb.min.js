/**
 * # JSUS: JavaScript UtilS. 
 * Copyright(c) 2012 Stefano Balietti
 * MIT Licensed
 * 
 * Collection of general purpose javascript functions. JSUS helps!
 * 
 * See README.md for extra help.
 */
(function(e){var t=e.JSUS={};t._classes={},t.log=function(e){console.log(e)},t.extend=function(e,n){if("object"!=typeof e&&"function"!=typeof e)return n;if("undefined"==typeof n){n=n||this;if("function"==typeof e){var r=e.toString();r=r.substr("function ".length),r=r.substr(0,r.indexOf("("))}else var r=e.constructor||e.__proto__.constructor;r&&(this._classes[r]=e)}for(var i in e)e.hasOwnProperty(i)&&(typeof n[i]!="object"?n[i]=e[i]:t.extend(e[i],n[i]));return e.prototype&&t.extend(e.prototype,n.prototype||n),n},t.require=t.get=function(e){return"undefined"==typeof t.clone?(t.log("JSUS.clone not found. Cannot continue."),!1):"undefined"==typeof e?t.clone(t._classes):"undefined"==typeof t._classes[e]?(t.log("Could not find class "+e),!1):t.clone(t._classes[e])},t.isNodeJS=function(){return"undefined"!=typeof module&&"undefined"!=typeof module.exports&&"function"==typeof require},t.isNodeJS()&&(require("./lib/compatibility"),require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse"),require("./lib/fs"))})("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window),function(JSUS){function COMPATIBILITY(){}COMPATIBILITY.compatibility=function(){var support={};try{Object.defineProperty({},"a",{enumerable:!1,value:1}),support.defineProperty=!0}catch(e){support.defineProperty=!1}try{eval("({ get x(){ return 1 } }).x === 1"),support.setter=!0}catch(err){support.setter=!1}try{var value;eval("({ set x(v){ value = v; } }).x = 1"),support.getter=!0}catch(err){support.getter=!1}return support},JSUS.extend(COMPATIBILITY)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments[1];for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),t.isArray=function(e){return e?Object.prototype.toString.call(e)==="[object Array]":!1},t.seq=function(t,n,r,i){if("number"!=typeof t)return!1;if(t===Infinity)return!1;if("number"!=typeof n)return!1;if(n===Infinity)return!1;if(t===n)return[t];if(r===0)return!1;if(!e.in_array(typeof r,["undefined","number"]))return!1;r=r||1,i=i||function(e){return e};var s=t,o=[];if(t<n)while(s<=n)o.push(i(s)),s+=r;else while(s>=n)o.push(i(s)),s-=r;return o},t.each=function(e,t,n){if("object"!=typeof e)return!1;if(!t)return!1;n=n||this;var r,i=e.length;for(r=0;r<i;r++)t.call(n,e[r]);return!0},t.map=function(){if(arguments.length<2)return;var n=Array.prototype.slice.call(arguments),r=n.shift(),i=n[0];if(!t.isArray(r)){e.log("ARRAY.map() the first argument must be an array. Found: "+r);return}var s=[],o=undefined;for(var u=0;u<r.length;u++)n[0]=r[u],o=i.apply(this,n),"undefined"!=typeof o&&s.push(o);return s},t.removeElement=function(t,n){if("undefined"==typeof t||!n)return!1;if("object"==typeof t)var r=e.equals;else var r=function(e,t){return e===t};for(var i=0;i<n.length;i++)if(r(t,n[i]))return n.splice(i,1);return!1},t.inArray=t.in_array=function(t,n){if(!n)return!1;var r=e.equals;for(var i=0;i<n.length;i++)if(r.call(this,t,n[i]))return!0;return!1},t.getNGroups=function(e,n){return t.getGroupsSizeN(e,Math.floor(e.length/n))},t.getGroupsSizeN=function(e,t){var n=e.slice(0),r=n.length,i=n.length,s=[],o,u,a=[],f=0;for(o=0;o<i;o++)u=Math.floor(Math.random()*r),f>=t&&(s.push(a),f=0,a=[]),a.push(n[u]),n.splice(u,1),r=n.length,f++;return a.length>0&&s.push(a),s},t._latinSquare=function(t,n,r){r="undefined"==typeof r?!0:r;if(t===n&&!r)return!1;var i=[],s=[];for(var o=0;o<t;o++)i[o]=o;var u=null,a=0,f=t,l=[];r||(f=t-1);for(o=0;o<n;o++){do u=e.randomInt(a,f);while(e.in_array(u,l));l.push(u),u==1?(s[o]=i.slice(u),s[o].push(0)):s[o]=i.slice(u).concat(i.slice(0,u))}return s},t.latinSquare=function(e,n){return n||(n=e),!e||e<0||n<0?!1:(n>e&&(n=e),t._latinSquare(e,n,!0))},t.latinSquareNoSelf=function(e,n){return n||(n=e-1),!e||e<0||n<0?!1:(n>e&&(n=e-1),t._latinSquare(e,n,!1))},t.generateCombinations=function(t,n){function r(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(t[e[r]]);return n}var i=t.length,s=[];for(var o=0;o<n;o++)s.push(o);var u=[];for(var o=i-n;o<i;o++)u.push(o);while(!e.equals(s,u)){callback(r(s,t));var o=n-1;while(s[o]==i-n+o)o-=1;s[o]+=1;for(var a=o+1;a<n;a++)s[a]=s[o]+a-o}return r(s,t)},t.matchN=function(e,n,r){if(!e)return;if(!n)return e;var i=[],s=e.length,o=[];for(var u=0;u<s;u++){var a=e.slice(0);a.splice(u,1),r&&(a=t.arrayDiff(a,o));var f=t.getNRandom(a,n);o=o.concat(f),f.splice(0,0,e[u]),i.push(f),f=[]}return i},t.rep=function(t,n){if(!t)return;if(!n)return t.slice(0);if(n<1){e.log("times must be greater or equal 1","ERR");return}var r=1,i=t.slice(0);for(;r<n;r++)i=i.concat(t);return i},t.stretch=function(n,r){if(!n)return;if(!r)return n.slice(0);if("number"==typeof r){if(r<1){e.log("times must be greater or equal 1","ERR");return}r=t.rep([r],n.length)}var i=[];for(var s=0;s<n.length;s++){var o=r[s%r.length];for(var u=0;u<o;u++)i.push(n[s])}return i},t.arrayIntersect=function(t,n){return t.filter(function(t){return e.in_array(t,n)})},t.arrayDiff=function(t,n){return t.filter(function(t){return!e.in_array(t,n)})},t.shuffle=function(e){if(!e)return;var t=e.slice(0),n=e.length-1,r,i;for(var s=n;s>0;s--)r=Math.floor(Math.random()*(s+1)),i=t[r],t[r]=t[s],t[s]=i;return t},t.getNRandom=function(e,n){return t.shuffle(e).slice(0,n)},t.distinct=function(e){var n=[];return e?(t.each(e,function(e){t.in_array(e,n)||n.push(e)}),n):n},t.transpose=function(e){if(!e)return;var n,r,i,s,o=[];n=e.length||0,r=t.isArray(e[0])?e[0].length:0;if(n===0||r===0)return o;for(i=0;i<r;i++){o[i]=[];for(s=0;s<n;s++)o[i][s]=e[s][i]}return o},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}var n=null;"undefined"!=typeof e.compatibility&&(n=e.compatibility()),t.equals=function(e,n){var r=typeof e,i=typeof n;if(r!==i)return!1;if("undefined"===r||"undefined"===i)return e===n;if(e===null||n===null)return e===n;if("number"===r&&isNaN(e)&&"number"===i&&isNaN(n))return isNaN(e)&&isNaN(n);var s={number:"",string:"","boolean":""};if(r in s)return e===n;if("function"===r)return e.toString()===n.toString();for(var o in e)if(e.hasOwnProperty(o)){if("undefined"==typeof n[o]&&"undefined"!=typeof e[o])return!1;if(!n[o]&&e[o])return!1;switch(typeof e[o]){case"function":if(e[o].toString()!==n[o].toString())return!1;default:if(!t.equals(e[o],n[o]))return!1}}for(o in n)if(n.hasOwnProperty(o)){if("undefined"==typeof e[o]&&"undefined"!=typeof n[o])return!1;if(!e[o]&&n[o])return!1}return!0},t.isEmpty=function(e){if("undefined"==typeof e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.size=t.getListSize=function(e){if(!e)return 0;if("number"==typeof e)return 0;if("string"==typeof e)return 0;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},t._obj2Array=function(e,n,r,i){if("object"!=typeof e)return[e];if(r){i="undefined"!=typeof i?i:1;if(i>r)return[e];i+=1}var s=[];for(var o in e)e.hasOwnProperty(o)&&(n&&s.push(o),"object"==typeof e[o]?s=s.concat(t._obj2Array(e[o],n,r,i)):s.push(e[o]));return s},t.obj2Array=function(e,n){return t._obj2Array(e,!1,n)},t.obj2KeyedArray=t.obj2KeyArray=function(e,n){return t._obj2Array(e,!0,n)},t.keys=t.objGetAllKeys=function(e,n,r){if(!e)return[];n="number"==typeof n&&n>=0?n:0,r="number"==typeof r&&r>=0?r:0;var i=[];for(var s in e)e.hasOwnProperty(s)&&(i.push(s),r<n&&"object"==typeof e[s]&&(i=i.concat(t.objGetAllKeys(e[s],r+1))));return i},t.implode=t.implodeObj=function(e){if(!e)return[];var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t},t.clone=function(e){if(!e)return e;if("number"==typeof e)return e;if("string"==typeof e)return e;if("boolean"==typeof e)return e;if(e===NaN)return e;if(e===Infinity)return e;var r;"function"==typeof e?r=function(){return e.apply(r,arguments)}:r=Object.prototype.toString.call(e)==="[object Array]"?[]:{};for(var i in e){var s;e[i]&&"object"==typeof e[i]?Object.prototype.toString.call(e[i])==="[object Array]"?s=e[i].slice(0):s=t.clone(e[i]):s=e[i];if(e.hasOwnProperty(i))r[i]=s;else if(n&&n.defineProperty)Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0});else try{Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0})}catch(o){r[i]=s}}return r},t.join=function(e,n){var r=t.clone(e);if(!n)return r;for(var i in r)r.hasOwnProperty(i)&&"undefined"!=typeof n[i]&&("object"==typeof n[i]?r[i]=t.join(r[i],n[i]):r[i]=n[i]);return r},t.merge=function(e,n){if(!e&&!n)return!1;if(!e)return t.clone(n);if(!n)return t.clone(e);var r=t.clone(e);for(var i in n)n.hasOwnProperty(i)&&(n[i]&&"object"==typeof n[i]?("object"!=typeof r[i]&&(Object.prototype.toString.call(n[i])==="[object Array]"?r[i]=[]:r[i]={}),r[i]=t.merge(r[i],n[i])):r[i]=n[i]);return r},t.mixin=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]=t[n]},t.mixout=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]||(e[n]=t[n])},t.mixcommon=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]&&(e[n]=t[n])},t.mergeOnKey=function(e,n,r){var i=t.clone(e);if(!n||!r)return i;for(var s in n)if(n.hasOwnProperty(s)){if(!i[s]||"object"!=typeof i[s])i[s]={};i[s][r]=n[s]}return i},t.subobj=function(e,n){if(!e)return!1;var r={};if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++){var s=n[i];t.hasOwnNestedProperty(s,e)&&t.setNestedValue(s,t.getNestedValue(s,e),r)}return r},t.skim=function(e,n){if(!e)return!1;var r=t.clone(e);if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++)t.deleteNestedKey(n[i],r);return r},t.setNestedValue=function(n,r,i){if(!n)return e.log("Cannot set value of undefined property","ERR"),!1;i="object"==typeof i?i:{};var s=n.split(".");if(s.length===1)return i[n]=r,i;var o=s.shift();return i[o]=t.setNestedValue(s.join("."),r,i[o]),i},t.getNestedValue=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return n[e];var i=r.shift();return t.getNestedValue(r.join("."),n[i])},t.deleteNestedKey=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return delete n[e],!0;var i=r.shift();return"undefined"==typeof n[i]?!1:t.deleteNestedKey(r.join("."),n[i])},t.hasOwnNestedProperty=function(e,n){if(!n)return!1;var r=e.split(".");if(r.length===1)return n.hasOwnProperty(e);var i=r.shift();return t.hasOwnNestedProperty(r.join("."),n[i])},t.split=function(t,n){if(!t)return;if(!n||"object"!=typeof t[n])return e.clone(t);var r=[],i=e.clone(t);i[n]={};var s=function(t){for(var o in t){var u=e.clone(i);t.hasOwnProperty(o)&&("object"==typeof t[o]?r=r.concat(s(t[o])):(u[n][o]=t[o],r.push(u)))}return r};return s(t[n])},t.melt=function(e,t){var n={},r=t.length;for(var i=0;i<e.length;i++)n[e[i]]=t[i%r];return n},t.uniqueKey=function(t,n,r){if(!t){e.log("Cannot find unique name in undefined object","ERR");return}n=n||""+Math.floor(Math.random()*1e10),r=r||1e6;var i=1;while(t[n]){n=n+""+i,i++;if(i>r)return}return n},t.augment=function(e,n,r){var i,s,r=r||t.keys(e);for(i=0;i<r.length;i++)s=r[i],"undefined"!=typeof e[s]&&Object.prototype.toString.call(e[s])!=="[object Array]"&&(e[s]=[e[s]]),"undefined"!==n[s]&&(e[s]||(e[s]=[]),e[s].push(n[s]))},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){function PARSE(){}PARSE.stringify_prefix="!?_",PARSE.getQueryString=function(e){var t=window.location.search.substring(1);if("undefined"==typeof e)return t;var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]===e)return unescape(i[1])}return!1},PARSE.tokenize=function(e,t,n){if(!e)return;if(!t||!t.length)return[e];n=n||{};var r="[";JSUS.each(t,function(e){e===" "&&(e="\\s"),r+=e}),r+="]+";var i=new RegExp(r);return e.split(i,n.limit)},PARSE.stringify=function(e,t){return JSON.stringify(e,function(e,t){var n=typeof t;return"function"===n?PARSE.stringify_prefix+t.toString():"undefined"===n?PARSE.stringify_prefix+"undefined":t===null?PARSE.stringify_prefix+"null":t},t)},PARSE.parse=function(str){function walker(e){var t;if("object"!=typeof e)return reviver(e);for(var n in e)e.hasOwnProperty(n)&&("object"==typeof e[n]?walker(e[n]):e[n]=reviver(e[n]));return e}function reviver(value){var type=typeof value;if(type==="string"){if(value.substring(0,len_prefix)!==PARSE.stringify_prefix)return value;if(value.substring(0,len_func)===marker_func)return eval("("+value.substring(len_prefix)+")");if(value.substring(0,len_null)===marker_null)return null;if(value.substring(0,len_und)===marker_und)return undefined}return value}var marker_func=PARSE.stringify_prefix+"function",marker_null=PARSE.stringify_prefix+"null",marker_und=PARSE.stringify_prefix+"undefined",len_prefix=PARSE.stringify_prefix.length,len_func=marker_func.length,len_null=marker_null.length,len_und=marker_und.length,o=JSON.parse(str);return walker(o)},JSUS.extend(PARSE)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e,t,n){function r(e,n){e=e||{};if(!t)throw new Error("JSUS not found.");this.db=[],this.tags={},this.hooks={insert:[],remove:[],update:[]},this.nddb_pointer=0,r.compatibility.getter?this.__defineGetter__("length",function(){return this.db.length}):this.length=null,this.query=new d,this.__C={},this.__H={},this.__I={},this.__V={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!1,this.__update.sort=!1,this.init(e),this.importDB(n)}function i(e,t){if(e===null)return;var n=typeof e;if(n==="undefined")return;if(n==="string")return;if(n==="number")return;this.db.push(e),t&&(this._indexIt(e,this.db.length-1),this._hashIt(e),this._viewIt(e)),this.emit("insert",e)}function s(e,n){return t.obj2Array(e,1)}function o(e,n){return t.obj2KeyedArray(e,1)}function u(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return t.obj2Array(r,1)}function a(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2Array(r,1)}function f(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return n.split(".").concat(t.obj2KeyedArray(r))}function l(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2KeyedArray(r)}function d(){this.operators={},this.registerDefaultOperators(),this.reset()}function v(e,t){this.idx=e,this.nddb=t,this.resolve={}}r.compatibility=t.compatibility(),e.NDDB=r,r.log=console.log,r.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},r.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},r.prototype.init=function(e){e=e||{},this.__options=e,e.log&&(r.log=e.log),e.C&&(this.__C=e.C),e.H&&(this.__H=e.H),e.I&&(this.__I=e.I),e.V&&(this.__V=e.V),e.tags&&(this.tags=e.tags),e.nddb_pointer>0&&(this.nddb_pointer=e.nddb_pointer),e.hooks&&(this.hooks=e.hooks),e.update&&("undefined"!=typeof e.update.pointer&&(this.__update.pointer=e.update.pointer),"undefined"!=typeof e.update.indexes&&(this.__update.indexes=e.update.indexes),"undefined"!=typeof e.update.sort&&(this.__update.sort=e.update.sort));if("object"==typeof e.operators)for(var t in e.operators)this.query.registerOperator(t,e.operators[t])},r.prototype.globalCompare=function(e,t){return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?-1:"undefined"==typeof e?1:-1},r.prototype._autoUpdate=function(e){var n=e?t.merge(this.__update,e):this.__update;n.pointer&&(this.nddb_pointer=this.db.length-1),n.sort&&this.sort(),n.indexes&&this.rebuildIndexes()},r.prototype.importDB=function(e){if(!e)return;for(var t=0;t<e.length;t++)i.call(this,e[t],this.__update.indexes);this._autoUpdate({indexes:!1})},r.prototype.insert=function(e){i.call(this,e,this.__update.indexes),this._autoUpdate({indexes:!1})},r.prototype.breed=function(e){return e=e||this.db,new this.constructor(this.cloneSettings(),e)},r.prototype.cloneSettings=function(){var e=this.__options||{};return e.H=this.__H,e.I=this.__I,e.C=this.__C,e.V=this.__V,e.tags=this.tags,e.update=this.__update,e.hooks=this.hooks,t.clone(e)},r.prototype.toString=function(){var e="";for(var t=0;t<this.db.length;t++)e+=this.db[t]+"\n";return e},r.prototype.stringify=function(e){if(!this.length)return"[]";e="undefined"==typeof e?!0:e;var n=e?0:4,i="[";return this.each(function(e){e=r.decycle(e),i+=t.stringify(e)+", "}),i=i.replace(/, $/,"]"),i},r.prototype.comparator=function(e,t){return!e||!t?(r.log("Cannot set empty property or empty comparator","ERR"),!1):(this.__C[e]=t,!0)},r.prototype.c=r.prototype.comparator,r.prototype.getComparator=function(e){return"undefined"!=typeof this.__C[e]?this.__C[e]:function(n,r){if("undefined"==typeof n&&"undefined"==typeof r)return 0;if("undefined"==typeof n)return 1;if("undefined"==typeof r)return-1;var i=t.getNestedValue(e,n),s=t.getNestedValue(e,r);return"undefined"==typeof i&&"undefined"==typeof s?0:"undefined"==typeof i?1:"undefined"==typeof s?-1:i>s?1:s>i?-1:0}},r.prototype.isReservedWord=function(e){return this[e]?!0:!1},r.prototype._isValidIndex=function(e){if("undefined"==typeof e)return r.log("A valid index name must be provided","ERR"),!1;if(this.isReservedWord(e)){var t="A reserved word have been selected as an index. ";return t+="Please select another one: "+e,r.log(t,"ERR"),!1}return!0},r.prototype.index=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__I[e]=t,this[e]=new v(e,this),!0)},r.prototype.i=r.prototype.index,r.prototype.view=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__V[e]=t,this[e]=new this.constructor,!0)},r.prototype.hash=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__H[e]=t,this[e]={},!0)},r.prototype.h=r.prototype.hash,r.prototype.resetIndexes=function(e){var n=e||t.merge({h:!0,v:!0,i:!0},e),r;if(n.h)for(r in this.__H)this.__H.hasOwnProperty(r)&&(this[r]={});if(n.v)for(r in this.__V)this.__V.hasOwnProperty(r)&&(this[r]=new this.constructor);if(n.v)for(r in this.__I)this.__I.hasOwnProperty(r)&&(this[r]=new v(r,this))},r.prototype.rebuildIndexes=function(){var e=!t.isEmpty(this.__H),n=!t.isEmpty(this.__I),r=!t.isEmpty(this.__V),i,s;if(!e&&!n&&!r)return;this.resetIndexes({h:e,v:r,i:n}),e&&!n&&!r?i=this._hashIt:!e&&n&&!r?i=this._indexIt:!e&&!n&&r?i=this._viewIt:e&&n&&!r?i=function(e,t){this._hashIt(e),this._indexIt(e,t)}:!e&&n&&r?i=function(e,t){this._indexIt(e,t),this._viewIt(e)}:e&&!n&&r?i=function(e,t){this._hashIt(e),this._viewIt(e)}:i=function(e,t){this._indexIt(e,t),this._hashIt(e),this._viewIt(e)};for(s=0;s<this.db.length;s++)i.call(this,this.db[s],s)},r.prototype._indexIt=function(e,n){if(!e||t.isEmpty(this.__I))return;var r,i,s;for(var o in this.__I)if(this.__I.hasOwnProperty(o)){r=this.__I[o],s=r(e);if("undefined"==typeof s)continue;this[o]||(this[o]=new v(o,this)),this[o]._add(s,n)}},r.prototype._viewIt=function(e){if(!e||t.isEmpty(this.__V))return;var n,r,i;for(var s in this.__V)if(this.__V.hasOwnProperty(s)){n=this.__V[s],i=n(e);if("undefined"==typeof i)continue;this[s]||(this[s]=new this.constructor),this[s].insert(e)}},r.prototype._hashIt=function(e){if(!e||t.isEmpty(this.__H))return!1;var n,r,i;for(var s in this.__H)if(this.__H.hasOwnProperty(s)){n=this.__H[s],i=n(e);if("undefined"==typeof i)continue;this[s]||(this[s]={}),this[s][i]||(this[s][i]=new this.constructor),this[s][i].insert(e)}},r.prototype.on=function(e,t){if(!e||!t||!this.hooks[e])return;return this.hooks[e].push(t),!0},r.prototype.off=function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(!t)return this.hooks[e]=[],!0;for(var n=0;n<this.hooks[e].length;n++)if(this.hooks[e][n]==t)return this.hooks[e].splice(n,1),!0;return!1},r.prototype.emit=function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;for(var n=0;n<this.hooks[e].length;n++)this.hooks[e][n].call(this,t)},r.prototype._analyzeQuery=function(e,n,i){var s=function(e,t,n){var i="(?)",s="Malformed query: "+e||i+" "+t||i+" "+n||i;return r.log(s,"WARN"),!1};"undefined"==typeof e&&s(e,n,i);if("undefined"!=typeof n){n==="="&&(n="==");if(!(n in this.query.operators))return r.log("Query error. Invalid operator detected: "+n,"WARN"),!1;if(t.in_array(n,["><","<>","in","!in"])){i instanceof Array||(r.log("Range-queries need an array as third parameter","WARN"),s(e,n,i));if(n==="<>"||n==="><")i[0]=t.setNestedValue(e,i[0]),i[1]=t.setNestedValue(e,i[1])}else t.in_array(n,[">","==",">=","<","<="])&&("undefined"==typeof i&&s(e,n,i),i=t.setNestedValue(e,i))}else"undefined"!=typeof i?s(e,n,i):(n="E",i="");return{d:e,op:n,value:i}},r.prototype.distinct=function(){return this.breed(t.distinct(this.db))},r.prototype.select=function(e,t,n){return this.query.reset(),arguments.length?this.and(e,t,n):this},r.prototype.and=function(e,t,n){var r=this._analyzeQuery(e,t,n);return r?(this.query.addCondition("AND",r,this.getComparator(e)),this):!1},r.prototype.or=function(e,t,n){var r=this._analyzeQuery(e,t,n);return r?(this.query.addCondition("OR",r,this.getComparator(e)),this):!1},r.prototype.selexec=function(e,t,n){return this.select(e,t,n).execute()},r.prototype.execute=function(){return this.filter(this.query.get.call(this.query))},r.prototype.exists=function(e){if(!e)return!1;for(var n=0;n<this.db.length;n++)if(t.equals(this.db[n],e))return!0;return!1},r.prototype.limit=function(e){e=e||0;if(e===0)return this.breed();var t=e>0?this.db.slice(0,e):this.db.slice(e);return this.breed(t)},r.prototype.reverse=function(){return this.db.reverse(),this},r.prototype.sort=function(e){if(!e)var t=this.globalCompare;else if("function"==typeof e)var t=e;else if(e instanceof Array)var n=this,t=function(t,r){for(var i=0;i<e.length;i++){var s=n.getComparator(e[i]).call(n,t,r);if(s!==0)return s}return s};else var t=this.getComparator(e);return this.db.sort(t),this},r.prototype.shuffle=function(){return this.db=t.shuffle(this.db),this},r.prototype.filter=function(e){return this.breed(this.db.filter(e))},r.prototype.each=r.prototype.forEach=function(){if(arguments.length===0)return;var e=arguments[0],t;for(t=0;t<this.db.length;t++)arguments[0]=this.db[t],e.apply(this,arguments)},r.prototype.map=function(){if(arguments.length===0)return;var e=arguments[0],t=[],n,r;for(r=0;r<this.db.length;r++)arguments[0]=this.db[r],n=e.apply(this,arguments),"undefined"!=typeof n&&t.push(n);return t},r.prototype.update=function(e){if(!this.db.length||!e)return this;for(var n=0;n<this.db.length;n++)t.mixin(this.db[n],e),this.emit("update",this.db[n]);return this._autoUpdate(),this},r.prototype.remove=function(){return this.length?(this.emit("remove",this.db),this.db=[],this._autoUpdate(),this):this},r.prototype.clear=function(e){if(e){this.db=[],this.tags={},this.query.reset(),this.nddb_pointer=0;var t;for(t in this.__H)this[t]&&delete this[t];for(t in this.__C)this[t]&&delete this[t];for(var t in this.__I)this[t]&&delete this[t]}else r.log("Do you really want to clear the current dataset? Please use clear(true)","WARN");return e},r.prototype.join=function(e,n,r,i){return this._join(e,n,t.equals,r,i)},r.prototype.concat=function(e,t,n,r){return this._join(e,t,function(){return!0},n,r)},r.prototype._join=function(e,n,r,i,s){if(!e||!n)return this.breed([]);r=r||t.equals,i="undefined"!=typeof i?i:"joined",s&&(s=s instanceof Array?s:[s]);var o=[],u=[],a,f;for(var l=0;l<this.db.length;l++){a=t.getNestedValue(e,this.db[l]);if("undefined"!=typeof a)for(var c=l+1;c<this.db.length;c++){f=t.getNestedValue(n,this.db[c]);if("undefined"!=typeof f&&r(a,f)){var h=t.clone(this.db[l]),p=s?t.subobj(this.db[c],s):this.db[c];h[i]=p,o.push(h)}}}return this.breed(o)},r.prototype.split=function(e){var n=[],r;for(r=0;r<this.db.length;r++)n=n.concat(t.split(this.db[r],e));return this.breed(n)},r.prototype.fetch=function(){return this.db},r.prototype.fetchSubObj=function(e){if(!e)return[];var n,r,i=[];for(n=0;n<this.db.length;n++)r=t.subobj(this.db[n],e),t.isEmpty(r)||i.push(r);return i},r.prototype.fetchValues=function(e){var n,r,i,s;s=typeof e,i={};if(s==="undefined")for(r=0;r<this.db.length;r++)t.augment(i,this.db[r],t.keys(this.db[r]));else if(s==="string"){i[e]=[];for(r=0;r<this.db.length;r++)n=t.getNestedValue(e,this.db[r]),"undefined"!=typeof n&&i[e].push(n)}else if(t.isArray(e)){i=t.melt(e,t.rep([],e.length));for(r=0;r<this.db.length;r++)n=t.subobj(this.db[r],e),t.isEmpty(n)||t.augment(i,n)}return i},r.prototype._fetchArray=function(e,t){var n,r,i,c;t?e?"string"==typeof e?n=f:n=l:n=o:e?"string"==typeof e?n=u:n=a:n=s,r=[];for(c=0;c<this.db.length;c++)i=n.call(this.db[c],this.db[c],e),"undefined"!=typeof i&&r.push(i);return r},r.prototype.fetchArray=function(e){return this._fetchArray(e)},r.prototype.fetchKeyArray=function(e){return this._fetchArray(e,!0)},r.prototype.groupBy=function(e){if(!e)return this.db;var n=[],r=[];for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);if("undefined"==typeof s)continue;if(!t.in_array(s,n)){n.push(s);var o=this.filter(function(n){if(t.equals(t.getNestedValue(e,n),s))return this});o.nddb_pointer=0,r.push(o)}}return r},r.prototype.count=function(e){if("undefined"==typeof e)return this.db.length;var n=0;for(var r=0;r<this.db.length;r++)t.hasOwnNestedProperty(e,this.db[r])&&n++;return n},r.prototype.sum=function(e){if("undefined"==typeof e)return!1;var n=0;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);isNaN(i)||(n+=i)}return n},r.prototype.mean=function(e){if("undefined"==typeof e)return!1;var n=0,r=0;for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);isNaN(s)||(n+=s,r++)}return r===0?0:n/r},r.prototype.stddev=function(e){if("undefined"==typeof e)return!1;var n=this.mean(e);if(isNaN(n))return!1;var r=0;return this.each(function(i){var s=t.getNestedValue(e,i);isNaN(s)||(r+=Math.pow(s-n,2))}),r!==0?Math.sqrt(r):0},r.prototype.min=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i<n||n===!1)&&(n=i)}return n},r.prototype.max=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i>n||n===!1)&&(n=i)}return n},r.prototype.skim=function(e){return e?this.breed(this.map(function(n){var r=t.skim(n,e);if(!t.isEmpty(r))return r})):this},r.prototype.keep=function(e){return e?this.breed(this.map(function(n){var r=t.subobj(n,e);if(!t.isEmpty(r))return r})):this.breed([])},r.prototype.diff=function(e){return!e||!e.length?this:("object"==typeof e&&(e instanceof r||e instanceof this.constructor)&&(e=e.db),this.breed(t.arrayDiff(this.db,e)))},r.prototype.intersect=function(e){if(!e||!e.length)return this;if("object"==typeof e)if(e instanceof r||e instanceof this.constructor)var e=e.db;return this.breed(t.arrayIntersect(this.db,e))},r.prototype.get=function(e){return"undefined"==typeof e||e<0||e>this.db.length-1?!1:this.db[e]},r.prototype.current=function(){return this.nddb_pointer<0||this.nddb_pointer>this.db.length-1?!1:this.db[this.nddb_pointer]},r.prototype.next=function(){this.nddb_pointer++;var e=r.prototype.current.call(this);return e||this.nddb_pointer--,e},r.prototype.previous=function(){this.nddb_pointer--;var e=r.prototype.current.call(this);return e||this.nddb_pointer++,e},r.prototype.first=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=0,t[0]):undefined},r.prototype.last=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=t.length-1,t[t.length-1]):undefined},r.prototype.tag=function(e,t){if("undefined"==typeof e)return r.log("Cannot register empty tag.","ERR"),!1;var n=null,i=typeof t;if(i==="undefined")n=this.db[this.nddb_pointer];else if(i==="number"){if(t>this.length||t<0)return r.log("Invalid index provided for tag registration","ERR"),!1;n=this.db[t]}else n=t;return this.tags[e]=n,n},r.prototype.resolveTag=function(e){return"undefined"==typeof e?(r.log("Cannot resolve empty tag.","ERR"),!1):this.tags[e]};var c=function(){return"function"==typeof n};r.prototype.save=function(e,i,s){return e?(s=s||!1,t.isNodeJS()?(h.writeFileSync(e,this.stringify(s),"utf-8"),i&&i(),!0):c()?(n(e,this.stringify(s)),i&&i(),!0):(r.log("No support for persistent storage found.","ERR"),!1)):(r.log("You must specify a valid file / id.","ERR"),!1)},r.prototype.load=function(e,i,s){if(!e)return r.log("You must specify a valid file / id.","ERR"),!1;if(!t.isNodeJS()){if(!c())return r.log("No support for persistent storage found.","ERR"),!1;var o=n(e);return this.importDB(o),i&&i(),!0}var u=function(e){var n=t.parse(e),i;for(i=0;i<n.length;i++)n[i]=r.retrocycle(n[i]);this.importDB(n)},a=h.readFileSync(e,"utf-8");return u.call(this,a),!0};if(t.isNodeJS()){require("./external/cycle.js");var h=require("fs"),p=require("ya-csv");r.prototype.load.csv=function(e,t,n){if(!e)return r.log("You must specify a valid CSV file.","ERR"),!1;n=n||{},"undefined"==typeof n.columnsFromHeader&&(n.columnsFromHeader=!0);var i=p.createCsvStreamReader(e,n);return n.columnNames&&i.setColumnNames(n.columnNames),i.addListener("data",function(e){this.insert(e)}),i.addListener("end",function(e){t&&callback()}),!0}}d.prototype.addCondition=function(e,t,n){t.type=e,t.comparator=n,this.query[this.pointer].push(t)},d.prototype.registerOperator=function(e,t){this.operators[e]=t},d.prototype.registerDefaultOperators=function(){this.operators.E=function(e,n,r){return function(n){if("undefined"!=typeof t.getNestedValue(e,n))return n}},this.operators["=="]=function(e,t,n){return function(e){if(n(e,t)===0)return e}},this.operators[">"]=function(e,t,n){return function(e){var r=n(e,t);if(r===1||r===0)return e}},this.operators["<"]=function(e,t,n){return function(e){if(n(e,t)===-1)return e}},this.operators["<="]=function(e,t,n){return function(e){var r=n(e,t);if(r===-1||r===0)return e}},this.operators["><"]=function(e,t,n){return function(e){if(n(e,t[0])>0&&n(e,t[1])<0)return e}},this.operators["<>"]=function(e,t,n){return function(e){if(n(e,t[0])<0&&n(e,t[1]>0))return e}},this.operators["in"]=function(e,n,r){return function(r){if(t.in_array(t.getNestedValue(e,r),n))return r}},this.operators["!in"]=function(e,n,r){return function(r){if(!t.in_array(t.getNestedValue(e,r),n))return r}}},d.prototype.addBreak=function(){this.pointer++,this.query[this.pointer]=[]},d.prototype.reset=function(){this.query=[],this.pointer=0,this.query[this.pointer]=[]},d.prototype.get=function(){function c(e,t){var n=e.d,r=e.op,i=e.value,s=e.comparator;return t[r](n,i,s)}var e,t,n,r,i,s,o,u,a=this.query,f=this.pointer,l=this.operators;if(f===0){e=a[f],t=e.length;if(t===1)return c(e[0],l);if(t===2){n=c(e[0],l),r=c(e[1],l),s=e[1].type;switch(s){case"OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e};case"AND":return function(e){if("undefined"!=typeof n(e)&&"undefined"!=typeof r(e))return e};case"NOT":return function(e){if("undefined"!=typeof n(e)&&"undefined"==typeof r(e))return e}}}else{if(t!==3)return function(n){var r,i,s,o,u="OR",a=!0;for(r=t-1;r>-1;r--){i=c(e[r],l),s=e[r].type,o="undefined"!=typeof i(n);if(s==="OR"){if(o)return n}else if(s==="AND"){if(!o)return;if(u==="OR"&&!a)return}u=s,a=s==="AND"?o:o||a}return n};n=c(e[0],l),r=c(e[1],l),i=c(e[2],l),s=e[1].type,o=e[2].type,s=s+"_"+o;switch(s){case"OR_OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof i(e))return e};case"OR_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof n(e))return e};case"AND_OR":return function(e){if("undefined"!=typeof i(e))return e;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e};case"AND_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e}}}}},v.prototype._add=function(e,t){this.resolve[e]=t},v.prototype._remove=function(e){delete this.resolve[e]},v.prototype.size=function(){return t.size(this.resolve)},v.prototype.get=function(e){return this.resolve[e]?this.nddb.db[this.resolve[e]]:!1},v.prototype.pop=function(e){var t,n;n=this.resolve[e];if("undefined"==typeof n)return!1;t=this.nddb.db[n];if("undefined"==typeof t)return;return this.nddb.db.splice(n,1),delete this.resolve[e],this.nddb.emit("remove",t),this.nddb._autoUpdate(),t},v.prototype.update=function(e,n){var r,i;return i=this.resolve[e],"undefined"==typeof i?!1:(r=this.nddb.db[i],t.mixin(r,n),this.nddb.emit("update",r),this.nddb._autoUpdate(),r)},v.prototype.getAllKeys=function(){return t.keys(this.resolve)},v.prototype.getAllKeyElements=function(){var e={},t;for(t in this.resolve)this.resolve.hasOwnProperty(t)&&(e[t]=this.nddb.db[this.resolve[t]]);return e}}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window,"undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS||require("JSUS").JSUS,"object"==typeof module&&"function"==typeof require?module.parent.exports.store||require("shelf.js/build/shelf-fs.js").store:this.store)