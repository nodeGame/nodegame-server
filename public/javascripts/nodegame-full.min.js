var JSON;void 0===String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof console&&(this.console={log:function(){}}),Date.now||(Date.now=function(){return(new Date).getTime()}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(find,i){void 0===i&&(i=0),i<0&&(i+=this.length),i<0&&(i=0);for(var n=this.length;i<n;i++)if(i in this&&this[i]===find)return i;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(find,i){for(void 0===i&&(i=this.length-1),i<0&&(i+=this.length),i>this.length-1&&(i=this.length-1),i++;i-- >0;)if(i in this&&this[i]===find)return i;return-1}),"function"!=typeof Object.create&&(Object.create=function(){var Temp=function(){};return function(prototype){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof prototype)throw TypeError("Argument must be an object");Temp.prototype=prototype;var result=new Temp;return Temp.prototype=null,result}}()),JSON||(JSON={}),function(){"use strict";var global=new Function("return this")(),JSON=global.JSON;function f(n){return n<10?"0"+n:n}JSON||(JSON={}),"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){return escapable.lastIndex=0,escapable.test(string)?'"'+string.replace(escapable,(function(a){var c=meta[a];return"string"==typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}))+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,partial,mind=gap,value=holder[key];switch(value&&"object"==typeof value&&"function"==typeof value.toJSON&&(value=value.toJSON(key)),"function"==typeof rep&&(value=rep.call(holder,key,value)),typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";if(gap+=indent,partial=[],"[object Array]"===Object.prototype.toString.apply(value)){for(length=value.length,i=0;i<length;i+=1)partial[i]=str(i,value)||"null";return v=0===partial.length?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]",gap=mind,v}if(rep&&"object"==typeof rep)for(length=rep.length,i=0;i<length;i+=1)"string"==typeof rep[i]&&(v=str(k=rep[i],value))&&partial.push(quote(k)+(gap?": ":":")+v);else for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=str(k,value))&&partial.push(quote(k)+(gap?": ":":")+v);return v=0===partial.length?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}",gap=mind,v}}"function"!=typeof JSON.stringify&&(JSON.stringify=function(value,replacer,space){var i;if(gap="",indent="","number"==typeof space)for(i=0;i<space;i+=1)indent+=" ";else"string"==typeof space&&(indent=space);if(rep=replacer,replacer&&"function"!=typeof replacer&&("object"!=typeof replacer||"number"!=typeof replacer.length))throw new Error("JSON.stringify");return str("",{"":value})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&"object"==typeof value)for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(void 0!==(v=walk(value,k))?value[k]=v:delete value[k]);return reviver.call(holder,key,value)}if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,(function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}))),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")}),global.JSON=JSON}(),Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement,fromIndex){var k;if(null==this)throw new TypeError('"this" is null or not defined');var O=Object(this),len=O.length>>>0;if(0===len)return-1;var n=+fromIndex||0;if(Math.abs(n)===1/0&&(n=0),n>=len)return-1;for(k=Math.max(n>=0?n:len-Math.abs(n),0);k<len;){if(k in O&&O[k]===searchElement)return k;k++}return-1}),function(exports){var JSUS=exports.JSUS={};JSUS._classes={},"undefined"==typeof console&&(console={}),void 0===console.log&&(console.log=function(){}),JSUS.log=function(txt){console.log(txt)},JSUS.extend=function(additional,target){var name,prop;if("object"!=typeof additional&&"function"!=typeof additional)return target;for(prop in void 0===target&&(target=target||this,(name="function"==typeof additional?(name=(name=additional.toString()).substr("function ".length)).substr(0,name.indexOf("(")):additional.constructor||additional.__proto__.constructor)&&(this._classes[name]=additional)),additional)additional.hasOwnProperty(prop)&&("object"!=typeof target[prop]?target[prop]=additional[prop]:JSUS.extend(additional[prop],target[prop]));return additional.prototype&&JSUS.extend(additional.prototype,target.prototype||target),target},JSUS.require=function(component,clone){var out;if((clone=void 0===clone||clone)&&void 0===JSUS.clone)return JSUS.log("JSUS.require: JSUS.clone not found, but clone requested. Cannot continue."),!1;if(void 0===component)out=JSUS._classes;else if(void 0===(out=JSUS._classes[component]))return JSUS.log("JSUS.require: could not find component "+component),!1;return clone?JSUS.clone(out):out},JSUS.isNodeJS=function(){return"undefined"!=typeof module&&void 0!==module.exports&&"function"==typeof require},JSUS.isNodeJS()?(require("./lib/compatibility"),require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse"),require("./lib/queue"),require("./lib/fs")):exports.J=exports.JSUS}("undefined"!=typeof module&&void 0!==module.exports?module.exports:window),function(JSUS){"use strict";function COMPATIBILITY(){}COMPATIBILITY.compatibility=function(){var support={};try{Object.defineProperty({},"a",{enumerable:!1,value:1}),support.defineProperty=!0}catch(e){support.defineProperty=!1}try{eval("({ get x(){ return 1 } }).x === 1"),support.setter=!0}catch(err){support.setter=!1}try{var value;eval("({ set x(v){ value = v; } }).x = 1"),support.getter=!0}catch(err){support.getter=!1}return support},JSUS.extend(COMPATIBILITY)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function ARRAY(){}var f;Array.prototype.filter||(Array.prototype.filter=function(fun){if(null==this)throw new TypeError;var t=new Object(this),len=t.length>>>0;if("function"!=typeof fun)throw new TypeError;for(var res=[],thisp=arguments[1],i=0;i<len;i++)if(i in t){var val=t[i];fun.call(thisp,val,i,t)&&res.push(val)}return res}),ARRAY.isArray="function"==typeof(f=Array.isArray)?f:function(o){return!!o&&"[object Array]"===Object.prototype.toString.call(o)},ARRAY.seq=function(start,end,increment,func){var i,out;if("number"!=typeof start)return!1;if(start===1/0)return!1;if("number"!=typeof end)return!1;if(end===1/0)return!1;if(0===increment)return!1;if(!JSUS.inArray(typeof increment,["undefined","number"]))return!1;if(start===end)return func?[func(start)]:[start];if(increment=increment||1,func=func||function(e){return e},i=start,out=[],start<end)for(;i<=end;)out.push(func(i)),i+=increment;else for(;i>=end;)out.push(func(i)),i-=increment;return out},ARRAY.each=function(array,cb,context){var i,len;if("object"!=typeof array)throw new TypeError("ARRAY.each: array must be object. Found: "+array);if("function"!=typeof cb)throw new TypeError("ARRAY.each: cb must be function. Found: "+cb);for(context=context||this,len=array.length,i=0;i<len;i++)cb.call(context,array[i],i)},ARRAY.map=function(){var i,len,args,out,o,array,func;if(array=arguments[0],func=arguments[1],ARRAY.isArray(array)){if("function"==typeof func){if(3===(len=arguments.length))args=[null,arguments[2]];else if(4===len)args=[null,arguments[2],arguments[3]];else for(len-=1,args=new Array(len),i=1;i<len;i++)args[i]=arguments[i+1];for(out=[],len=array.length,i=0;i<len;i++)args[0]=array[i],void 0!==(o=func.apply(this,args))&&out.push(o);return out}JSUS.log("ARRAY.map: second parameter must be function. Found: "+func)}else JSUS.log("ARRAY.map: first parameter must be array. Found: "+array)},ARRAY.removeElement=function(needle,haystack){var func,i;if(void 0===needle||!haystack)return!1;for(func="object"==typeof needle?JSUS.equals:function(a,b){return a===b},i=0;i<haystack.length;i++)if(func(needle,haystack[i]))return haystack.splice(i,1);return!1},ARRAY.inArray=function(needle,haystack){var func,i,len;if(!haystack)return!1;for(func=JSUS.equals,len=haystack.length,i=0;i<len;i++)if(func.call(this,needle,haystack[i]))return!0;return!1},ARRAY.in_array=function(needle,haystack){return console.log("***ARRAY.in_array is deprecated. Use ARRAY.inArray instead.***"),ARRAY.inArray(needle,haystack)},ARRAY.getNGroups=function(array,N){return ARRAY.getGroupsSizeN(array,Math.floor(array.length/N))},ARRAY.getGroupsSizeN=function(array,N){var i,idx,copy=array.slice(0),len=copy.length,originalLen=copy.length,result=[],group=[],count=0;for(i=0;i<originalLen;i++)idx=Math.floor(Math.random()*len),count>=N&&(result.push(group),count=0,group=[]),group.push(copy[idx]),copy.splice(idx,1),len=copy.length,count++;return group.length>0&&result.push(group),result},ARRAY._latinSquare=function(S,N,self){if(self=void 0===self||self,S===N&&!self)return!1;for(var seq=[],latin=[],i=0;i<S;i++)seq[i]=i;var idx=null,limit=S,extracted=[];for(self||(limit=S-1),i=0;i<N;i++){do{idx=JSUS.randomInt(0,limit)}while(JSUS.inArray(idx,extracted));extracted.push(idx),1==idx?(latin[i]=seq.slice(idx),latin[i].push(0)):latin[i]=seq.slice(idx).concat(seq.slice(0,idx))}return latin},ARRAY.latinSquare=function(S,N){return N||(N=S),!(!S||S<0||N<0)&&(N>S&&(N=S),ARRAY._latinSquare(S,N,!0))},ARRAY.latinSquareNoSelf=function(S,N){return N||(N=S-1),!(!S||S<0||N<0)&&(N>S&&(N=S-1),ARRAY._latinSquare(S,N,!1))},ARRAY.generateCombinations=function combinations(arr,k){var i,subI,ret,sub,next;for(ret=[],i=0;i<arr.length;i++)if(1===k)ret.push([arr[i]]);else for(sub=combinations(arr.slice(i+1,arr.length),k-1),subI=0;subI<sub.length;subI++)(next=sub[subI]).unshift(arr[i]),ret.push(next);return ret},ARRAY.matchN=function(array,N,strict){var result,i,copy,group,len,found;if(array){if(!N)return array;for(result=[],len=array.length,found=[],i=0;i<len;i++)(copy=array.slice(0)).splice(i,1),strict&&(copy=ARRAY.arrayDiff(copy,found)),group=ARRAY.getNRandom(copy,N),found=found.concat(group),group.splice(0,0,array[i]),result.push(group),group=[];return result}},ARRAY.rep=function(array,times){var i,result;if(ARRAY.isArray(array)||(array=[array]),!times)return array.slice(0);if(!(times<1)){for(i=1,result=array.slice(0);i<times;i++)result=result.concat(array);return result}JSUS.log("times must be greater or equal 1","ERR")},ARRAY.stretch=function(array,times){var result,i,repeat,j;if(array){if(!times)return array.slice(0);if("number"==typeof times){if(times<1)return void JSUS.log("times must be greater or equal 1","ERR");times=ARRAY.rep([times],array.length)}for(result=[],i=0;i<array.length;i++)for(repeat=times[i%times.length],j=0;j<repeat;j++)result.push(array[i]);return result}},ARRAY.arrayIntersect=function(a1,a2){return a1.filter((function(i){return JSUS.inArray(i,a2)}))},ARRAY.arrayDiff=function(a1,a2){return a1.filter((function(i){return!JSUS.inArray(i,a2)}))},ARRAY.shuffle=function(array){var copy,j,tmp,i;if(array){for(copy=Array.prototype.slice.call(array),i=array.length-1;i>0;i--)tmp=copy[j=Math.floor(Math.random()*(i+1))],copy[j]=copy[i],copy[i]=tmp;return copy}},ARRAY.getNRandom=function(array,N){return ARRAY.shuffle(array).slice(0,N)},ARRAY.distinct=function(array){var out=[];return array?(ARRAY.each(array,(function(e){ARRAY.inArray(e,out)||out.push(e)})),out):out},ARRAY.transpose=function(array){if(array){var w,h,i,j,t=[];if(w=array.length||0,h=ARRAY.isArray(array[0])?array[0].length:0,0===w||0===h)return t;for(i=0;i<h;i++)for(t[i]=[],j=0;j<w;j++)t[i][j]=array[j][i];return t}},JSUS.extend(ARRAY)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";var onFocusChange,changeTitle,isDisabled,id,clearBlinkInterval,finalTitle,elem;function DOM(){}DOM.get=function(name,attributes){var el;return el=document.createElement(name),"string"==typeof attributes?el.id=attributes:attributes&&this.addAttributes(el,attributes),"iframe"===name&&el.id&&!el.name&&(el.name=el.id),el},DOM.add=DOM.append=function(name,root,options){var el;if(el=this.get(name,options),options&&options.insertBefore){if(options.insertAfter)throw new Error("DOM.add: options.insertBefore and options.insertBefore cannot be both set.");if(!root.parentNode)throw new Error("DOM.add: root.parentNode not found. Cannot insert before.");root.parentNode.insertBefore(el,root)}else if(options&&options.insertAfter){if(!root.parentNode)throw new Error("DOM.add: root.parentNode not found. Cannot insert after.");DOM.insertAfter(el,root)}else root.appendChild(el);return el},DOM.addAttributes=function(elem,attributes){var key;if(!DOM.isElement(elem))throw new TypeError("DOM.addAttributes: elem must be HTMLElement. Found: "+elem);if(void 0===attributes)return elem;if("object"!=typeof attributes)throw new TypeError("DOM.addAttributes: attributes must be object or undefined. Found: "+attributes);for(key in attributes)attributes.hasOwnProperty(key)&&("id"===key||"innerHTML"===key?elem[key]=attributes[key]:"class"===key||"className"===key?DOM.addClass(elem,attributes[key]):"style"===key?DOM.style(elem,attributes[key]):"insertBefore"!==key&&"insertAfter"!==key&&elem.setAttribute(key,attributes[key]));return elem},DOM.write=function(root,text){var content;return null==text&&(text=""),content=JSUS.isNode(text)||JSUS.isElement(text)?text:document.createTextNode(text),root.appendChild(content),content},DOM.writeln=function(root,text,rc){var content;return content=DOM.write(root,text),this.add(rc||"br",root),content},DOM.sprintf=function(string,args,root){var text,span,idx_start,idx_finish,idx_replace,idxs,spans,key,i;for(key in root=root||document.createElement("span"),spans={},(args=args||{})["%strong"]="",args["%em"]="",args)if(args.hasOwnProperty(key))switch(key.charAt(0)){case"%":if(-1===(idx_start=string.indexOf(key)))continue;if(idx_replace=idx_start+key.length,-1===(idx_finish=string.indexOf(key,idx_replace))){JSUS.log("Error. Could not find closing key: "+key);continue}spans[idx_start]=key;break;case"@":string=string.replace(key,escape(args[key]));break;case"!":string=string.replace(key,args[key]);break;default:JSUS.log("Identifier not in [!,@,%]: "+key[0])}if(!JSUS.size(spans))return root.appendChild(document.createTextNode(string));for(idxs=JSUS.keys(spans).sort((function(a,b){return a-b})),idx_finish=0,i=0;i<idxs.length;i++)key=spans[idxs[i]],idx_finish!==(idx_start=string.indexOf(key))-1&&root.appendChild(document.createTextNode(string.substring(idx_finish,idx_start))),idx_replace=idx_start+key.length,idx_finish=string.indexOf(key,idx_replace),span="%strong"===key?document.createElement("strong"):"%em"===key?document.createElement("em"):DOM.get("span",args[key]),text=string.substring(idx_replace,idx_finish),span.appendChild(document.createTextNode(text)),root.appendChild(span),idx_finish+=key.length;return idx_finish!==string.length&&root.appendChild(document.createTextNode(string.substring(idx_finish))),root},DOM.isNode=function(o){return!(!o||"object"!=typeof o)&&("object"==typeof Node?o instanceof Node:"number"==typeof o.nodeType&&"string"==typeof o.nodeName)},DOM.isElement=function(o){return o&&"object"==typeof o&&1===o.nodeType&&"string"==typeof o.nodeName},DOM.shuffleElements=function(parent,order,cb){var i,len,numOrder,idOrder,children,child,id;if(!JSUS.isNode(parent))throw new TypeError("DOM.shuffleElements: parent must be a node. Found: "+parent);if(!parent.children||!parent.children.length)return JSUS.log("DOM.shuffleElements: parent has no children.","ERR"),!1;if(order)if(void 0===cb&&"function"==typeof order)cb=order;else{if(!JSUS.isArray(order))throw new TypeError("DOM.shuffleElements: order must be array. Found: "+order);if(order.length!==parent.children.length)throw new Error("DOM.shuffleElements: order length must match the number of children nodes.")}if(cb&&"function"!=typeof cb)throw new TypeError("DOM.shuffleElements: order must be array. Found: "+order);if(void 0===(children=parent.children))for(child=this.firstChild;child;)1==child.nodeType&&children.push(child),child=child.nextSibling;for(len=children.length,idOrder=new Array(len),cb&&(numOrder=new Array(len)),order||(order=JSUS.sample(0,len-1)),i=0;i<len;i++){if("string"!=typeof(id=children[order[i]].id)||""===id)throw new Error("DOM.shuffleElements: no id found on child n. "+order[i]);idOrder[i]=id,cb&&(numOrder[i]=order[i])}for(i=0;i<len;i++)parent.appendChild(children[idOrder[i]]),cb&&cb(children[idOrder[i]],i,numOrder[i]);return idOrder},DOM.populateSelect=function(select,options){var key,opt;if(!DOM.isElement(select))throw new TypeError("DOM.populateSelect: select must be HTMLElement. Found: "+select);if(options){if("object"!=typeof options)throw new TypeError("DOM.populateSelect: options must be object or undefined. Found: "+options);for(key in options)options.hasOwnProperty(key)&&((opt=document.createElement("option")).value=key,opt.innerHTML=options[key],select.appendChild(opt))}return select},DOM.removeChildrenFromNode=function(node){for(;node.hasChildNodes();)node.removeChild(node.firstChild)},DOM.insertAfter=function(node,referenceNode){return referenceNode.insertBefore(node,referenceNode.nextSibling)},DOM.addCSS=function(cssPath,root,attributes){if("string"!=typeof cssPath||""===cssPath.trim())throw new TypeError("DOM.addCSS: cssPath must be a non-empty string. Found: "+cssPath);if(!(root=root||document.head||document.body||document))throw new Error("DOM.addCSS: root is undefined, and could not detect a valid root for css: "+cssPath);return attributes=JSUS.mixin({rel:"stylesheet",type:"text/css",href:cssPath},attributes),this.add("link",root,attributes)},DOM.addJS=function(jsPath,root,attributes){if("string"!=typeof jsPath||""===jsPath.trim())throw new TypeError("DOM.addCSS: jsPath must be a non-empty string. Found: "+jsPath);if(!(root=root||document.head||document.body||document))throw new Error("DOM.addCSS: root is undefined, and could not detect a valid root for css: "+jsPath);return attributes=JSUS.mixin({charset:"utf-8",type:"text/javascript",src:jsPath},attributes),this.add("script",root,attributes)},DOM.highlight=function(elem,code){var color;switch(code){case"OK":color="green";break;case"WARN":color="yellow";break;case"ERR":color="red";break;default:color="#"===code.charAt(0)?code:"red"}return this.addBorder(elem,color)},DOM.addBorder=function(elem,color,width,type){var properties;return properties={border:(width=width||"5px")+" "+(type=type||"solid")+" "+(color=color||"red")},DOM.style(elem,properties)},DOM.style=function(elem,properties){var i;if(!DOM.isElement(elem))throw new TypeError("DOM.style: elem must be HTMLElement. Found: "+elem);if(properties){if("object"!=typeof properties)throw new TypeError("DOM.style: properties must be object or undefined. Found: "+properties);for(i in properties)properties.hasOwnProperty(i)&&(elem.style[i]=properties[i])}return elem},DOM.generateUniqueId=function(){function scanDocuments(docs,id){var i,len;if(1===(len=docs.length))return!docs[0].document.getElementById(id);if(2===len)return!(!docs[0].document.getElementById(id)||!docs[1].document.getElementById(id));for(i=-1;++i<len;)if(docs[i].document.getElementById(id))return!1;return!0}return 100,function(prefix,checkFrames){var id,windows,found,counter;if(prefix){if("string"!=typeof prefix&&"number"!=typeof prefix)throw new TypeError("DOM.generateUniqueId: prefix must be string or number. Found: "+prefix)}else prefix=JSUS.randomString(8,"a");for(id=prefix+"_",windows=[window],(checkFrames||void 0===checkFrames)&&window.frames&&(windows=windows.concat(window.frames)),found=!0,counter=-1;found;)if(found=scanDocuments(windows,id=prefix+"_"+JSUS.randomInt(1e3)),++counter>100)throw new Error("DOM.generateUniqueId: could not find unique id within 100 trials.");return id}}(),DOM.removeClass=function(elem,className,force){var regexpr;if(!force&&!DOM.isElement(elem))throw new TypeError("DOM.removeClass: elem must be HTMLElement. Found: "+elem);if(className){if("string"!=typeof className||""===className.trim())throw new TypeError("DOM.removeClass: className must be HTMLElement. Found: "+className);regexpr=new RegExp("(?:^|\\s)"+className+"(?!\\S)"),elem.className=elem.className.replace(regexpr,"")}return elem},DOM.addClass=function(elem,className,force){if(!force&&!DOM.isElement(elem))throw new TypeError("DOM.addClass: elem must be HTMLElement. Found: "+elem);if(className){if(className instanceof Array&&(className=className.join(" ")),"string"!=typeof className||""===className.trim())throw new TypeError("DOM.addClass: className must be HTMLElement. Found: "+className);elem.className?elem.className+=" "+className:elem.className=className}return elem},DOM.getElementsByClassName=function(document,className,nodeName){var result,node,tag,seek,i,rightClass;if(result=[],tag=nodeName||"*",document.evaluate)for(seek="//"+tag+'[contains(concat(" ", normalize-space(@class), " "), "'+className+' ")]',seek=document.evaluate(seek,document,null,0,null);node=seek.iterateNext();)result.push(node);else for(rightClass=new RegExp("(^| )"+className+"( |$)"),seek=document.getElementsByTagName(tag),i=0;i<seek.length;i++)rightClass.test((node=seek[i]).className)&&result.push(seek[i]);return result},DOM.getIFrameDocument=function(iframe){return iframe&&(iframe.contentDocument||iframe.contentWindow)?iframe.contentWindow.document:null},DOM.getIFrameAnyChild=function(iframe){var contentDocument;if(iframe)return(contentDocument=DOM.getIFrameDocument(iframe)).head||contentDocument.body||contentDocument.lastChild||contentDocument.getElementsByTagName("html")[0]},DOM.addEvent=function(element,event,func,capture){return capture=!!capture,element.attachEvent?element.attachEvent("on"+event,func):element.addEventListener(event,func,capture)},DOM.removeEvent=function(element,event,func,capture){return capture=!!capture,element.detachEvent?element.detachEvent("on"+event,func):element.removeEventListener(event,func,capture)},DOM.onFocusIn=function(cb,ctx){var origCb;if("function"!=typeof cb&&null!==cb)throw new TypeError("JSUS.onFocusIn: cb must be function or null.");if(ctx){if("object"!=typeof ctx&&"function"!=typeof ctx)throw new TypeError("JSUS.onFocusIn: ctx must be object, function or undefined.");origCb=cb,cb=function(){origCb.call(ctx)}}onFocusChange(cb)},DOM.onFocusOut=function(cb,ctx){var origCb;if("function"!=typeof cb&&null!==cb)throw new TypeError("JSUS.onFocusOut: cb must be function or null.");if(ctx){if("object"!=typeof ctx&&"function"!=typeof ctx)throw new TypeError("JSUS.onFocusIn: ctx must be object, function or undefined.");origCb=cb,cb=function(){origCb.call(ctx)}}onFocusChange(void 0,cb)},DOM.disableRightClick=function(doc){(doc=doc||document).layers?(doc.captureEvents(Event.MOUSEDOWN),doc.onmousedown=function(e){if((doc.layers||doc.getElementById&&!doc.all)&&(2==e.which||3==e.which))return!1}):doc.all&&!doc.getElementById&&(doc.onmousedown=function(){if(2==event.button)return!1}),doc.oncontextmenu=function(){return!1}},DOM.enableRightClick=function(doc){(doc=doc||document).layers?(doc.releaseEvents(Event.MOUSEDOWN),doc.onmousedown=null):doc.all&&!doc.getElementById&&(doc.onmousedown=null),doc.oncontextmenu=null},DOM.disableBackButton=(isDisabled=!1,function(disable){if((disable=void 0===disable||disable)&&!isDisabled){if(!history.pushState||!history.go)return JSUS.log("DOM.disableBackButton: method not supported by browser."),null;history.pushState(null,null,location.href),window.onpopstate=function(event){history.go(1)}}else isDisabled&&(window.onpopstate=null);return isDisabled=disable,disable}),DOM.playSound="undefined"==typeof Audio?function(){console.log("JSUS.playSound: Audio tag not supported in your browser. Cannot play sound.")}:function(sound){var audio;if("string"==typeof sound)audio=new Audio(sound);else{if("object"!=typeof sound||"function"!=typeof sound.play)throw new TypeError("JSUS.playSound: sound must be string or audio element.");audio=sound}audio.play()},DOM.blinkTitle=(id=null,clearBlinkInterval=function(opts){clearInterval(id),id=null,elem&&(elem.removeEventListener("click",clearBlinkInterval),elem=null),finalTitle&&(document.title=finalTitle,finalTitle=null)},function(titles,options){var period,where,rotation,rotationId,nRepeats;if(null!==id&&clearBlinkInterval(),void 0===titles)return null;if(where="JSUS.blinkTitle: ",void 0===(options=options||{}).finalTitle)finalTitle=document.title;else{if("string"!=typeof options.finalTitle)throw new TypeError(where+"options.finalTitle must be string or undefined. Found: "+options.finalTitle);finalTitle=options.finalTitle}if(void 0!==options.repeatFor&&!1===(nRepeats=JSUS.isInt(options.repeatFor,0)))throw new TypeError(where+"options.repeatFor must be a positive integer. Found: "+options.repeatFor);if(options.stopOnFocus&&JSUS.onFocusIn((function(){clearBlinkInterval(),onFocusChange(null,null)})),void 0!==options.stopOnClick){if("object"!=typeof options.stopOnClick||!options.stopOnClick.addEventListener)throw new TypeError(where+"options.stopOnClick must be an HTML element with method addEventListener. Found: "+options.stopOnClick);(elem=options.stopOnClick).addEventListener("click",clearBlinkInterval)}if(options.startOnBlur)return options.startOnBlur=null,JSUS.onFocusOut((function(){JSUS.blinkTitle(titles,options)})),null;if("string"==typeof titles)titles=[titles,"!!!"];else if(!JSUS.isArray(titles))throw new TypeError(where+"titles must be string, array of strings or undefined. Found: "+titles);return rotationId=0,period=options.period||1e3,(rotation=function(){changeTitle(titles[rotationId]),rotationId=(rotationId+1)%titles.length,"number"==typeof nRepeats&&0===rotationId&&0==--nRepeats&&clearBlinkInterval()})(),id=setInterval(rotation,period),clearBlinkInterval}),DOM.cookieSupport=function(){var c,persist;persist=!0;do{if(c="gCStest="+Math.floor(1e8*Math.random()),document.cookie=persist?c+";expires=Tue, 01-Jan-2030 00:00:00 GMT":c,-1!==document.cookie.indexOf(c))return document.cookie=c+";expires=Sat, 01-Jan-2000 00:00:00 GMT",persist}while(!(persist=!persist));return null},DOM.viewportSize=function(dim){var w,d,e,g,x,y;if(dim&&"x"!==dim&&"y"!==dim)throw new TypeError('DOM.viewportSize: dim must be "x","y" or undefined. Found: '+dim);return w=window,e=(d=document).documentElement,g=d.getElementsByTagName("body")[0],x=w.innerWidth||e.clientWidth||g.clientWidth,y=w.innerHeight||e.clientHeight||g.clientHeight,dim?"x"===dim?x:y:{x:x,y:y}},DOM.makeTabbable=function(elem,opts){return opts=opts||{},elem.setAttribute("tabindex",opts.index||0),opts.clicklable&&DOM.makeClickable(elem),elem},DOM.makeClickable=function(){function clickCb(event){32!==event.keyCode&&13!==event.keyCode||(event.preventDefault(),event.target.click())}var cb;return cb=function(elem,add){return void 0===add&&(add=!0),add?elem.addEventListener("keydown",clickCb):elem.removeEventListener("keydown",clickCb),elem},cb.cb=clickCb,cb}(),onFocusChange=function(document){var inFocusCb,outFocusCb,event,hidden,evtMap;if(!document)return function(){JSUS.log("onFocusChange: no document detected.")};function onchange(evt){((evt=evt||window.event).type in evtMap?evtMap[evt.type]:!!this[hidden])?outFocusCb&&outFocusCb():inFocusCb&&inFocusCb()}return"hidden"in document?(hidden="hidden",event="visibilitychange"):"mozHidden"in document?(hidden="mozHidden",event="mozvisibilitychange"):"webkitHidden"in document?(hidden="webkitHidden",event="webkitvisibilitychange"):"msHidden"in document&&(hidden="msHidden",event="msvisibilitychange"),evtMap={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1},function(inCb,outCb){var onchangeCb;void 0!==inCb?inFocusCb=inCb:outFocusCb=outCb,onchangeCb=inFocusCb||outFocusCb?onchange:null,event?onchangeCb?document.addEventListener(event,onchange):document.removeEventListener(event,onchange):"onfocusin"in document?document.onfocusin=document.onfocusout=onchangeCb:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=onchangeCb}}("undefined"!=typeof document?document:null),changeTitle=function(title){if("string"!=typeof title)throw new TypeError("JSUS.changeTitle: title must be string. Found: "+title);document.title=title},JSUS.extend(DOM)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function EVAL(){}EVAL.eval=function(str,context){var func;if(str)return context=context||this,func=function(str){return str="("+str+")","undefined"!=typeof window&&window.execScript?(window.execScript("__my_eval__ = "+str),__my_eval__):eval(str)},func.call(context,str)},JSUS.extend(EVAL)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function OBJ(){}var makeClone,splitValue,model,level,_key,posAsKeys,compatibility=null;function setProp(clone,i,value){try{Object.defineProperty(clone,i,{value:value,writable:!0,configurable:!0})}catch(e){clone[i]=value}}void 0!==JSUS.compatibility&&(compatibility=JSUS.compatibility()),OBJ.createObj="function"!=typeof Object.create?function(){function Temp(){}var hasOwn=Object.prototype.hasOwnProperty;return function(O){if("object"!=typeof O)throw new TypeError("Object prototype may only be an Object or null");Temp.prototype=O;var obj=new Temp;if(Temp.prototype=null,arguments.length>1){var Properties=new Object(arguments[1]);for(var prop in Properties)hasOwn.call(Properties,prop)&&(obj[prop]=Properties[prop])}return obj}}():Object.create,OBJ.equals=function(o1,o2){var type1,type2,p;if((type1=typeof o1)!==(type2=typeof o2))return!1;if("undefined"===type1||"undefined"===type2)return o1===o2;if(null===o1||null===o2)return o1===o2;if("number"===type1&&isNaN(o1)&&"number"===type2&&isNaN(o2))return isNaN(o1)&&isNaN(o2);if(type1 in{number:"",string:"",boolean:""})return o1===o2;if("function"===type1)return o1.toString()===o2.toString();for(p in o1)if(o1.hasOwnProperty(p)){if(void 0===o2[p]&&void 0!==o1[p])return!1;if(!o2[p]&&o1[p])return!1;if("function"==typeof o1[p]){if(o1[p].toString()!==o2[p].toString())return!1}else if(!OBJ.equals(o1[p],o2[p]))return!1}for(p in o2)if(o2.hasOwnProperty(p)){if(void 0===o1[p]&&void 0!==o2[p])return!1;if(!o1[p]&&o2[p])return!1}return!0},OBJ.isEmpty=function(o){var key;if(!o)return!0;if("string"==typeof o)return""===o.trim();if("number"==typeof o)return!1;if("function"==typeof o)return!1;for(key in o)if(o.hasOwnProperty(key))return!1;return!0},OBJ.size=OBJ.getListSize=function(obj){var n,key;if(!obj)return 0;if("number"==typeof obj)return 0;if("string"==typeof obj)return 0;for(key in n=0,obj)obj.hasOwnProperty(key)&&n++;return n},OBJ._obj2Array=function(obj,keyed,level,cur_level){var result,key;if("object"!=typeof obj)return[obj];if(level){if((cur_level=void 0!==cur_level?cur_level:1)>level)return[obj];cur_level+=1}for(key in result=[],obj)obj.hasOwnProperty(key)&&(keyed&&result.push(key),"object"==typeof obj[key]?result=result.concat(OBJ._obj2Array(obj[key],keyed,level,cur_level)):result.push(obj[key]));return result},OBJ.obj2Array=function(obj,level){return OBJ._obj2Array(obj,!1,level)},OBJ.obj2KeyedArray=OBJ.obj2KeyArray=function(obj,level){return OBJ._obj2Array(obj,!0,level)},OBJ.obj2QueryString=function(obj){var str,key;if("object"!=typeof obj)throw new TypeError("JSUS.objectToQueryString: obj must be object.");for(key in str=[],obj)obj.hasOwnProperty(key)&&str.push(encodeURIComponent(key)+"="+encodeURIComponent(obj[key]));return"?"+str.join("&")},OBJ.keys=function(){return function(obj,level,options){var keys,type,allKeys,leafKeys,levelKeys,separator,myLevel,curParent;if(2===arguments.length&&"object"==typeof level&&(level=(options=level).level),"all"===(type=(options=options||{}).type?options.type.toLowerCase():"all"))allKeys=!0;else if("leaf"===type)leafKeys=!0;else{if("level"!==type)throw new Error("keys: unknown type option: "+type);levelKeys=!0}if(options.cb&&"function"!=typeof options.cb)throw new TypeError("JSUS.keys: options.cb must be function or undefined. Found: "+options.cb);if(void 0===level?myLevel=0:"number"==typeof level?myLevel=level:"string"==typeof level&&(myLevel=parseInt(level,10)),"number"!=typeof myLevel||isNaN(myLevel))throw new Error("JSUS.keys: level must be number, undefined or a parsable string. Found: "+level);return level<0?[]:(options.concat&&(separator=void 0===options.separator?".":options.separator),curParent=options.parent?options.parent+separator:"",!options.concat&&options.distinct&&(keys={}),_keys(obj,myLevel,0,curParent,options.concat,allKeys,leafKeys,levelKeys,separator,options.array||[],keys,options.skip||{},options.cb))};function _keys(obj,level,curLevel,curParent,concatKeys,allKeys,leafKeys,levelKeys,separator,res,uniqueKeys,skipKeys,cb){var key,isLevel,isObj,tmp;for(key in isLevel=curLevel===level,obj)obj.hasOwnProperty(key)&&(isObj="object"==typeof obj[key],(allKeys||leafKeys&&(isLevel||!isObj)||levelKeys&&isLevel)&&(concatKeys?skipKeys[tmp=curParent+key]||(cb?_doCb(tmp,res,cb):res.push(tmp)):skipKeys[key]||(uniqueKeys?uniqueKeys[key]||(cb?_doCb(key,res,cb):res.push(key),uniqueKeys[key]=!0):cb?_doCb(key,res,cb):res.push(key))),isObj&&curLevel<level&&_keys(obj[key],level,curLevel+1,concatKeys?curParent+key+separator:key,concatKeys,allKeys,leafKeys,levelKeys,separator,res,uniqueKeys,skipKeys,cb));return res}function _doCb(key,res,cb){var tmp;"string"==typeof(tmp=cb(key))||"number"==typeof tmp?res.push(tmp):JSUS.isArray(tmp)&&tmp.length?tmp.length<4?(res.push(tmp[0]),tmp.length>1&&(res.push(tmp[1]),tmp.length>2&&res.push(tmp[2]))):function(){for(var i=-1,len=tmp.length;++i<len;)res.push(tmp[i])}():void 0===tmp&&res.push(key)}}(),OBJ.implode=OBJ.implodeObj=function(obj){var result,key,o;if(!obj)return[];for(key in result=[],obj)obj.hasOwnProperty(key)&&((o={})[key]=obj[key],result.push(o));return result},OBJ.clone=function(obj){var clone,i,value;if(!obj)return obj;if("number"==typeof obj)return obj;if("string"==typeof obj)return obj;if("boolean"==typeof obj)return obj;for(i in clone="function"==typeof obj?function(){var len,args;if(len=arguments.length){if(1===len)return obj.call(clone,arguments[0]);if(2===len)return obj.call(clone,arguments[0],arguments[1]);for(args=new Array(len),i=0;i<len;i++)args[i]=arguments[i];return obj.apply(clone,args)}return obj.call(clone)}:"[object Array]"===Object.prototype.toString.call(obj)?[]:{},obj)value=obj[i]&&"object"==typeof obj[i]?OBJ.clone(obj[i]):obj[i],obj.hasOwnProperty(i)?clone[i]=value:compatibility&&compatibility.defineProperty?Object.defineProperty(clone,i,{value:value,writable:!0,configurable:!0}):setProp(clone,i,value);return clone},OBJ.classClone=function(obj,depth){var clone,i;if(0===depth)return obj;if(obj&&"object"==typeof obj){for(i in clone="[object Array]"===Object.prototype.toString.call(obj)?[]:JSUS.createObj(obj.constructor.prototype),obj)obj.hasOwnProperty(i)&&(obj[i]&&"object"==typeof obj[i]?clone[i]=JSUS.classClone(obj[i],depth-1):clone[i]=obj[i]);return clone}return JSUS.clone(obj)},OBJ.join=function(obj1,obj2){var clone,i;if(clone=OBJ.clone(obj1),!obj2)return clone;for(i in clone)clone.hasOwnProperty(i)&&void 0!==obj2[i]&&("object"==typeof obj2[i]?clone[i]=OBJ.join(clone[i],obj2[i]):clone[i]=obj2[i]);return clone},OBJ.merge=function(obj1,obj2){var clone,i;if(!obj1&&!obj2)return!1;if(!obj1)return OBJ.clone(obj2);if(!obj2)return OBJ.clone(obj1);for(i in clone=OBJ.clone(obj1),obj2)obj2.hasOwnProperty(i)&&(obj2[i]&&"object"==typeof obj2[i]?("object"!=typeof clone[i]&&("[object Array]"===Object.prototype.toString.call(obj2[i])?clone[i]=[]:clone[i]={}),clone[i]=OBJ.merge(clone[i],obj2[i])):clone[i]=obj2[i]);return clone},OBJ.mixin=function(obj1,obj2){var i;if(obj1||obj2){if(!obj1)return obj2;if(!obj2)return obj1;for(i in obj2)obj1[i]=obj2[i];return obj1}},OBJ.mixout=function(obj1,obj2){var i;if(obj1||obj2){if(!obj1)return obj2;if(!obj2)return obj1;for(i in obj2)void 0===obj1[i]&&(obj1[i]=obj2[i]);return obj1}},OBJ.mixcommon=function(obj1,obj2){var i;if(obj1||obj2){if(!obj1)return obj2;if(!obj2)return obj1;for(i in obj2)void 0!==obj1[i]&&(obj1[i]=obj2[i]);return obj1}},OBJ.mergeOnKey=function(obj1,obj2,key){var clone,i;if(clone=OBJ.clone(obj1),!obj2||!key)return clone;for(i in obj2)obj2.hasOwnProperty(i)&&(clone[i]&&"object"==typeof clone[i]||(clone[i]={}),clone[i][key]=obj2[i]);return clone},OBJ.subobj=OBJ.subObj=function(o,select){var out,i,key;if(!o)return!1;if(out={},!select)return out;for(select instanceof Array||(select=[select]),i=0;i<select.length;i++)key=select[i],o.hasOwnProperty(key)?out[key]=o[key]:OBJ.hasOwnNestedProperty(key,o)&&OBJ.setNestedValue(key,OBJ.getNestedValue(key,o),out);return out},OBJ.skim=function(o,remove){var out,i;if(!o)return!1;if(out=OBJ.clone(o),!remove)return out;for(remove instanceof Array||(remove=[remove]),i=0;i<remove.length;i++)out.hasOwnProperty(i)?delete out[i]:OBJ.deleteNestedKey(remove[i],out);return out},OBJ.setNestedValue=function(str,value,obj){var keys,k;return str?(obj="object"==typeof obj?obj:{},1===(keys=str.split(".")).length?(obj[str]=value,obj):(obj[k=keys.shift()]=OBJ.setNestedValue(keys.join("."),value,obj[k]),obj)):(JSUS.log("Cannot set value of undefined property","ERR"),!1)},OBJ.getNestedValue=function(str,obj){var keys,k;if(obj)return 1===(keys=str.split(".")).length?obj[str]:(k=keys.shift(),OBJ.getNestedValue(keys.join("."),obj[k]))},OBJ.deleteNestedKey=function(str,obj){var keys,k;if(obj)return 1===(keys=str.split(".")).length?(delete obj[str],!0):void 0!==obj[k=keys.shift()]&&OBJ.deleteNestedKey(keys.join("."),obj[k])},OBJ.hasOwnNestedProperty=function(str,obj){var keys,k;return!!obj&&(1===(keys=str.split(".")).length?obj.hasOwnProperty(str):(k=keys.shift(),OBJ.hasOwnNestedProperty(keys.join("."),obj[k])))},OBJ.split=(makeClone=function(value,out,keys){var i,len,tmp,copy;switch(copy=JSUS.clone(model),keys.length){case 0:copy[_key]=JSUS.clone(value);break;case 1:copy[_key][keys[0]]=JSUS.clone(value);break;case 2:copy[_key][keys[0]]={},copy[_key][keys[0]][keys[1]]=JSUS.clone(value);break;default:for(i=-1,len=keys.length-1,tmp=copy[_key];++i<len;)tmp[keys[i]]={},tmp=tmp[keys[i]];tmp[keys[keys.length-1]]=JSUS.clone(value)}out.push(copy)},splitValue=function(value,out,curLevel,keysArray){var i,curPosAsKey;if(level&&curLevel>=level)makeClone(value,out,keysArray);else for(i in curPosAsKey=posAsKeys||!JSUS.isArray(value),value)value.hasOwnProperty(i)&&("object"==typeof value[i]&&level&&curLevel+1<=level?splitValue(value[i],out,curLevel+1,curPosAsKey?keysArray.concat(i):keysArray):makeClone(value[i],out,curPosAsKey?keysArray.concat(i):keysArray))},function(o,key,l,positionAsKey){var out;if("object"!=typeof o)throw new TypeError("JSUS.split: o must be object. Found: "+o);if("string"!=typeof key||""===key.trim())throw new TypeError("JSUS.split: key must a non-empty string. Found: "+key);if(l&&("number"!=typeof l||l<0))throw new TypeError("JSUS.split: l must a non-negative number or undefined. Found: "+l);return model=JSUS.clone(o),"object"!=typeof o[key]?[model]:(out=[],_key=key,model[key]={},level=void 0===l?1:l,posAsKeys=positionAsKey,splitValue(o[key],out,0,[]),_key=void 0,model=void 0,level=void 0,posAsKeys=void 0,out)}),OBJ.melt=function(keys,values){for(var o={},valen=values.length,i=0;i<keys.length;i++)o[keys[i]]=values[i%valen];return o},OBJ.uniqueKey=function(obj,prefixName,stop){var name,duplicateCounter;if(obj){for(duplicateCounter=1,stop=stop||1e6,name=prefixName=""+(prefixName||Math.floor(1e15*Math.random()));obj[name];)if(name=prefixName+duplicateCounter,++duplicateCounter>stop)return;return name}JSUS.log("Cannot find unique name in undefined object","ERR")},OBJ.randomKey=function(obj){var keys;if("object"!=typeof obj)throw new TypeError("OBJ.randomKey: obj must be object. Found: "+obj);return(keys=Object.keys(obj))[keys.length*Math.random()<<0]},OBJ.augment=function(obj1,obj2,keys){var i,k;for(keys=keys||OBJ.keys(obj1),i=0;i<keys.length;i++)void 0!==obj1[k=keys[i]]&&"[object Array]"!==Object.prototype.toString.call(obj1[k])&&(obj1[k]=[obj1[k]]),"undefined"!==obj2[k]&&(obj1[k]||(obj1[k]=[]),obj1[k].push(obj2[k]))},OBJ.pairwiseWalk=function(o1,o2,cb){var i,out;if(o1||o2){if(!o1)return o2;if(!o2)return o1;for(i in out={},o1)o1.hasOwnProperty(i)&&(out[i]=o2.hasOwnProperty(i)?cb(o1[i],o2[i]):cb(o1[i]));for(i in o2)o2.hasOwnProperty(i)&&void 0===out[i]&&(out[i]=cb(void 0,o2[i]));return out}},OBJ.getKeyByValue=function(obj,value,allKeys){var key,out;if("object"!=typeof obj)throw new TypeError("OBJ.getKeyByValue: obj must be object. Found: "+obj);for(key in allKeys&&(out=[]),obj)if(obj.hasOwnProperty(key)&&OBJ.equals(value,obj[key])){if(!allKeys)return key;out.push(key)}return out},OBJ.reverseObj=function(o,cb){var k,res;if(cb&&"function"!=typeof cb)throw new TypeError("OBJ.reverseObj: cb must be function or undefined. Found: "+cb);if(res={},!o)return res;for(k in o)o.hasOwnProperty(k)&&(cb?res[(k=cb(k,o[k]))[1]]=res[k[0]]:res[o[k]]=k);return res},JSUS.extend(OBJ)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function RANDOM(){}RANDOM.random=function(a,b){var c;if(void 0===b){if(void 0===a)return Math.random();b=a,a=0}return a===b?a:(b<a&&(c=a,a=b,b=c),Math.random()*(b-a)+a)},RANDOM.randomInt=function(a,b){return a===b?a:Math.floor(RANDOM.random(a,b)+1)},RANDOM.randomDate=function(){function isValidDate(date){return date&&"[object Date]"===Object.prototype.toString.call(date)&&!isNaN(date)}return function(startDate,endDate){if(void 0===startDate)startDate=new Date("1900");else if(!isValidDate(startDate))throw new TypeError("randomDate: startDate must be a valid date. Found: "+startDate);if(void 0===endDate)endDate=new Date;else if(!isValidDate(endDate))throw new TypeError("randomDate: endDate must be a valid date or undefined. Found: "+endDate);return new Date(startDate.getTime()+Math.random()*(endDate.getTime()-startDate.getTime()))}}(),RANDOM.sample=function(a,b){var out;return!!(out=JSUS.seq(a,b))&&JSUS.shuffle(out)},RANDOM.getNormalGenerator=function(){return function normal(mu,sigma){var v1,v2,s;if("number"!=typeof mu)throw new TypeError("nextNormal: mu must be number.");if("number"!=typeof sigma)throw new TypeError("nextNormal: sigma must be number.");return mu===oldMu&&sigma===oldSigma||(genReady=!1,oldMu=mu,oldSigma=sigma),genReady?(genReady=!1,sigma*x2+mu):(s=(v1=2*Math.random()-1)*v1+(v2=2*Math.random()-1)*v2)>=1?normal(mu,sigma):(multiplier=Math.sqrt(-2*Math.log(s)/s),x2=v2*multiplier,genReady=!0,sigma*(v1*multiplier)+mu)};var oldMu,oldSigma,x2,multiplier,genReady},RANDOM.nextNormal=RANDOM.getNormalGenerator(),RANDOM.nextLogNormal=function(mu,sigma){if("number"!=typeof mu)throw new TypeError("nextLogNormal: mu must be number.");if("number"!=typeof sigma)throw new TypeError("nextLogNormal: sigma must be number.");return Math.exp(RANDOM.nextNormal(mu,sigma))},RANDOM.nextExponential=function(lambda){if("number"!=typeof lambda)throw new TypeError("nextExponential: lambda must be number.");if(lambda<=0)throw new TypeError("nextExponential: lambda must be greater than 0.");return-Math.log(1-Math.random())/lambda},RANDOM.nextBinomial=function(p,trials){var counter,sum;if("number"!=typeof p)throw new TypeError("nextBinomial: p must be number.");if("number"!=typeof trials)throw new TypeError("nextBinomial: trials must be number.");if(p<0||p>1)throw new TypeError("nextBinomial: p must between 0 and 1.");if(trials<1)throw new TypeError("nextBinomial: trials must be greater than 0.");for(counter=0,sum=0;counter<trials;)Math.random()<p&&(sum+=1),counter++;return sum},RANDOM.nextGamma=function(alpha,k){var intK,kDiv,alphaDiv,u1,u2,u3,x,i,tmp;if("number"!=typeof alpha)throw new TypeError("nextGamma: alpha must be number.");if("number"!=typeof k)throw new TypeError("nextGamma: k must be number.");if(alpha<1)throw new TypeError("nextGamma: alpha must be greater than 1.");if(k<1)throw new TypeError("nextGamma: k must be greater than 1.");for(u1=Math.random(),u2=Math.random(),u3=Math.random(),intK=Math.floor(k)+3,kDiv=1/k,alphaDiv=1/alpha,x=0,i=3;++i<intK;)x+=Math.log(Math.random());return x*=-alphaDiv,tmp=Math.log(u3)*(Math.pow(u1,kDiv)/(Math.pow(u1,kDiv)+Math.pow(u2,1/(1-k)))),x+(tmp*=-alphaDiv)},RANDOM.randomString=function(len,chars,useChars){var mask,result,i,nSpaces;if(void 0!==len&&("number"!=typeof len||len<1))throw new Error("randomString: len must a number > 0 or undefined. Found: "+len);if(void 0!==chars){if("string"!=typeof chars||""===chars.trim())throw new Error("randomString: chars must a non-empty string or undefined. Found: "+chars)}else if(useChars)throw new Error("randomString: useChars is TRUE, but chars is undefined.");if(len=len||6,chars=chars||"a",mask="",useChars)mask=chars;else if(chars.indexOf("a")>-1&&(mask+="abcdefghijklmnopqrstuvwxyz"),chars.indexOf("A")>-1&&(mask+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),chars.indexOf("1")>-1&&(mask+="0123456789"),chars.indexOf("!")>-1&&(mask+="!~`@#$%^&*()_+-={}[]:\";'<>?,./|\\"),(nSpaces=chars.indexOf("_"))>-1)if(nSpaces=chars.charAt(nSpaces+1),1===(nSpaces=JSUS.isInt(nSpaces,0)||1))mask+=" ";else if(2===nSpaces)mask+="  ";else if(3===nSpaces)mask+="   ";else for(i=-1;++i<nSpaces;)mask+=" ";for(i=-1,result="";++i<len;)result+=mask[Math.floor(Math.random()*mask.length)];return result},RANDOM.randomEmail=function(){return RANDOM.randomString(RANDOM.randomInt(5,15),"!Aa0")+"@"+RANDOM.randomString(RANDOM.randomInt(3,10))+"."+RANDOM.randomString(RANDOM.randomInt(2,3))},JSUS.extend(RANDOM)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function TIME(){}function pad(number){return number<10?"0"+number:number}function _getTime(ms){var d,res;return res=pad((d=new Date).getHours())+":"+pad(d.getMinutes())+":"+pad(d.getSeconds()),ms&&(res+=":"+pad(d.getMilliseconds())),res}Date.prototype.toISOString||(Date.prototype.toISOString=function(){var ms=(this.getUTCMilliseconds()/1e3).toFixed(3);return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+ms.slice(2,5)+"Z"}),TIME.getDate=TIME.getFullDate=function(){return(new Date).toISOString()},TIME.getTime=function(){return _getTime()},TIME.getTimeM=function(){return _getTime(!0)},TIME.parseMilliseconds=function(ms){var result,x,seconds,minutes,hours,days;if("number"!=typeof ms)throw new TypeError("TIME.parseMilliseconds: ms must be number.");return(result=[])[4]=x=ms/1e3,seconds=x%60,result[3]=Math.floor(seconds),minutes=(x/=60)%60,result[2]=Math.floor(minutes),hours=(x/=60)%24,result[1]=Math.floor(hours),days=x/=24,result[1]=Math.floor(days),result},TIME.now="function"==typeof Date.now?Date.now:function(){return(new Date).getTime()},JSUS.extend(TIME)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){"use strict";function PARSE(){}function preprocessRange(expr){for(var mult=function(match,p1,p2,p3){var n1=parseInt(p1,10),n3=parseInt(p3,10);return"*"==p2?n1*n3:n1/n3},add=function(match,p1,p2,p3){var n1=parseInt(p1,10),n3=parseInt(p3,10);return"-"==p2?n1-n3:n1+n3},mod=function(match,p1,p2,p3){return parseInt(p1,10)%parseInt(p3,10)};expr.match(/([-+]?\d+) *([*\/]) *([-+]?\d+)/g);)expr=expr.replace(/([-+]?\d+) *([*\/]) *([-+]?\d+)/,mult);for(;expr.match(/([-+]?\d+) *([-+]) *([-+]?\d+)/g);)expr=expr.replace(/([-+]?\d+) *([-+]) *([-+]?\d+)/,add);for(;expr.match(/([-+]?\d+) *% *([-+]?\d+)/g);)expr=expr.replace(/([-+]?\d+) *% *([-+]?\d+)/,mod);return expr}PARSE.stringify_prefix="!?_",PARSE.marker_func=PARSE.stringify_prefix+"function",PARSE.marker_null=PARSE.stringify_prefix+"null",PARSE.marker_und=PARSE.stringify_prefix+"undefined",PARSE.marker_nan=PARSE.stringify_prefix+"NaN",PARSE.marker_inf=PARSE.stringify_prefix+"Infinity",PARSE.marker_minus_inf=PARSE.stringify_prefix+"-Infinity",PARSE.getQueryString=function(name,referer){var results;if(referer&&"string"!=typeof referer)throw new TypeError("JSUS.getQueryString: referer must be string or undefined. Found: "+referer);return referer=referer||window.location.search,void 0===name?referer:(name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),null!==(results=new RegExp("[\\?&]"+name+"=([^&#]*)").exec(referer))&&decodeURIComponent(results[1].replace(/\+/g," ")))},PARSE.isMobileAgent=function(agent){if(agent){if("string"!=typeof agent)throw new TypeError("JSUS.isMobileAgent: agent must be undefined or string. Found: "+agent)}else{if(!navigator)throw new Error("JSUS.isMobileAgent: agent undefined and no navigator. Are you in the browser?");agent=navigator.userAgent}return new RegExp("Android|webOS|iPhone|iPad|BlackBerry|Windows Phone|Opera Mini|IEMobile|Mobile","i").test(agent)},PARSE.tokenize=function(str,separators,modifiers){var pattern,regex;if(str)return separators&&separators.length?(modifiers=modifiers||{},pattern="[",JSUS.each(separators,(function(s){" "===s&&(s="\\s"),pattern+=s})),pattern+="]+",regex=new RegExp(pattern),str.split(regex,modifiers.limit)):[str]},PARSE.stringify=function(o,spaces){return JSON.stringify(o,(function(key,value){var type=typeof value;return"function"===type?PARSE.stringify_prefix+value.toString():"undefined"===type?PARSE.marker_und:null===value?PARSE.marker_null:"number"===type&&isNaN(value)?PARSE.marker_nan:value===Number.POSITIVE_INFINITY?PARSE.marker_inf:value===Number.NEGATIVE_INFINITY?PARSE.marker_minus_inf:value}),spaces)},PARSE.stringifyAll=function(o,spaces){var i;if("object"==typeof o)for(i in o)o.hasOwnProperty(i)||("object"==typeof o[i]?o[i]=PARSE.stringifyAll(o[i]):o[i]=o[i]);return PARSE.stringify(o)},PARSE.parse=function(){var customCb,len_prefix=PARSE.stringify_prefix.length,len_func=PARSE.marker_func.length,len_null=PARSE.marker_null.length,len_und=PARSE.marker_und.length,len_nan=PARSE.marker_nan.length,len_inf=PARSE.marker_inf.length,len_minus_inf=PARSE.marker_minus_inf.length;function walker(o){var i;if("object"!=typeof o)return reviver(o);for(i in o)o.hasOwnProperty(i)&&("object"==typeof o[i]?walker(o[i]):o[i]=reviver(o[i]));return customCb&&customCb(o),o}function reviver(value){if("string"===typeof value){if(value.substring(0,len_prefix)!==PARSE.stringify_prefix)return value;if(value.substring(0,len_func)===PARSE.marker_func)return JSUS.eval(value.substring(len_prefix));if(value.substring(0,len_null)===PARSE.marker_null)return null;if(value.substring(0,len_und)===PARSE.marker_und)return;if(value.substring(0,len_nan)===PARSE.marker_nan)return NaN;if(value.substring(0,len_inf)===PARSE.marker_inf)return 1/0;if(value.substring(0,len_minus_inf)===PARSE.marker_minus_inf)return-1/0}return value}return function(str,cb){return customCb=cb,walker(JSON.parse(str))}}(),PARSE.isInt=function(n,lower,upper,leq,ueq){var i;return!!/^-?\d+$/.test(n)&&((i=parseInt(n,10))===parseFloat(n)&&PARSE.isNumber(i,lower,upper,leq,ueq))},PARSE.isFloat=function(n,lower,upper,leq,ueq){return!!/^-?\d*(\.\d+)?$/.test(n)&&(-1!==n.toString().indexOf(".")&&PARSE.isNumber(n,lower,upper,leq,ueq))},PARSE.isNumber=function(n,lower,upper,leq,ueq){return!(isNaN(n)||!isFinite(n)||""===n)&&(n=parseFloat(n),("number"!=typeof lower||!(leq?n<lower:n<=lower))&&(("number"!=typeof upper||!(ueq?n>upper:n>=upper))&&n))},PARSE.isEmail=function(email){var idx;return"string"==typeof email&&(!(email.trim().length<5)&&(-1!==(idx=email.indexOf("@"))&&0!==idx&&idx!==email.length-1&&!(-1===(idx=email.lastIndexOf("."))||idx===email.length-1||idx>idx+1)))},PARSE.range=function(expr,available){var i,len,x,solution,begin,end,lowerBound,numbers,invalidChars,invalidBeforeOpeningBracket,invalidDot;if(solution=[],void 0===expr)return solution;if("number"==typeof expr)expr=""+expr;else if("string"!=typeof expr)throw new TypeError("PARSE.range: expr must be string, number, undefined. Found: "+expr);if(void 0===available)available=expr;else if(JSUS.isArray(available)){if(0===available.length)return solution;begin=Math.min.apply(null,available),end=Math.max.apply(null,available)}else if("object"==typeof available){if("function"!=typeof available.next)throw new TypeError("PARSE.range: available.next must be function. Found: "+available.next);if("function"!=typeof available.isFinished)throw new TypeError("PARSE.range: available.isFinished must be function. Found: "+available.isFinished);if("number"!=typeof available.begin)throw new TypeError("PARSE.range: available.begin must be number. Found: "+available.begin);if("number"!=typeof available.end)throw new TypeError("PARSE.range: available.end must be number. Found: "+available.end);begin=available.begin,end=available.end}else{if("string"!=typeof available)throw new TypeError("PARSE.range: available must be string, array, object or undefined. Found: "+available);if(null===(numbers=(available=preprocessRange(available)).match(/([-+]?\d+)/g)))throw new Error("PARSE.range: no numbers in available: "+available);lowerBound=Math.min.apply(null,numbers),available=PARSE.range(available,{begin:lowerBound,end:Math.max.apply(null,numbers),value:lowerBound,next:function(){return this.value++},isFinished:function(){return this.value>this.end}}),begin=Math.min.apply(null,available),end=Math.max.apply(null,available)}if(invalidChars=/[^ \*\d<>=!\|&\.\[\],\(\)\-\+%]/g,(expr=(expr=preprocessRange(expr=(expr=expr.replace(/end/g,parseInt(end,10))).replace(/begin/g,parseInt(begin,10)))).replace(/([-+]?\d+\.\d+)/g,(function(match,p1){return parseInt(p1,10)}))).match(invalidChars))throw new Error("PARSE.range: invalid characters found: "+expr);if(invalidChars=/[^ \d<>=!\|&,\(\)\-\+%x\.]/g,invalidBeforeOpeningBracket=/[^ &!|\(] *\(/g,invalidDot=/\.[^\d]|[^\d]\./,(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=(expr=expr.replace(/([^& ]) *& *([^& ])/g,"$1&&$2")).replace(/([^| ]) *\| *([^| ])/g,"$1||$2")).replace(/([-+]?\d+)/g,"(x==$1)")).replace(/% *\(x==([-+]?\d+)\)/,"!(x%$1)")).replace(/!\(x%([-+]?\d+)\) *={1,} *\(x==([-+]?\d+)\)/g,"(x%$1==$2)")).replace(/([<>]=?) *\(x==([-+]?\d+)\)/g,"(x$1$2)")).replace(/\(x==([-+]?\d+)\)\.{2,}\(x==(\+?\d+)\)\.{2,}\(x==([-+]?\d+)\)/g,"(x>=$1&&x<=$3&&!((x- $1)%$2))")).replace(/\(x==([-+]?\d+)\)\.{2,}\(x==(-\d+)\)\.{2,}\(x==([-+]?\d+)\)/g,"(x<=$1&&x>=$3&&!((x- $1)%$2))")).replace(/\(x==([-+]?\d+)\)\.{2,}\(x==([-+]?\d+)\)/g,"(x>=$1&&x<=$2)")).replace(/([(\[]) *\(x==([-+]?\d+)\) *, *\(x==([-+]?\d+)\) *([\])])/g,(function(match,p1,p2,p3,p4){return"(x>"+("("==p1?"":"=")+p2+"&&x<"+(")"==p4?"":"=")+p3+")"}))).replace("*",1)).replace(/\s/g,"")).replace(/\)[,] *(!*)\(/g,")||$1(")).match(invalidChars))throw new Error("PARSE.range: invalid characters found: "+expr);if(expr.match(invalidBeforeOpeningBracket))throw new Error("PARSE.range: invalid character before opending bracket found: "+expr);if(expr.match(invalidDot))throw new Error("PARSE.range: invalid dot found: "+expr);if(JSUS.isArray(available))for(i=-1,len=available.length;++i<len;)x=parseInt(available[i],10),JSUS.eval(expr.replace(/x/g,x))&&solution.push(x);else for(;!available.isFinished();)x=parseInt(available.next(),10),JSUS.eval(expr.replace(/x/g,x))&&solution.push(x);return solution},void 0!==Function.prototype.name?PARSE.funcName=function(func){if("function"!=typeof func)throw new TypeError("PARSE.funcName: func must be function. Found: "+func);return func.name}:PARSE.funcName=function(func){var res;if("function"!=typeof func)throw new TypeError("PARSE.funcName: func must be function. Found: "+func);return(res=/function\s([^(]{1,})\(/.exec(func.toString()))&&res.length>1?res[1].trim():""},JSUS.extend(PARSE)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(J){"use strict";if("undefined"!=typeof module&&void 0!==module.exports?(J=module.parent.exports.JSUS||require("JSUS").JSUS,module.exports=NDDB,module.exports.NDDB=NDDB):(J=JSUS,window.NDDB=NDDB),!J)throw new Error("NDDB: missing dependency: JSUS.");var df=J.compatibility().defineProperty;function NDDB(opts,db){var that;that=this,opts=opts||{},this.name=opts.name||"nddb",this.nddbid=new NDDBIndex("nddbid",this),this.db=[],this.lastSelection=[],this.hashtray=new NDDBHashtray,this.tags={},this.hooks={insert:[],remove:[],update:[],setwd:[],save:[],load:[]},this.sharedHooks={insert:[],remove:[],update:[],setwd:[],save:[],load:[]},this.nddb_pointer=0,this.query=new QueryBuilder,this.filters={},this.addDefaultFilters(),this.__userDefinedFilters={},this.__C={},this.__H={},this.__I={},this.__V={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!0,this.__update.sort=!1,this.__shared={},this.__formats={},this.__defaultFormat=null,this.__wd=null,this.__parentDb=null,this.log=console.log,this.globalCompare=function(o1,o2){return-1},this.comparator("*",(function(o1,o2,trigger1,trigger2){var d,c,res;for(d in o1){if(c=that.getComparator(d),o2[d]=o2["*"],(res=c(o1,o2))===trigger1)return res;if("undefined"!==trigger2&&res===trigger2)return res}return 0===trigger1?1===trigger2?-1:1:1===trigger1?0===trigger2?-1:0:0===trigger2?1:0})),"function"==typeof this.addDefaultFormats&&this.addDefaultFormats(),this.__cache={},this.init(opts),db&&this.importDB(db),opts.journal&&"function"==typeof NDDB.prototype.journal&&this.journal({filename:opts.journal,load:!0,cb:opts.cb})}function queryError(text,d,op,value){var err;throw"(?)",err=this._getConstrName()+"._analyzeQuery: "+text+". Malformed query: "+d||"(?) "+op||"(?) "+value||"(?).",new Error(err)}function getValuesArray(o){return J.obj2Array(o,1)}function getKeyValuesArray(o){return J.obj2KeyedArray(o,1)}function getValuesArray_KeyString(o,key){var el=J.getNestedValue(key,o);if(void 0!==el)return J.obj2Array(el,1)}function getValuesArray_KeyArray(o,key){var el=J.subobj(o,key);if(!J.isEmpty(el))return J.obj2Array(el,1)}function getKeyValuesArray_KeyString(o,key){var el=J.getNestedValue(key,o);if(void 0!==el)return key.split(".").concat(J.obj2KeyedArray(el))}function getKeyValuesArray_KeyArray(o,key){var el=J.subobj(o,key);if(!J.isEmpty(el))return J.obj2KeyedArray(el)}function nddb_insert(o,doUpdate){var nddbid;return"object"!=typeof o&&"function"!=typeof o&&this.throwErr("TypeError","insert","object or function expected, "+typeof o+" received"),void 0===o._nddbid&&((nddbid=J.uniqueKey(this.nddbid.resolve))||this.throwErr("Error","insert","failed to create index: "+o),df?Object.defineProperty(o,"_nddbid",{value:nddbid}):o._nddbid=nddbid),this.nddbid.resolve[o._nddbid]=this.db.length,!1!==this.emit("insert",o,this.db.length)&&(this.db.push(o),doUpdate&&(this._indexIt(o,this.db.length-1),this._hashIt(o),this._viewIt(o)),!0)}function executeSaveLoad(that,method,file,cb,options){var ff,format;return that.storageAvailable()||that.throwErr("Error","save","no persistent storage available"),void 0===options&&"object"==typeof cb?(options=cb,cb=void 0):void 0===cb&&"function"==typeof options&&(cb=options,options=void 0),function(that,method,file,cb,options){"string"==typeof file&&""!==file.trim()||that.throwErr("TypeError",method,"file must be a non-empty string. Found: "+file),cb&&"function"!=typeof cb&&that.throwErr("TypeError",method,"cb must be function or undefined. Found: "+cb),options&&"object"!=typeof options&&("function"==typeof options&&void 0===cb||that.throwErr("TypeError",method,"options must be object or undefined. Found: "+options))}(that,method,file,cb,options),format=(options=options||{}).format||function(file){var format;return(format=file.lastIndexOf("."))<0?null:file.substr(format+1)}(file),ff=function(that,method,format){var ff,defFormat;format&&(ff=that.getFormat(format));ff&&(ff[method]||that.throwErr("Error",method,"format "+format+" found, but method "+method+" not available"),ff=ff[method]);ff||((defFormat=that.getDefaultFormat())||that.throwErr("Error",method,"format "+format+" not found and no default format specified"),(ff=that.getFormat(defFormat,method))||that.throwErr("Error",method,"format "+format+" not found, but default format has no method "+method));return ff}(that,method,format),that.emit("s"===method.charAt(0)?"save":"load",options,{file:file,format:format,cb:cb}),ff(that,file,cb,options),that}function QueryBuilder(){this.reset()}function findCallback(obj){return obj.cb}function NDDBHashtray(){this.resolve={}}function NDDBIndex(idx,nddb){this.idx=idx,this.nddb=nddb,this.resolve={},this.keys=[],this.resolveKeys={}}NDDB.db=function(opts,db){return new NDDB(opts,db)},NDDB.lineBreak="\n",NDDB.decycle=function(e){return JSON&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},NDDB.retrocycle=function(e){return JSON&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},NDDB.prototype.addFilter=function(op,cb){this.filters[op]=cb,this.__userDefinedFilters[op]=this.filters[op]},NDDB.prototype.addDefaultFilters=function(){var that;function generalLike(d,value,comparator,sensitive){var regex;return RegExp.escape=function(str){return str.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},regex=(regex=RegExp.escape(value)).replace(/%/g,".*").replace(/_/g,"."),regex=new RegExp("^"+regex+"$",sensitive),"object"==typeof d?function(elem){var i,len;for(len=d.length,i=0;i<len;i++)if(void 0!==elem[d[i]]&&regex.test(elem[d[i]]))return elem}:"*"===d?function(elem){var d;for(d in elem)if(void 0!==elem[d]&&regex.test(elem[d]))return elem}:function(elem){if(void 0!==elem[d]&&regex.test(elem[d]))return elem}}that=this,this.filters.E=function(d,value,comparator){return"object"==typeof d?function(elem){var d,c;for(d in elem)if(c=that.getComparator(d),value[d]=value[0]["*"],c(elem,value,1)>0&&(value[d]=value[1]["*"],c(elem,value,-1)<0))return elem;return void 0!==elem[d]||void 0!==J.getNestedValue(d,elem)?elem:void 0}:function(elem){return void 0!==elem[d]||void 0!==J.getNestedValue(d,elem)?elem:void 0}},this.filters["=="]=function(d,value,comparator){return function(elem){if(0===comparator(elem,value,0))return elem}},this.filters["!="]=function(d,value,comparator){return function(elem){if(0!==comparator(elem,value,0))return elem}},this.filters[">"]=function(d,value,comparator){return"object"==typeof d||"*"===d?function(elem){if(1===comparator(elem,value,1))return elem}:function(elem){if(void 0!==elem[d])return 1===comparator(elem,value,1)?elem:void 0}},this.filters[">="]=function(d,value,comparator){return"object"==typeof d||"*"===d?function(elem){var compared=comparator(elem,value,0,1);if(1===compared||0===compared)return elem}:function(elem){if(void 0!==elem[d]){var compared=comparator(elem,value,0,1);return 1===compared||0===compared?elem:void 0}}},this.filters["<"]=function(d,value,comparator){return"object"==typeof d||"*"===d?function(elem){if(-1===comparator(elem,value,-1))return elem}:function(elem){if(void 0!==elem[d])return-1===comparator(elem,value,-1)?elem:void 0}},this.filters["<="]=function(d,value,comparator){return"object"==typeof d||"*"===d?function(elem){var compared=comparator(elem,value,0,-1);if(-1===compared||0===compared)return elem}:function(elem){if(void 0!==elem[d]){var compared=comparator(elem,value,0,-1);return-1===compared||0===compared?elem:void 0}}},this.filters["><"]=function(d,value,comparator){return"object"==typeof d?function(elem){var i,len;for(len=d.length,i=0;i<len;i++)if(comparator(elem,value[0],1)>0&&comparator(elem,value[1],-1)<0)return elem}:"*"===d?function(elem){var d,c;for(d in elem)if(c=that.getComparator(d),value[d]=value[0]["*"],c(elem,value,1)>0&&(value[d]=value[1]["*"],c(elem,value,-1)<0))return elem}:function(elem){if(comparator(elem,value[0],1)>0&&comparator(elem,value[1],-1)<0)return elem}},this.filters["<>"]=function(d,value,comparator){return"object"==typeof d||"*"===d?function(elem){if(comparator(elem,value[0],-1)<0||comparator(elem,value[1],1)>0)return elem}:function(elem){if(void 0!==elem[d])return comparator(elem,value[0],-1)<0||comparator(elem,value[1],1)>0?elem:void 0}},this.filters.in=function(d,value,comparator){return"object"==typeof d?function(elem){var i,len;for(len=value.length,i=0;i<len;i++)if(0===comparator(elem,value[i],0))return elem}:function(elem){var i,obj,len;for(obj={},len=value.length,i=0;i<len;i++)if(obj[d]=value[i],0===comparator(elem,obj,0))return elem}},this.filters["!in"]=function(d,value,comparator){return"object"==typeof d?function(elem){var i,len;for(len=value.length,i=0;i<len;i++)if(0===comparator(elem,value[i],0))return;return elem}:function(elem){var i,obj,len;for(obj={},len=value.length,i=0;i<len;i++)if(obj[d]=value[i],0===comparator(elem,obj,0))return;return elem}},this.filters.LIKE=function(d,value,comparator){return generalLike(d,value)},this.filters.iLIKE=function(d,value,comparator){return generalLike(d,value,0,"i")}},NDDB.prototype.throwErr=function(type,method,err){var errMsg,text;if("object"==typeof err?text=err.stack||err:"string"==typeof err&&(text=err),text=text||"generic error",errMsg=this._getConstrName(),method&&(errMsg=errMsg+"."+method),errMsg=errMsg+": "+text,"TypeError"===type)throw new TypeError(errMsg);throw new Error(errMsg)},NDDB.prototype.init=function(options){var filter,sh,i,errMsg;if(options=options||{},this.__options=options,options.tags&&("object"!=typeof options.tags&&(errMsg="options.tag must be object or undefined",this.throwErr("TypeError","init",errMsg)),this.tags=options.tags),void 0!==options.nddb_pointer&&("number"!=typeof options.nddb_pointer&&(errMsg="options.nddb_pointer must be number or undefined",this.throwErr("TypeError","init",errMsg)),this.nddb_pointer=options.nddb_pointer),options.hooks&&("object"!=typeof options.hooks&&(errMsg="options.hooks must be object or undefined",this.throwErr("TypeError","init",errMsg)),this.hooks=options.hooks),options.globalCompare&&("function"!=typeof options.globalCompare&&(errMsg="options.globalCompare must be function or undefined",this.throwErr("TypeError","init",errMsg)),this.globalCompare=options.globalCompare),options.update&&("object"!=typeof options.update&&(errMsg="options.update must be object or undefined",this.throwErr("TypeError","init",errMsg)),void 0!==options.update.pointer&&(this.__update.pointer=options.update.pointer),void 0!==options.update.indexes&&(this.__update.indexes=options.update.indexes),void 0!==options.update.sort&&(this.__update.sort=options.update.sort)),"object"==typeof options.filters)for(filter in"object"!=typeof options.filters&&(errMsg="options.filters must be object or undefined",this.throwErr("TypeError","init",errMsg)),options.filters)this.addFilter(filter,options.filters[filter]);if("object"==typeof options.shared)for(sh in options.shared)options.shared.hasOwnProperty(sh)&&(this.__shared[sh]=options.shared[sh]);if(delete this.__options.shared,options.log&&this.initLog(options.log,options.logCtx),options.formats)for(i in"object"!=typeof options.formats&&(errMsg="options.formats must be object or undefined",this.throwErr("TypeError","init",errMsg)),options.formats)options.formats.hasOwnProperty(i)&&this.addFormat(i,options.formats[i]);if(options.defaultFormat&&this.setDefaultFormat(options.defaultFormat),options.wd&&"function"==typeof this.setWD&&this.setWD(options.wd),options.C&&("object"!=typeof options.C&&(errMsg="options.C must be object or undefined",this.throwErr("TypeError","init",errMsg)),this.__C=options.C),options.H)for(i in"object"!=typeof options.H&&(errMsg="options.H must be object or undefined",this.throwErr("TypeError","init",errMsg)),options.H)options.H.hasOwnProperty(i)&&this.hash(i,options.H[i]);if(options.I)for(i in"object"!=typeof options.I&&(errMsg="options.I must be object or undefined",this.throwErr("TypeError","init",errMsg)),this.__I=options.I,options.I)options.I.hasOwnProperty(i)&&this.index(i,options.I[i]);if(options.V)for(i in"object"!=typeof options.V&&(errMsg="options.V must be object or undefined",this.throwErr("TypeError","init",errMsg)),this.__V=options.V,options.V)options.V.hasOwnProperty(i)&&this.view(i,options.V[i])},NDDB.prototype.initLog=function(cb,ctx){"function"!=typeof cb&&this.throwErr("TypeError","initLog","cb must be function"),"function"!=typeof(ctx=ctx||this)&&"object"!=typeof ctx&&this.throwErr("TypeError","initLog","ctx must be object or function"),this.log=function(){var args,i,len;for(len=arguments.length,args=new Array(len),i=0;i<len;i++)args[i]=arguments[i];return cb.apply(ctx,args)}},NDDB.prototype._getConstrName=function(){return this.constructor&&this.constructor.name?this.constructor.name:"NDDB"},NDDB.prototype._autoUpdate=function(options){var u;u=this.__update,((options=options||{}).pointer||void 0===options.pointer&&u.pointer)&&(this.nddb_pointer=this.db.length-1),(options.sort||void 0===options.sort&&u.sort)&&this.sort(),(options.indexes||void 0===options.indexes&&u.indexes)&&this.rebuildIndexes()},NDDB.prototype.importDB=function(db){var i,len;for(J.isArray(db)||this.throwErr("TypeError","importDB","db must be array. Found: "+db),i=-1,len=db.length;++i<len;)nddb_insert.call(this,db[i],this.__update.indexes);this._autoUpdate({indexes:!1})},NDDB.prototype.insert=function(o,updateRules){return void 0===updateRules?updateRules=this.__update:"object"!=typeof updateRules&&this.throwErr("TypeError","insert","updateRules must be object or undefined. Found: ",updateRules),!1!==nddb_insert.call(this,o,updateRules.indexes)&&(this._autoUpdate({indexes:!1,pointer:updateRules.pointer,sort:updateRules.sort}),o)},NDDB.prototype.size=function(){return this.db.length},NDDB.prototype.slice=function(start,end){return"number"!=typeof start&&this.throwErr("TypeError","slice","start must be number. Found: "+start),void 0!==end&&"number"!=typeof end&&this.throwErr("TypeError","slice","end must be number or undefined. Found: "+end),this.breed(this.fetch().slice(start,end))},NDDB.prototype.breed=function(db){return db&&!J.isArray(db)&&this.throwErr("TypeError","breed","db must be array or undefined. Found: "+db),new this.constructor(this.cloneSettings(),db||this.fetch())},NDDB.prototype.cloneSettings=function(leaveOut){var i,options,keepShared,logCopy,logCtxCopy;for(i in keepShared=!0,(options=this.__options||{}).H=this.__H,options.I=this.__I,options.C=this.__C,options.V=this.__V,options.tags=this.tags,options.update=this.__update,options.hooks=this.hooks,options.globalCompare=this.globalCompare,options.filters=this.__userDefinedFilters,options.formats=this.__formats,options.defaultFormat=this.__defaultFormat,options.wd=this.__wd,options.log&&(logCopy=options.log,delete options.log),options.logCtx&&(logCtxCopy=options.logCtx,delete options.logCtx),options=J.clone(options),leaveOut)if(leaveOut.hasOwnProperty(i)){if("shared"===i){keepShared=!1;continue}delete options[i]}return keepShared&&(options.shared=this.__shared),logCopy&&(options.log=logCopy,this.__options.log=logCopy),logCtxCopy&&(options.logCtx=logCtxCopy,this.__options.logCtx=logCtxCopy),options},NDDB.prototype.toString=function(){var out,i;for(out="",i=0;i<this.db.length;i++)out+=this.db[i]+"\n";return out},NDDB.prototype.stringify=function(){function stringifyItem(item,lineBreak,spaces,comma,decycle){var res;return decycle&&(item=NDDB.decycle(item)),res=J.stringify(item,spaces),comma&&(res+=", "),lineBreak&&(res+=lineBreak),res}return function(opts){var db,i,len,out,spaces,lineBreak,decycle;if(opts=opts||{},!this.size())return opts.enclose?"[]":"";for(decycle=!1!==opts.decycle,lineBreak=opts.lineBreak||NDDB.lineBreak,spaces=opts.pretty?4:0,out=opts.enclose?"["+lineBreak:"",i=-1,len=(db=this.fetch()).length-1;++i<len;)out+=stringifyItem(db[i],lineBreak,spaces,opts.comma,decycle);return out+=stringifyItem(db[i],lineBreak,spaces,!1,decycle),opts.enclose&&(out+="]"),out}}(),NDDB.prototype.comparator=function(d,comparator){"string"!=typeof d&&this.throwErr("TypeError","comparator","d must be string"),"function"!=typeof comparator&&this.throwErr("TypeError","comparator","comparator must be function"),this.__C[d]=comparator},NDDB.prototype.getComparator=function(d){var i,len,comparator,comparators;if("string"==typeof d)comparator=void 0!==this.__C[d]?this.__C[d]:function(o1,o2){var v1,v2;return void 0===o1&&void 0===o2?0:void 0===o1?1:void 0===o2?-1:(void 0!==o1[d]?v1=o1[d]:-1!==d.lastIndexOf(".")&&(v1=J.getNestedValue(d,o1)),void 0!==o2[d]?v2=o2[d]:-1!==d.lastIndexOf(".")&&(v2=J.getNestedValue(d,o2)),void 0===v1&&void 0===v2?0:void 0===v1?1:void 0===v2?-1:v1>v2?1:v2>v1?-1:v2===v1?0:1)};else{for(comparators={},len=d.length,i=0;i<len;i++)comparators[d[i]]=this.getComparator(d[i]);comparator=function(o1,o2,trigger1,trigger2){var i,res,obj;for(i in comparators)if(comparators.hasOwnProperty(i)){if(void 0===o1[i])continue;if((obj={})[i]=o2,(res=comparators[i](o1,obj))===trigger1)return res;if("undefined"!==trigger2&&res===trigger2)return res}return 0===trigger1?1===trigger2?-1:1:1===trigger1?0===trigger2?-1:0:0===trigger2?1:0}}return comparator},NDDB.prototype.isReservedWord=function(key){return!!this[key]},NDDB.prototype.index=function(idx,func){"string"!=typeof idx&&"number"!=typeof idx&&this.throwErr("TypeError","index","idx must be string or number"),this.isReservedWord(idx)&&this.throwErr("TypeError","index","idx is reserved word: "+idx),void 0===func?func=function(item){return item[idx]}:"function"!=typeof func&&this.throwErr("TypeError","index","func must be function or undefined. Found: "+func),this.__I[idx]=func,this[idx]=new NDDBIndex(idx,this)},NDDB.prototype.view=function(idx,func){var settings;return"string"!=typeof idx&&"number"!=typeof idx&&this.throwErr("TypeError","view","idx must be string or number"),this.isReservedWord(idx)&&this.throwErr("TypeError","view","idx is reserved word: "+idx),void 0===func?func=function(item){return item[idx]}:"function"!=typeof func&&this.throwErr("TypeError","view","func must be function or undefined. Found: "+func),this.__V[idx]=func,(settings=this.cloneSettings({V:!0,hooks:!0})).name=idx,this[idx]=new NDDB(settings),this[idx].__parentDb=this,this[idx]},NDDB.prototype.hash=function(idx,func){"string"!=typeof idx&&"number"!=typeof idx&&this.throwErr("TypeError","hash","idx must be string or number"),this.isReservedWord(idx)&&this.throwErr("TypeError","hash","idx is reserved word: "+idx),void 0===func?func=function(item){return item[idx]}:"function"!=typeof func&&this.throwErr("TypeError","hash","func must be function or undefined. Found: "+func),this[idx]={},this.__H[idx]=func},NDDB.prototype.resetIndexes=function(options){var key,reset;if((reset=options||J.merge({h:!0,v:!0,i:!0},options)).h)for(key in this.__H)this.__H.hasOwnProperty(key)&&(this[key]={});if(reset.v)for(key in this.__V)this.__V.hasOwnProperty(key)&&(this[key]=new this.constructor);if(reset.i)for(key in this.__I)this.__I.hasOwnProperty(key)&&(this[key]=new NDDBIndex(key,this))},NDDB.prototype.rebuildIndexes=function(){var h,i,v,cb,idx;if(h=!J.isEmpty(this.__H),i=!J.isEmpty(this.__I),v=!J.isEmpty(this.__V),h||i||v)for(cb=!h||i||v?h||!i||v?h||i||!v?h&&i&&!v?function(o,idx){this._hashIt(o),this._indexIt(o,idx)}:!h&&i&&v?function(o,idx){this._indexIt(o,idx),this._viewIt(o)}:h&&!i&&v?function(o){this._hashIt(o),this._viewIt(o)}:function(o,idx){this._indexIt(o,idx),this._hashIt(o),this._viewIt(o)}:this._viewIt:this._indexIt:this._hashIt,this.resetIndexes({h:h,v:v,i:i}),idx=0;idx<this.db.length;idx++)cb.call(this,this.db[idx],idx)},NDDB.prototype._indexIt=function(o,dbidx,oldIdx){var index,key;if(o&&!J.isEmpty(this.__I))for(key in this.__I)this.__I.hasOwnProperty(key)&&((index=(0,this.__I[key])(o))!==oldIdx&&void 0!==oldIdx&&void 0!==this[key].resolve[oldIdx]&&this[key]._remove(oldIdx),void 0!==index&&(this[key]||(this[key]=new NDDBIndex(key,this)),this[key]._add(index,dbidx)))},NDDB.prototype._viewIt=function(o){var key,settings;if(!o||J.isEmpty(this.__V))return!1;for(key in this.__V)if(this.__V.hasOwnProperty(key)){if(void 0===(0,this.__V[key])(o)){if(!this[key])continue;void 0!==this[key].nddbid.resolve[o._nddbid]&&this[key].nddbid.remove(o._nddbid);continue}this[key]||((settings=this.cloneSettings({V:!0,hooks:!0})).name=key,this[key]=new NDDB(settings),this[key].__parentDb=this),this[key].insert(o)}},NDDB.prototype._hashIt=function(o){var hash,key,settings,oldHash;if(!o||J.isEmpty(this.__H))return!1;for(key in this.__H)if(this.__H.hasOwnProperty(key)){if(void 0===(hash=(0,this.__H[key])(o))){(oldHash=this.hashtray.get(key,o._nddbid))&&(this[key][oldHash].nddbid.remove(o._nddbid),this.hashtray.remove(key,o._nddbid));continue}this[key]||(this[key]={}),this[key][hash]||((settings=this.cloneSettings({H:!0,hooks:!0})).name=hash,this[key][hash]=new NDDB(settings),this[key][hash].__parentDb=this),this[key][hash].insert(o),this.hashtray.set(key,o._nddbid,hash)}},NDDB.prototype.on=function(event,func,shared){"string"!=typeof event&&this.throwErr("TypeError","on","event must be string. Found: "+event),"function"!=typeof func&&this.throwErr("TypeError","on","func must be function. Found: "+func),this.hooks[event]||this.throwErr("TypeError","on","unknown event: "+event),this.hooks[event].push(func),shared&&this.sharedHooks[event].push(func)},NDDB.prototype.off=function(event,func){var i;if("string"!=typeof event&&this.throwErr("TypeError","off","event must be string"),func&&"function"!=typeof func&&this.throwErr("TypeError","off","func must be function or undefined"),this.hooks[event]||this.throwErr("TypeError","off","unknown event: "+event),!this.hooks[event].length)return!1;if(!func)return this.hooks[event]=[],this.sharedHooks[event]=[],!0;for(i=0;i<this.hooks[event].length;i++)if(this.sharedHooks[event][i]==func&&this.sharedHooks[event].splice(i,1),this.hooks[event][i]==func)return this.hooks[event].splice(i,1),!0;return!1},NDDB.prototype.emit=function(){var event,hooks,h,h2,i,len,argLen,args,res;if("string"!=typeof(event=arguments[0])&&this.throwErr("TypeError","emit","first argument must be string"),(hooks=this.hooks[event])||this.throwErr("TypeError","emit","unknown event: "+event),this.__parentDb&&(hooks=hooks.length?hooks.concat(this.__parentDb.sharedHooks[event]):this.__parentDb.sharedHooks[event]),!(len=hooks.length))return!0;switch(argLen=arguments.length,len){case 1:if(h=hooks[0],1===argLen)res=h.call(this);else if(2===argLen)res=h.call(this,arguments[1]);else if(3===argLen)res=h.call(this,arguments[1],arguments[2]);else{for(args=new Array(argLen-1),i=0;i<argLen;i++)args[i]=arguments[i+1];res=h.apply(this,args)}break;case 2:if(h=hooks[0],h2=hooks[1],1===argLen)res=(res=!1!==h.call(this))&&!1!==h2.call(this);else if(2===argLen)res=(res=!1!==h.call(this,arguments[1]))&&!1!==h2.call(this,arguments[1]);else if(3===argLen)res=(res=!1!==h.call(this,arguments[1],arguments[2]))&&!1!==h2.call(this,arguments[1],arguments[2]);else{for(args=new Array(argLen-1),i=0;i<argLen;i++)args[i]=arguments[i+1];res=(res=!1!==h.apply(this,args))&&!1!==h2.apply(this,args)}break;default:if(1===argLen)for(i=0;i<len&&!1!==(res=!1!==hooks[i].call(this));i++);else if(2===argLen)for(res=!0,i=0;i<len&&!1!==(res=!1!==hooks[i].call(this,arguments[1]));i++);else if(3===argLen)for(res=!0,i=0;i<len&&!1!==(res=!1!==hooks[i].call(this,arguments[1],arguments[2]));i++);else{for(args=new Array(argLen-1),i=0;i<argLen;i++)args[i]=arguments[i+1];for(res=!0,i=0;i<len&&!1!==(res=!1!==hooks[i].apply(this,args));i++);}}return res},NDDB.prototype._analyzeQuery=function(d,op,value){var i,len,errText;if(void 0===d&&queryError.call(this,"undefined dimension",d,op,value),void 0!==op){if("="===op?op="==":"!=="===op&&(op="!="),op in this.filters||queryError.call(this,"unknown operator "+op,d,op,value),J.inArray(op,["><","<>","in","!in"]))value instanceof Array||(errText="range-queries need an array as third parameter",queryError.call(this,errText,d,op,value)),"<>"!==op&&"><"!==op||J.isArray(d)||(value[0]=J.setNestedValue(d,value[0]),value[1]=J.setNestedValue(d,value[1]));else if(J.inArray(op,["!=",">","==",">=","<","<="]))if(void 0===value&&(errText="value cannot be undefined in comparison queries",queryError.call(this,errText,d,op,value)),J.isArray(d))for(len=d.length,i=0;i<len;i++)J.setNestedValue(d[i],value);else value=J.setNestedValue(d,value)}else void 0!==value?(errText="undefined filter and defined value",queryError.call(this,errText,d,op,value)):(op="E",value="");return{d:d,op:op,value:value}},NDDB.prototype.distinct=function(){return this.breed(J.distinct(this.db))},NDDB.prototype.select=function(d,op,value){return this.query.reset(),arguments.length?this.and(d,op,value):this},NDDB.prototype.and=function(d,op,value){var q,cb;return q=this._analyzeQuery(d,op,value),cb=this.filters[q.op](q.d,q.value,this.getComparator(q.d)),this.query.addCondition("AND",cb),this},NDDB.prototype.or=function(d,op,value){var q,cb;return q=this._analyzeQuery(d,op,value),cb=this.filters[q.op](q.d,q.value,this.getComparator(q.d)),this.query.addCondition("OR",cb),this},NDDB.prototype.selexec=function(d,op,value){return this.select(d,op,value).execute()},NDDB.prototype.execute=function(){return this.filter(this.query.get.call(this.query))},NDDB.prototype.exists=function(o){var i,len,db;for("object"!=typeof o&&"function"!=typeof o&&this.throwErr("TypeError","exists","o must be object or function"),len=(db=this.fetch()).length,i=0;i<len;i++)if(J.equals(db[i],o))return!0;return!1},NDDB.prototype.limit=function(limit){var db;return"number"!=typeof limit&&this.throwErr("TypeError","exists","limit must be number"),db=this.fetch(),0!==limit&&(db=limit>0?db.slice(0,limit):db.slice(limit)),this.breed(db)},NDDB.prototype.reverse=function(){return this.db.reverse(),this},NDDB.prototype.sort=function(d){var func,that;return d?"function"==typeof d?func=d:d instanceof Array?(that=this,func=function(a,b){var i,result;for(i=0;i<d.length;i++)if(0!==(result=that.getComparator(d[i]).call(that,a,b)))return result;return result}):func=this.getComparator(d):func=this.globalCompare,this.db.sort(func),this},NDDB.prototype.shuffle=function(update){var shuffled;return shuffled=J.shuffle(this.db),update&&(this.db=shuffled,this.rebuildIndexes()),this.breed(shuffled)},NDDB.prototype.random=function(N,strict){var i,len,used,out,idx;if("number"!=typeof N&&this.throwErr("TypeError","random","N must be number Found: "+N),N<1&&this.throwErr("Error","random","N must be > 0. Found: "+N),N>(len=this.db.length)&&!1!==strict&&this.throwErr("Error","random","not enough items in db. Found: "+len+". Requested: "+N),N<len/3)for(i=0,out=new Array(N),used={};i<N;)void 0===used[idx=J.randomInt(0,len)-1]&&(used[idx]=!0,out[i]=this.db[idx],i++);else out=(out=J.shuffle(this.db)).slice(0,N);return this.breed(out)},NDDB.prototype.table=function(idx){var res,db,i,v;for(db=this.fetch(),res={},i=0;i<db.length;i++)void 0!==(v=db[i][idx])&&(void 0===res[v]?res[v]=1:res[v]++);return res},NDDB.prototype.filter=function(func){return this.breed(this.fetch().filter(func))},NDDB.prototype.each=NDDB.prototype.forEach=function(){var func,i,db,len,args,argLen;switch("function"!=typeof(func=arguments[0])&&this.throwErr("TypeError","each","first argument must be function"),len=(db=this.fetch()).length,argLen=arguments.length){case 1:for(i=0;i<len;i++)func.call(this,db[i]);break;case 2:for(i=0;i<len;i++)func.call(this,db[i],arguments[1]);break;case 3:for(i=0;i<len;i++)func.call(this,db[i],arguments[1],arguments[2]);break;default:for((args=new Array(argLen+1))[0]=null,i=1;i<argLen;i++)args[i]=arguments[i];for(i=0;i<len;i++)args[0]=db[i],func.apply(this,args)}},NDDB.prototype.map=function(){var func,i,db,len,out,o,args,argLen;switch("function"!=typeof(func=arguments[0])&&this.throwErr("TypeError","map","first argument must be function"),len=(db=this.fetch()).length,out=[],argLen=arguments.length){case 1:for(i=0;i<len;i++)void 0!==(o=func.call(this,db[i]))&&out.push(o);break;case 2:for(i=0;i<len;i++)void 0!==(o=func.call(this,db[i],arguments[1]))&&out.push(o);break;case 3:for(i=0;i<len;i++)void 0!==(o=func.call(this,db[i],arguments[1],arguments[2]))&&out.push(o);break;default:for((args=new Array(argLen+1))[0]=null,i=1;i<argLen;i++)args[i]=arguments[i];for(i=0;i<len;i++)args[0]=db[i],void 0!==(o=func.apply(this,args))&&out.push(o)}return out},NDDB.prototype.update=function(update,updateRules){var i,len,db;if("object"!=typeof update&&this.throwErr("TypeError","update","update must be object. Found: ",update),void 0===updateRules?updateRules=this.__update:"object"!=typeof updateRules&&this.throwErr("TypeError","update","updateRules must be object or undefined. Found: ",updateRules),len=(db=this.fetch()).length){for(i=0;i<len;i++)!0===this.emit("update",db[i],update,i)&&(J.mixin(db[i],update),updateRules.indexes&&(this._indexIt(db[i]),this._hashIt(db[i]),this._viewIt(db[i])));this._autoUpdate({indexes:!1,pointer:updateRules.pointer,sort:updateRules.sort})}return this},NDDB.prototype.removeAllEntries=function(){return console.log("***NDDB.removeAllEntries is deprecated. Use NDDB.clear instead***"),this.db.length?(this.emit("remove",this.db),this.nddbid.resolve={},this.db=[],this._autoUpdate(),this):this},NDDB.prototype.clear=function(){var i;for(i in this.db=[],this.nddbid.resolve={},this.tags={},this.query.reset(),this.nddb_pointer=0,this.lastSelection=[],this.hashtray.clear(),this.__H)this[i]&&(this[i]=null);for(i in this.__C)this[i]&&(this[i]=null);for(i in this.__I)this[i]&&(this[i]=null)},NDDB.prototype.join=function(key1,key2,pos,select){return this._join(key1,key2,J.equals,pos,select)},NDDB.prototype.concat=function(key1,key2,pos,select){return this._join(key1,key2,(function(){return!0}),pos,select)},NDDB.prototype._join=function(key1,key2,comparator,pos,select){var out,foreign_key,key,i,j,o,o2;if(!key1||!key2)return this.breed([]);for(comparator=comparator||J.equals,pos=void 0!==pos?pos:"joined",select&&(select=select instanceof Array?select:[select]),out=[],i=0;i<this.db.length;i++)if(void 0!==(foreign_key=J.getNestedValue(key1,this.db[i])))for(j=i+1;j<this.db.length;j++)void 0!==(key=J.getNestedValue(key2,this.db[j]))&&comparator(foreign_key,key)&&(o=J.clone(this.db[i]),o2=select?J.subobj(this.db[j],select):this.db[j],o[pos]=o2,out.push(o));return this.breed(out)},NDDB.prototype.split=function(key,level,positionAsKey){var out,i,db,len;for("string"!=typeof key&&this.throwErr("TypeError","split","key must be string"),len=(db=this.fetch()).length,out=[],i=0;i<len;i++)out=out.concat(J.split(db[i],key,level,positionAsKey));return this.breed(out)},NDDB.prototype.fetch=function(doNotReset){var db;return this.db.length&&this.query.query.length?(doNotReset&&"boolean"!=typeof doNotReset&&this.throwErr("TypeError","fetch","doNotReset must be undefined or boolean"),db=this.db.filter(this.query.get.call(this.query)),doNotReset||this.query.reset()):db=this.db,this.lastSelection=db,db},NDDB.prototype.fetchSubObj=function(key){var i,el,db,out;if(!key)return[];for(db=this.fetch(),out=[],i=0;i<db.length;i++)el=J.subobj(db[i],key),J.isEmpty(el)||out.push(el);return out},NDDB.prototype.fetchValues=function(key){var db,el,i,out,typeofkey;if(db=this.fetch(),out={},"undefined"===(typeofkey=typeof key))for(i=0;i<db.length;i++)J.augment(out,db[i],J.keys(db[i]));else if("string"===typeofkey)for(out[key]=[],i=0;i<db.length;i++)void 0!==(el=J.getNestedValue(key,db[i]))&&out[key].push(el);else if(J.isArray(key))for(out=J.melt(key,J.rep([],key.length)),i=0;i<db.length;i++)el=J.subobj(db[i],key),J.isEmpty(el)||J.augment(out,el);return out},NDDB.prototype._fetchArray=function(key,keyed){var db,cb,out,el,i;for(cb=keyed?key?"string"==typeof key?getKeyValuesArray_KeyString:getKeyValuesArray_KeyArray:getKeyValuesArray:key?"string"==typeof key?getValuesArray_KeyString:getValuesArray_KeyArray:getValuesArray,db=this.fetch(),out=[],i=0;i<db.length;i++)void 0!==(el=cb.call(db[i],db[i],key))&&out.push(el);return out},NDDB.prototype.fetchArray=function(key){return this._fetchArray(key)},NDDB.prototype.fetchKeyArray=function(key){return this._fetchArray(key,!0)},NDDB.prototype.groupBy=function(key){var groups,outs,i,el,out,db;if(db=this.fetch(),!key)return db;for(groups=[],outs=[],i=0;i<db.length;i++)void 0!==(el=J.getNestedValue(key,db[i]))&&(J.inArray(el,groups)||(groups.push(el),(out=this.filter((function(elem){if(J.equals(J.getNestedValue(key,elem),el))return elem}))).nddb_pointer=0,outs.push(out)));return outs},NDDB.prototype.count=function(key){var i,count,len,db;if(len=(db=this.fetch()).length,void 0===key)return len;for("string"!=typeof key&&this.throwErr("TypeError","count","key must be string or undefined"),count=0,i=0;i<len;i++)J.hasOwnNestedProperty(key,db[i])&&count++;return count},NDDB.prototype.sum=function(key){var sum,i,len,tmp,db;for("string"!=typeof key&&this.throwErr("TypeError","sum","key must be string"),len=(db=this.fetch()).length,sum=NaN,i=0;i<len;i++)tmp=J.getNestedValue(key,db[i]),isNaN(tmp)||(isNaN(sum)&&(sum=0),sum+=tmp);return sum},NDDB.prototype.mean=function(key){var sum,count,tmp,db,i,len;for("string"!=typeof key&&this.throwErr("TypeError","mean","key must be string"),len=(db=this.fetch()).length,sum=0,count=0,i=0;i<len;i++)tmp=J.getNestedValue(key,db[i]),isNaN(tmp)||(sum+=tmp,count++);return 0===count?NaN:sum/count},NDDB.prototype.stddev=function(key){var count,tmp,db,i,len,sum,sumSquared;if("string"!=typeof key&&this.throwErr("TypeError","stddev","key must be string"),!(len=(db=this.fetch()).length)||1===len)return NaN;for(i=-1,sum=0,sumSquared=0,count=0;++i<len;)tmp=J.getNestedValue(key,db[i]),isNaN(tmp)||(count++,sum+=tmp,sumSquared+=Math.pow(tmp,2));return tmp=sumSquared-Math.pow(sum,2)/count,Math.sqrt(tmp/(count-1))},NDDB.prototype.min=function(key){var min,tmp,db,i,len;for("string"!=typeof key&&this.throwErr("TypeError","min","key must be string"),len=(db=this.fetch()).length,min=NaN,i=0;i<len;i++)tmp=J.getNestedValue(key,db[i]),!isNaN(tmp)&&(tmp<min||isNaN(min))&&(min=tmp);return min},NDDB.prototype.max=function(key){var max,i,len,tmp,db;for("string"!=typeof key&&this.throwErr("TypeError","max","key must be string"),len=(db=this.fetch()).length,max=NaN,i=0;i<len;i++)tmp=J.getNestedValue(key,db[i]),!isNaN(tmp)&&(tmp>max||isNaN(max))&&(max=tmp);return max},NDDB.prototype.skim=function(skim){return"string"==typeof skim||J.isArray(skim)||this.throwErr("TypeError","skim","skim must be string or array"),this.breed(this.map((function(e){var skimmed=J.skim(e,skim);if(!J.isEmpty(skimmed))return skimmed})))},NDDB.prototype.keep=function(keep){return"string"==typeof keep||J.isArray(keep)||this.throwErr("TypeError","keep","keep must be string or array"),this.breed(this.map((function(e){var subobj=J.subobj(e,keep);if(!J.isEmpty(subobj))return subobj})))},NDDB.prototype.diff=function(nddb){return J.isArray(nddb)||("object"==typeof nddb&&J.isArray(nddb.db)||this.throwErr("TypeError","diff","nddb must be array or NDDB"),nddb=nddb.db),nddb.length?this.breed(J.arrayDiff(this.fetch(),nddb)):this.breed([])},NDDB.prototype.intersect=function(nddb){return J.isArray(nddb)||("object"==typeof nddb&&J.isArray(nddb.db)||this.throwErr("TypeError","intersect","nddb must be array or NDDB"),nddb=nddb.db),nddb.length?this.breed(J.arrayIntersect(this.fetch(),nddb)):this.breed([])},NDDB.prototype.get=function(pos){return"number"!=typeof pos&&this.throwErr("TypeError","get","pos must be number"),this.db[pos]},NDDB.prototype.current=function(){return this.db[this.nddb_pointer]},NDDB.prototype.next=function(){var el;return this.nddb_pointer++,(el=NDDB.prototype.current.call(this))||this.nddb_pointer--,el},NDDB.prototype.previous=function(){var el;return this.nddb_pointer--,(el=NDDB.prototype.current.call(this))||this.nddb_pointer++,el},NDDB.prototype.first=function(doNotUpdatePointer){var db=this.fetch();if(db.length)return doNotUpdatePointer||(this.nddb_pointer=0),db[0]},NDDB.prototype.last=function(doNotUpdatePointer){var db=this.fetch();if(db.length)return doNotUpdatePointer||(this.nddb_pointer=db.length-1),db[db.length-1]},NDDB.prototype.tag=function(tag,idx){var ref,typeofIdx;return"string"!=typeof tag&&"number"!=typeof tag&&this.throwErr("TypeError","tag","tag must be string or number"),ref=null,"undefined"===(typeofIdx=typeof idx)?ref=this.db[this.db.length-1]:"number"===typeofIdx?((idx>this.length||idx<0)&&this.throwErr("Error","tag","invalid index provided: "+idx),ref=this.db[idx]):ref=idx,this.tags[tag]=ref,ref},NDDB.prototype.resolveTag=function(tag){return"string"!=typeof tag&&this.throwErr("TypeError","resolveTag","tag must be string"),this.tags[tag]},NDDB.prototype.load=function(file,opts,cb){return executeSaveLoad(this,"load",file,cb,opts)},NDDB.prototype.save=function(file,opts,cb){return executeSaveLoad(this,"save",file,cb,opts)},NDDB.prototype.loadSync=function(file,opts,cb){return executeSaveLoad(this,"loadSync",file,cb,opts)},NDDB.prototype.saveSync=function(file,opts,cb){return executeSaveLoad(this,"saveSync",file,cb,opts)},NDDB.prototype.addFormat=function(format,obj){var f,i,len;for(!function(that,format,obj){"string"==typeof format||J.isArray(format)||format.length||that.throwErr("TypeError","addFormat","format must be a non-empty string or array");"object"!=typeof obj&&that.throwErr("TypeError","addFormat","obj must be object");obj.save||obj.saveSync||that.throwErr("Error","addFormat","format must at least one save function: sync or async");obj.load||obj.loadSync||that.throwErr("Error","addFormat","format must at least one load function: sync or async");(obj.save||obj.load)&&("function"!=typeof obj.save&&that.throwErr("TypeError","addFormat","save function is not a function"),"function"!=typeof obj.load&&that.throwErr("TypeError","addFormat","load function is not a function"));(obj.saveSync||obj.loadSync)&&("function"!=typeof obj.saveSync&&that.throwErr("TypeError","addFormat","saveSync function is not a function"),"function"!=typeof obj.loadSync&&that.throwErr("TypeError","addFormat","loadSync function is not a function"))}(this,format,obj),J.isArray(format)||(format=[format]),i=-1,len=format.length;++i<len;)"string"==typeof(f=format[i])&&""!==f.trim()||this.throwErr("TypeError","addFormat","format must be a non-empty string"),this.__formats[f]=obj},NDDB.prototype.getFormat=function(format,method){var f;return(f=this.__formats[format])&&method&&(f=f[method]),f||null},NDDB.prototype.setDefaultFormat=function(format){null===format||"string"==typeof format&&""!==format.trim()||this.throwErr("TypeError","setDefaultFormat","format must be a non-empty string or null"),format&&!this.__formats[format]&&this.throwErr("Error","setDefaultFormat","unknown format: "+format),this.__defaultFormat=format},NDDB.prototype.getDefaultFormat=function(){return this.__defaultFormat},NDDB.prototype.addDefaultFormats=null,QueryBuilder.prototype.addCondition=function(type,filter){this.query[this.pointer].push({type:type,cb:filter})},QueryBuilder.prototype.addBreak=function(){this.pointer++,this.query[this.pointer]=[]},QueryBuilder.prototype.reset=function(){this.query=[],this.pointer=0,this.query[this.pointer]=[]},QueryBuilder.prototype.get=function(){var line,lineLen,f1,f2,f3,query=this.query,pointer=this.pointer;if(0===pointer){if(line=query[pointer],1===(lineLen=line.length))return findCallback(line[0]);if(2===lineLen)switch(f1=findCallback(line[0]),f2=findCallback(line[1]),line[1].type){case"OR":return function(elem){return void 0!==f1(elem)||void 0!==f2(elem)?elem:void 0};case"AND":return function(elem){if(void 0!==f1(elem)&&void 0!==f2(elem))return elem};case"NOT":return function(elem){if(void 0!==f1(elem)&&void 0===f2(elem))return elem}}else{if(3!==lineLen)return function(elem){var i,f,type,resOK,prevType="OR",prevResOK=!0;for(i=lineLen-1;i>-1;i--){if(f=findCallback(line[i]),type=line[i].type,resOK=void 0!==f(elem),"OR"===type){if(resOK)return elem}else if("AND"===type){if(!resOK)return;if("OR"===prevType&&!prevResOK)return}prevType=type,prevResOK="AND"===type?resOK:resOK||prevResOK}return elem};switch(f1=findCallback(line[0]),f2=findCallback(line[1]),f3=findCallback(line[2]),line[1].type+"_"+line[2].type){case"OR_OR":return function(elem){return void 0!==f1(elem)||void 0!==f2(elem)||void 0!==f3(elem)?elem:void 0};case"OR_AND":return function(elem){if(void 0!==f3(elem))return void 0!==f2(elem)||void 0!==f1(elem)?elem:void 0};case"AND_OR":return function(elem){return void 0!==f3(elem)||void 0!==f2(elem)&&void 0!==f1(elem)?elem:void 0};case"AND_AND":return function(elem){if(void 0!==f3(elem)&&void 0!==f2(elem))return void 0!==f1(elem)?elem:void 0}}}}},NDDBHashtray.prototype.set=function(key,nddbid,hash){this.resolve[key+"_"+nddbid]=hash},NDDBHashtray.prototype.get=function(key,nddbid){return this.resolve[key+"_"+nddbid]},NDDBHashtray.prototype.remove=function(key,nddbid){delete this.resolve[key+"_"+nddbid]},NDDBHashtray.prototype.clear=function(){this.resolve={}},NDDBIndex.prototype._add=function(idx,dbidx){this.resolve[idx]=dbidx,void 0===this.resolveKeys[idx]&&(this.resolveKeys[idx]=this.keys.length,this.keys.push(""+idx))},NDDBIndex.prototype._remove=function(idx){delete this.resolve[idx],this.keys.splice(this.resolveKeys[idx],1),delete this.resolveKeys[idx]},NDDBIndex.prototype.size=function(){return this.keys.length},NDDBIndex.prototype.get=function(idx){return void 0!==this.resolve[idx]&&this.nddb.db[this.resolve[idx]]},NDDBIndex.prototype.remove=function(idx){var o,dbidx;return void 0!==(dbidx=this.resolve[idx])&&(void 0!==(o=this.nddb.db[dbidx])&&(!1!==this.nddb.emit("remove",o,dbidx)&&(this.nddb.db.splice(dbidx,1),this._remove(idx),this.nddb._autoUpdate(),o)))},NDDBIndex.prototype.pop=NDDBIndex.prototype.remove,NDDBIndex.prototype.update=function(idx,update){var o,dbidx,nddb;return void 0!==update&&(void 0!==(dbidx=this.resolve[idx])&&(o=(nddb=this.nddb).db[dbidx],!1!==nddb.emit("update",o,update,dbidx)&&(J.mixin(o,update),nddb.__update.indexes&&(nddb._indexIt(o,dbidx,idx),nddb._hashIt(o),nddb._viewIt(o)),nddb._autoUpdate({indexes:!1}),o)))},NDDBIndex.prototype.getAllKeys=function(){return this.keys.slice(0)},NDDBIndex.prototype.getAllKeyElements=function(){var out,idx,i,len;for(out={},i=-1,len=this.keys.length;++i<len;)out[idx=this.keys[i]]=this.nddb.db[this.resolve[idx]];return out}}(),function(window){if(void 0!==window.node)throw new Error("nodegame-client: a global node variable is already defined. Aborting...");var node=window.node={};"undefined"!=typeof JSUS&&(node.JSUS=JSUS),"undefined"!=typeof NDDB&&(node.NDDB=NDDB),"undefined"!=typeof store&&(node.store=store),node.support=JSUS.compatibility(),node.version="7.1.0"}(window),function(node){"use strict";var k;(k=node.constants={}).nodename="ng",k.verbosity_levels={ALWAYS:-Number.MAX_VALUE,error:-1,warn:0,info:1,silly:10,debug:100,NEVER:Number.MAX_VALUE},k.action={},k.action.SET="set",k.action.GET="get",k.action.SAY="say",k.target={},k.target.DATA="DATA",k.target.HI="HI",k.target.PCONNECT="PCONNECT",k.target.PDISCONNECT="PDISCONNECT",k.target.PRECONNECT="PRECONNECT",k.target.MCONNECT="MCONNECT",k.target.MDISCONNECT="MDISCONNECT",k.target.MRECONNECT="MRECONNECT",k.target.PLIST="PLIST",k.target.MLIST="MLIST",k.target.PLAYER_UPDATE="PLAYER_UPDATE",k.target.REDIRECT="REDIRECT",k.target.LANG="LANG",k.target.SETUP="SETUP",k.target.GAMECOMMAND="GAMECOMMAND",k.target.SERVERCOMMAND="SERVERCOMMAND",k.target.ALERT="ALERT",k.target.LOG="LOG",k.target.BYE="BYE",k.target.JOIN="JOIN",k.target.TXT="TXT",k.target.ACK="ACK",k.target.WARN="WARN",k.target.ERR="ERR",k.gamecommands={start:"start",pause:"pause",resume:"resume",stop:"stop",restart:"restart",step:"step",push_step:"push_step",goto_step:"goto_step",clear_buffer:"clear_buffer",erase_buffer:"erase_buffer"},k.IN="in.",k.OUT="out.",k.stateLevels={UNINITIALIZED:0,STARTING:1,INITIALIZING:2,INITIALIZED:5,STAGE_INIT:10,STEP_INIT:20,PLAYING_STEP:30,STAGE_EXIT:50,STEP_EXIT:60,FINISHING:70,GAMEOVER:100,RUNTIME_ERROR:-1},k.stageLevels={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:5,LOADING_FRAME:20,FRAME_LOADED:25,EXECUTING_CALLBACK:30,CALLBACK_EXECUTED:40,LOADED:45,PLAYING:50,PAUSING:55,PAUSED:60,RESUMING:65,RESUMED:70,DONE_CALLED:80,GETTING_DONE:90,DONE:100,EXITING:110},k.windowLevels={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:5,LOADING:30,LOADED:40},k.screenLevels={ACTIVE:1,UNLOCKING:-1,LOCKING:-2,LOCKED:-3},k.UNDEFINED_PLAYER=-1,k.UNAUTH_PLAYER="unautorized_player",k.publishLevels={ALL:4,MOST:3,REGULAR:2,FEW:1,NONE:0}}("undefined"!=typeof node?node:module.exports),function(exports,parent){"use strict";exports.stepRules={};var node=parent;exports.stepRules.SOLO=function(stage,myStageLevel,pl,game){return myStageLevel===node.constants.stageLevels.DONE},exports.stepRules.SOLO_STEP=function(stage,myStageLevel,pl,game){return 1!==game.plot.stepsToNextStage(stage,!0)&&myStageLevel===node.constants.stageLevels.DONE},exports.stepRules.WAIT=function(stage,myStageLevel,pl,game){return!1},exports.stepRules.SYNC_STEP=function(stage,myStageLevel,pl,game){return myStageLevel===node.constants.stageLevels.DONE&&pl.isStepDone(stage)},exports.stepRules.SYNC_STAGE=function(stage,myStageLevel,pl,game){var iamdone;return iamdone=myStageLevel===node.constants.stageLevels.DONE,game.plot.stepsToNextStage(stage)>1?iamdone:iamdone&&pl.isStepDone(stage,"STAGE_UPTO")},exports.stepRules.OTHERS_SYNC_STEP=function(stage,myStageLevel,pl){return!!pl.size()&&(stage=pl.first().stage,pl.arePlayersSync(stage,node.constants.stageLevels.DONE,"EXACT"))},exports.stepRules.OTHERS_SYNC_STAGE=function(stage,myStageLevel,pl,game){var nSteps;return!!pl.size()&&(stage=pl.first().stage,1!==(nSteps=game.plot.stepsToNextStage(stage))&&(stage={stage:stage.stage,step:stage.step+(nSteps-1),round:stage.round}),pl.arePlayersSync(stage,node.constants.stageLevels.DONE,"EXACT",!0))}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var J=parent.JSUS;function ErrorManager(node){this.lastError=null,this.init(node)}parent.ErrorManager=ErrorManager,ErrorManager.prototype.init=function(node){var that;that=this,J.isNodeJS()||(window.onerror=function(msg,url,lineno,colno,error){var str;return msg=node.game.getCurrentGameStage().toString()+"@"+J.getTime()+"> "+url+" "+lineno+","+colno+": "+msg,error&&JSON.stringify(error),that.lastError=msg,node.err(msg),node.debug&&(W.init({waitScreen:!0}),str="<strong>DEBUG mode: client-side error detected.</strong><br/><br/>",str+=msg,str+='</br></br>Open the DevTools in your browser for details.</br><em style="font-size: smaller">This message will not be shown in production mode.</em>',W.lockScreen(str)),!node.debug})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var J=parent.JSUS,NDDB=parent.NDDB,GameStage=parent.GameStage;function EventEmitter(name,node){if("string"!=typeof name)throw new TypeError("EventEmitter constructor: name must be string. Found: "+name);this.node=node,this.name=name,this.events={},this.recordChanges=!1,this.changes={added:[],removed:[]},this.labels={},this.history=new EventHistory(this.node)}function EventEmitterManager(node){this.node=node,this.ee={},this.createEE("ng"),this.createEE("game"),this.createEE("stage"),this.createEE("step")}function EventHistory(node){this.node=node,this.history=new NDDB,this.history.hash("stage",(function(e){var stage;if(e)return stage="object"==typeof e.stage?e.stage:this.node.game.stage,node.GameStage.toHash(stage,"S.s.r")}))}exports.EventEmitter=EventEmitter,exports.EventEmitterManager=EventEmitterManager,EventEmitter.prototype.on=function(type,listener,label){if("string"!=typeof type||""===type)throw new TypeError("EventEmitter.on: type must be a non-empty string. Found: "+type);if("function"!=typeof listener)throw new TypeError("EventEmitter.on: listener must be function.Found: "+listener);label&&function(that,listener,label,method){if("string"!=typeof label&&"number"!=typeof label)throw new TypeError("EventEmitter."+method+": label must be string or undefined. Found: "+label);if(that.labels[label])throw new Error("EventEmitter."+method+": label is not unique: "+label);that.labels[label]=!0,listener.__ngid=""+label}(this,listener,label,"on"),this.events[type]?"object"==typeof this.events[type]?this.events[type].push(listener):this.events[type]=[this.events[type],listener]:this.events[type]=listener,this.recordChanges&&this.changes.added.push({type:type,listener:listener}),this.node.silly(this.name+".on: added: "+type)},EventEmitter.prototype.once=function(type,listener,label){var that=this;label||(label=J.uniqueKey(this.labels,type)),this.on(type,(function(){var i,len,args;for(args=[],i=-1,len=arguments.length;++i<len;)args[i]=arguments[i];that.off(type,label),listener.apply(that.node.game,args)}),label)},EventEmitter.prototype.emit=function(){var handler,len,args,i,listeners,type,ctx,node,res,tmpRes;if(type=arguments[0],void 0!==(handler=this.events[type])){if(ctx=(node=this.node).game,this.node.conf.events&&this.node.conf.events.dumpEvents&&this.node.info("F: "+this.name+": "+type),"function"==typeof handler)switch(arguments.length){case 1:res=handler.call(ctx);break;case 2:res=handler.call(ctx,arguments[1]);break;case 3:res=handler.call(ctx,arguments[1],arguments[2]);break;case 4:res=handler.call(ctx,arguments[1],arguments[2],arguments[3]);break;default:for(len=arguments.length,args=new Array(len-1),i=1;i<len;i++)args[i-1]=arguments[i];res=handler.apply(ctx,args)}else if(handler&&"object"==typeof handler){for(len=arguments.length,args=new Array(len-1),i=1;i<len;i++)args[i-1]=arguments[i];for(len=(listeners=handler.slice()).length,res=[],i=0;i<len;i++)void 0!==(tmpRes=listeners[i].apply(node.game,args))&&res.push(tmpRes);res.length?1===res.length&&(res=res[0]):res=void 0}if(node.conf&&node.conf.events&&node.conf.events.history){for(len=arguments.length,args=new Array(len),i=-1;++i<len;)args[i]=arguments[i];this.history.insert({stage:node.game.getCurrentGameStage(),args:args})}return res}},EventEmitter.prototype.emitAsync=function(){var that,len,args,i,arg1,arg2,arg3;if(arg1=arguments[0],this.events[arg1])switch(that=this,len=arguments.length){case 1:setTimeout((function(){that.emit(arg1)}),0);break;case 2:arg2=arguments[1],setTimeout((function(){that.emit(arg1,arg2)}),0);break;case 3:arg2=arguments[1],arg3=arguments[2],setTimeout((function(){that.emit(arg1,arg2,arg3)}),0);break;default:for(args=new Array(len),i=-1;++i<len;)args[i]=arguments[i];setTimeout((function(){that.emit.apply(that,args)}),0)}},EventEmitter.prototype.remove=EventEmitter.prototype.off=function(type,listener){var listeners,len,i,node,found,oneFound,removed;if(removed=[],node=this.node,"string"!=typeof type)throw new TypeError("EventEmitter.remove ("+this.name+"): type must be string. Found: "+type);if(listener&&"function"!=typeof listener&&"string"!=typeof listener)throw new TypeError("EventEmitter.remove ("+this.name+"): listener must be function, string, or undefined. Found: "+listener);if("string"==typeof listener&&""===listener.trim())throw new Error("EventEmitter.remove ("+this.name+"): listener cannot be an empty string");if(this.events[type])if(listener)if("function"==typeof this.events[type])"function"==typeof listener?listener==this.events[type]&&(oneFound=!0):listener===this.events[type].__ngid?(this.labels[listener]=null,oneFound=!0):listener===J.funcName(this.events[type])&&(oneFound=!0),oneFound&&(removed.push(this.events[type]),this.events[type]=null);else for(len=(listeners=this.events[type]).length,i=0;i<len;i++)found=!1,"function"==typeof listener?listeners[i]==listener&&(found=!0):listener===listeners[i].__ngid?(this.labels[listener]=null,found=!0):listener===J.funcName(listeners[i])&&(found=!0),found&&(oneFound=!0,removed.push(listeners[i]),1===len?this.events[type]=null:(listeners.splice(i,1),len--,i--));else{for(oneFound=!0,i=-1,len=this.events[type].length;++i<len;)removed.push(this.events[type][i]);this.events[type]=null}if(oneFound){if(this.recordChanges)for(i=-1,len=removed.length;++i<len;)this.changes.removed.push({type:type,listener:removed[i]});node.silly("ee."+this.name+" removed listener: "+type)}else node.warn("EventEmitter.remove ("+this.name+"): requested listener was not found for event "+type);return removed},EventEmitter.prototype.clear=function(){var event,i,len;if(this.recordChanges)for(event in this.events)if("function"==typeof this.events[event])this.changes.removed.push({type:event,listener:this.events[event]});else if(J.isArray(this.events[event]))for(i=-1,len=this.events[event].length;++i<len;)this.changes.removed.push({type:event,listener:this.events[event][i]});this.events={},this.labels={}},EventEmitter.prototype.size=function(mod){var count;if(count=0,!mod){for(mod in this.events)this.events.hasOwnProperty(mod)&&this.events[mod]&&count++;return count}if("string"==typeof mod)return this.events[mod]?"function"==typeof this.events[mod]?1:this.events[mod].length:0;for(mod in this.events)count+=this.size(mod);return count},EventEmitter.prototype.printAll=function(){var i,len,totalLen,str;for(i in totalLen=0,str="",this.events)this.events.hasOwnProperty(i)&&(str+=i+": "+(len=this.size(i))+"\n",totalLen+=len);return console.log("["+this.name+"] "+totalLen+" listener/s."),str&&console.log(str),totalLen},EventEmitter.prototype.getChanges=function(clear){var changes;return(this.changes.added.length||this.changes.removed.length)&&(changes=this.changes,clear&&(this.changes={added:[],removed:[]})),changes},EventEmitter.prototype.setRecordChanges=function(record){if("boolean"==typeof record)this.recordChanges=record;else if(void 0!==record)throw new TypeError("EventEmitter.setRecordChanged: record must be boolean or undefined. Found: "+record);return this.recordChanges},EventEmitterManager.prototype.createEE=function(name){return this.ee[name]=new EventEmitter(name,this.node),this[name]=this.ee[name],this.ee[name]},EventEmitterManager.prototype.destroyEE=function(name){if("string"!=typeof name)throw new TypeError("EventEmitterManager.destroyEE: name must be string. Found: "+name);return!!this.ee[name]&&(delete this[name],delete this.ee[name],!0)},EventEmitterManager.prototype.clear=function(){this.ng.clear(),this.game.clear(),this.stage.clear(),this.step.clear()},EventEmitterManager.prototype.emit=function(eventName){var i,tmpRes,res,args,len,ees;if("string"!=typeof eventName)throw new TypeError("EventEmitterManager.emit: eventName must be string. Found: "+eventName);switch(res=[],len=arguments.length,ees=this.ee||this.events.ee,len){case 1:void 0!==(tmpRes=ees.ng.emit(eventName))&&res.push(tmpRes),void 0!==(tmpRes=ees.game.emit(eventName))&&res.push(tmpRes),void 0!==(tmpRes=ees.stage.emit(eventName))&&res.push(tmpRes),void 0!==(tmpRes=ees.step.emit(eventName))&&res.push(tmpRes);break;case 2:void 0!==(tmpRes=ees.ng.emit(eventName,arguments[1]))&&res.push(tmpRes),void 0!==(tmpRes=ees.game.emit(eventName,arguments[1]))&&res.push(tmpRes),void 0!==(tmpRes=ees.stage.emit(eventName,arguments[1]))&&res.push(tmpRes),void 0!==(tmpRes=ees.step.emit(eventName,arguments[1]))&&res.push(tmpRes);break;case 3:void 0!==(tmpRes=ees.ng.emit(eventName,arguments[1],arguments[2]))&&res.push(tmpRes),void 0!==(tmpRes=ees.game.emit(eventName,arguments[1],arguments[2]))&&res.push(tmpRes),void 0!==(tmpRes=ees.stage.emit(eventName,arguments[1],arguments[2]))&&res.push(tmpRes),void 0!==(tmpRes=ees.step.emit(eventName,arguments[1],arguments[2]))&&res.push(tmpRes);break;default:for(args=new Array(len),i=-1;++i<len;)args[i]=arguments[i];void 0!==(tmpRes=ees.ng.emit.apply(ees.ng,args))&&res.push(tmpRes),void 0!==(tmpRes=ees.game.emit.apply(ees.game,args))&&res.push(tmpRes),void 0!==(tmpRes=ees.stage.emit.apply(ees.stage,args))&&res.push(tmpRes),void 0!==(tmpRes=ees.step.emit.apply(ees.step,args))&&res.push(tmpRes)}return res.length<2?res[0]:res},EventEmitterManager.prototype.emitAsync=function(eventName){var i,len,args,ees;if("string"!=typeof eventName)throw new TypeError("EventEmitterManager.emit: eventName must be string. Found: "+eventName);switch(len=arguments.length,ees=this.ee||this.events.ee,len){case 1:ees.ng.emitAsync(eventName),ees.game.emitAsync(eventName),ees.stage.emitAsync(eventName),ees.step.emitAsync(eventName);break;case 2:ees.ng.emitAsync(eventName,arguments[1]),ees.game.emitAsync(eventName,arguments[1]),ees.stage.emitAsync(eventName,arguments[1]),ees.step.emitAsync(eventName,arguments[1]);break;case 3:ees.ng.emitAsync(eventName,arguments[1],arguments[2]),ees.game.emitAsync(eventName,arguments[1],arguments[2]),ees.stage.emitAsync(eventName,arguments[1],arguments[2]),ees.step.emitAsync(eventName,arguments[1],arguments[2]);break;default:for(args=new Array(len),i=-1;++i<len;)args[i]=arguments[i];ees.ng.emitAsync.apply(ees.ng,args),ees.game.emitAsync.apply(ees.game,args),ees.stage.emitAsync.apply(ees.stage,args),ees.step.emitAsync.apply(ees.step,args)}},EventEmitterManager.prototype.remove=function(eventName,listener){var res;if("string"!=typeof eventName)throw new TypeError("EventEmitterManager.remove: eventName must be string. Found: "+eventName);if(listener&&"function"!=typeof listener&&"string"!=typeof listener)throw new TypeError("EventEmitter.remove ("+this.name+"): listener must be function, string, or undefined. Found: "+listener);return(res={}).ng=this.ng.remove(eventName,listener),res.game=this.game.remove(eventName,listener),res.stage=this.stage.remove(eventName,listener),res.step=this.step.remove(eventName,listener),res},EventEmitterManager.prototype.printAll=function(eventEmitterName){var total;if(eventEmitterName&&"string"!=typeof eventEmitterName)throw new TypeError("EventEmitterManager.printAll: eventEmitterName must be string or undefined. Found: "+eventEmitterName);if(eventEmitterName&&!this.ee[eventEmitterName])throw new TypeError("EventEmitterManager.printAll: eventemitter not found: "+eventEmitterName);return eventEmitterName?total=this.ee[eventEmitterName].printAll():(total=0,total+=this.ng.printAll(),total+=this.game.printAll(),total+=this.stage.printAll(),total+=this.step.printAll(),console.log("Total number of registered listeners: "+total)),total},EventEmitterManager.prototype.getAll=function(eventEmitterName){if(eventEmitterName&&"string"!=typeof eventEmitterName)throw new TypeError("EventEmitterManager.getAll: eventEmitterName must be string or undefined. Found: "+eventEmitterName);if(eventEmitterName&&!this.ee[eventEmitterName])throw new TypeError("EventEmitterManager.getAll: eventemitter not found: "+eventEmitterName);return eventEmitterName?this.ee[eventEmitterName].events:{ng:this.ng.events,game:this.game.events,stage:this.stage.events,step:this.step.events}},EventEmitterManager.prototype.getChanges=function(clear){var changes,tmp;return changes={},(tmp=this.ee.ng.getChanges(clear))&&(changes.ng=tmp),(tmp=this.ee.game.getChanges(clear))&&(changes.game=tmp),(tmp=this.ee.stage.getChanges(clear))&&(changes.stage=tmp),(tmp=this.ee.step.getChanges(clear))&&(changes.step=tmp),J.isEmpty(changes)?null:changes},EventEmitterManager.prototype.setRecordChanges=function(record){var out;return(out={}).ng=this.ee.ng.setRecordChanges(record),out.game=this.ee.game.setRecordChanges(record),out.stage=this.ee.stage.setRecordChanges(record),out.step=this.ee.step.setRecordChanges(record),out},EventEmitterManager.prototype.size=function(mod){var count;return count=this.ng.size(mod),count+=this.game.size(mod),count+=this.stage.size(mod),count+=this.step.size(mod)},EventHistory.prototype.remit=function(stage,discard,keep){var hash,db,remit,node;if(node=this.node,!this.history.count())return node.warn("no event history was found to remit"),!1;if(node.silly("remitting "+node.events.history.count()+" events"),stage){if(this.history.rebuildIndexes(),hash=new GameStage.toHash(stage,"S.s.r"),!this.history.stage)return node.silly("No past events to re-emit found."),!1;if(!this.history.stage[hash])return node.silly("Current stage "+hash+" has no events to re-emit"),!1;db=this.history.stage[hash]}else db=this.history;return discard&&db.select("event","in",discard).remove(),keep&&(db=db.select("event","in",keep)),db.count()?(remit=function(){node.silly("re-emitting "+db.count()+" events"),db.each((function(e){node.emit(e.event,e.p1,e.p2,e.p3)}))},node.game.isReady()?remit.call(node.game):node.on("LOADED",(function(){remit.call(node.game)})),!0):(node.silly("no valid events to re-emit after cleanup"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";function GameStage(gameStage){var tokens,stageNum,stepNum,roundNum,err;if(this.stage=0,this.step=0,this.round=0,"string"==typeof gameStage){if(""===gameStage)throw new Error("GameStage constructor: gameStage name cannot be an empty string.");if("."===gameStage.charAt(0))throw new Error("GameStage constructor: gameStage name cannot start with a dot. Name: "+gameStage);if(tokens=gameStage.split("."),stageNum=parseInt(tokens[0],10),this.stage=isNaN(stageNum)?tokens[0]:stageNum,"string"==typeof tokens[1]){if(!tokens[1].length)throw new Error("GameStage constructor: gameStage contains empty step: "+gameStage);stepNum=parseInt(tokens[1],10),this.step=isNaN(stepNum)?tokens[1]:stepNum}else 0!==this.stage&&(this.step=1);if("string"==typeof tokens[2]){if(!tokens[2].length)throw new Error("GameStage constructor: gameStage contains empty round: "+gameStage);roundNum=parseInt(tokens[2],10),this.round=roundNum}else 0!==this.stage&&(this.round=1)}else if(gameStage&&"object"==typeof gameStage)this.stage=gameStage.stage,this.step=void 0!==gameStage.step?gameStage.step:0===this.stage?0:1,this.round=void 0!==gameStage.round?gameStage.round:0===this.stage?0:1;else if("number"==typeof gameStage){if(gameStage%1!=0)throw new TypeError("GameStage constructor: gameStage cannot be a non-integer number. Found: "+gameStage);this.stage=gameStage,0===this.stage?(this.step=0,this.round=0):(this.step=1,this.round=1)}else if(null!=gameStage)throw new TypeError("GameStage constructor: gameStage must be string, object, number, undefined, or null. Found: "+gameStage);if("number"==typeof this.stage)this.stage<0&&(err="stage");else if("string"!=typeof this.stage)throw new Error("GameStage constructor: gameStage.stage must be number or string: "+typeof this.stage);if("number"==typeof this.step)this.step<0&&(err=err?err+", step":"step");else if("string"!=typeof this.step)throw new Error("GameStage constructor: gameStage.step must be number or string: "+typeof this.step);if("number"!=typeof this.round)throw new Error("GameStage constructor: gameStage.round must be number. Found: "+this.round);if(this.round<0&&(err=err?err+", round":"round"),err)throw new TypeError("GameStage constructor: "+err+" field/s contain/s negative numbers.");if(!(0===this.stage&&0===this.step&&0===this.round||0!==this.stage&&0!==this.step&&0!==this.round))throw new Error("GameStage constructor: malformed game stage: "+this.toString())}exports.GameStage=GameStage,GameStage.defaults={},GameStage.defaults.hash="S.s.r",GameStage.prototype.toString=function(){return this.stage+"."+this.step+"."+this.round},GameStage.toHash=function(gs,str){var hash,i,idx,properties;if(!gs||"object"!=typeof gs)throw new TypeError("GameStage.toHash: gs must be object. Found: "+gs);if(!str||!str.length)return gs.stage+"."+gs.step+"."+gs.round;for(hash="","Ssr",properties=["stage","step","round"],i=0;i<str.length;i++)hash+=(idx="Ssr".indexOf(str.charAt(i)))<0?str.charAt(i):gs[properties[idx]];return hash},GameStage.toObject=function(){return{stage:this.stage,step:this.step,round:this.round}},GameStage.compare=function(gs1,gs2){var result;return gs1||gs2?gs2?gs1?(gs1=new GameStage(gs1),gs2=new GameStage(gs2),"number"==typeof gs1.stage?result="number"==typeof gs2.stage?gs2.stage-gs1.stage:-1:"number"==typeof gs2.stage&&(result=1),0===result&&("number"==typeof gs1.round?result="number"==typeof gs2.round?gs2.round-gs1.round:-1:"number"==typeof gs2.round&&(result=1)),0===result&&("number"==typeof gs1.step?result="number"==typeof gs2.step?gs2.step-gs1.step:-1:"number"==typeof gs2.step&&(result=1)),result>0?1:result<0?-1:0):1:-1:0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.PlayerList=PlayerList;var syncTypes,J=parent.JSUS,NDDB=parent.NDDB,GameStage=parent.GameStage,stageLevels=parent.constants.stageLevels,stateLevels=parent.constants.stateLevels;function PlayerList(options,db){(options=options||{}).name=options.name||"plist",options.update||(options.update={}),void 0===options.update.indexes&&(options.update.indexes=!0),this.pcounter=0,NDDB.call(this,options),this.id||this.index("id",(function(p){return p.id})),db&&this.importDB(db),this.globalCompare=PlayerList.comparePlayers}function array2Groups(array){var i,len,settings;for(settings=this.cloneSettings(),i=-1,len=array.length;++i<len;)array[i]=new PlayerList(settings,array[i]);return array}function Player(player){var key;if("object"!=typeof player)throw new TypeError("Player constructor: player must be object. Found: "+player);if("string"!=typeof player.id)throw new TypeError("Player constructor: id must be string. Found: "+player.id);for(key in this.id=player.id,this.sid=player.sid,this.clientType=player.clientType||null,this.group=player.group||null,this.role=player.role||null,this.partner=player.partner||null,this.count=void 0===player.count?null:player.count,this.admin=!!player.admin,this.disconnected=!!player.disconnected,this.ip=player.ip||null,this.name=player.name||null,this.stage=player.stage||new GameStage,this.stageLevel=player.stageLevel||stageLevels.UNINITIALIZED,this.stateLevel=player.stateLevel||stateLevels.UNINITIALIZED,this.lang={name:"English",shortName:"en",nativeName:"English",path:"en/"},player)player.hasOwnProperty(key)&&"function"!=typeof player[key]&&(this.hasOwnProperty(key)||(this[key]=player[key]))}PlayerList.prototype=new NDDB,PlayerList.prototype.constructor=PlayerList,PlayerList.comparePlayers=function(p1,p2){return p1.id===p2.id?0:p1.count<p2.count?1:p1.count>p2.count?-1:0},PlayerList.prototype.importDB=function(db){var i,len;if(!J.isArray(db))throw new TypeError("PlayerList.importDB: db must be array.");for(i=-1,len=db.length;++i<len;)this.add(db[i])},PlayerList.prototype.add=function(player,updateRules){if(!(player instanceof Player)){if("object"!=typeof player)throw new TypeError("PlayerList.add: player must be object. Found: "+player);if("string"!=typeof player.id)throw new TypeError("PlayerList.add: player.id must be string. Found: "+player.id);player=new Player(player)}if(this.exist(player.id))throw new Error("PlayerList.add: player already existing: "+player.id+".");return this.insert(player,updateRules),player.count=this.pcounter,this.pcounter++,player},PlayerList.prototype.get=function(id){var player;if("string"!=typeof id)throw new TypeError("PlayerList.get: id must be string");if(!(player=this.id.get(id)))throw new Error("PlayerList.get: Player not found: "+id);return player},PlayerList.prototype.remove=function(id){var player;if("string"!=typeof id)throw new TypeError("PlayerList.remove: id must be string. Found: "+id);if(!(player=this.id.remove(id)))throw new Error("PlayerList.remove: player not found: "+id);return player},PlayerList.prototype.pop=PlayerList.prototype.remove,PlayerList.prototype.exist=function(id){return!!this.id.get(id)},PlayerList.prototype.clear=function(){NDDB.prototype.clear.call(this),this.rebuildIndexes()},PlayerList.prototype.updatePlayer=function(id,update){var player;if("string"!=typeof id)throw new TypeError("PlayerList.updatePlayer: id must be string. Found: "+id);if("object"!=typeof update)throw new TypeError("PlayerList.updatePlayer: update must be object. Found: "+update);if(void 0!==update.id)throw new Error("PlayerList.updatePlayer: update cannot change the player id.");if(!(player=this.id.update(id,update)))throw new Error("PlayerList.updatePlayer: player not found: "+id);return player},PlayerList.prototype.isStepDone=function(gameStage,type,checkOutliers){return this.arePlayersSync(gameStage,stageLevels.DONE,type,checkOutliers)},PlayerList.prototype.isStepLoaded=function(gameStage){return this.arePlayersSync(gameStage,stageLevels.LOADED,"EXACT")},PlayerList.prototype.arePlayersSync=function(gameStage,stageLevel,type,checkOutliers){var p,i,len,cmp,outlier;if(gameStage=new GameStage(gameStage),void 0!==stageLevel&&"number"!=typeof stageLevel)throw new TypeError("PlayerList.arePlayersSync: stagelevel must be number or undefined.");if("string"!=typeof(type=type||"EXACT"))throw new TypeError("PlayerList.arePlayersSync: type must be string or undefined.");if(void 0===syncTypes[type])throw new Error("PlayerList.arePlayersSync: unknown type: "+type+".");if(!(checkOutliers=void 0===checkOutliers||!!checkOutliers)&&"EXACT"===type)throw new Error("PlayerList.arePlayersSync: incompatible options: type=EXACT and checkOutliers=FALSE.");for(i=-1,len=this.db.length;++i<len;){switch(p=this.db[i],type){case"EXACT":if(0!==(cmp=GameStage.compare(gameStage,p.stage)))return!1;break;case"STAGE":gameStage.stage!==p.stage.stage&&(outlier=!0);break;case"STAGE_UPTO":if(cmp=GameStage.compare(gameStage,p.stage),gameStage.stage!==p.stage.stage||cmp<0){outlier=!0;break}if(cmp>0)return!1}if(checkOutliers&&outlier)return!1;if(void 0!==stageLevel&&p.stageLevel!==stageLevel)return!1}return!0},PlayerList.prototype.toString=function(eol){var out,EOL;return out="",EOL=eol||"\n",this.each((function(p){var stage;out+=p.id+": "+p.name,stage=new GameStage(p.stage),out+=": "+stage+EOL})),out},PlayerList.prototype.getNGroups=function(N){var groups;if("number"!=typeof N||isNaN(N)||N<1)throw new TypeError("PlayerList.getNGroups: N must be a number > 0: "+N);return groups=J.getNGroups(this.db,N),array2Groups.call(this,groups)},PlayerList.prototype.getGroupsSizeN=function(N){var groups;if("number"!=typeof N||isNaN(N)||N<1)throw new TypeError("PlayerList.getNGroups: N must be a number > 0: "+N);return groups=J.getGroupsSizeN(this.db,N),array2Groups.call(this,groups)},PlayerList.prototype.getRandom=function(N){var shuffled;if(void 0===N&&(N=1),"number"!=typeof N||isNaN(N)||N<1)throw new TypeError("PlayerList.getRandom: N must be a number > 0 or undefined: "+N+".");return shuffled=this.shuffle(),1===N?shuffled.first():shuffled.limit(N).fetch()},syncTypes={STAGE:"",STAGE_UPTO:"",EXACT:""},exports.Player=Player,Player.prototype.toString=function(){return(this.name||"")+" ("+this.id+") "+new GameStage(this.stage)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){"use strict";var GameStage=node.GameStage,J=node.JSUS;function GameMsg(gm){gm=gm||{},this.id=void 0===gm.id?Math.floor(1e6*Math.random()):gm.id,this.sid=gm.sid,this.session=gm.session,this.stage=gm.stage,this.action=gm.action,this.target=gm.target,this.from=gm.from,this.to=gm.to,this.text=gm.text,this.data=gm.data,this.priority=gm.priority,this.reliable=gm.reliable,this.created=J.getDate(),this.forward=0}exports.GameMsg=GameMsg,GameMsg.clone=function(gameMsg){return new GameMsg(gameMsg)},GameMsg.prototype.stringify=function(){return JSON.stringify(this)},GameMsg.prototype.toString=function(){var SPT,line,tmp;return SPT=",\t","\t",'"','"unknown"\t',line=this.created+SPT,line+=this.id+SPT,line+=this.session+SPT,line+=this.action+SPT,line+=this.target?this.target.length<6?this.target+SPT+"\t":this.target+SPT:'"unknown"\t',line+=this.from?this.from.length<6?this.from+SPT+"\t":this.from+SPT:'"unknown"\t',line+=this.to?this.to.length<6?this.to+SPT+"\t":this.to+SPT:'"unknown"\t',null===this.text||void 0===this.text?line+='"no text",\t':"number"==typeof this.text?line+=""+this.text:(tmp=this.text.toString()).length>12?line+='"'+tmp.substr(0,9)+'..."'+SPT:tmp.length<6?line+='"'+tmp+'"'+",\t\t":line+='"'+tmp+'"'+SPT,null===this.data||void 0===this.data?line+='"no data",\t':"number"==typeof this.data?line+=""+this.data:(tmp=this.data.toString()).length>12?line+='"'+tmp.substr(0,9)+'..."'+SPT:tmp.length<9?line+='"'+tmp+'"'+",\t\t":line+='"'+tmp+'"'+SPT,line+=new GameStage(this.stage)+SPT,line+=this.reliable+SPT,line+=this.priority},GameMsg.prototype.toSMS=function(){var line="["+this.from+"]->["+this.to+"]\t";return line+="|"+this.action+"."+this.target+"|\t",line+=" "+this.text+" "},GameMsg.prototype.toInEvent=function(){return"in."+this.toEvent()},GameMsg.prototype.toOutEvent=function(){return"out."+this.toEvent()},GameMsg.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.GamePlot=GamePlot;var GameStage=parent.GameStage,J=parent.JSUS;function GamePlot(node,stager){var tmpCache,handler;this.node=node,this.stager=null,this.cache={},this.tmpCache=(tmpCache={},handler=function(prop,value){if(void 0===prop)return tmpCache;if("string"==typeof prop)return 1===arguments.length?tmpCache[prop]:(tmpCache[prop]=value,value);throw new TypeError("GamePlot.tmpCache: prop must be string. Found: "+prop)},handler.clear=function(){var tmp;return tmp=tmpCache,tmpCache={},tmp},handler.hasOwnProperty=function(prop){if("string"!=typeof prop)throw new TypeError("GamePlot.tmpCache.hasProperty: prop must be string. Found: "+prop);return tmpCache.hasOwnProperty(prop)},handler),this._normalizedCache={},this.init(stager)}function cacheStepProperty(that,gameStage,property,value){that.cache[gameStage]||(that.cache[gameStage]={}),that.cache[gameStage][property]=value}GamePlot.GAMEOVER="NODEGAME_GAMEOVER",GamePlot.END_SEQ="NODEGAME_END_SEQ",GamePlot.NO_SEQ="NODEGAME_NO_SEQ",GamePlot.prototype.init=function(stager){if(stager){if("object"!=typeof stager)throw new Error("GamePlot.init: called with invalid stager.");this.stager=stager}else this.stager=null;this.cache={},this.tmpCache.clear()},GamePlot.prototype.nextStage=function(curStage,execLoops){var seqObj,stageNo,normStage;if(!this.stager)return GamePlot.NO_SEQ;if(this.isFlexibleMode())return console.log("***GamePlot.nextStage: method not available in flexible mode.***"),null;if(null===(normStage=this.normalizeGameStage(curStage)))return this.node.silly("GamePlot.nextStage: invalid stage: "+curStage),null;if(0===(stageNo=normStage.stage))return new GameStage({stage:1,step:1,round:1});if("gameover"===(seqObj=this.stager.sequence[stageNo-1]).type)return GamePlot.GAMEOVER;if(execLoops=void 0===execLoops||execLoops,this.stager.stages[seqObj.id],stageNo<this.stager.sequence.length){if(seqObj=this.stager.sequence[stageNo],!execLoops&&"loop"===seqObj.type)return null;for(;"loop"===seqObj.type&&!seqObj.cb.call(this.node.game);){if(++stageNo>=this.stager.sequence.length)return GamePlot.END_SEQ;seqObj=this.stager.sequence[stageNo]}return"gameover"===this.stager.sequence[stageNo].type?GamePlot.GAMEOVER:new GameStage({stage:stageNo+1,step:1,round:1})}return GamePlot.END_SEQ},GamePlot.prototype.next=function(curStage,execLoops){var seqObj,stageObj,stageNo,stepNo,normStage,nextStage;if(!this.stager)return GamePlot.NO_SEQ;if(seqObj=null,stageObj=null,normStage=null,nextStage=null,this.isFlexibleMode()){if(0===(curStage=new GameStage(curStage)).stage)return this.stager.generalNextFunction&&(nextStage=this.stager.generalNextFunction()),nextStage?new GameStage({stage:nextStage,step:1,round:1}):GamePlot.END_SEQ;if(void 0===(stageObj=this.stager.stages[curStage.stage]))throw new Error("Gameplot.next: received non-existent stage: "+curStage.stage);if((stepNo="number"==typeof curStage.step?curStage.step:stageObj.steps.indexOf(curStage.step)+1)<1)throw new Error("GamePlot.next: received non-existent step: "+stageObj.id+"."+curStage.step);return stepNo+1<=stageObj.steps.length?new GameStage({stage:stageObj.id,step:stepNo+1,round:1}):(this.stager.nextFunctions[stageObj.id]?nextStage=this.stager.nextFunctions[stageObj.id]():this.stager.generalNextFunction&&(nextStage=this.stager.generalNextFunction()),nextStage===GamePlot.GAMEOVER?GamePlot.GAMEOVER:nextStage?new GameStage({stage:nextStage,step:1,round:1}):GamePlot.END_SEQ)}if(null===(normStage=this.normalizeGameStage(curStage)))return this.node.silly("GamePlot.next: invalid stage: "+curStage),null;if(0===(stageNo=normStage.stage))return new GameStage({stage:1,step:1,round:1});if(stepNo=normStage.step,"gameover"===(seqObj=this.stager.sequence[stageNo-1]).type)return GamePlot.GAMEOVER;if(execLoops=void 0===execLoops||execLoops,stageObj=this.stager.stages[seqObj.id],stepNo+1<=seqObj.steps.length)return new GameStage({stage:stageNo,step:stepNo+1,round:normStage.round});if("repeat"===seqObj.type&&normStage.round+1<=seqObj.num)return new GameStage({stage:stageNo,step:1,round:normStage.round+1});if("doLoop"===seqObj.type||"loop"===seqObj.type){if(!execLoops)return null;if(seqObj.cb.call(this.node.game))return new GameStage({stage:stageNo,step:1,round:normStage.round+1})}if(stageNo<this.stager.sequence.length){if(seqObj=this.stager.sequence[stageNo],!execLoops&&"loop"===seqObj.type)return null;for(;"loop"===seqObj.type&&!seqObj.cb.call(this.node.game);){if(++stageNo>=this.stager.sequence.length)return GamePlot.END_SEQ;seqObj=this.stager.sequence[stageNo]}return"gameover"===this.stager.sequence[stageNo].type?GamePlot.GAMEOVER:new GameStage({stage:stageNo+1,step:1,round:1})}return GamePlot.END_SEQ},GamePlot.prototype.previous=function(curStage,execLoops){var normStage,seqObj,prevSeqObj,stageNo,stepNo,prevStepNo;if(!this.stager)return GamePlot.NO_SEQ;if(null,null,null===(normStage=this.normalizeGameStage(curStage)))return this.node.warn("GamePlot.previous: invalid stage: "+curStage),null;if(0===(stageNo=normStage.stage))return new GameStage;if(stepNo=normStage.step,seqObj=this.stager.sequence[stageNo-1],execLoops=void 0===execLoops||execLoops,stepNo>1)return new GameStage({stage:stageNo,step:stepNo-1,round:normStage.round});if(normStage.round>1)return new GameStage({stage:stageNo,step:seqObj.steps.length,round:normStage.round-1});if(1===stageNo)return new GameStage;if(prevSeqObj=this.stager.sequence[stageNo-2],!execLoops&&"loop"===seqObj.type)return null;for(;"loop"===prevSeqObj.type&&!prevSeqObj.cb.call(this.node.game);){if(--stageNo<=1)return new GameStage;prevSeqObj=this.stager.sequence[stageNo-2]}return prevStepNo=prevSeqObj.steps.length,"repeat"===prevSeqObj.type?new GameStage({stage:stageNo-1,step:prevStepNo,round:prevSeqObj.num}):new GameStage({stage:stageNo-1,step:prevStepNo,round:1})},GamePlot.prototype.jump=function(curStage,delta,execLoops){var stageType;if(execLoops=void 0===execLoops||execLoops,delta<0)for(;delta<0;){if(!((curStage=this.previous(curStage,execLoops))instanceof GameStage)||0===curStage.stage)return curStage;if(delta++,!execLoops)if("loop"===(stageType=this.stager.sequence[curStage.stage-1].type)){if(delta<0)return null}else if("doLoop"===stageType)return delta<-1?null:curStage}else for(;delta>0;){if(!((curStage=this.next(curStage,execLoops))instanceof GameStage))return curStage;if(delta--,!execLoops&&("loop"===(stageType=this.stager.sequence[curStage.stage-1].type)||"doLoop"===stageType))return delta>0?null:curStage}return curStage},GamePlot.prototype.stepsToNextStage=function(gameStage,countRepeat){var seqObj,totSteps,stepNo;if(!this.stager)return null;if(!(gameStage=this.normalizeGameStage(gameStage)))return null;if(0===gameStage.stage)return 1;if(!(seqObj=this.getSequenceObject(gameStage)))return null;if(stepNo=gameStage.step,totSteps=seqObj.steps.length,countRepeat)if("repeat"===seqObj.type)gameStage.round>1&&(stepNo=(gameStage.round-1)*totSteps+stepNo),totSteps*=seqObj.num;else if("loop"===seqObj.type||"doLoop"===seqObj.type)return null;return 1+totSteps-stepNo},GamePlot.prototype.stepsToPreviousStage=function(gameStage){return console.log("GamePlot.stepsToPreviousStage is **deprecated**. UseGamePlot.stepsFromPreviousStage instead."),this.stepsFromPreviousStage(gameStage)},GamePlot.prototype.stepsFromPreviousStage=function(gameStage,countRepeat){var seqObj,stepNo;if(!this.stager)return null;if(!(gameStage=this.normalizeGameStage(gameStage))||0===gameStage.stage)return null;if(!(seqObj=this.getSequenceObject(gameStage)))return null;if(stepNo=gameStage.step,countRepeat)if("repeat"===seqObj.type)gameStage.round>1&&(stepNo=seqObj.steps.length*(gameStage.round-1)+stepNo);else if("loop"===seqObj.type||"doLoop"===seqObj.type)return null;return stepNo},GamePlot.prototype.getSequenceObject=function(gameStage){return this.stager&&(gameStage=this.normalizeGameStage(gameStage))?this.stager.sequence[gameStage.stage-1]:null},GamePlot.prototype.getStage=function(gameStage){var stageObj;return this.stager?((gameStage=this.normalizeGameStage(gameStage))&&(stageObj=(stageObj=this.stager.sequence[gameStage.stage-1])?this.stager.stages[stageObj.id]:null),stageObj||null):null},GamePlot.prototype.getStep=function(gameStage){var seqObj,stepObj;return this.stager?((seqObj=this.getSequenceObject(gameStage))&&(stepObj=this.stager.steps[seqObj.steps[gameStage.step-1]]),stepObj||null):null},GamePlot.prototype.getStepRule=function(gameStage){var rule;return"string"==typeof(rule=this.getProperty(gameStage,"stepRule"))&&(rule=parent.stepRules[rule]),rule||this.stager.getDefaultStepRule()},GamePlot.prototype.getGlobal=function(gameStage,globalVar){var stepObj,stageObj,stepGlobals,stageGlobals,defaultGlobals;return gameStage=new GameStage(gameStage),(stepObj=this.getStep(gameStage))&&(stepGlobals=stepObj.globals)&&stepGlobals.hasOwnProperty(globalVar)?stepGlobals[globalVar]:(stageObj=this.getStage(gameStage))&&(stageGlobals=stageObj.globals)&&stageGlobals.hasOwnProperty(globalVar)?stageGlobals[globalVar]:this.stager&&(defaultGlobals=this.stager.getDefaultGlobals())&&defaultGlobals.hasOwnProperty(globalVar)?defaultGlobals[globalVar]:null},GamePlot.prototype.getGlobals=function(gameStage){var stepstage,globals;if("string"!=typeof gameStage&&"object"!=typeof gameStage)throw new TypeError("GamePlot.getGlobals: gameStage must be string or object.");return globals={},this.stager?(J.mixin(globals,this.stager.getDefaultGlobals()),(stepstage=this.getStage(gameStage))&&J.mixin(globals,stepstage.globals),(stepstage=this.getStep(gameStage))&&J.mixin(globals,stepstage.globals),globals):globals},GamePlot.prototype.getProperty=function(gameStage,prop,notFound,mask){var stepObj,stageObj,defaultProps,found,res;if("string"!=typeof prop)throw new TypeError("GamePlot.getProperty: property must be string. Found: "+prop);if(gameStage=new GameStage(gameStage),"object"!=typeof(mask=mask||{}))throw new TypeError("GamePlot.getProperty: mask must be object or undefined. Found: "+mask);return!mask.tmpCache&&this.tmpCache.hasOwnProperty(prop)&&0===GameStage.compare(gameStage,this.node.player.stage)?this.tmpCache(prop):!mask.tmpCache&&this.cache[gameStage]&&this.cache[gameStage].hasOwnProperty(prop)?this.cache[gameStage][prop]:(mask.step||(stepObj=this.getStep(gameStage))&&stepObj.hasOwnProperty(prop)&&(res=stepObj[prop],found=!0),found||mask.stage||(stageObj=this.getStage(gameStage))&&stageObj.hasOwnProperty(prop)&&(res=stageObj[prop],found=!0),found||mask.game||!this.stager||(defaultProps=this.stager.getDefaultProperties())&&defaultProps.hasOwnProperty(prop)&&(res=defaultProps[prop],found=!0),found?(cacheStepProperty(this,gameStage,prop,res),res):void 0===notFound?null:notFound)},GamePlot.prototype.updateProperty=function(gameStage,property,value){var stepObj,stageObj,defaultProps,found;if(gameStage=new GameStage(gameStage),"string"!=typeof property)throw new TypeError("GamePlot.updateProperty: property must be string. Found: "+property);return(stepObj=this.getStep(gameStage))&&stepObj.hasOwnProperty(property)&&(stepObj[property]=value,found=!0),found||(stageObj=this.getStage(gameStage))&&stageObj.hasOwnProperty(property)&&(stageObj[property]=value,found=!0),!found&&this.stager&&(defaultProps=this.stager.getDefaultProperties())&&defaultProps.hasOwnProperty(property)&&(defaultProps[property]=value,found=!0),!!found&&(cacheStepProperty(this,gameStage,property,value),!0)},GamePlot.prototype.setStepProperty=function(gameStage,property,value){var stepObj;if(gameStage=new GameStage(gameStage),"string"!=typeof property)throw new TypeError("GamePlot.setStepProperty: property must be string");return!!(stepObj=this.getStep(gameStage))&&(stepObj[property]=value,cacheStepProperty(this,gameStage,property,value),!0)},GamePlot.prototype.setStageProperty=function(gameStage,property,value){var stageObj;if(gameStage=new GameStage(gameStage),"string"!=typeof property)throw new TypeError("GamePlot.setStageProperty: property must be string");return!!(stageObj=this.getStage(gameStage))&&(stageObj[property]=value,!0)},GamePlot.prototype.isReady=function(){return this.stager&&(this.stager.sequence.length>0||null!==this.stager.generalNextFunction||!J.isEmpty(this.stager.nextFunctions))},GamePlot.prototype.normalizeGameStage=function(gameStage){var stageNo,stageObj,stepNo,seqIdx,seqObj,gs;if(this.isFlexibleMode())throw new Error("GamePlot.normalizeGameStage: invalid call in flexible sequence.");if("string"==typeof gameStage&&this._normalizedCache[gameStage])return this._normalizedCache[gameStage];if("number"==typeof(gs=new GameStage(gameStage)).stage){if(0===gs.stage)return new GameStage;stageNo=gs.stage}else{if("string"!=typeof gs.stage)throw new Error("GamePlot.normalizeGameStage: gameStage.stage must be number or string: "+typeof gs.stage);if(gs.stage===GamePlot.GAMEOVER||gs.stage===GamePlot.END_SEQ||gs.stage===GamePlot.NO_SEQ)return null;for(seqIdx=0;seqIdx<this.stager.sequence.length&&this.stager.sequence[seqIdx].id!==gs.stage;seqIdx++);stageNo=seqIdx+1}if(stageNo<1||stageNo>this.stager.sequence.length)return this.node.silly("GamePlot.normalizeGameStage: non-existent stage: "+gs.stage),null;if(!(seqObj=this.stager.sequence[stageNo-1]))return null;if("gameover"===seqObj.type)return new GameStage({stage:stageNo,step:1,round:gs.round});if(!(stageObj=this.stager.stages[seqObj.id]))return null;if("number"==typeof gs.step)stepNo=gs.step;else{if("string"!=typeof gs.step)throw new Error("GamePlot.normalizeGameStage: gameStage.step must be number or string: "+typeof gs.step);stepNo=seqObj.steps.indexOf(gs.step)+1}return stepNo<1||stepNo>stageObj.steps.length?(this.node.silly("normalizeGameStage non-existent step: "+stageObj.id+"."+gs.step),null):"number"!=typeof gs.round?null:(gs=new GameStage({stage:stageNo,step:stepNo,round:gs.round}),"string"==typeof gameStage&&(this._normalizedCache[gameStage]=gs),gs)},GamePlot.prototype.isFlexibleMode=function(){return 0===this.stager.sequence.length},GamePlot.prototype.getRound=function(gs,mod){var seqObj;if(0===(gs=new GameStage(gs)).stage)return null;if(!(seqObj=this.getSequenceObject(gs)))return null;if(!mod||"current"===mod)return gs.round;if("past"===mod)return gs.round-1;if("total"===mod)return"repeat"===seqObj.type?seqObj.num:"plain"===seqObj.type?1:null;if("remaining"===mod)return"repeat"===seqObj.type?seqObj.num-gs.round:"plain"===seqObj.type?1:null;throw new TypeError("GamePlot.getRound: mod must be a known string or undefined. Found: "+mod)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.GameMsgGenerator=GameMsgGenerator;var GameMsg=parent.GameMsg,GameStage=parent.GameStage,constants=parent.constants;function GameMsgGenerator(node){this.node=node}GameMsgGenerator.prototype.create=function(msg){var gameStage,priority,node;return node=this.node,gameStage=msg.stage?msg.stage:node.game?node.game.getCurrentGameStage():new GameStage("0.0.0"),priority=void 0!==msg.priority?msg.priority:msg.target===constants.target.GAMECOMMAND||msg.target===constants.target.REDIRECT||msg.target===constants.target.PCONNECT||msg.target===constants.target.PDISCONNECT||msg.target===constants.target.PRECONNECT||msg.target===constants.target.SERVERCOMMAND||msg.target===constants.target.SETUP?1:0,new GameMsg({session:void 0!==msg.session?msg.session:node.socket.session,stage:gameStage,action:msg.action||constants.action.SAY,target:msg.target||constants.target.DATA,from:node.player?node.player.id:constants.UNDEFINED_PLAYER,to:void 0!==msg.to?msg.to:"SERVER",text:void 0!==msg.text?""+msg.text:null,data:void 0!==msg.data?msg.data:{},priority:priority,reliable:msg.reliable||1})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.PushManager=PushManager;var GameStage=parent.GameStage,DONE=parent.constants.stageLevels.DONE,PUSH_STEP=parent.constants.gamecommands.push_step,GAMECOMMAND=parent.constants.target.GAMECOMMAND;function PushManager(node,options){this.node=node,this.timer=null,this.offsetWaitTime=PushManager.offsetWaitTime,this.replyWaitTime=PushManager.replyWaitTime,this.checkPushWaitTime=PushManager.checkPushWaitTime,this.init(options)}function forceDisconnect(node,p){var msg;node.warn("push-manager: disconnecting "+p.id),msg=node.msg.create({target:"SERVERCOMMAND",text:"DISCONNECT",data:{id:p.id,sid:p.sid}}),node.socket.send(msg)}function checkAndAssignWaitTime(method,options,name,that){var n;if(void 0!==(n=options[name])&&(n=options[name+="WaitTime"]),void 0!==n){if("number"!=typeof n||n<0)throw new TypeError("PushManager."+method+": options."+name+"must be a positive number. Found: "+n);return that[name]=n,n}}PushManager.offsetWaitTime=5e3,PushManager.replyWaitTime=2e3,PushManager.checkPushWaitTime=2e3,PushManager.prototype.init=function(options){!function(method,options,that){checkAndAssignWaitTime(method,options,"offset",that),checkAndAssignWaitTime(method,options,"reply",that),checkAndAssignWaitTime(method,options,"check",that)}("init",options=options||{},this)},PushManager.prototype.startTimer=function(conf){var stage,that,offset,node;if(!0===conf||void 0===conf)conf={};else if("object"!=typeof conf)throw new TypeError("PushManager.startTimer: conf must be object, TRUE, or undefined. Found: "+conf);node=this.node,this.timer?this.clearTimer():this.timer=node.timer.createTimer({name:"push_clients",validity:"game"}),offset=void 0!==conf.offset?node.timer.parseInput("offset",conf.offset):this.offsetWaitTime,stage={stage:node.player.stage.stage,step:node.player.stage.step,round:node.player.stage.round},node.info("push-manager: starting timer with offset "+offset),that=this,this.timer.init({milliseconds:offset,update:offset,timeup:function(){that.pushGame.call(that,stage,conf)}}),this.timer.start()},PushManager.prototype.clearTimer=function(){this.timer&&!this.timer.isStopped()&&(this.node.silly("push-manager: timer cleared."),this.timer.stop())},PushManager.prototype.isActive=function(){return!this.timer.isStopped()},PushManager.prototype.pushGame=function(stage,conf){var m,node,replyWaitTime,checkPushWaitTime;(node=this.node).info("push-manager: checking clients"),"object"==typeof conf&&(replyWaitTime=checkAndAssignWaitTime(m="pushGame",conf,"reply",conf),checkPushWaitTime=checkAndAssignWaitTime(m,conf,"check",conf)),void 0===replyWaitTime&&(replyWaitTime=this.replyWaitTime),void 0===checkPushWaitTime&&(checkPushWaitTime=this.checkPushWaitTime),node.game.pl.each((function(p){p.stageLevel!==DONE&&0===GameStage.compare(p.stage,stage)&&(node.warn("push-manager: push needed: "+p.id),node.get(PUSH_STEP,(function(value){!function(node,p,stage,milliseconds){node.info("push-manager: received reply from "+p.id),setTimeout((function(){var pp;node.game.pl.exist(p.id)&&(pp=node.game.pl.get(p.id),0!==GameStage.compare(pp.stage,stage)||pp.stageLevel===DONE?node.info("push-manager: push worked for "+p.id):forceDisconnect(node,pp))}),milliseconds||0)}(node,p,stage,checkPushWaitTime)}),p.id,{timeout:replyWaitTime,executeOnce:!0,target:GAMECOMMAND,timeoutCb:function(){forceDisconnect(node,p)}}))}))}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.SizeManager=SizeManager;var J=parent.JSUS;function SizeManager(node){this.node=node,this.checkSize=function(){return!0},this.changeHandler=function(op,obj){return!0},this.minThresold=null,this.minCb=null,this.minRecoveryCb=null,this.maxThreshold=null,this.minCbCalled=!1,this.maxCb=null,this.maxRecoveryCb=null,this.maxCbCalled=!1,this.exactThreshold=null,this.exactCb=null,this.exactRecoveryCb=null,this.exactCbCalled=!1}SizeManager.prototype.clear=function(){this.minThreshold=null,this.minCb=null,this.minRecoveryCb=null,this.minCbCalled=!1,this.maxThreshold=null,this.maxCb=null,this.maxRecoveryCb=null,this.maxCbCalled=!1,this.exactThreshold=null,this.exactCb=null,this.exactRecoveryCb=null,this.exactCbCalled=!1,this.changeHandler=function(op,obj){return!0},this.checkSize=function(){return!0}},SizeManager.prototype.init=function(step){var node,property,doPlChangeHandler;if(this.clear(),node=this.node,step=step||node.player.stage,(property=node.game.plot.getProperty(step,"minPlayers"))&&(this.setHandler("min",property),doPlChangeHandler=!0),property=node.game.plot.getProperty(step,"maxPlayers")){if(this.setHandler("max",property),"*"===this.minThreshold)throw new Error('SizeManager.init: maxPlayers cannot be"*" if minPlayers is "*"');if(this.maxThreshold<=this.minThreshold)throw new Error("SizeManager.init: maxPlayers must be greater than minPlayers: "+this.maxThreshold+"<="+this.minThreshold);doPlChangeHandler=!0}if(property=node.game.plot.getProperty(step,"exactPlayers")){if(doPlChangeHandler)throw new Error("SizeManager.init: exactPlayers cannot be set if either minPlayers or maxPlayers is set.");this.setHandler("exact",property),doPlChangeHandler=!0}return doPlChangeHandler?(this.changeHandler=this.changeHandlerFull,this.addListeners(),this.checkSize=this.checkSizeFull):(this.checkSize=function(){return!0},this.changeHandler=function(){return!0}),doPlChangeHandler},SizeManager.prototype.checkSizeFull=function(){var nPlayers,limit;return nPlayers=this.node.game.pl.size(),this.node.player.admin||nPlayers++,!((limit=this.minThreshold)&&"*"!==limit&&nPlayers<limit)&&(!((limit=this.maxThreshold)&&"*"!==limit&&nPlayers>limit)&&(!(limit=this.exacThreshold)||"*"===limit||nPlayers===limit))},SizeManager.prototype.changeHandlerFull=function(op,player){var threshold,nPlayers,game,res;return res=!0,nPlayers=(game=this.node.game).pl.size(),this.node.player.admin||nPlayers++,(threshold=this.minThreshold)&&("pdisconnect"===op?("*"===threshold||nPlayers<threshold)&&(this.minCbCalled||(this.minCbCalled=!0,game.getProperty("onWrongPlayerNum").call(game,"min",this.minCb,player)),res=!1):"pconnect"===op&&(this.minCbCalled&&game.getProperty("onCorrectPlayerNum").call(game,"min",this.minRecoveryCb,player),this.minCbCalled=!1)),(threshold=this.maxThreshold)&&("pconnect"===op?("*"===threshold||nPlayers>threshold)&&(this.maxCbCalled||(this.maxCbCalled=!0,game.getProperty("onWrongPlayerNum").call(game,"max",this.maxCb,player)),res=!1):"pdisconnect"===op&&(this.maxCbCalled&&game.getProperty("onCorrectPlayerNum").call(game,"max",this.maxRecoveryCb,player),this.maxCbCalled=!1)),(threshold=this.exactThreshold)&&(nPlayers!==threshold?(this.exactCbCalled||(this.exactCbCalled=!0,game.getProperty("onWrongPlayerNum").call(game,"exact",this.exactCb,player)),res=!1):(this.exactCbCalled&&game.getProperty("onCorrectPlayerNum").call(game,"exact",this.exactRecoveryCb,player),this.exactCbCalled=!1)),res},SizeManager.prototype.setHandler=function(type,values){values=function(name,property,node){var num,cb,recoverCb,newArray;if("number"==typeof property)newArray=!0,property=[property];else if(!J.isArray(property))throw new TypeError("SizeManager.init: "+name+"Players property must be number or non-empty array. Found: "+property);if(num=property[0],cb=property[1]||null,recoverCb=property[2]||null,"@"===num)num=node.game.pl.size()||1,newArray||((property=property.slice(0))[0]=num);else if("*"!==num&&("number"!=typeof num||!isFinite(num)||num<1))throw new TypeError("SizeManager.init: "+name+"Players must be a finite number greater than 1 or a wildcard (*,@). Found: "+num);if(cb){if("function"!=typeof cb)throw new TypeError("SizeManager.init: "+name+"Players cb must be function or undefined. Found: "+cb)}else property[1]=null;if(recoverCb){if("function"!=typeof cb)throw new TypeError("SizeManager.init: "+name+"Players recoverCb must be function or undefined. Found: "+recoverCb)}else property[2]=null;return property}(type,values,this.node),this[type+"Threshold"]=values[0],this[type+"Cb"]=values[1],this[type+"RecoveryCb"]=values[2]},SizeManager.prototype.addListeners=function(){var that;that=this,this.node.events.step.on("in.say.PCONNECT",(function(p){that.changeHandler("pconnect",p.data)}),"plManagerCon"),this.node.events.step.on("in.say.PDISCONNECT",(function(p){that.changeHandler("pdisconnect",p.data)}),"plManagerDis")},SizeManager.prototype.removeListeners=function(){this.node.events.step.off("in.say.PCONNECT","plManagerCon"),this.node.events.step.off("in.say.PDISCONNECT","plManagerDis")}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var J=node.JSUS,Stager=exports.Stager={},blockTypes={BLOCK_DEFAULT:"__default",BLOCK_STAGEBLOCK:"__stageBlock_",BLOCK_STAGE:"__stage",BLOCK_STEPBLOCK:"__stepBlock_",BLOCK_STEP:"__step",BLOCK_ENCLOSING:"__enclosing_",BLOCK_ENCLOSING_STEPS:"__enclosing_steps",BLOCK_ENCLOSING_STAGES:"__enclosing_stages"};Stager.blockTypes=blockTypes,Stager.checkPositionsParameter=function(positions,method){var err;if(void 0===positions)return;"number"==typeof positions&&(isNaN(positions)||positions<0||!isFinite(positions)?err=!0:positions+="");if(err||"string"!=typeof positions||""===positions.trim())throw new TypeError("Stager."+method+": positions must be a non-empty string, a positive finite number, or undefined. Found: "+positions);return positions},Stager.addStageBlock=function(that,id,type,positions){var toClose;that.currentStage!==BLOCK_DEFAULT&&(toClose=type===BLOCK_STAGEBLOCK?1:2,that.endBlocks(toClose+that.openStepBlocks),that.openStepBlocks=0);addBlock(that,id,type,positions,BLOCK_STAGE)},Stager.addBlock=addBlock,Stager.checkFinalized=function(that,method){if(that.finalized)throw new Error("Stager."+method+": stager has been already finalized")},Stager.handleStepsArray=function(that,stageId,steps,method){var i,len;for(i=-1,len=steps.length;++i<len;)if("object"==typeof steps[i])that.addStep(steps[i]),steps[i]=steps[i].id;else{if("string"!=typeof steps[i])throw new TypeError("Stager."+method+": stage "+stageId+": each item in the steps  array must be string or object. Found: "+steps[i]);that.steps[steps[i]]||that.addStep({id:steps[i],cb:that.getDefaultCb()})}},Stager.makeDefaultCb=makeDefaultCb,Stager.isDefaultCb=function(cb){return cb._defaultCb},Stager.isDefaultStep=isDefaultStep,Stager.makeDefaultStep=makeDefaultStep,Stager.unmakeDefaultStep=function(step){step._defaultStep&&(step._defaultStep=null);return step},Stager.addStepToBlock=function(that,block,stepId,stageId,positions){var stepInBlock;if(block.hasItem(stepId))return!1;stepInBlock={type:stageId,item:stepId,id:stepId},isDefaultStep(that.steps[stepId])&&makeDefaultStep(stepInBlock);return block.add(stepInBlock,positions),!0};var BLOCK_DEFAULT=blockTypes.BLOCK_DEFAULT,BLOCK_STAGEBLOCK=blockTypes.BLOCK_STAGEBLOCK,BLOCK_STAGE=blockTypes.BLOCK_STAGE;function addBlock(that,id,type,positions,currentBlockType){var block;that.currentBlockType=currentBlockType,block=new node.Block({id:id||J.uniqueKey(that.blocksIds,type),type:type,positions:positions}),that.unfinishedBlocks.push(block),that.blocks.push(block),that.blocksIds[block.id]=that.blocks.length-1}function makeDefaultCb(cb){return void 0===cb&&(cb=function(){}),cb._defaultCb=!0,cb}function makeDefaultStep(step,cb){return"string"==typeof step&&(step={id:step,cb:makeDefaultCb(cb)}),step._defaultStep=!0,step}function isDefaultStep(step){return step._defaultStep}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.Block=Block;var J=parent.JSUS,Stager=parent.Stager,isDefaultStep=Stager.isDefaultStep,BLOCK_ENCLOSING_STEPS=Stager.blockTypes.BLOCK_ENCLOSING_STEPS;function Block(options){if("object"!=typeof options)throw new TypeError("Block constructor: options must be object: "+options);if("string"!=typeof options.type||""===options.type.trim())throw new TypeError("Block constructor: options.type must be a non-empty string: "+options.type);if("string"!=typeof options.id||""===options.id.trim())throw new TypeError("Block constructor: options.id must be a non-empty string: "+options.id);this.type=options.type,this.id=options.id,this.positions=void 0!==options.positions?options.positions:"linear",this.takenPositions=[],this.items=[],this.itemsIds={},this.unfinishedItems=[],this.index=0,this.finalized=!1,this.resetCache=null}function sortFunction(left,right){return left.positions.length<=right.positions.length?1:-1}Block.prototype.add=function(item,positions){if(this.finalized)throw new Error("Block.add: block already finalized, cannot add further items");if("string"!=typeof item.id)throw new TypeError("Block.add: block "+this.id+": item id must be string: "+item.id||"undefined");if("string"!=typeof item.type)throw new TypeError("Block.add: block "+this.id+": item type must be string: "+item.type||"undefined");if(this.itemsIds[item.id])throw new TypeError("Block.add: block "+this.id+": item was already added to block: "+item.id);void 0===positions&&(positions="linear"),this.unfinishedItems.push({item:item,positions:positions}),this.itemsIds[item.id]=!0},Block.prototype.remove=function(itemId){var i,len;if(this.finalized)throw new Error("Block.remove: block already finalized, cannot remove items.");if(this.hasItem(itemId)){for(i=-1,len=this.unfinishedItems.length;++i<len;)if(this.unfinishedItems[i].item.id===itemId)return this.itemsIds[itemId]=null,this.resetCache&&this.resetCache.unfinishedItems[itemId]&&delete this.resetCache.unfinishedItems[itemId],this.unfinishedItems.splice(i,1);throw new Error("Block.remove: item "+itemId+" was found in the in the itemsIds list, but could not be removed from block "+this.id)}},Block.prototype.removeAllItems=function(){var i,len;if(this.finalized)throw new Error("Block.remove: block already finalized, cannot remove items.");for(i=-1,len=this.unfinishedItems.length;++i<len;)this.remove(this.unfinishedItems[0].item.id)},Block.prototype.hasItem=function(itemId){return!!this.itemsIds[itemId]},Block.prototype.finalize=function(){var entry,item,positions,i,len,chosenPosition,available;if(!this.finalized)if(this.unfinishedItems.length){for(this.isType(BLOCK_ENCLOSING_STEPS)&&this.size()>1&&isDefaultStep(this.unfinishedItems[0].item)&&(this.itemsIds[this.unfinishedItems[0].item.id]=null,this.unfinishedItems.splice(0,1)),i=-1,len=this.unfinishedItems.length;++i<len;)"linear"===this.unfinishedItems[i].positions&&(this.unfinishedItems[i].positions=i);for(available=J.seq(0,this.size()-1),i=-1,len=this.unfinishedItems.length;++i<len;)positions=this.unfinishedItems[i].positions,this.unfinishedItems[i].positions=J.range(positions,available);for(;this.unfinishedItems.length>0;){if(this.unfinishedItems.sort(sortFunction),item=(entry=this.unfinishedItems.pop()).item,0===(positions=entry.positions).length)throw new Error("Block.finalize: no valid position for entry "+item.id+" in Block "+this.id);for(chosenPosition=positions[J.randomInt(0,positions.length)-1],this.items[chosenPosition]=item,this.takenPositions.push(chosenPosition),i=-1,len=this.unfinishedItems.length;++i<len;)J.removeElement(chosenPosition,this.unfinishedItems[i].positions)}this.finalized=!0}else this.finalized=!0},Block.prototype.next=function(){var item;return this.index<this.items.length&&((item=this.items[this.index])instanceof Block?!1===(item=item.next())?(this.index++,this.next()):item:(this.index++,item))},Block.prototype.backup=function(){this.resetCache=J.classClone({takenPositions:this.takenPositions,unfinishedItems:this.unfinishedItems,items:this.items,itemsIds:this.itemsIds},3)},Block.prototype.restore=function(){this.index=0,this.finalized=!1,this.resetCache&&(this.unfinishedItems=this.resetCache.unfinishedItems,this.takenPositions=this.resetCache.takenPositions,this.items=this.resetCache.items,this.itemsIds=this.resetCache.itemsIds,this.resetCache=null)},Block.prototype.size=function(){return this.items.length+this.unfinishedItems.length},Block.prototype.isType=Block.prototype.isOfType=function(type){return this.type===type},Block.prototype.clone=function(){var block;return(block=new Block({type:this.type,id:this.id})).positions=J.clone(this.positions),block.takenPositions=J.clone(this.takenPositions),block.items=J.clone(this.items),block.itemsIds=this.itemsIds,block.unfinishedItems=J.clone(this.unfinishedItems),block.index=this.index,block.finalized=this.finalized,block.resetCache=J.clone(this.resetCache),block}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var J=parent.JSUS,tmpStager=parent.Stager;J.mixin(Stager,tmpStager),exports.Stager=Stager;var blockTypes=Stager.blockTypes,isDefaultStep=Stager.isDefaultStep;function Stager(stateObj){if(this.sequence=[],this.stages={},this.steps={},this.blocks=[],this.blocksIds={},this.unfinishedBlocks=[],this.openStepBlocks=0,this.currentStage=blockTypes.BLOCK_DEFAULT,this.currentBlockType=blockTypes.BLOCK_DEFAULT,this.generalNextFunction=null,this.nextFunctions={},this.setDefaultStepRule(),this.defaultGlobals={},this.defaultProperties={},this.onInit=null,this.onGameover=null,this.finalized=!1,this.toSkip={stages:{},steps:{}},this.defaultCallback=Stager.defaultCallback,this.cacheReset={unfinishedBlocks:[]},this.log=console.log,stateObj){if("object"!=typeof stateObj)throw new TypeError("Stager: stateObj must be object. Found: "+stateObj);this.setState(stateObj)}else this.stageBlock(blockTypes.BLOCK_DEFAULT,"linear")}Stager.defaultCallback=function(){this.node.log(this.getCurrentStepObj().id)},Stager.makeDefaultCb(Stager.defaultCallback),Stager.prototype.clear=function(){return this.steps={},this.stages={},this.sequence=[],this.openStepBlocks=0,this.generalNextFunction=null,this.nextFunctions={},this.setDefaultStepRule(),this.defaultGlobals={},this.defaultProperties={},this.onInit=null,this.onGameover=null,this.blocks=[],this.blocksIds={},this.unfinishedBlocks=[],this.finalized=!1,this.currentStage=blockTypes.BLOCK_DEFAULT,this.currentBlockType=blockTypes.BLOCK_DEFAULT,this.toSkip={stages:{},steps:{}},this.defaultCallback=Stager.defaultCallback,this.cacheReset={unfinishedBlocks:[]},this},Stager.prototype.init=function(){return this.clear(),this.stageBlock(blockTypes.BLOCK_DEFAULT,"linear"),this},Stager.prototype.finalize=function(){var currentItem,stageId,stepId,outermostBlock,blockIndex,i,len,seqItem;if(!this.finalized&&this.blocks.length){for(i=-1,len=this.unfinishedBlocks.length;++i<len;)this.cacheReset.unfinishedBlocks.push(this.unfinishedBlocks[i].id);for(blockIndex=0;blockIndex<this.blocks.length;++blockIndex)this.blocks[blockIndex].backup();for(this.endAllBlocks(),blockIndex=0;blockIndex<this.blocks.length;++blockIndex)this.blocks[blockIndex].finalize();for(currentItem=(outermostBlock=this.blocks[0]).next();currentItem;){if(currentItem.type===blockTypes.BLOCK_STAGE)stageId=currentItem.item.id,"gameover"!==currentItem.item.type&&this.isSkipped(stageId)||((seqItem=J.clone(currentItem.item)).steps=[],this.sequence.push(seqItem));else if(stageId=currentItem.type,stepId=currentItem.item,!(this.isSkipped(stageId,stepId)||isDefaultStep(this.steps[stepId])&&1!==this.stages[stageId].steps.length))for(i=-1,len=this.sequence.length;++i<len;)if(this.sequence[i].id===stageId){this.sequence[i].steps.push(stepId);break}currentItem=outermostBlock.next()}this.finalized=!0}},Stager.prototype.reset=function(){var blockIdx,i,len;if(!this.finalized)return this;if(len=this.cacheReset.unfinishedBlocks.length){for(i=-1;++i<len;)blockIdx=this.blocksIds[this.cacheReset.unfinishedBlocks[i]],this.unfinishedBlocks.push(this.blocks[blockIdx]);this.cacheReset={unfinishedBlocks:[]}}for(blockIdx=0;blockIdx<this.blocks.length;++blockIdx)this.blocks[blockIdx].restore();this.sequence=[],this.finalized=!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var J=node.JSUS,Stager=node.Stager,checkPositionsParameter=Stager.checkPositionsParameter,addStageBlock=Stager.addStageBlock,addBlock=Stager.addBlock,checkFinalized=Stager.checkFinalized,handleStepsArray=Stager.handleStepsArray,makeDefaultStep=Stager.makeDefaultStep,addStepToBlock=Stager.addStepToBlock,blockTypes=Stager.blockTypes,BLOCK_STAGE=blockTypes.BLOCK_STAGE,BLOCK_STEPBLOCK=blockTypes.BLOCK_STEPBLOCK,BLOCK_STEP=blockTypes.BLOCK_STEP,BLOCK_ENCLOSING=blockTypes.BLOCK_ENCLOSING,BLOCK_ENCLOSING_STEPS=blockTypes.BLOCK_ENCLOSING_STEPS,BLOCK_ENCLOSING_STAGES=blockTypes.BLOCK_ENCLOSING_STAGES;function addLoop(that,type,stage,loopFunc,positions){var stageName;if(checkFinalized(that,type),stageName=handleStageParameter(that,stage,type),"function"!=typeof loopFunc)throw new TypeError("Stager."+type+": loopFunc must be function. Found: "+loopFunc);return addStageToCurrentBlock(that,{type:type,id:stageName,cb:loopFunc},positions=checkPositionsParameter(positions,type)),addStepsToCurrentBlock(that,that.stages[stageName].steps),that}function addStageToCurrentBlock(that,stage,positions){var name,rndName;name=stage.id||stage.type,rndName="_"+Math.floor((that.blocks.length+1)/2),addStageBlock(that,BLOCK_ENCLOSING+name+rndName,BLOCK_ENCLOSING_STAGES,positions),that.getCurrentBlock().add({type:BLOCK_STAGE,item:stage,id:stage.id}),that.currentStage=name,addBlock(that,BLOCK_ENCLOSING+name+"_steps"+rndName,BLOCK_ENCLOSING_STEPS,"linear",BLOCK_STEP)}function addStepsToCurrentBlock(that,steps){var curBlock,i,len;for(curBlock=that.getCurrentBlock(),i=-1,len=steps.length;++i<len;)addStepToBlock(that,curBlock,steps[i],that.currentStage)}function handleStageParameter(that,stage,method){var tokens,id,alias;if("object"==typeof stage){if(id=stage.id,that.stages[id])throw new Error("Stager."+method+": stage is object, but a stage with the same id already exists: "+id);if(stage.cb||stage.steps){if(stage.cb){if(that.steps[id])throw new Error("Stager."+method+": stage has cb property, but a step with the same id is already defined: "+id);that.addStep({id:id,cb:stage.cb}),delete stage.cb,stage.steps=[id]}}else stage.steps=[id],that.steps[id]||that.addStep({id:id,cb:that.getDefaultCb()});that.addStage(stage)}else{if("string"!=typeof stage)throw new TypeError("Stager."+method+": stage must be string or object. Found: "+stage);tokens=function(that,nameAndAlias,method){var tokens,id,alias;if(tokens=function(nameAndAlias){var tokens;return{id:(tokens=nameAndAlias.split(" AS "))[0].trim(),alias:tokens[1]?tokens[1].trim():void 0}}(nameAndAlias),(id=tokens.id)===(alias=tokens.alias))throw new Error("Stager."+method+": id equal to alias: "+nameAndAlias);if(alias&&!that.stages[id])throw new Error("Stager."+method+": alias is referencing non-existing stage: "+id);if(alias&&that.stages[alias])throw new Error("Stager."+method+": alias is not unique: "+alias);return tokens}(that,stage,method),alias=tokens.alias,id=tokens.id,alias?that.stages[alias]=that.stages[id]:that.stages[id]||(that.steps[id]||that.addStep(makeDefaultStep(id,that.getDefaultCb())),that.addStage({id:id,steps:[id]}))}return alias||id}function checkStageStepId(method,s,id){if("string"!=typeof id)throw new TypeError("Stager."+method+": "+s+".id must be string. Found: "+id);if(""===id.trim())throw new TypeError("Stager."+method+": "+s+".id cannot be an empty string.");if(-1!==id.lastIndexOf("."))throw new Error("Stager."+method+": "+s+".id cannot contains dots. Found: "+id);if(/^\d+$/.test(id.charAt(0)))throw new Error("Stager."+method+": "+s+".id cannot begin with a number. Found: "+id)}Stager.prototype.createStep=Stager.prototype.addStep=function(step){if(function(step,method){if(null===step||"object"!=typeof step)throw new TypeError("Stager."+method+": step must be object. Found: "+step);if("function"!=typeof step.cb)throw new TypeError("Stager."+method+": step.cb must be function. Found: "+step.cb);checkStageStepId(method,"step",step.id)}(step,"addStep"),this.steps.hasOwnProperty(step.id))throw new Error('Stager.addStep: step "'+step.id+'" already existing, use extendStep to modify it');this.steps[step.id]=step},Stager.prototype.createStage=Stager.prototype.addStage=function(stage){var id;if(function(stage,method){if("object"!=typeof stage)throw new TypeError("Stager."+method+": stage must be object. Found: "+stage);if(!stage.steps&&!stage.cb||stage.steps&&stage.cb)throw new TypeError("Stager."+method+": stage must have either a steps or a cb property");if(J.isArray(stage.steps)){if(!stage.steps.length)throw new Error("Stager."+method+": stage.steps cannot be empty")}else if(stage.steps)throw new TypeError("Stager."+method+": stage.steps must be array or undefined.  Found: "+stage.steps);checkStageStepId(method,"stage",stage.id)}(stage,"addStage"),id=stage.id,this.stages.hasOwnProperty(id))throw new Error('Stager.addStage: stage "'+id+'" already existing, use extendStage to modify it');stage.cb?(this.addStep({id:id,cb:stage.cb}),delete stage.cb,stage.steps=[id]):handleStepsArray(this,id,stage.steps,"addStage"),this.stages[id]=stage},Stager.prototype.cloneStep=function(stepId,newStepId){var step;if("string"!=typeof stepId)throw new TypeError("Stager.cloneStep: stepId must be string. Found: "+stepId);if("string"!=typeof newStepId)throw new TypeError("Stager.cloneStep: newStepId must be string. Found: "+newStepId);if(this.steps[newStepId])throw new Error("Stager.cloneStep: newStepId already taken: "+newStepId);if(!(step=this.steps[stepId]))throw new Error("Stager.cloneStep: step not found: "+stepId);return(step=J.clone(step)).id=newStepId,this.addStep(step),step},Stager.prototype.cloneStage=function(stageId,newStageId){var stage;if("string"!=typeof stageId)throw new TypeError("Stager.cloneStage: stageId must be string.Found: "+stageId);if("string"!=typeof newStageId)throw new TypeError("Stager.cloneStage: newStageId must be string. Found: "+newStageId);if(this.stages[newStageId])throw new Error("Stager.cloneStage: newStageId already taken: "+newStageId+".");if(!(stage=this.stages[stageId]))throw new Error("Stager.cloneStage: stage not found: "+stageId);return(stage=J.clone(stage)).id=newStageId,this.addStage(stage),stage},Stager.prototype.step=function(step,positions){var id,curBlock;if(!(curBlock=this.getCurrentBlock()).isType(BLOCK_ENCLOSING_STEPS)&&!curBlock.isType(BLOCK_STEPBLOCK))throw new Error('Stager.step: step "'+step+'" cannot be added here. Have you add at least one stage?');return checkFinalized(this,"step"),id=function(that,step,method){var id;if("object"==typeof step){if(id=step.id,that.steps[id])throw new Error("Stager."+method+": step is object, but a step with the same id already exists: "+id);step.cb||(step.cb=that.getDefaultCallback())}else{if("string"!=typeof step)throw new TypeError("Stager."+method+": step must be string or object. Found: "+step);step={id:id=step,cb:that.getDefaultCallback()}}that.steps[id]||that.addStep(step);return id}(this,step,"step"),positions=checkPositionsParameter(positions,"step"),addStepToBlock(this,curBlock,id,this.currentStage,positions),this.stages[this.currentStage].steps.push(id),this},Stager.prototype.stage=Stager.prototype.next=function(stage,positions){var stageName;return checkFinalized(this,"next"),addStageToCurrentBlock(this,{type:"plain",id:stageName=handleStageParameter(this,stage,"next")},positions=checkPositionsParameter(positions,"next")),addStepsToCurrentBlock(this,this.stages[stageName].steps),this},Stager.prototype.repeatStage=Stager.prototype.repeat=function(stage,nRepeats,positions){var stageName;if(checkFinalized(this,"repeat"),stageName=handleStageParameter(this,stage,"next"),"number"!=typeof nRepeats||isNaN(nRepeats)||nRepeats<=0)throw new Error("Stager.repeat: nRepeats must be a positive number. Found: "+nRepeats);return positions=checkPositionsParameter(positions,"repeat"),addStageToCurrentBlock(this,{type:"repeat",id:stageName,num:parseInt(nRepeats,10)},positions),addStepsToCurrentBlock(this,this.stages[stageName].steps),this},Stager.prototype.loopStage=Stager.prototype.loop=function(stage,loopFunc,positions){return addLoop(this,"loop",stage,loopFunc,positions)},Stager.prototype.doLoopStage=Stager.prototype.doLoop=function(stage,loopFunc,positions){return addLoop(this,"doLoop",stage,loopFunc,positions)},Stager.prototype.gameover=function(){return addStageToCurrentBlock(this,{id:"gameover",type:"gameover"}),this}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var J=node.JSUS,Stager=node.Stager,stepRules=node.stepRules,isDefaultCb=Stager.isDefaultCb,makeDefaultCb=Stager.makeDefaultCb;Stager.prototype.setState=function(stateObj,updateRule){var idx,stageObj,seqObj,blockObj;if("object"!=typeof stateObj)throw new TypeError("Stager.setState: stateObj must be object. Found: "+stageObj);if("string"!=typeof(updateRule=updateRule||"replace"))throw new TypeError("Stager.setState: updateRule must be string or undefined. Found: "+updateRule);if("replace"===updateRule)this.clear();else if("append"!==updateRule)throw new Error("Stager.setState: invalid updateRule: "+updateRule);for(idx in stateObj.steps)stateObj.steps.hasOwnProperty(idx)&&this.addStep(stateObj.steps[idx]);for(idx in stateObj.stages)stageObj=stateObj.stages[idx],stateObj.stages.hasOwnProperty(idx)&&stageObj.id===idx&&this.addStage(stageObj);for(idx in stateObj.stages)stageObj=stateObj.stages[idx],stateObj.stages.hasOwnProperty(idx)&&stageObj.id!==idx&&(this.stages[idx]=this.stages[stageObj.id]);if(stateObj.hasOwnProperty("openStepBlocks")&&(this.openStepBlocks=stateObj.openStepBlocks),stateObj.hasOwnProperty("sequence"))for(idx=0;idx<stateObj.sequence.length;idx++)seqObj=stateObj.sequence[idx],this.sequence[idx]=seqObj;for(idx in stateObj.hasOwnProperty("generalNextFunction")&&this.registerGeneralNext(stateObj.generalNextFunction),stateObj.nextFunctions)stateObj.nextFunctions.hasOwnProperty(idx)&&this.registerNext(idx,stateObj.nextFunctions[idx]);if(stateObj.hasOwnProperty("defaultStepRule")&&this.setDefaultStepRule(stateObj.defaultStepRule),stateObj.hasOwnProperty("defaultGlobals")&&this.setDefaultGlobals(stateObj.defaultGlobals),stateObj.hasOwnProperty("defaultProperties")&&this.setDefaultProperties(stateObj.defaultProperties),stateObj.hasOwnProperty("onInit")&&this.setOnInit(stateObj.onInit),stateObj.hasOwnProperty("onGameover")&&this.setOnGameover(stateObj.onGameover),stateObj.hasOwnProperty("toSkip")&&(this.toSkip=stateObj.toSkip),stateObj.hasOwnProperty("defaultCallback")&&this.setDefaultCallback(stateObj.defaultCallback),stateObj.hasOwnProperty("cacheReset")&&(this.cacheReset=stateObj.cacheReset),stateObj.hasOwnProperty("blocks"))for(this.blocksIds={},idx=0;idx<stateObj.blocks.length;idx++)blockObj=stateObj.blocks[idx],this.blocks[idx]=blockObj,this.blocksIds[blockObj.id]=idx;stateObj.hasOwnProperty("currentStage")&&(this.currentStage=stateObj.currentStage),stateObj.hasOwnProperty("currentBlockType")&&(this.currentBlockType=stateObj.currentBlockType),this.finalized=!0},Stager.prototype.getState=function(finalize){var out,i,len;for((finalize=void 0===finalize||!!finalize)&&this.finalize(),(out=J.clone({steps:this.steps,stages:this.stages,sequence:this.sequence,generalNextFunction:this.generalNextFunction,nextFunctions:this.nextFunctions,defaultStepRule:this.defaultStepRule,defaultGlobals:this.defaultGlobals,defaultProperties:this.defaultProperties,onInit:this.onInit,onGameover:this.onGameover,toSkip:this.toSkip,defaultCallback:this.defaultCallback,cacheReset:this.cacheReset,currentStage:this.currentStage,currentBlockType:this.currentBlockType,openStepBlocks:this.openStepBlocks})).blocks=[],i=-1,len=this.blocks.length;++i<len;)out.blocks.push(this.blocks[i].clone());if(!finalize)for(out.unfinishedBlocks=[],i=-1,len=this.unfinishedBlocks.length;++i<len;)out.unfinishedBlocks.push(this.unfinishedBlocks[i].clone());return out},Stager.prototype.setDefaultStepRule=function(stepRule){if(stepRule){if("function"!=typeof stepRule)throw new TypeError("Stager.setDefaultStepRule: stepRule must be function or undefined. Found: "+stepRule);this.defaultStepRule=stepRule}else this.defaultStepRule=stepRules.SOLO},Stager.prototype.getDefaultStepRule=function(){return this.defaultStepRule},Stager.prototype.setDefaultCallback=function(cb){var i;if(null===cb)cb=Stager.defaultCallback;else if("function"!=typeof cb)throw new TypeError("Stager.setDefaultCallback: defaultCallback must be function or null. Found: "+cb);for(i in this.defaultCallback=makeDefaultCb(cb),this.steps)this.steps.hasOwnProperty(i)&&isDefaultCb(this.steps[i].cb)&&(this.steps[i].cb=this.defaultCallback)},Stager.prototype.getDefaultCb=Stager.prototype.getDefaultCallback=function(){return this.defaultCallback||Stager.defaultCallback},Stager.prototype.setDefaultGlobals=function(defaultGlobals,mixin){if(!defaultGlobals||"object"!=typeof defaultGlobals)throw new TypeError("Stager.setDefaultGlobals: defaultGlobals must be object. Found: "+defaultGlobals);mixin?J.mixin(this.defaultGlobals,defaultGlobals):this.defaultGlobals=defaultGlobals},Stager.prototype.getDefaultGlobals=function(){return this.defaultGlobals},Stager.prototype.setDefaultProperty=function(name,value){if("string"!=typeof name)throw new TypeError("Stager.setDefaultProperty: name must be string. Found: "+name);this.defaultProperties[name]=value},Stager.prototype.setDefaultProperties=function(defaultProperties,mixin){if(!defaultProperties||"object"!=typeof defaultProperties)throw new TypeError("Stager.setDefaultProperties: defaultProperties must be object. Found: "+defaultProperties);mixin?J.mixin(this.defaultProperties,defaultProperties):this.defaultProperties=defaultProperties},Stager.prototype.getDefaultProperties=function(){return this.defaultProperties},Stager.prototype.setOnInit=function(func){if(func&&"function"!=typeof func)throw new TypeError("Stager.setOnInit: func must be function or undefined. Found: "+func);this.onInit=func},Stager.prototype.getOnInit=function(){return this.onInit},Stager.prototype.setOnGameover=function(func){if(func&&"function"!=typeof func)throw new Error("Stager.setOnGameover: func must be function or undefined.");this.onGameover=func},Stager.prototype.setOnGameOver=Stager.prototype.setOnGameover,Stager.prototype.getOnGameover=function(){return this.onGameover},Stager.prototype.getOnGameOver=Stager.prototype.getOnGameover}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var Stager=node.Stager;Stager.prototype.registerGeneralNext=function(func){if(null!==func&&"function"!=typeof func)throw new TypeError("Stager.registerGeneralNext: func must be function or undefined. Found: "+func);this.generalNextFunction=func},Stager.prototype.registerNext=function(id,func){if("function"!=typeof func)throw new TypeError("Stager.registerNext: func must be function. Found: "+func);if(!this.stages[id])throw new TypeError("Stager.registerNext: non existent stage id: "+id);this.nextFunctions[id]=func}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var J=node.JSUS,Stager=node.Stager,checkFinalized=Stager.checkFinalized,handleStepsArray=Stager.handleStepsArray,addStepToBlock=Stager.addStepToBlock,isDefaultStep=Stager.isDefaultStep,unmakeDefaultStep=Stager.unmakeDefaultStep;function setSkipStageStepArray(that,stageId,stepId,value,method){if(J.isArray(stageId)&&1===stageId.length&&(stageId=stageId[0]),J.isArray(stepId)&&1===stepId.length&&(stepId=stepId[0]),J.isArray(stageId)&&J.isArray(stepId))throw new Error("Staker."+method+": stageId and stepId cannot be both arrays of length > 1");J.isArray(stageId)?stageId.forEach((_stageId=>{setSkipStageStep(that,_stageId,stepId,value,method)})):J.isArray(stepId)?stepId.forEach((_stepId=>{setSkipStageStep(that,stageId,_stepId,value,method)})):setSkipStageStep(that,stageId,stepId,value,method)}function setSkipStageStep(that,stageId,stepId,value,method){var allStepsSkipped,steps,i;if("string"!=typeof stageId||""===stageId.trim())throw new TypeError("Stager."+method+": stageId must be a non-empty string. Found: "+stageId);if(that.stages[stageId]||console.log("**warn: Stager."+method+': unknown stage: "'+stageId+'" (you may still add it later)'),stepId){if("string"!=typeof stepId||""===stepId.trim())throw new TypeError("Stager."+method+": stepId must be a non-empty string or undefined.Found: "+stepId);return that.steps[stepId]||console.log("**warn: Stager."+method+': unknown step: "'+stepId+'" (you may still add it later)'),void 0!==value&&(that.toSkip.steps[stageId+"."+stepId]=value),that.toSkip.stages[stageId]||that.toSkip.steps[stageId+"."+stepId]}if(void 0!==value&&(that.toSkip.stages[stageId]=value),that.toSkip.stages[stageId])return!0;for(allStepsSkipped=!0,steps=that.stages[stageId].steps,i=0;i<steps.length;i++)if(!(0===i&&steps.length>1&&isDefaultStep(that.steps[steps[i]])||that.toSkip.steps[stageId+"."+steps[i]])){allStepsSkipped=!1;break}return allStepsSkipped}function validateExtendedStep(stepId,update,updateFunction){var errBegin;if(updateFunction){if(errBegin="Stager.extendStep: update function must return an object with ",!update||"object"!=typeof update)throw new TypeError(errBegin+"id and cb. Found: "+update+". Step id: "+stepId);if(update.id!==stepId)throw new Error("Stager.extendStep: update function cannot alter the step id: "+stepId);if("function"!=typeof update.cb)throw new TypeError(errBegin+"a valid callback. Step id:"+stepId);if(update.init&&"function"!=typeof update.init)throw new TypeError(errBegin+"invalid init property. Function or undefined expected, found: "+typeof update.init+". Step id:"+stepId);if(update.exit&&"function"!=typeof update.exit)throw new TypeError(errBegin+"invalid exit property. Function or undefined expected, found: "+typeof update.exit+". Step id:"+stepId);if(update.done&&"function"!=typeof update.done)throw new TypeError(errBegin+"invalid done property. Function or undefined expected, found: "+typeof update.done+". Step id:"+stepId)}else{if(update.hasOwnProperty("id"))throw new Error("Stager.extendStep: update.id cannot be set. Step id: "+stepId);if(update.cb&&"function"!=typeof update.cb)throw new TypeError("Stager.extendStep: update.cb must be function or undefined. Step id:"+stepId);if(update.init&&"function"!=typeof update.init)throw new TypeError("Stager.extendStep: update.init must be function or undefined. Step id:"+stepId);if(update.exit&&"function"!=typeof update.exit)throw new TypeError("Stager.extendStep: update.exit must be function or undefined. Step id:"+stepId);if(update.done&&"function"!=typeof update.done)throw new TypeError("Stager.extendStep: update.done must be function or undefined. Step id:"+stepId)}}function validateExtendedStage(that,stageId,update,updateFunction){var block,i,len;if(updateFunction&&update.id!==stageId||!updateFunction&&update.hasOwnProperty("id"))throw new Error("Stager.extendStage: id cannot be altered: "+stageId);if(update.cb)throw new TypeError("Stager.extendStage: update.cb cannot be specified. Stage id: "+stageId);if(update.init&&"function"!=typeof update.init)throw new TypeError("Stager.extendStage: update.init must be function or undefined. Stage id:"+stageId);if(update.exit&&"function"!=typeof update.exit)throw new TypeError("Stager.extendStage: update.exit must be function or undefined. Stage id:"+stageId);if(update.done&&"function"!=typeof update.done)throw new TypeError("Stager.extendStage: update.done must be function or undefined. Stage id:"+stageId);if(update.steps){if(!J.isArray(update.steps))throw new Error("Stager.extendStage: update.steps must be array or undefined. Stage id: "+stageId+"Found: "+update.steps);if(!update.steps.length)throw new Error("Stager.extendStage: update.steps is an empty array. Stage id: "+stageId);if(J.equals(that.stages[stageId].steps,update.steps))return;if(handleStepsArray(that,stageId,update.steps,"extendStage"),!(block=that.findBlockWithItem(stageId)))return;for((block=void 0!==block.unfinishedItems[1]?block.unfinishedItems[1].item:that.blocks[that.blocks.length-1]).removeAllItems(),i=-1,len=update.steps.length;++i<len;)isDefaultStep(that.steps[update.steps[i]])&&unmakeDefaultStep(that.steps[update.steps[i]]),addStepToBlock(that,block,update.steps[i],stageId)}}Stager.prototype.extendStep=function(stepId,update){var step;if("string"!=typeof stepId)throw new TypeError("Stager.extendStep: stepId must be string. Found: "+stepId);if(!(step=this.steps[stepId]))throw new Error("Stager.extendStep: stepId not found: "+stepId);if("function"==typeof update)validateExtendedStep(stepId,step=update(J.clone(step)),!0),this.steps[stepId]=step;else{if(!update||"object"!=typeof update)throw new TypeError('Stager.extendStep: step "'+stepId+'": update must be object or function. Found: '+update);validateExtendedStep(stepId,update,!1),J.mixin(step,update)}},Stager.prototype.extendStage=function(stageId,update){var stage;if("string"!=typeof stageId)throw new TypeError("Stager.extendStage: stageId must be string. Found: "+stageId);if(!(stage=this.stages[stageId]))throw new Error("Stager.extendStage: stageId not found: "+stageId);if("function"==typeof update){if(!(stage=update(J.clone(stage)))||"object"!=typeof stage||!stage.id||!stage.steps)throw new TypeError("Stager.extendStage: update function must return an object with id and steps. Found: "+stage);validateExtendedStage(this,stageId,stage,!0),this.stages[stageId]=stage}else{if(!update||"object"!=typeof update)throw new TypeError('Stager.extendStage: stage "'+stageId+'": update must be object or function. Found: '+update);validateExtendedStage(this,stageId,update,!1),J.mixin(stage,update)}},Stager.prototype.extendAllSteps=function(update){var step;for(step in this.steps)this.steps.hasOwnProperty(step)&&this.extendStep(step,update)},Stager.prototype.extendSteps=function(stepIds,update){if(!J.isArray(stepIds))throw new TypeError("Stager.extendSteps: stepIds must be array. Found: "+stepIds);stepIds.forEach((stepId=>{this.steps[stepId]?this.extendStep(stepId,update):console.log('**warn: Stager.extendSteps: step with id " '+stepId+'" not found')}))},Stager.prototype.extendAllStages=function(update){var stage;for(stage in this.stages)this.stages.hasOwnProperty(stage)&&this.extendStage(stage,update)},Stager.prototype.extendStages=function(stageIds,update){if(!J.isArray(stageIds))throw new TypeError("Stager.extendSteps: stageIds must be array. Found: "+stageIds);stageIds.forEach((stageId=>{this.stages[stageId]?this.extendStage(stageId,update):console.log('**warn: Stager.extendStages: stage with id " '+stageId+'" not found')}))},Stager.prototype.skip=function(stageId,stepId){checkFinalized(this,"skip"),setSkipStageStepArray(this,stageId,stepId,!0,"skip")},Stager.prototype.unskip=function(stageId,stepId){checkFinalized(this,"unskip"),setSkipStageStepArray(this,stageId,stepId,!1,"unskip")},Stager.prototype.isSkipped=function(stageId,stepId){return!!setSkipStageStep(this,stageId,stepId,void 0,"isSkipped")}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var Stager=node.Stager,checkPositionsParameter=Stager.checkPositionsParameter,addStageBlock=Stager.addStageBlock,addBlock=Stager.addBlock,blockTypes=Stager.blockTypes,BLOCK_DEFAULT=blockTypes.BLOCK_DEFAULT,BLOCK_STAGEBLOCK=blockTypes.BLOCK_STAGEBLOCK,BLOCK_STEPBLOCK=blockTypes.BLOCK_STEPBLOCK,BLOCK_STEP=blockTypes.BLOCK_STEP,BLOCK_ENCLOSING=blockTypes.BLOCK_ENCLOSING,BLOCK_ENCLOSING_STEPS=blockTypes.BLOCK_ENCLOSING_STEPS;Stager.prototype.stepBlock=function(id,positions){var curBlock,err;if(1===arguments.length)console.log("***deprecation warning: Stager.stepBlock will require two parameters in the next version.***"),positions=id;else{if("string"!=typeof id||""===id.trim())throw new TypeError("Stager.stepBlock: id must be a non-empty string. Found: "+id);if(this.blocksIds[id])throw new Error("Stager.stepBlock: non-unique id: "+id)}if(!(curBlock=this.getCurrentBlock())||curBlock.id===BLOCK_DEFAULT||!curBlock.isType(BLOCK_ENCLOSING_STEPS)&&!curBlock.isType(BLOCK_STEPBLOCK))throw err="Stager.stepBlock: block ",id&&(err+='"'+id+'"'),err+="cannot be added here. Did add at least one stage before?",new Error(err);if(curBlock.isType(BLOCK_STEPBLOCK)&&0===curBlock.size())throw err="Stager.stepBlock: block ",id&&(err+='"'+id+'"'),err+="cannot be added here. Did add at least one step in the previous step block?",new Error(err);return checkPositionsParameter(positions,"stepBlock"),addBlock(this,id,BLOCK_STEPBLOCK,positions,BLOCK_STEP),this.openStepBlocks++,this},Stager.prototype.stageBlock=function(id,positions){var curBlock,err;if(1===arguments.length)console.log("***deprecation warning: Stager.stageBlock will require two parameters in the next version.***"),positions=id;else{if("string"!=typeof id||""===id.trim())throw new TypeError("Stager.stageBlock: id must be a non-empty string. Found: "+id);if(this.blocksIds[id])throw new Error("Stager.stageBlock: non-unique id: "+id)}if((curBlock=this.getCurrentBlock())&&curBlock.id!==BLOCK_DEFAULT&&curBlock.isType(BLOCK_STAGEBLOCK))throw err="Stager.stageBlock: block ",id&&(err+='"'+id+'"'),err+="cannot be added here. Did add at least one stage in the previous stage block?",new Error(err);return checkPositionsParameter(positions,"stageBlock"),addStageBlock(this,id,BLOCK_STAGEBLOCK,positions),this},Stager.prototype.getCurrentBlock=function(){return 0!==this.unfinishedBlocks.length&&this.unfinishedBlocks[this.unfinishedBlocks.length-1]},Stager.prototype.endBlock=function(options){var block,currentBlock,found,i;if(!this.unfinishedBlocks.length)return this;if(options=options||{},(block=this.unfinishedBlocks.pop()).isType(BLOCK_STEPBLOCK)){i=this.blocks.length-1;do{found=-1!==(currentBlock=this.blocks[i]).id.indexOf(BLOCK_ENCLOSING),i--}while(!found&&i>=0);if(!found)throw new Error("Stager.endBlock: could not find enclosing block for stepBlock "+block.name);currentBlock.add(block,block.positions)}else block.isType(BLOCK_STAGEBLOCK)?block.id!==BLOCK_DEFAULT&&-1===block.id.indexOf(BLOCK_ENCLOSING)&&this.blocks[0].add(block,block.positions):(currentBlock=this.getCurrentBlock())&&currentBlock.add(block,block.positions);return options.finalize&&block.finalize(),this},Stager.prototype.endBlocks=function(n,options){var i;for(i=0;i<n;++i)this.endBlock(options);return this},Stager.prototype.endAllBlocks=function(){this.endBlocks(this.unfinishedBlocks.length)},Stager.prototype.findBlockWithItem=function(itemId){var i,len;for(i=-1,len=this.blocks.length;++i<len;)if(this.blocks[i].hasItem(itemId))return this.blocks[i];return!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){var Stager=node.Stager;Stager.prototype.getSequence=function(format){var result,seqIdx,seqObj,stepPrefix;switch(format){case"hstages":for(seqIdx in result=[],this.sequence)if(this.sequence.hasOwnProperty(seqIdx))switch((seqObj=this.sequence[seqIdx]).type){case"gameover":result.push("[game over]");break;case"plain":result.push(seqObj.id);break;case"repeat":result.push(seqObj.id+" [x"+seqObj.num+"]");break;case"loop":result.push(seqObj.id+" [loop]");break;case"doLoop":result.push(seqObj.id+" [doLoop]");break;default:throw new Error("Stager.getSequence: unknownsequence object type: "+seqObj.type)}break;case"hsteps":for(seqIdx in result=[],this.sequence)if(this.sequence.hasOwnProperty(seqIdx))switch(seqObj=this.sequence[seqIdx],stepPrefix=seqObj.id+".",seqObj.type){case"gameover":result.push("[game over]");break;case"plain":seqObj.steps.map((function(stepID){result.push(stepPrefix+stepID)}));break;case"repeat":seqObj.steps.map((function(stepID){result.push(stepPrefix+stepID+" [x"+seqObj.num+"]")}));break;case"loop":seqObj.steps.map((function(stepID){result.push(stepPrefix+stepID+" [loop]")}));break;case"doLoop":seqObj.steps.map((function(stepID){result.push(stepPrefix+stepID+" [doLoop]")}));break;default:throw new Error("Stager.getSequence: unknownsequence object type: "+seqObj.type)}break;case"o":result=this.sequence;break;default:throw new Error("Stager.getSequence: invalid format: "+format)}return result},Stager.prototype.extractStage=function(ids,useSeq){var result,stepIdx,stepId,stageId,stageObj,idArray,idIdx,id;if(ids instanceof Array)idArray=ids;else{if("string"!=typeof ids)return null;idArray=[ids]}for(idIdx in result={steps:{},stages:{},sequence:[]},useSeq=!1!==useSeq,idArray)if(idArray.hasOwnProperty(idIdx)){if(id=idArray[idIdx],!(stageObj=this.stages[id]))return null;for(stepIdx in stageObj.steps)stageObj.steps.hasOwnProperty(stepIdx)&&(stepId=stageObj.steps[stepIdx],result.steps[stepId]=this.steps[stepId]);stageId=stageObj.id,result.stages[stageId]=stageObj,stageId!==id&&(result.stages[id]=stageObj),useSeq&&result.sequence.push({type:"plain",id:stageId})}return result}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports){"use strict";var types={};function checkContract(Proto){var test;return!!(test=new Proto).send&&!!test.connect}exports.SocketFactory={checkContract:checkContract,getTypes:function(){return types},get:function(node,type,options){var Socket=types[type];return Socket?new Socket(node,options):null},register:function(type,proto){if(type&&proto){if(!checkContract(proto))throw new Error("Cannot register invalid Socket class: "+type);types[type]=proto}}}}("undefined"!=typeof node?node:module.exports),function(exports,parent){"use strict";exports.Socket=Socket;var GameMsg=parent.GameMsg,SocketFactory=parent.SocketFactory,J=parent.JSUS;function Socket(node){this.buffer=[],this.session=null,this.userOptions={},this.socket=null,this.connected=!1,this.connecting=!1,this.reconnecting=!1,this.connectingTimeout=null,this.connectingTimeoutMs=1e4,this.url=null,this.channelName=null,this.type=null,this.emitOutMsg=!1,this.antiSpoofing=null,this.journalOn=!1,this.journal=new parent.NDDB({update:{indexes:!0}}),this.journal.player||this.journal.hash("to"),this.node=node}function logSecureParseError(text,e){var error;return text=text||"generic error while parsing a game message.",error=e?text+": "+e:text,this.node.err("Socket.secureParse: "+error),!1}Socket.prototype.setup=function(options){if(options){if("object"!=typeof options)throw new TypeError("Socket.setup: options must be object or undefined.");if((options=J.clone(options)).connectingTimeout){if(!J.isInt(options.connectingTimeout,0))throw new TypeError("Socket.setup: options.connectingTimeout a positive number or undefined.");this.connectingTimeoutMs=options.connectingTimeout}options.type&&(this.setSocketType(options.type,options),options.type=null),void 0!==options.emitOutMsg&&(this.emitOutMsg=options.emitOutMsg,options.emitOutMsg=null),this.userOptions=options}},Socket.prototype.setSocketType=function(type,options){if("string"!=typeof type)throw new TypeError("Socket.setSocketType: type must be string.");if(options&&"object"!=typeof options)throw new TypeError("Socket.setSocketType: options must be object or undefined.");if(this.socket=SocketFactory.get(this.node,type,options),!this.socket)throw new Error("Socket.setSocketType: type not found: "+type+".");return this.type=type,this.socket},Socket.prototype.connect=function(uri,options){var humanReadableUri,that;if(this.isConnected())throw new Error("Socket.connect: socket is already connected. Only one connection is allowed.");if(this.connecting)throw new Error("Socket.connecting: one connection attempt is already in progress. Please try again later.");if(uri&&"string"!=typeof uri)throw new TypeError("Socket.connect: uri must be string or undefined.");if(options){if("object"!=typeof options)throw new TypeError("Socket.connect: options must be object or undefined.");this.userOptions=options}if(humanReadableUri=uri||"local server",!this.socket)throw new Error("Socket.connet: cannot connet to "+humanReadableUri+" . No socket defined.");this.connecting=!0,this.url=uri,this.node.info("connecting to "+humanReadableUri+"."),this.node.emit("SOCKET_CONNECTING"),this.socket.connect(this.url,this.userOptions),this.connected||(that=this,this.connectingTimeout=setTimeout((function(){that.node.warn("connection attempt to "+humanReadableUri+" timed out. Disconnected."),that.socket.disconnect(),that.connecting=!1}),this.connectingTimeoutMs))},Socket.prototype.reconnect=function(force){if(!this.url)throw new Error("Socket.reconnect: cannot find previous uri.");!this.reconnecting||force?(this.reconnecting=!0,(this.connecting||this.isConnected())&&this.disconnect(),this.connect(this.url,this.userOptions),this.reconnecting=!1):node.warn("Socket.reconnect: socket is already reconnecting. Try with force parameter.")},Socket.prototype.disconnect=function(force){force||this.connecting||this.isConnected()?(this.socket.disconnect(),this.connecting=!1,this.connected=!1):node.warn("Socket.disconnect: socket is not connected nor connecting. Try with force parameter.")},Socket.prototype.onConnect=function(){this.connected=!0,this.connecting=!1,this.connectingTimeout&&clearTimeout(this.connectingTimeout),this.node.emit("SOCKET_CONNECT"),this.node.info("socket connected.")},Socket.prototype.onDisconnect=function(){this.connected=!1,this.connecting=!1,this.node.emit("SOCKET_DISCONNECT"),this.node.game.pl.clear(),this.node.game.ml.clear(),this.setMsgListener(this.onMessageHI),this.session=null,this.node.info("socket closed.")},Socket.prototype.secureParse=function(msg){var gameMsg;try{gameMsg=GameMsg.clone(JSON.parse(msg)),this.node.info("R: "+gameMsg)}catch(e){return logSecureParseError.call(this,"malformed msg received",e)}return gameMsg},Socket.prototype.validateIncomingMsg=function(gameMsg){return this.session&&gameMsg.session!==this.session?logSecureParseError.call(this,"mismatched session in incoming message."):gameMsg},Socket.prototype.onMessageHI=function(msg){if((msg=this.validateIncomingMsg(msg))&&"HI"===msg.target){if(msg.to===parent.constants.UNAUTH_PLAYER)return this.node.warn("connection was not authorized."),void("redirect"===msg.text?"undefined"!=typeof window&&(window.location=msg.data):this.disconnect());this.setMsgListener(),this.startSession(msg),this.node.emit("NODEGAME_READY")}},Socket.prototype.onMessageFull=function(msg){(msg=this.validateIncomingMsg(msg))&&(msg.priority>0||this.node.game.isReady()?this.node.emit(msg.toInEvent(),msg):(this.node.silly("B: "+msg),this.buffer.push(msg)))},Socket.prototype.onMessage=Socket.prototype.onMessageHI,Socket.prototype.setMsgListener=function(msgHandler){if(msgHandler&&"function"!=typeof msgHandler)throw new TypeError("Socket.setMsgListener: msgHandler must be a function or undefined. Found: "+msgHandler);this.onMessage=msgHandler||this.onMessageFull},Socket.prototype.shouldClearBuffer=function(){return this.node.game.isReady()},Socket.prototype.clearBuffer=function(msgHandler){var nelem,msg,i,funcCtx,func;for(msgHandler?(funcCtx=this.node.game,func=msgHandler):(funcCtx=this.node.events,func=this.node.events.emit),nelem=this.buffer.length,i=0;i<nelem;i++)(msg=this.buffer.shift())&&(func.call(funcCtx,msg.toInEvent(),msg),this.node.silly("D: "+msg))},Socket.prototype.eraseBuffer=function(){this.buffer=[]},Socket.prototype.startSession=function(msg,force){if(this.session&&!force)throw new Error("Socket.startSession: session already existing. Use force parameter to overwrite it.");this.session=msg.session,this.node.game.isStoppable()&&this.node.game.stop(),this.channelName=msg.data.channel.name,this.node.createPlayer(msg.data.player),msg.data.antiSpoofing&&(this.socket.enableAntiSpoofing?(this.antiSpoofing=!0,this.socket.enableAntiSpoofing(!0)):this.node.log("Socket.startSession: server requested anti-spoofing, but socket does not support it.")),this.node.window&&!msg.data.channel.isDefault&&this.node.window.setUriChannel(this.channelName)},Socket.prototype.isConnected=function(){return this.socket&&this.socket.isConnected()},Socket.prototype.send=function(msg){var outEvent;return msg.from&&msg.from!==this.node.UNDEFINED_PLAYER?this.isConnected()?(this.emitOutMsg&&(outEvent=msg.toOutEvent(),this.node.events.ee.game.emit(outEvent,msg),this.node.events.ee.stage.emit(outEvent,msg),this.node.events.ee.step.emit(outEvent,msg)),this.socket.send(msg),this.node.info("S: "+msg),this.journalOn&&this.node.game.isReady()&&this.journal.insert(msg),!0):(this.node.err("Socket.send: cannot send message. No open socket. Message discarded."),!1):(this.node.err("Socket.send: cannot send message. Player undefined. Message discarded."),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node,io){var J=node.JSUS;function SocketIo(node){this.node=node,this.socket=null}exports.SocketIo=SocketIo,SocketIo.prototype.connect=function(url,options){var node,socket;if(node=this.node,"string"!=typeof url)throw TypeError("SocketIO.connect: url must be string.");return J.mixin(options,{"force new connection":!0}),(socket=io.connect(url,options)).on("connect",(function(){node.info("socket.io connection open"),node.socket.onConnect.call(node.socket),socket.on("message",(function(msg){(msg=node.socket.secureParse(msg))&&node.socket.onMessage(msg)}))})),socket.on("disconnect",(function(){node.socket.onDisconnect.call(node.socket)})),this.socket=socket,!0},SocketIo.prototype.disconnect=function(){this.socket.disconnect()},SocketIo.prototype.isConnected=function(){return this.socket&&this.socket.connected},SocketIo.prototype.sendEasy=function(msg){this.socket.send(msg.stringify())},SocketIo.prototype.sendNoSpoof=function(msg){msg.sid=this.node.player.strippedSid,this.socket.send(msg.stringify())},SocketIo.prototype.send=SocketIo.prototype.sendEasy,SocketIo.prototype.enableAntiSpoofing=function(value){this.send=value?this.sendNoSpoof:this.sendEasy},node.SocketFactory.register("SocketIo",SocketIo)}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof module&&"undefined"!=typeof require?require("socket.io-client"):"undefined"!=typeof io?io:{}),function(exports,parent){"use strict";var J=("undefined"!==typeof node?node:module.parent.exports).JSUS;function Roler(){this.roles={},this.rolesArray=[],this.rolifiedMatches=null,this.role2IdMatches=null,this.id2RoleMatches=null,this.role2IdRoundMap=[],this.rolify=Roler.linearRolifier,this.missingId="bot"}function validateRoleIdMatches(method,matches){var i,len,j,lenJ,k,nKeys,arrayOk,elem,isArray;if(!J.isArray(matches)||!matches.length)throw new Error("Roler."+method+": matches must be a non-empty array. Found: "+matches);for(arrayOk="setRole2IdMatches"===method,i=-1,len=matches.length;++i<len;){if(!(lenJ=matches[i=-1].length))throw new Error("Roler."+method+": matches round "+i+"has no elements.");for(;++i<lenJ;){if("object"!=typeof matches[i][j])throw new Error("Roler."+method+": matches round "+i+" element "+j+" should be object. Found: "+matches[i][j]);for(k in nKeys=0,isArray=!1,matches[i][j])if(matches[i][j].hasOwnProperty(k)){if(nKeys++,""===k.trim())throw new Error("Roler."+method+": roles matches ("+i+","+j+") has invalid key: "+k);if(elem=matches[i][j][k],arrayOk&&J.isArray(elem)){if(isArray=!0,2!==elem.length)throw new Error("Roler."+method+": roles matches ("+i+","+j+", "+k+") has invalid length: "+elem);validString(method,elem[0],i,j,k),validString(method,elem[1],i,j,k)}else validString(method,elem,i,j,k)}if(isArray&&1!==nKeys||!isArray&&2!==nKeys)throw new Error("Roler."+method+": roles matches ("+i+","+j+") was expected to have 2 elements in total. Found: "+matches[i][j])}}}function validString(method,elem,i,j,k){if("string"!=typeof elem||""===elem.trim())throw new Error("Roler."+method+": roles map ("+i+","+j+","+k+") has invalid elements: "+elem)}exports.Roler=Roler,Roler.linearRolifier=function(match,x,y){var roles,len,id1,id2,soloIdx;if(!(len=match.length))throw new Error("Roler.rolify: match must be a non empty array. Found: "+match);if(id1=match[0],id2=match[1],roles=new Array(len),id1!==this.missingId&&id2!==this.missingId)this.setRoleFor(id1,this.rolesArray[0],x),this.setRoleFor(id2,this.rolesArray[1],x),roles=[this.rolesArray[0],this.rolesArray[1]];else{if(!this.rolesArray[2])throw new Error("Roler.rolify: role3 required, but not found.");soloIdx=id1===this.missingId?1:0,this.setRoleFor(match[soloIdx],this.rolesArray[2],x),roles[soloIdx]=this.rolesArray[2]}return roles},Roler.prototype.init=function(options){(options=options||{}).rolifyCb&&this.setRolifyCb(options.rolifyCb),options.roles&&this.setRoles(options.roles),options.missingId&&(this.missingId=options.missingId)},Roler.prototype.clear=function(){this.roles={},this.rolesArray=[],this.id2RoleRoundMap=[],this.role2IdRoundMap=[],this.rolifiedMatches=null,this.role2IdMatches=null,this.id2RoleMatches=null},Roler.prototype.setRolifyCb=function(cb){if("function"!=typeof cb)throw new TypeError("Roler.setRolifyCb: cb must be function. Found: "+cb);this.rolify=cb},Roler.prototype.setRoles=function(roles,min,max){var rolesObj,role,i,len,err;if(this.clear(),min&&"number"!=typeof min||min<2)throw new TypeError("Roler.setRoles: min must be a number > 2 or undefined. Found: "+min);if(min=min||2,max&&"number"!=typeof max||max<min)throw new TypeError("Roler.setRoles: max must be number or undefined. Found: "+max);if(!J.isArray(roles))throw new TypeError("Roler.setRoles: roles must be array. Found: "+roles);if((len=roles.length)<min||len>max)throw err="Roler.setRoles: roles must contain at least "+min+" roles",max&&(err+=" and no more than "+max),err+=". Found: "+len,new Error(err);for(rolesObj={},i=-1;++i<len;){if("string"!=typeof(role=roles[i])||""===role.trim())throw new TypeError("Roler.setRoles: each role must be a non-empty string. Found: "+role);rolesObj[role]=!0}this.roles=rolesObj,this.rolesArray=roles},Roler.prototype.setRoleFor=function(id,role,x){if("string"!=typeof id)throw new TypeError("Roler.setRoleFor: id must be string. Found: "+id);if("string"!=typeof role)throw new TypeError("Roler.setRoleFor: role must be string. Found: "+role);if(!this.roles[role])throw new Error("Roler.setRoleFor: unknown role: "+role);if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.setRoleFor: x must be a non-negative number. Found: "+x);this.id2RoleRoundMap[x]||(this.id2RoleRoundMap[x]={}),this.id2RoleRoundMap[x][id]=role,this.role2IdRoundMap[x]||(this.role2IdRoundMap[x]={}),this.role2IdRoundMap[x][role]||(this.role2IdRoundMap[x][role]=[]),this.role2IdRoundMap[x][role].push(id)},Roler.prototype.setRolifiedMatches=function(rolifiedMatches,validate){var i,len,j,lenJ;if(void 0===validate||validate){if(!J.isArray(rolifiedMatches)||!rolifiedMatches.length)throw new Error("Roler.setRolifiedMatches: rolifiedMatches must be a non-empty array. Found: "+rolifiedMatches);for(i=-1,len=rolifiedMatches.length;++i<len;){if(!(lenJ=rolifiedMatches[i=-1].length))throw new Error("Roler.setRolifiedMatches: rolifiedMatches round "+i+"has no elements.");for(;++i<lenJ;){if(!J.isArray(rolifiedMatches[i][j]))throw new Error("Roler.setRolifiedMatches: rolifiedMatches round "+i+" element "+j+" should be array. Found: "+rolifiedMatches[i][j]);if(2!==rolifiedMatches[i][j].length)throw new Error("Roler.setRolifiedMatches: roles ("+i+","+j+") was expected to have length 2: "+rolifiedMatches[i][j]);if("string"!=typeof rolifiedMatches[i][j][0]||"string"!=typeof rolifiedMatches[i][j][1]||""===rolifiedMatches[i][j][0].trim()||""===rolifiedMatches[i][j][1].trim())throw new Error("Roler.setRolifiedMatches: roles ("+i+","+j+") has invalid elements: "+rolifiedMatches[i][j])}}}this.rolifiedMatches=rolifiedMatches},Roler.prototype.setRole2IdMatches=function(matches,validate){(void 0===validate||validate)&&validateRoleIdMatches("setRole2IdMatches",matches),this.role2IdMatches=matches},Roler.prototype.setId2RoleMatches=function(matches,validate){(void 0===validate||validate)&&validateRoleIdMatches("setId2RoleMatches",matches),this.id2RoleMatches=matches},Roler.prototype.getRoleFor=function(id,x){if("string"!=typeof id)throw new TypeError("Roler.getRoleFor: id must be string. Found: "+id);if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getRoleFor: x must be a non-negative number. Found: "+x);return this.id2RoleRoundMap[x][id]||null},Roler.prototype.getIdForRole=function(role,x){if("string"!=typeof role)throw new TypeError("Roler.getIdForRole: role must be string. Found: "+role);if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getIdForRole: x must be a non-negative number. Found: "+x);return this.role2IdRoundMap[x][role]||[]},Roler.prototype.getRolifiedMatches=function(){return this.rolifiedMatches},Roler.prototype.getRoleMatch=function(x,y){if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getRoleMatch: x must be a non-negative number. Found: "+x);if(void 0===y)return this.rolifiedMatches[x]||null;if("number"!=typeof y||y<0||isNaN(y))throw new TypeError("Roler.getRoleMatch: y must be undefined or a non-negative number. Found: "+y);return this.rolifiedMatches[x][y]||null},Roler.prototype.getRole2IdMatch=function(x,y){if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getRole2IdMatch: x must be a non-negative number. Found: "+x);if(void 0===y)return this.role2IdMatches[x]||null;if("number"!=typeof y||y<0||isNaN(y))throw new TypeError("Roler.getRole2IdMatch: y must be a non-negative number. Found: "+y);return this.role2IdMatches[x][y]||null},Roler.prototype.getId2RoleMatch=function(x,y){if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getId2RoleMatch: x must be a non-negative number. Found: "+x);if(void 0===y)return this.id2RoleMatches[x]||null;if("number"!=typeof y||y<0||isNaN(y))throw new TypeError("Roler.getId2RoleMatch: y must be a non-negative number. Found: "+y);return this.id2RoleMatches[x][y]||null},Roler.prototype.getRole2IdRoundMap=function(x){if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getRole2IdRoundMap: x must be a non-negative number. Found: "+x);return this.role2IdRoundMap[x]||null},Roler.prototype.getId2RoleRoundMap=function(x){if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.getId2RoleRoundMap: x must be a non-negative number. Found: "+x);return this.id2RoleRoundMap[x]||null},Roler.prototype.rolifyAll=function(matches){var i,len,j,lenJ,row,rolifiedMatches,r1,r2,rolesObj,idRolesObj;if(!J.isArray(matches)||!matches.length)throw new Error("Roler.rolifyAll: match must be a non empty array. Found: "+matches);for(i=-1,len=matches.length,rolifiedMatches=new Array(len),rolesObj=new Array(len),idRolesObj=new Array(len);++i<len;)for(j=-1,lenJ=(row=matches[i]).length,rolifiedMatches[i]=new Array(lenJ),rolesObj[i]=new Array(lenJ),idRolesObj[i]=new Array(lenJ);++j<lenJ;)rolifiedMatches[i][j]=this.rolify(row[j],i,j),r1=rolifiedMatches[i][j][0],r2=rolifiedMatches[i][j][1],rolesObj[i][j]={},r1!==r2?(rolesObj[i][j][r1]=row[j][0],rolesObj[i][j][r2]=row[j][1]):rolesObj[i][j][r1]=[row[j][0],row[j][1]],idRolesObj[i][j]={},idRolesObj[i][j][row[j][0]]=r1,idRolesObj[i][j][row[j][1]]=r2;return this.rolifiedMatches=rolifiedMatches,this.role2IdMatches=rolesObj,this.id2RoleMatches=idRolesObj,rolifiedMatches},Roler.prototype.roleExists=function(role){if("string"!=typeof role||""===role.trim())throw new TypeError("Roler.roleExists: role must be a non-empty string. Found: "+role);return!!this.roles[role]},Roler.prototype.hasRole=function(id,role,x){if("string"!=typeof id)throw new TypeError("Roler.hasRole: id must be string. Found: "+id);if("string"!=typeof role)throw new TypeError("Roler.hasRole: role must be string. Found: "+role);if("number"!=typeof x||x<0||isNaN(x))throw new TypeError("Roler.hasRole: x must be a non-negative number. Found: "+x);return this.id2RoleRoundMap[x][id]===role},Roler.prototype.replaceId=function(oldId,newId){var m,n,i,len,j,lenJ,h,k,lenK,rowFound,tmp,role;if("string"!=typeof oldId)throw new TypeError("Roler.replaceId: oldId should be string. Found: "+oldId);if("string"!=typeof newId&&""!==newId.trim())throw new TypeError("Roler.replaceId: newId should be a non-empty string. Found: "+newId);if(!this.id2RoleMatches)return!1;for(m=this.id2RoleMatches,n=this.role2IdMatches,i=-1,len=m.length;++i<len;){if(j=-1,lenJ=m[i].length,j>0&&!rowFound)return!1;for(;++j<lenJ;){for(h in rowFound=!1,m[i][j])if(m[i][j].hasOwnProperty(h)&&h===oldId){if(role=m[i][j][oldId],m[i][j][newId]=role,delete m[i][j][oldId],rowFound=!0,tmp=n[i][j][role],J.isArray(tmp)){if(1===(lenK=tmp.length))tmp[0]=newId;else if(2===lenK)tmp[0]===oldId?tmp[0]=newId:tmp[1]=newId;else for(k=-1;++k<lenK;)if(tmp[k]===oldId){tmp[k]=newId;break}}else n[i][j][role]=newId;break}if(rowFound)break}}for(m=this.id2RoleRoundMap,n=this.role2IdRoundMap,i=-1,len=m.length;++i<len;)for(j in rowFound=!1,m[i]){if(m[i].hasOwnProperty(j)&&j===oldId)if(m[i][newId]=m[i][oldId],delete m[i][oldId],rowFound=!0,1===(tmp=n[i][m[i][newId]]).length)tmp[0]=newId;else for(h=-1;++h<len;)if(tmp[h]===oldId){tmp[h]=newId;break}if(rowFound)break}return!0}}("undefined"!=typeof node?node:module.exports),function(exports,node){var fetchMatch,J=node.JSUS,Roler=node.Roler;function Matcher(options){options=options||{},this.x=null,this.y=null,this.matches=null,this.resolvedMatches=null,this.resolvedMatchesObj=null,this.resolvedMatchesById=null,this.ids=null,this.assignedIds=null,this.idsMap=null,this.assignedIdsMap=null,this.assignerCb=Matcher.randomAssigner,this.missingId=Matcher.missingId,this.bye=Matcher.bye,this.doObjLists=!0,this.doIdLists=!0,this.doRoles=!1,this.roler=options.roler||null,this.roler=options.roler||null,this.init(options)}function importMatchItem(i,j,item,map,miss){if("number"==typeof item)return void 0!==map[item]?map[item]:miss;if("string"==typeof item)return item;throw new TypeError("Matcher.match: items can be only string or number. Found: "+item+" at position "+i+","+j)}function resetResolvedData(matcher){matcher.resolvedMatches=null,matcher.resolvedMatchesObj=null,matcher.resolvedMatchesById=null,matcher.assignedIds=null,matcher.assignedIdsMap=null}function pairMatcher(alg,n,options){var ps,matches,bye,i,lenI,j,lenJ,jj,id1,id2,roundsLimit,cycle,cycleI,skipBye,fixedRolesNoSameMatch;if("number"==typeof n&&n>1)ps=J.seq(0,n-1);else{if(!(J.isArray(n)&&n.length>1))throw new TypeError("pairMatcher."+alg+": n must be number > 1 or array of length > 1.");ps=n.slice(),n=ps.length}if(bye=void 0!==(options=options||{}).bye?options.bye:-1,skipBye=options.skipBye||!1,n%2==1&&(ps.push(bye),n+=1),options.fixedRoles&&!1===options.canMatchSameRole&&(fixedRolesNoSameMatch=!0),"number"==typeof options.rounds){if(options.rounds<=0)throw new Error("pairMatcher."+alg+": options.rounds must be a positive number or undefined. Found: "+options.rounds);if(options.rounds>n-1)throw new Error("pairMatcher."+alg+": options.rounds cannot be greater than "+(n-1)+". Found: "+options.rounds);roundsLimit=options.rounds}else roundsLimit=fixedRolesNoSameMatch?Math.floor(n/2):n-1;if(void 0!==options.cycle){if("mirror_invert"!==(cycle=options.cycle)&&"mirror"!==cycle&&"repeat_invert"!==cycle&&"repeat"!==cycle)throw new Error("pairMatcher."+alg+': options.cycle must be equal to "mirror"/"mirror_invert", "repeat"/"repeat_invert" or undefined . Found: '+options.cycle);matches=new Array(2*roundsLimit)}else matches=new Array(roundsLimit);for(i=-1,lenI=roundsLimit;++i<lenI;){for("random"===alg&&(ps=J.shuffle(ps)),lenJ=n/2,matches[i]=new Array(skipBye?lenJ-1:lenJ),cycle&&(matches[cycleI="mirror"===cycle||"mirror_invert"===cycle?2*roundsLimit-i-1:i+roundsLimit]=new Array(skipBye?lenJ-1:lenJ)),jj=j=-1;++j<lenJ;)fixedRolesNoSameMatch?(id1=ps[2*j],id2=ps[(2*i+2*j+1)%n]):(id1=ps[j],id2=ps[n-1-j]),(!skipBye||id1!==bye&&id2!==bye)&&(jj++,matches[i][jj]=[id1,id2],"repeat"===cycle?matches[cycleI][jj]=[id1,id2]:"repeat_invert"===cycle?matches[cycleI][jj]=[id2,id1]:"mirror"===cycle?matches[cycleI][jj]=[id1,id2]:"mirror_invert"===cycle&&(matches[cycleI][jj]=[id2,id1]));fixedRolesNoSameMatch||ps.splice(1,0,ps.pop())}return matches}function hasOrGetNext(m,mod,x,y,id){var nRows;if(!J.isArray(this.resolvedMatches)||!this.resolvedMatches.length)throw new Error("Matcher."+m+": no resolved matches found.");if(nRows=this.resolvedMatches.length-1,void 0===x){if(void 0!==y)throw new Error("Matcher."+m+": cannot specify y without x.");return null===this.x?(this.x=0,this.y=0,fetchMatch[mod].call(this,0,0,id)):(x=this.x,y=this.y+1,x<=nRows?y<=this.resolvedMatches[x].length-1?!mod||(this.x=x,this.y=y,fetchMatch[mod].call(this,x,y,id)):(x+=1,y=0,mod&&(this.x=x,this.y=y),x<=nRows?fetchMatch[mod].call(this,x,y,id):!!mod&&null):!!mod&&null)}if("number"!=typeof x)throw new TypeError("Matcher."+m+": x must be number or undefined. Found: "+x);if(x<0||isNaN(x))throw new Error("Matcher."+m+": x cannot be negative or NaN. Found: "+x);if(x>nRows)return!!mod&&(this.x=x,this.y=0,null);if(void 0===y)return!mod||(this.x=x,this.y=this.resolvedMatches[nRows].length,fetchMatch[mod].call(this,x,y,id));if("number"!=typeof y)throw new TypeError("Matcher."+m+": y must be number or undefined.");if(y<0||isNaN(y))throw new Error("Matcher."+m+": y cannot be negative or NaN. Found: "+y);return y<=this.resolvedMatches[x].length-1?!mod||(this.x=x,this.y=y,fetchMatch[mod].call(this,x,y)):!!mod&&(this.x=x,this.y=y,null)}exports.Matcher=Matcher,Matcher.bye=-1,Matcher.missingId="bot",Matcher.randomAssigner=function(ids){return J.shuffle(ids)},Matcher.linearAssigner=function(ids){return J.clone(ids)},Matcher.prototype.init=function(options){if((options=options||{}).assignerCb&&this.setAssignerCb(options.assignerCb),options.ids&&this.setIds(options.ids),options.bye&&(this.bye=options.bye),options.missingId&&(this.missingId=options.missingId),null===options.x)this.x=null;else if("number"==typeof options.x){if(options.x<0)throw new Error("Matcher.init: options.x cannot be negative.Found: "+options.x);this.x=options.x}else if(options.x)throw new TypeError("Matcher.init: options.x must be number, null or undefined. Found: "+options.x);if(null===options.y)this.y=null;else if("number"==typeof options.y){if(options.y<0)throw new Error("Matcher.init: options.y cannot be negative.Found: "+options.y);this.y=options.y}else if(options.y)throw new TypeError("Matcher.init: options.y must be number, null or undefined. Found: "+options.y);options.doRoles||options.roles?(this.roler||(this.roler=new Roler),this.roler.init({missingId:this.missingId,roles:options.roles}),this.doRoles=!0):void 0!==options.doRoles&&(this.doRoles=!!options.doRoles),void 0!==options.doObjLists&&(this.doObjLists=!!options.doObjLists),void 0!==options.doIdLists&&(this.doIdLists=!!options.doIdLists)},Matcher.prototype.generateMatches=function(alg){var matches;if("string"!=typeof alg)throw new TypeError("Matcher.generateMatches: alg must be string. Found: "+alg);if("roundrobin"!==(alg=alg.toLowerCase())&&"round_robin"!==alg&&"random"!==alg&&"random_pairs"!==alg)throw new Error("Matcher.generateMatches: unknown algorithm: "+alg);return matches=pairMatcher(alg,arguments[1],arguments[2]),this.setMatches(matches),matches},Matcher.prototype.setMatches=function(matches){if(!J.isArray(matches)||!matches.length)throw new TypeError("Matcher.setMatches: matches must be a non-empty array. Found: "+matches);this.matches=matches,resetResolvedData(this)},Matcher.prototype.getMatches=function(){return this.matches},Matcher.prototype.setIds=function(ids){var i,len;if(!J.isArray(ids)||!ids.length)throw new TypeError("Matcher.setIds: ids must be a non-empty array. Found: "+ids);for(this.idsMap={},i=-1,len=ids.length;++i<len;)this.idsMap[ids[i]]=!0;this.ids=ids,resetResolvedData(this)},Matcher.prototype.getIds=function(){return this.ids},Matcher.prototype.assignIds=function(ids){var i,len;if(void 0!==ids&&this.setIds(ids),!J.isArray(this.ids)||!this.ids.length){if(!J.isArray(this.matches)||!this.matches.length)throw new TypeError("Matcher.assignIds: no ids and no matches found.");this.ids=J.seq(0,this.matches.length-1,1,(function(i){return""+i}))}for(this.assignedIds=this.assignerCb(this.ids),this.assignedIdsMap={},i=-1,len=this.assignedIds.length;++i<len;)this.assignedIdsMap[this.assignedIds[i]]=i},Matcher.prototype.setAssignerCb=function(cb){if("function"!=typeof cb)throw new TypeError("Matcher.setAssignerCb: cb must be function. Found: "+cb);this.assignerCb=cb},Matcher.prototype.match=function(assignIds){var i,lenI,j,lenJ,pair,matched,matchedObj,matchedId,id1,id2,roles,rolesObj,idRolesObj,r1,r2;if(!J.isArray(this.matches)||!this.matches.length)throw new Error("Matcher.match: no matches found");for(this.assignedIds&&!assignIds||(J.isArray(assignIds)?this.assignIds(assignIds):this.assignIds()),i=-1,lenI=this.matches.length,matched=new Array(lenI),matchedObj=this.doObjLists?new Array(lenI):null,matchedId=this.doIdLists?{}:null,this.doRoles?(roles=new Array(lenI),rolesObj=new Array(lenI),idRolesObj=new Array(lenI)):(roles=null,rolesObj=null,idRolesObj=null);++i<lenI;)for(j=-1,lenJ=this.matches[i].length,matched[i]=new Array(lenJ),this.doObjLists&&(matchedObj[i]={}),this.doRoles&&(roles[i]=new Array(lenJ),rolesObj[i]=new Array(lenJ),idRolesObj[i]=new Array(lenJ));++j<lenJ;)null,null,id1=importMatchItem(i,j,(pair=this.matches[i][j])[0],this.assignedIds,this.missingId),id2=importMatchItem(i,j,pair[1],this.assignedIds,this.missingId),matched[i][j]=[id1,id2],this.doObjLists&&(matchedObj[i][id1]=id2,matchedObj[i][id2]=id1),this.doIdLists&&(matchedId[id1]||(matchedId[id1]=new Array(lenI)),matchedId[id2]||(matchedId[id2]=new Array(lenI)),matchedId[id1][i]=id2,matchedId[id2][i]=id1),this.doRoles&&(roles[i][j]=this.roler.rolify(matched[i][j],i,j),r1=roles[i][j][0],r2=roles[i][j][1],rolesObj[i][j]={},r1!==r2?(rolesObj[i][j][r1]=id1,rolesObj[i][j][r2]=id2):rolesObj[i][j][r1]=[id1,id2],idRolesObj[i][j]={},idRolesObj[i][j][id1]=r1,idRolesObj[i][j][id2]=r2);this.resolvedMatches=matched,this.resolvedMatchesObj=matchedObj,this.resolvedMatchesById=matchedId,this.roles=roles,this.rolesObj=rolesObj,this.doRoles&&(this.roler.setRolifiedMatches(roles,!1),this.roler.setRole2IdMatches(rolesObj,!1),this.roler.setId2RoleMatches(idRolesObj,!1)),this.x=null,this.y=null},Matcher.prototype.hasNext=function(x,y){return hasOrGetNext.call(this,"hasNext",0,x,y)},Matcher.prototype.getMatch=function(x,y){return hasOrGetNext.call(this,"getMatch",1,x,y)},Matcher.prototype.getMatchFor=function(id,x){var out;if("string"!=typeof id)throw new TypeError("Matcher.getMatchFor: id must be string. Found:"+id);if(!this.resolvedMatchesById)throw new Error("Matcher.getMatchFor: no id-based matches found.");if(!(out=this.resolvedMatchesById[id]))return null;if(void 0===x)return out;if("number"==typeof x&&x>=0&&!isNaN(x))return x>out.length-1?null:out[x];throw new TypeError("Matcher.getMatchFor: x must be a positive number or undefined. Found: "+x)},Matcher.prototype.getMatchObject=function(x,y){if(!this.resolvedMatchesObj)throw new Error("Matcher.getMatchObject: no obj matches found.");return hasOrGetNext.call(this,"getMatchObject",3,x,y)},Matcher.prototype.normalizeRound=function(round){if(!this.matches)throw new TypeError("Matcher.normalizeRound: no matches found.");if("number"!=typeof round||isNaN(round)||round<1)throw new TypeError("Matcher.normalizeRound: round must be a number > 0. Found: "+round);return(round-1)%this.matches.length},Matcher.prototype.replaceId=function(oldId,newId){var m,i,len,j,lenJ,h,lenH,rowFound;if("string"!=typeof oldId)throw new TypeError("Matcher.replaceId: oldId should be string. Found: "+oldId);if("string"!=typeof newId||""===newId.trim())throw new TypeError("Matcher.replaceId: newId should be a non-empty string. Found: "+newId);if(!this.resolvedMatches)return!1;if(void 0===(m=this.idsMap[oldId]))return!1;for(this.idsMap[newId]=!0,delete this.idsMap[oldId],i=-1,len=(m=this.ids).length;++i<len;)if(m[i]===oldId){m[i]=newId;break}if((m=this.assignedIdsMap)[newId]=m[oldId],delete m[oldId],this.assignedIds[m[newId]]=newId,!(m=this.resolvedMatches))return!0;for(i=-1,len=m.length;++i<len;)for(j=-1,lenJ=m[i].length,rowFound=!1;++j<lenJ;){for(h=-1,lenH=m[i][j].length;++h<lenH;)if(m[i][j][h]===oldId){m[i][j][h]=newId,rowFound=!0;break}if(rowFound)break}for(i=-1,len=(m=this.resolvedMatchesObj).length;++i<len;)for(j in m[i])if(m[i].hasOwnProperty(j)&&j===oldId){m[i][newId]=m[i][oldId],m[i][m[i][oldId]]=newId,delete m[i][oldId];break}for(i in m=this.resolvedMatchesById)if(m.hasOwnProperty(i))if(i===oldId)m[newId]=m[oldId],delete m[oldId];else for(lenJ=m[i].length,j=-1;++j<lenJ;)m[i][j]===oldId&&(m[i][j]=newId);return!0},Matcher.prototype.clear=function(){this.x=null,this.y=null,this.matches=null,this.resolvedMatches=null,this.resolvedMatchesObj=null,this.ids=null,this.assignedIds=null,this.idsMap=null,this.assignedIdsMap=null,this.assignerCb=Matcher.randomAssigner,this.missingId=Matcher.missingId,this.bye=Matcher.bye},fetchMatch=[function(){return!0},function(x,y){return"number"==typeof y?this.resolvedMatches[x][y]:this.resolvedMatches[x]},function(x,y,id){return"number"==typeof x&&"number"==typeof y?this.resolvedMatchesById[id][x]:this.resolvedMatchesById[id]},function(x,y){var match,res;return"number"==typeof y?((res={})[(match=this.resolvedMatches[x][y])[0]]=match[1],res[match[1]]=match[0],res):this.resolvedMatchesObj[x]}]}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";function MatcherManager(node){this.node=node,this.roler=new parent.Roler,this.matcher=new parent.Matcher({roler:this.roler}),this.lastSettings=null,this.lastMatches=null,this.lastMatchesById={}}function round2Index(method,round){if(void 0===round&&0===(round=this.node.game.getRound()))throw new Error("MatcherManager."+method+": game stage is 0.0.0, please specify a valid round");return"number"==typeof round&&(round=this.matcher.normalizeRound(round)),round}function randomPairs(settings){var r1,r2,ii,i,len,roundMatches,nMatchesIdx,match,id1,id2,missId,matches,matchesById,sayPartner,doRoles,opts,roles,matchedRoles,game,n,nRounds;for(this.lastMatches=null,this.lastMatchesById=null,matchesById={},sayPartner=void 0===settings.sayPartner||!!settings.sayPartner,doRoles=!!settings.roles,n=(game=this.node.game).pl.size(),(nRounds=void 0!==settings.rounds?settings.rounds:game.plot.getRound(game.getNextStep(),"total"))>n-1&&(nRounds=n-1),"random"===settings.match?(doRoles&&(this.roler.clear(),this.roler.setRoles(settings.roles,2),this.matcher.init({doRoles:doRoles})),this.matcher.generateMatches("random",n,{rounds:nRounds,skipBye:settings.skipBye,bye:settings.bye,fixedRoles:settings.fixedRoles,canMatchSameRole:settings.canMatchSameRole}),this.matcher.setIds(game.pl.id.getAllKeys()),this.matcher.match(!0)):!this.matcher.matches||settings.reInit?(doRoles&&(this.roler.clear(),this.roler.setRoles(settings.roles,2),this.matcher.init({doRoles:doRoles})),this.matcher.generateMatches("roundrobin",n,{rounds:nRounds,cycle:settings.cycle,skipBye:settings.skipBye,bye:settings.bye,fixedRoles:settings.fixedRoles,canMatchSameRole:settings.canMatchSameRole}),settings.assignerCb&&this.matcher.setAssignerCb(settings.assignerCb),this.matcher.setIds(game.pl.id.getAllKeys()),this.matcher.match(!0)):this.matcher.hasNext()||this.matcher.init({x:null,y:null}),nMatchesIdx="number"==typeof this.matcher.x?this.matcher.x+1:0,len=(roundMatches=this.matcher.getMatch(nMatchesIdx)).length,matches=n%2==0?new Array(2*len):settings.skipBye?new Array(2*len-2):new Array(2*len-1),missId=this.matcher.missingId,matchedRoles=this.roler.getRolifiedMatches(),ii=i=-1;++i<len;)ii++,id1=(match=roundMatches[i])[0],id2=match[1],game.pl.exist(id1)||(id1=missId),game.pl.exist(id2)||(id2=missId),id1!==id2?doRoles?((r1=(roles=matchedRoles[nMatchesIdx][i])[0])&&(opts=sayPartner?{id:id1,options:{role:r1,partner:id2}}:{id:id1,options:{role:r1}},matches[ii]=opts,matchesById[id1]=opts.options),(r2=roles[1])&&(r1&&ii++,opts=sayPartner?{id:id2,options:{role:r2,partner:id1}}:{id:id2,options:{role:r2}},matches[ii]=opts,matchesById[id2]=opts.options)):sayPartner&&(id1!==missId&&(opts={id:id1,options:{partner:id2}},matches[ii]=opts,matchesById[id1]=opts.options),id2!==missId&&(id1!==missId&&ii++,opts={id:id2,options:{partner:id1}},matches[ii]=opts,matchesById[id2]=opts.options)):(len--,matches.length--);return this.lastMatches=matches,this.lastMatchesById=matchesById,this.lastSettings=settings,matches}exports.MatcherManager=MatcherManager,MatcherManager.prototype.clear=function(mod){switch(this.lastMatches=null,this.lastSettings=null,this.lastMatchesById={},mod){case"roles":this.roler.clear();break;case"matches":this.matcher.clear();break;default:this.roler.clear(),this.matcher.clear()}},MatcherManager.prototype.match=function(settings){var matches;if("string"==typeof settings&&(settings={match:settings}),"object"!=typeof settings||null===settings)throw new TypeError("MatcherManager.match: settings must be object or string. Found: "+settings);if("random_pairs"!==settings.match&&"round_robin"!==settings.match&&"roundrobin"!==settings.match)throw new Error('MatcherManager.match: only "random_pairs" and "round_robin" algorithms supported. Found: '+settings.match);if(!(matches=randomPairs.call(this,settings))||!matches.length)throw new Error('MatcheManager.match: "'+settings.match+'" did not return matches.');return matches},MatcherManager.prototype.getMatches=function(mod,round){if("string"!=typeof mod){if(void 0!==mod)throw new TypeError("MatcherManager.getMatches: mod must be undefined or string. Found: "+mod);mod="ARRAY"}if(void 0!==round&&"number"!=typeof round)throw new TypeError("MatcherManager.getMatches: round must be undefined or number. Found: "+round);if(!this.matcher.getMatches())return null;if(round=round2Index.call(this,"getMatches",round),"ARRAY"===mod)return this.matcher.getMatch(round);if("ARRAY_ROLES"===mod)return this.roler.getRoleMatch(round);if("ARRAY_ID_ROLES"===mod)return this.roler.getId2RoleMatch(round);if("ARRAY_ROLES_ID"===mod)return this.roler.getRole2IdMatch(round);if("OBJ"===mod)return this.matcher.getMatchObject(round);if("OBJ_ROLES_ID"===mod)return this.roler.getRole2IdRoundMap(round);if("OBJ_ID_ROLES"===mod)return this.roler.getId2RoleRoundMap(round);throw new Error("MatcherManager.getMatches: unknown modifier: "+mod)},MatcherManager.prototype.getMatchFor=function(id,round){return this.matcher.getMatches()?(round=round2Index.call(this,"getMatchFor",round),this.matcher.getMatchFor(id,round)):null},MatcherManager.prototype.getRoleFor=function(id,round){return this.matcher.getMatches()?(round=round2Index.call(this,"getRoleFor",round),this.roler.getRoleFor(id,round)):null},MatcherManager.prototype.getIdForRole=function(role,round){return this.matcher.getMatches()?(round=round2Index.call(this,"getIdForRole",round),this.roler.getIdForRole(role,round)):null},MatcherManager.prototype.getIterationRound=function(){return this.matcher.x||0},MatcherManager.prototype.replaceId=function(oldId,newId){return this.matcher.replaceId(oldId,newId)&&this.roler.replaceId(oldId,newId)},MatcherManager.prototype.getSetupFor=function(id){if("string"!=typeof id)throw new TypeError("MatcherManager.getSetupFor: id must be string. Found: "+id);return this.lastMatchesById[id]||null}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NDDB=parent.NDDB,GameStage=parent.GameStage,J=parent.JSUS;function GameDB(options,db){var that;that=this,(options=options||{}).name=options.name||"memory",options.update||(options.update={}),options.update.indexes=!0,options.defaultCSVHeader=["session","treatment","player","stage","step","timestamp","time","timeup"],options.skipCSVKeys={isCorrect:!0,id:!0,done:!0},NDDB.call(this,options,db),this.comparator("stage",(function(o1,o2){var _o2;return"string"==typeof o2.stage&&that.node&&!1===J.isInt(o2.stage)&&(_o2=that.node.game.plot.normalizeGameStage(o2.stage))&&(o2.stage=_o2),GameStage.compare(o1.stage,o2.stage)})),this.hash("player",(function(o){return o.player})),this.hash("stage",(function(o){if(o.stage)return GameStage.toHash(o.stage,"S.s.r")})),this.view("done"),this.on("save",(function(opts,info){opts.append&&(opts.flags="a"),"csv"===info.format&&function(that,opts){var toId,split,plot;void 0===opts.bool2num&&(opts.bool2num=!0);toId=void 0===opts.stageNum2Id||opts.stageNum2Id,split=void 0===opts.splitStage||opts.splitStage,plot=that.node.game.plot,opts.adapter||(opts.adapter={});split?(void 0===opts.adapter.stage&&(opts.adapter.stage=function(i){if(i.stage)return toId?plot.getStage(i.stage).id:i.stage.stage}),void 0===opts.adapter.step&&(opts.adapter.step=function(i){if(i.stage)return toId?plot.getStep(i.stage).id:i.stage.step}),void 0===opts.adapter.round&&(opts.adapter.round=function(i){return i.stage.round})):void 0===opts.adapter.stage&&(opts.adapter.stage=function(i){var s=i.stage;if(s)return toId?plot.getStage(s).id+"."+plot.getStep(s).id+"."+s.round:s.stage+"."+s.step+"."+s.round});opts.flatten&&(void 0===opts.header&&void 0===opts.headers&&(opts.header=that.defaultCSVHeader||"all"),opts.preprocess=function(item,current){var s;s=that.node.game.plot.getStage(item.stage).id,s+="."+that.node.game.plot.getStep(item.stage).id,s+="."+item.stage.round,that.node.game.plot.getStage(),item.time&&(item["time_"+s]=item.time),item.timeup&&(item["timeup_"+s]=item.timeup),item.timestamp&&(item["timestamp_"+s]=item.timestamp),delete item.time,delete item.timestamp})}(that,opts)}),!0),this.stepView=function(step){return this.view(step,(function(item){if(that.node.game.isStep(step,item.stage))return!0}))},this.stageView=function(stage){return this.view(stage,(function(item){if(that.node.game.isStage(stage,item.stage))return!0}))},this.node=this.__shared.node}GameDB.prototype=new NDDB,GameDB.prototype.constructor=GameDB,exports.GameDB=GameDB,GameDB.prototype.add=function(o){if("string"!=typeof o.player)throw new TypeError("GameDB.add: player missing or invalid: ",o);if("object"!=typeof o.stage)throw new Error("GameDB.add: stage missing or invalid: ",o);o.timestamp||(o.timestamp=Date.now?Date.now():(new Date).getTime()),o.session=this.node.nodename,o.treatment=this.node.game.settings.treatmentName,this.insert(o)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.Game=Game;var GameStage=parent.GameStage,GameMsg=parent.GameMsg,GameDB=parent.GameDB,GamePlot=parent.GamePlot,PlayerList=parent.PlayerList,Stager=parent.Stager,PushManager=parent.PushManager,SizeManager=parent.SizeManager,MatcherManager=parent.MatcherManager,J=parent.JSUS,constants=parent.constants,stageLevels=constants.stageLevels,stateLevels=constants.stateLevels;function Game(node){this.node=node,this.setStateLevel(stateLevels.UNINITIALIZED,"S"),this.setStageLevel(stageLevels.UNINITIALIZED,"S"),this.metadata={name:"A nodeGame game",description:"No description",version:"0.0.1"},this.settings={},this.playerList=this.pl=new PlayerList({log:this.node.log,logCtx:this.node,name:"pl_"+this.node.nodename}),this.pl.on("insert",(function(p){if(p.id===node.player.id)throw new Error("node.game.pl.on.insert: cannot add player with id equal to node.player.id.")})),this.monitorList=this.ml=new PlayerList({log:this.node.log,logCtx:this.node,name:"ml_"+this.node.nodename}),this.memory=new GameDB({log:this.node.log,logCtx:this.node,shared:{node:this.node}}),this.plot=new GamePlot(this.node,new Stager),this.role=null,this.partner=null,this.matcher=MatcherManager?new MatcherManager(this.node):null,this.timer=this.node.timer.createTimer({name:"game_timer",stagerSync:!0}),this.setCurrentGameStage(new GameStage,"S"),this.setStateLevel(stateLevels.STARTING,"S"),this.paused=!1,this.pauseCounter=0,this.willBeDone=!1,this.globals={},this._steppedSteps=[new GameStage],this._breakStage=!1,this.pushManager=new PushManager(this.node),this.sizeManager=new SizeManager(this.node)}Game.prototype.start=function(options){var onInit,node,startStage;if(node=this.node,options&&"object"!=typeof options)throw new TypeError("Game.start: options must be object or undefined.");if(node.player.placeholder)throw new Error("Game.start: no player defined.");if(!this.isStartable())throw new Error("Game.start: game cannot be started.");node.info("game started."),node.timer.setTimestamp("start"),startStage=(options=options||{}).startStage||new GameStage,this.updateGlobals(startStage),(onInit=this.plot.stager.getOnInit())&&(this.setStateLevel(stateLevels.INITIALIZING),node.emit("INIT"),onInit.call(node.game)),this.setStateLevel(stateLevels.INITIALIZED),this.setCurrentGameStage(startStage,"S"),node.log("game started."),!1!==options.step&&this.step(options.stepOptions)},Game.prototype.restart=function(){this.stop(),this.start()},Game.prototype.stop=function(){var node;if(!this.isStoppable())throw new Error("Game.stop: game cannot be stopped.");(node=this.node).timer.destroyAllTimers(!0),node.events.ee.game.clear(),node.events.ee.stage.clear(),node.events.ee.step.clear(),node.socket.eraseBuffer(),this.memory.clear(),node.window&&node.window.reset(),this.setStateLevel(stateLevels.STARTING,"S"),this.setStageLevel(stageLevels.UNINITIALIZED,"S"),this.setCurrentGameStage(new GameStage),node.game=null,node.game=new Game(node),node.game.pl=this.pl,node.game.ml=this.ml,node.log("game stopped.")},Game.prototype.gameover=function(){var onGameover,node;node=this.node,this.getStateLevel()>=stateLevels.FINISHING?node.warn("Game.gameover called on a finishing game."):(node.emit("GAME_ALMOST_OVER"),(onGameover=this.plot.stager.getOnGameover())&&(this.setStateLevel(stateLevels.FINISHING),onGameover.call(node.game)),this.setStateLevel(stateLevels.GAMEOVER),this.setStageLevel(stageLevels.DONE),node.log("game over."),node.emit("GAME_OVER"))},Game.prototype.isPaused=function(){return this.paused},Game.prototype.pause=function(param){var msgHandler,node;if(!this.isPausable())throw new Error("Game.pause: game cannot be paused.");(node=this.node).emit("PAUSING",param),this.paused=!0,this.pauseCounter++,(msgHandler=this.plot.getProperty(this.getCurrentGameStage(),"pauseMsgHandler"))&&node.socket.setMsgListener((function(msg){msg=node.socket.secureParse(msg),msgHandler.call(node.game,msg.toInEvent(),msg)})),node.timer.setTimestamp("paused"),node.emit("PAUSED",param),node.log("game paused.")},Game.prototype.resume=function(param){var msgHandler,node;if(!this.isResumable())throw new Error("Game.resume: game cannot be resumed.");(node=this.node).emit("RESUMING",param),this.paused=!1,msgHandler=this.plot.getProperty(this.getCurrentGameStage(),"resumeMsgHandler"),node.socket.clearBuffer(msgHandler),node.socket.setMsgListener(),node.timer.setTimestamp("resumed"),node.emit("RESUMED",param),this.shouldEmitPlaying()&&this.node.emit("PLAYING"),node.log("game resumed.")},Game.prototype.shouldStep=function(stageLevel){var stepRule,curStep;if(!this.sizeManager.checkSize()||!this.isSteppable())return!1;if(curStep=this.getCurrentGameStage(),"function"!=typeof(stepRule=this.plot.getStepRule(curStep)))throw new TypeError("Game.shouldStep: stepRule must be function. Found: "+stepRule);return stepRule(curStep,stageLevel=stageLevel||this.getStageLevel(),this.pl,this)},Game.prototype.breakStage=function(doBreak){var b;return b=this._breakStage,void 0!==doBreak&&(this._breakStage=!!doBreak),b},Game.prototype.stepBack=function(options){var prevStep;return!!(prevStep=this.getPreviousStep(1,options))&&(this._steppedSteps.splice(this._steppedSteps.length-2,2),this.gotoStep(prevStep,options))},Game.prototype.step=function(options){var curStep,nextStep;return curStep=this.getCurrentGameStage(),nextStep=this.breakStage(!1)?this.plot.nextStage(curStep):this.plot.next(curStep),this.gotoStep(nextStep,options)},Game.prototype.gotoStep=function(nextStep,options){var node,tmp,curStep,curStageObj,nextStageObj,stageInit,stepInitCb,matcherOptions,matches,role,partner,i,len,pid,remoteOptions,curStepExitCb;if(!this.isSteppable())throw new Error("Game.gotoStep: game cannot be stepped");if("string"!=typeof nextStep&&"object"!=typeof nextStep)throw new TypeError("Game.gotoStep: nextStep must be a object or a string. Found: "+nextStep);if(options&&"object"!=typeof options)throw new TypeError("Game.gotoStep: options must be object or undefined. Found: "+options);if((node=this.node).silly("Next step ---\x3e "+nextStep),this.timer.reset(),this.pushManager.clearTimer(),curStep=this.getCurrentGameStage(),curStageObj=this.plot.getStage(curStep),curStepExitCb=this.plot.getProperty(curStep,"exit",null,{stage:!0}),this.plot.tmpCache.clear(),node.socket.journalOn&&(node.socket.journalOn=!1,node.socket.journal.clear()),this.plot.getProperty(nextStep,"syncStepping"))if((matcherOptions=this.plot.getProperty(nextStep,"matcher"))&&"object"==typeof matcherOptions)for(i=-1,len=(matches=this.matcher.match(matcherOptions)).length;++i<len;)pid=matches[i].id,remoteOptions={plot:matches[i].options},0===curStep.stage?node.remoteCommand("start",pid,{stepOptions:remoteOptions}):(remoteOptions.targetStep=nextStep,node.remoteCommand("goto_step",pid,remoteOptions));else!0===matcherOptions&&(remoteOptions={plot:{role:!0,partner:!0}}),0===curStep.stage?node.remoteCommand("start","ROOM",{stepOptions:remoteOptions}):(remoteOptions?remoteOptions.targetStep=nextStep:remoteOptions=nextStep,node.remoteCommand("goto_step","ROOM",remoteOptions));if(curStepExitCb&&(this.setStateLevel(stateLevels.STEP_EXIT),this.setStageLevel(stageLevels.EXITING),curStepExitCb.call(this)),node.events.ee.step.clear(),node.socket.shouldClearBuffer()&&node.socket.clearBuffer(),node.timer.destroyStepTimers(),"string"==typeof nextStep){if(curStageObj&&curStageObj.exit&&(this.setStateLevel(stateLevels.STAGE_EXIT),this.setStageLevel(stageLevels.EXITING),curStageObj.exit.call(this)),node.events.ee.stage.clear(),nextStep===GamePlot.GAMEOVER)return this.gameover(),node.socket.shouldClearBuffer()&&node.socket.clearBuffer(),null;if(tmp=this.plot.normalizeGameStage(nextStep),!nextStep)throw new Error("Game.gotoStep: could not resolve step: "+nextStep);nextStep=tmp,tmp=null}if(node.emit("STEPPING",curStep,nextStep),!(nextStageObj=this.plot.getStage(nextStep)))return!1;if(!this.plot.getStep(nextStep))return!1;if(curStageObj&&nextStageObj.id===curStageObj.id||(curStageObj&&curStageObj.exit&&(this.setStateLevel(stateLevels.STAGE_EXIT),this.setStageLevel(stageLevels.EXITING),curStageObj.exit.call(this)),node.timer.destroyStageTimers(),stageInit=!0),this.setStageLevel(stageLevels.UNINITIALIZED,"S"),this.setCurrentGameStage(nextStep),"object"==typeof options)!function(game,options){var prop;options.beDone?(game.willBeDone=!0,game.beDone=!0):options.willBeDone&&game.node.once("PLAYING",(function(){game.node.done()}));if(options.plot)for(prop in options.plot)options.plot.hasOwnProperty(prop)&&game.plot.tmpCache(prop,options.plot[prop]);options.msgs&&options.msgs.foreach((function(msg){game.node.socket.onMessage(new GameMsg(msg).toInEvent(),msg)}));if(options.cb){if("function"!=typeof options.cb)throw new TypeError("Game.gotoStep: options.cb must be function or undefined. Found: "+options.cb);options.cb.call(game,options)}}(this,options);else if(options)throw new TypeError("Game.gotoStep: options must be object or undefined. Found: "+options);if(!0===(role=this.plot.getProperty(nextStep,"role"))){if(!(role=this.role))throw new Error('Game.gotoStep: "role" is true, but no previous role is found in step '+nextStep)}else if(role?"function"==typeof role&&(role=role.call(this)):role=null,null===role&&null!==this.getProperty("roles"))throw new Error('Game.gotoStep: "role" is null, but "roles" are found in step '+nextStep);return this.setRole(role,!0),(partner=this.plot.getProperty(nextStep,"partner"))?!0===partner?partner=this.partner:"function"==typeof partner&&(partner=partner.call(this)):partner=null,this.setPartner(partner,!0),stageInit&&(node.timer.setTimestamp("stage",(new Date).getTime()),node.events.ee.stage.clear(),this.setStateLevel(stateLevels.STAGE_INIT),this.setStageLevel(stageLevels.INITIALIZING),nextStageObj.hasOwnProperty("init")&&nextStageObj.init.call(node.game)),(stepInitCb=this.plot.getProperty(nextStep,"init",null,{stage:!0}))&&(this.setStateLevel(stateLevels.STEP_INIT),this.setStageLevel(stageLevels.INITIALIZING),stepInitCb.call(node.game)),this.setStateLevel(stateLevels.PLAYING_STEP),this.setStageLevel(stageLevels.INITIALIZED),this.updateGlobals(nextStep),this.sizeManager.init(nextStep),node.socket.shouldClearBuffer()&&node.socket.clearBuffer(),this._steppedSteps.push(nextStep),!0===this.plot.getProperty(nextStep,"reconnect")&&(node.socket.journalOn=!0),this.beDone?node.emit("PLAYING"):this.execStep(this.getCurrentGameStage()),!0},Game.prototype.execStep=function(step){var cb,origCb,widget,widgetObj,widgetRoot,widgetCb,widgetExit,widgetDone,doneCb,origDoneCb,exitCb,origExitCb,w,frame,uri,frameOptions,frameAutoParse,reloadFrame;if("object"!=typeof step)throw new TypeError("Game.execStep: step must be object. Found: "+step);if(cb=this.plot.getProperty(step,"cb"),frame=this.plot.getProperty(step,"frame"),(widget=this.plot.getProperty(step,"widget"))?(this.widgetStep=!0,"string"==typeof widget&&(widget={name:widget}),"string"!=typeof widget.id&&(widget.id="ng_step_widget_"+widget.name),widget.ref||(widget.ref=widget.name.toLowerCase(),this[widget.ref]&&(widget.ref=J.uniqueKey(this,widget.ref))),widget.options||(widget.options=widget),widgetCb=function(){if(!1===widget.append)widgetObj=this.node.widgets.get(widget.name,widget.options);else{if(widget.options.className||(widget.options.className="centered"),widget.options.widgetStep=!0,"string"==typeof widget.root)widgetRoot=widget.root;else{if(void 0!==widget.root)throw new TypeError("Game.execStep: widget.root must be string or undefined. Found: "+widget.root);widgetRoot="container"}widgetRoot=W.getElementById(widgetRoot),widgetObj=this.node.widgets.append(widget.name,widgetRoot,widget.options)}node.game[widget.ref]=widgetObj},cb?(origCb=cb,cb=function(){widgetCb.call(this),origCb.call(this)}):cb=widgetCb,widgetDone=function(){var values,opts;return opts=widgetObj.required&&!1!==widget.checkValues?{highlight:!0,markAttempt:!0}:{highlight:!1,markAttempt:!1},values=widgetObj.getValues(opts),!widgetObj.required||!1===widget.checkValues||node.game.timer.isTimeup()||!values||null!==values.choice&&!1!==values.isCorrect?values:(!0!==values._scrolledIntoView&&"function"==typeof widgetObj.bodyDiv.scrollIntoView&&widgetObj.bodyDiv.scrollIntoView({behavior:"smooth"}),!1)},(doneCb=this.plot.getProperty(step,"done"))?(origDoneCb=doneCb,doneCb=function(){var values,valuesCb;return!1!==(values=widgetDone.call(this))&&void 0!==(valuesCb=origDoneCb.call(this,values))&&(values=valuesCb),values}):doneCb=widgetDone,this.plot.tmpCache("done",doneCb),!1!==widget.destroyOnExit&&(widgetExit=function(){this[widget.ref].destroy(),this[widget.ref]=null},(exitCb=this.plot.getProperty(step,"exit",null,{stage:!0}))?(origExitCb=exitCb,exitCb=function(){widgetExit.call(this),origExitCb.call(this)}):exitCb=widgetExit,this.plot.tmpCache("exit",exitCb)),!1===widget.append||frame||(frame="/pages/default.html")):this.widgetStep=!1,w=this.node.window,frame){if(frameOptions={},"function"==typeof frame&&(frame=frame.call(node.game)),"string"==typeof frame)uri=frame;else{if("object"!=typeof frame)throw new TypeError("Game.execStep: frame must be string or object. Found: "+frame+". Step: "+step);if("string"!=typeof(uri=frame.uri))throw new TypeError("Game.execStep: frame.uri must be string: "+uri+". Step: "+step);frameOptions.frameLoadMode=frame.loadMode,frameOptions.storeMode=frame.storeMode,(frameAutoParse=frame.autoParse)&&(!0===frameAutoParse&&(frameAutoParse=this.settings),frameOptions.autoParse=frameAutoParse,frameOptions.autoParseMod=frame.autoParseMod,frameOptions.autoParsePrefix=frame.autoParsePrefix)}w&&(reloadFrame=uri!==w.unprocessedUri),reloadFrame||(reloadFrame=void 0!==frame.reload?!!frame.reload:!(reloadFrame=this._steppedSteps[this._steppedSteps.length-2])||(reloadFrame.round!==step.round||reloadFrame.stage!==step.stage)),reloadFrame?this.execCallback((function(){this.node.window.loadFrame(uri,cb,frameOptions)})):(this.execCallback(cb),w&&(w.adjustFrameHeight(0,120),!1!==frame.scrollUp&&window.scrollTo(0,0)))}else this.execCallback(cb),w&&(w.adjustFrameHeight(0,120),window.scrollTo(0,0))},Game.prototype.execCallback=function(cb){this.setStageLevel(stageLevels.EXECUTING_CALLBACK),!1===cb.call(this.node.game)&&this.node.err("A non fatal error occurred in callback of stage "+this.getCurrentGameStage()),this.setStageLevel(stageLevels.CALLBACK_EXECUTED),this.node.emit("STEP_CALLBACK_EXECUTED")},Game.prototype.getCurrentStepObj=function(){return this.plot.getStep(this.getCurrentGameStage())},Game.prototype.getCurrentStep=Game.prototype.getCurrentStepObj,Game.prototype.getCurrentStageObj=function(){return this.plot.getStage(this.getCurrentGameStage())},Game.prototype.getCurrentStepProperty=function(propertyName){var step;if("string"!=typeof propertyName)throw new TypeError("Game.getCurrentStepProperty: propertyName must be string");return void 0===(step=this.plot.getStep(this.getCurrentGameStage()))[propertyName]?null:step[propertyName]},Game.prototype.getCurrentGameStage=function(){return this.node.player.stage},Game.prototype.setCurrentGameStage=function(gameStage,mod){gameStage=new GameStage(gameStage),("F"===mod||!mod&&0!==GameStage.compare(this.getCurrentGameStage(),gameStage))&&this.publishUpdate("stage",{stage:gameStage,stageLevel:this.getStageLevel()}),this.node.player.stage=gameStage},Game.prototype.getStateLevel=function(){return this.node.player.stateLevel},Game.prototype.setStateLevel=function(stateLevel,mod){var node;if(node=this.node,"number"!=typeof stateLevel)throw new TypeError("Game.setStateLevel: stateLevel must be number. Found: "+stateLevel);("F"===mod||!mod&&this.getStateLevel()!==stateLevel)&&this.publishUpdate("stateLevel",{stateLevel:stateLevel}),node.player.stateLevel=stateLevel},Game.prototype.getStageLevel=function(){return this.node.player.stageLevel},Game.prototype.setStageLevel=function(stageLevel,mod){var node;if(node=this.node,"number"!=typeof stageLevel)throw new TypeError("Game.setStageLevel: stageLevel must be number. Found: "+stageLevel);("F"===mod||!mod&&this.getStageLevel()!==stageLevel)&&this.publishUpdate("stageLevel",{stageLevel:stageLevel}),node.player.stageLevel=stageLevel},Game.prototype.publishUpdate=function(type,update){if("string"!=typeof type)throw new TypeError("Game.publishUpdate: type must be string. Found: "+type);if("stage"!==type&&"stageLevel"!==type&&"stateLevel"!==type)throw new Error("Game.publishUpdate: unknown update type: "+type);this.shouldPublishUpdate(type,update)&&this.node.socket.send(this.node.msg.create({target:constants.target.PLAYER_UPDATE,data:update,text:type,to:"ROOM"}))},Game.prototype.shouldPublishUpdate=function(type,value){var myStage,levels,myPublishLevel;if("string"!=typeof type)throw new TypeError("Game.shouldPublishUpdate: type must be string.");if(myStage=this.getCurrentGameStage(),levels=constants.publishLevels,(myPublishLevel=this.plot.getProperty(myStage,"publishLevel"))===levels.NONE)return!1;if(this.plot.getProperty(myStage,"syncOnLoaded")&&"stageLevel"===type&&value.stageLevel===stageLevels.LOADED)return!0;switch(myPublishLevel){case levels.FEW:return"stage"===type;case levels.REGULAR:return"stateLevel"!==type&&("stageLevel"!==type||(value.stageLevel===stageLevels.PLAYING||value.stageLevel===stageLevels.DONE));case levels.MOST:return"stateLevel"!==type;case levels.ALL:default:return!0}},Game.prototype.isReady=function(){if(this.paused)return!1;switch(this.getStateLevel()){case stateLevels.UNINITIALIZED:case stateLevels.INITIALIZING:case stateLevels.STAGE_INIT:case stateLevels.STEP_INIT:case stateLevels.FINISHING:case stateLevels.STAGE_EXIT:case stateLevels.STEP_EXIT:return!1;case stateLevels.PLAYING_STEP:switch(this.getStageLevel()){case stageLevels.EXECUTING_CALLBACK:case stageLevels.CALLBACK_EXECUTED:case stageLevels.PAUSING:case stageLevels.RESUMING:case stageLevels.GETTING_DONE:return!1}}return!0},Game.prototype.isStartable=function(){return this.plot.isReady()&&this.getStateLevel()<stateLevels.INITIALIZING},Game.prototype.isStoppable=function(){return this.getStateLevel()>stateLevels.INITIALIZING},Game.prototype.isPausable=function(){return!this.paused&&this.getStateLevel()>stateLevels.INITIALIZING},Game.prototype.isResumable=function(){return this.paused&&this.getStateLevel()>stateLevels.INITIALIZING},Game.prototype.isSteppable=function(){var stateLevel;return(stateLevel=this.getStateLevel())>stateLevels.INITIALIZING&&stateLevel<stateLevels.FINISHING},Game.prototype.isGameover=Game.prototype.isGameOver=function(){return this.getStateLevel()===stateLevels.GAMEOVER},Game.prototype.shouldEmitPlaying=function(strict){var curGameStage,node;return(void 0!==strict&&!strict||this.getStageLevel()===stageLevels.LOADED)&&(node=this.node,curGameStage=this.getCurrentGameStage(),!!this.isReady()&&(!!this.sizeManager.checkSize()&&(!this.plot.getProperty(curGameStage,"syncOnLoaded")||node.game.pl.isStepLoaded(curGameStage))))},Game.prototype.compareCurrentStep=function(step){var normalizedStep;return normalizedStep=this.plot.normalizeGameStage(new GameStage(step)),GameStage.compare(this.getCurrentGameStage(),normalizedStep)},Game.prototype.getPreviousStep=function(delta,opts){var len,curStep,prevStep,execLoops;if("number"!=typeof(delta=delta||1)||delta<1)throw new TypeError("Game.getPreviousStep: delta must be a positive number or undefined. Found: "+delta);if((len=this._steppedSteps.length-delta-1)>0?prevStep=this._steppedSteps[len]:("boolean"==typeof opts&&(execLoops=opts),prevStep=this.plot.jump(this.getCurrentGameStage(),-delta,execLoops)),"object"==typeof opts){if(curStep=node.game.getCurrentGameStage(),!1===opts.acrossStages&&curStep.stage!==prevStep.stage)return null;if(!1===opts.acrossRounds&&curStep.round!==prevStep.round)return null;if(opts.noZeroStep&&0===prevStep.stage)return null}return prevStep},Game.prototype.getNextStep=function(delta){if("number"!=typeof(delta=delta||1)||delta<1)throw new TypeError("Game.getNextStep: delta must be a positive number or undefined: ",delta);return this.plot.jump(this.getCurrentGameStage(),delta,!1)},Game.prototype.updateGlobals=function(stage){var newGlobals,g;if(stage=stage||this.getCurrentGameStage(),newGlobals=this.plot.getGlobals(stage),"undefined"!=typeof window&&this.node.window){for(g in newGlobals)newGlobals.hasOwnProperty(g)&&("node"===g||"W"===g?node.warn("Game.updateGlobals: invalid name: "+g):window[g]=newGlobals[g]);for(g in this.globals)this.globals.hasOwnProperty(g)&&!newGlobals.hasOwnProperty(g)&&("node"===g&&"W"===g||delete window[g])}return this.globals=newGlobals,this.globals},Game.prototype.getProperty=function(prop,nf){return this.plot.getProperty(this.getCurrentGameStage(),prop,nf)},Game.prototype.getStageId=function(stage){return(stage=this.plot.getStage(stage||this.getCurrentGameStage()))?stage.id:null},Game.prototype.getStepId=function(stage){return(stage=this.plot.getStep(stage||this.getCurrentGameStage()))?stage.id:null},Game.prototype.getRound=function(mod){return this.plot.getRound(this.getCurrentGameStage(),mod)},Game.prototype.isStage=function(stage,compareStage){var s;if(compareStage){if("object"!=typeof compareStage)throw new TypeError("Game.isStage: compareStage must be object or undefined. Found: "+compareStage);s=compareStage.stage}else s=this.getCurrentGameStage().stage;return"number"==typeof stage?stage===s:!(!(stage=this.plot.normalizeGameStage(stage))||stage.stage!==s)},Game.prototype.isStep=function(step,compareStage){var s;if(compareStage){if("object"!=typeof compareStage)throw new TypeError("Game.isStep: compareStage must be object or undefined. Found: "+compareStage);s=compareStage.step}else s=this.getCurrentGameStage().step;return"number"==typeof step?step===s:(-1===step.lastIndexOf(".")&&(step=this.getStageId(compareStage)+"."+step),!(!(step=this.plot.normalizeGameStage(step))||step.step!==s))},Game.prototype.isRound=function(round){var r;return r=this.getRound(),"number"==typeof round?round===r:!(!(round=this.plot.normalizeGameStage(round))||round.round!==r)},Game.prototype.isWidgetStep=function(){return this.widgetStep},Game.prototype.setRole=function(role,force){var roles,roleObj,prop;if("string"==typeof role&&""!==role.trim()){if(this.role&&!force)throw new Error('Game.setRole: attempt to change role "'+this.role+'" to "'+role+'" in step: '+this.getCurrentGameStage());if(!(roles=this.getProperty("roles")))throw new Error('Game.setRole: trying to set role "'+role+"\", but 'roles' not found in current step: "+this.getCurrentGameStage());if(!(roleObj=roles[role]))throw new Error('Game.setRole: role "'+role+'" not found in current step: '+this.getCurrentGameStage());for(prop in roleObj)roleObj.hasOwnProperty(prop)&&this.plot.tmpCache(prop,roleObj[prop])}else if(null!==role)throw new TypeError("Game.setRole: role must be string or null. Found: "+role);this.role=role,this.node.player.role=role},Game.prototype.getRole=function(){return this.role},Game.prototype.setPartner=function(partner,force){if("string"==typeof partner&&""!==partner.trim()){if(this.partner&&!force)throw new Error('Game.setPartner: attempt to change partner "'+this.partner+'" to "'+partner+'" in step: '+this.getCurrentGameStage())}else if(null!==partner)throw new TypeError("Game.setPartner: partner must be a non-empty string or null. Found: "+partner);this.partner=partner,this.node.player.partner=partner},Game.prototype.getPartner=function(){return this.partner}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var J=("undefined"!=typeof node?node:module.parent.exports).JSUS;function Timer(node,settings){var that;this.node=node,this.settings=settings||{},this.timers={},this._stepTimers=[],this._stageTimers=[],this.timestamps={},this._pausedTimestamps={},this._cumulPausedTimestamps={},this._effectiveDiffs={},that=this,this.node.on("PAUSED",(function(){var i,ts;for(i in ts=that.getTimestamp("paused"),that.timestamps)that.timestamps.hasOwnProperty(i)&&(that._pausedTimestamps[i]=ts)})),this.node.on("RESUMED",(function(){var i,time,pt,cpt,pausedTime;for(i in pt=that._pausedTimestamps,cpt=that._cumulPausedTimestamps,time=J.now(),pt)pt[i]&&pt.hasOwnProperty(i)&&(pausedTime=time-pt[i],cpt[i]?cpt[i]+=pausedTime:cpt[i]=pausedTime);that._pausedTimestamps={}})),function(that){var _minWait,_maxWait,_prob,args,i,len;function randomFire(method,hook,emit,ctx,args){var that,waitTime,callback,timerObj,tentativeName;if(that=this,void 0===_maxWait)_maxWait=5e3;else if("number"!=typeof _maxWait)throw resetWaits(),new TypeError("Timer."+method+": maxWait must be number or undefined. Found: "+_maxWait);if(void 0===_minWait)_minWait=_maxWait<1e3?0:1e3;else if("number"!=typeof _minWait)throw resetWaits(),new TypeError("Timer."+method+": minWait must be number or undefined. Found: "+_minWait);waitTime=J.randomInt(_minWait,_maxWait),callback=emit?function(){that.destroyTimer(timerObj),args?that.node.emit.apply(that.node.events,[hook].concat(args)):that.node.emit(hook)}:function(){that.destroyTimer(timerObj),hook.apply(ctx,args)},tentativeName=method+"_"+hook+"_"+J.randomInt(0,1e6),timerObj=this.createTimer({milliseconds:waitTime,timeup:callback,name:J.uniqueKey(this.timers,tentativeName)}),this.node.game&&this.node.game.isReady()?timerObj.start():this.node.once("PLAYING",(function(){timerObj.start()})),resetWaits()}function resetWaits(){_maxWait=5e3,_minWait=1e3}function done(param){evaluateProb()&&randomFire.call(that,"done",node.done,!1,node,[param])}function emit(event){if("string"!=typeof event)throw new TypeError("Timer.emit: event must be string. Found: "+event);if(evaluateProb()){if(2===(len=arguments.length))args=[arguments[1]];else if(3===len)args=[arguments[2],arguments[1]];else if(len>3)for(i=-1,len-=1,args=new Array(len);++i<len;)args[i]=arguments[i+1];randomFire.call(that,"emit",event,!0,null,args)}}function exec(func,ctx){if("function"!=typeof func)throw new TypeError("Timer.exec: func must be function. Found: "+func);if(void 0===ctx)ctx=node.game;else if("object"!=typeof ctx&&"function"!=typeof ctx)throw new TypeError("Timer.exec: ctx must be object, function or undefined. Found: "+ctx);if(evaluateProb()){if(3===(len=arguments.length))args=[arguments[2]];else if(4===len)args=[arguments[3],arguments[2]];else if(len>4)for(i=-1,len-=2,args=new Array(len);++i<len;)args[i]=arguments[i+2];randomFire.call(that,"exec",func,!1,ctx,args)}}function timeup(param){evaluateProb()&&randomFire.call(that,"timeup",(function(){node.game.timer.doTimeUp()}),!1,node.game,[param])}function evaluateProb(){var p;return p=_prob,_prob=1,"number"==typeof p?Math.random()<=p:!!p.call(node.game)}function prob(prob){var tmp;if(void 0===prob)_prob=.5;else if("function"==typeof prob)_prob=prob;else{if(!1===(tmp=J.isNumber(prob,0,1,!0,!0)))throw new Error("Timer.prob: prob must be a number between 0 and 1, undefined or function. Found: "+prob);_prob=tmp}return{done:done,emit:emit,exec:exec,timeup:timeup}}function random(maxWait,minWait){return _maxWait=maxWait,_minWait=minWait,{done:done,emit:emit,exec:exec,timeup:timeup,prob:prob}}function wait(wait){return random(wait,wait)}_prob=1,random.done=done,random.emit=emit,random.exec=exec,random.prob=prob,random.timeup=timeup,wait.done=done,wait.emit=emit,wait.exec=exec,wait.prob=prob,wait.timeup=timeup,that.random=random,that.wait=wait}(this)}function destroyTempTimers(that,timers){var i,len,t;for(len=that[timers].length,i=0;i<len;i++)(t=that[timers][i]).status!==GameTimer.DESTROYED&&that.destroyTimer(t);that[timers]=[]}function GameTimer(node,options){options=options||{},this.node=node,this.name=options.name||"timer_"+J.randomInt(0,1e6),this.status=GameTimer.UNINITIALIZED,this.options=options,this.timerId=null,this.milliseconds=null,this.timeLeft=null,this.timeLeftAtStop=null,this.timePassed=0,this.timePassedAtStop=null,this.update=void 0,this.updateRemaining=0,this.updateStart=0,this.startPaused=null,this.timeup="TIMEUP",this.hooks=[],this.hookNames={},this.eventEmitterName=null,this.stagerSync=!1,this.stagerProperty="timer",this.init(this.options)}function updateCallback(that){var i;for(that.status=GameTimer.RUNNING,that.timePassed+=that.update,that.timeLeft-=that.update,that.updateStart=J.now(),i=that.hooks.length;i>0;i--)that.fire(that.hooks[i-1]);return!(that.timeLeft<=0)||(that.doTimeup(),!1)}function checkInitialized(that){return"number"!=typeof that.milliseconds?"this.milliseconds must be a number":that.update>that.milliseconds?"this.update must not be greater than this.milliseconds":null}function checkDestroyed(that,method){if(that.status===GameTimer.DESTROYED)throw new Error("GameTimer."+method+": gameTimer marked as destroyed: "+that.name)}exports.Timer=Timer,Timer.prototype.setTimeout=function(timeup,milliseconds,validity){return this.createTimer({milliseconds:milliseconds||1,timeup:timeup,validity:validity}).start()},Timer.prototype.create=Timer.prototype.createTimer=function(options){var gameTimer,pausedCb,resumedCb,ee,val;if(options&&"object"!=typeof options&&"number"!=typeof options)throw new TypeError("Timer.createTimer: options must be undefined, object or number. Found: "+options);if("number"==typeof options&&(options={milliseconds:options}),(options=options||{}).name=options.name||J.uniqueKey(this.timers,"timer_"+J.randomInt(0,1e7)),this.timers[options.name])throw new Error("Timer.createTimer: timer name already in use: "+options.name);if(val=options.validity){if(!(ee=this.node.events.ee[val]))throw new Error('Timer.createTimer: validity must be "ng", "game", "stage", "step". Found: '+val)}else ee=this.node.getCurrentEventEmitter();return options.eventEmitterName=ee.name,this.node.game&&this.node.game.paused&&void 0===options.startPaused&&(options.startPaused=!0),gameTimer=new GameTimer(this.node,options),pausedCb=function(){gameTimer.isPaused()||gameTimer.pause()},resumedCb=function(){(gameTimer.isPaused()||gameTimer.startPaused)&&gameTimer.resume()},ee.on("PAUSED",pausedCb),ee.on("RESUMED",resumedCb),gameTimer.timerPausedCallback=pausedCb,gameTimer.timerResumedCallback=resumedCb,this.timers[gameTimer.name]=gameTimer,"step"===ee.name?this._stepTimers.push(gameTimer):"stage"===ee.name&&this._stageTimers.push(gameTimer),gameTimer},Timer.prototype.destroyTimer=function(gameTimer){var eeName;if("string"==typeof gameTimer){if(!this.timers[gameTimer])throw new Error("node.timer.destroyTimer: gameTimer not found: "+gameTimer);gameTimer=this.timers[gameTimer]}if("object"!=typeof gameTimer)throw new Error("node.timer.destroyTimer: gameTimer must be string or object. Found: "+gameTimer);gameTimer.isStopped()||gameTimer.stop(),(eeName=gameTimer.eventEmitterName)?(this.node.events.ee[eeName].remove("PAUSED",gameTimer.timerPausedCallback),this.node.events.ee[eeName].remove("RESUMED",gameTimer.timerResumedCallback)):(this.node.off("PAUSED",gameTimer.timerPausedCallback),this.node.off("RESUMED",gameTimer.timerResumedCallback)),gameTimer.syncWithStager(!1),gameTimer.status=GameTimer.DESTROYED,delete this.timers[gameTimer.name]},Timer.prototype.destroyStepTimers=function(){destroyTempTimers(this,"_stepTimers")},Timer.prototype.destroyStageTimers=function(){destroyTempTimers(this,"_stageTimers")},Timer.prototype.destroyAllTimers=function(all){var i;for(i in this.timers)if(this.timers.hasOwnProperty(i)){if(!all&&i===this.node.game.timer.name)continue;this.destroyTimer(this.timers[i])}this._stepTimers=[],this._stageTimers=[]},Timer.prototype.getTimer=function(name){if("string"!=typeof name)throw new TypeError("Timer.getTimer: name must be string. Found: "+name);return this.timers[name]||null},Timer.prototype.setTimestamp=function(name,time){var i;if(void 0===time&&(time=J.now()),"string"!=typeof name)throw new Error("Timer.setTimestamp: name must be a string. Found: "+name);if("number"!=typeof time)throw new Error("Timer.setTimestamp: time must be a number or undefined. Found: "+time);if(this.node.game.pauseCounter)for(i in this._pausedTimestamps[name]&&(this._pausedTimestamps[name]=null),this._cumulPausedTimestamps[name]&&(this._cumulPausedTimestamps[name]=null),this.node.game.isPaused()&&(this._pausedTimestamps[name]=time),this._effectiveDiffs[name]={},this.timestamps)this.timestamps.hasOwnProperty(i)&&(this._effectiveDiffs[name][i]=this.getTimeSince(i,!0));return this.timestamps[name]=time,time},Timer.prototype.getTimestamp=function(name){if("string"!=typeof name)throw new Error("Timer.getTimestamp: name must be a string. Found: "+name);return this.timestamps.hasOwnProperty(name)?this.timestamps[name]:null},Timer.prototype.getAllTimestamps=function(){return this.timestamps},Timer.prototype.getTimeSince=function(name,effective){var currentTime;if(currentTime=J.now(),"string"!=typeof name)throw new TypeError("Timer.getTimeSince: name must be string. Found: "+name);return this.timestamps.hasOwnProperty(name)?(effective&&(this._pausedTimestamps[name]&&(currentTime-=currentTime-this._pausedTimestamps[name]),this._cumulPausedTimestamps[name]&&(currentTime-=this._cumulPausedTimestamps[name])),currentTime-this.timestamps[name]):null},Timer.prototype.getTimeDiff=function(nameFrom,nameTo,effective){var timeFrom,timeTo,ed;if("string"!=typeof nameFrom)throw new TypeError("Timer.getTimeDiff: nameFrom must be string.Found: "+nameFrom);if("string"!=typeof nameTo)throw new TypeError("Timer.getTimeDiff: nameTo must be string. Found: "+nameTo);if(null==(timeFrom=this.timestamps[nameFrom]))throw new Error("Timer.getTimeDiff: nameFrom does not resolve to a valid timestamp: "+nameFrom);if(null==(timeTo=this.timestamps[nameTo]))throw new Error("Timer.getTimeDiff: nameTo does not resolve to a valid timestamp: "+nameTo);if(effective){if((ed=this._effectiveDiffs)[nameFrom]&&ed[nameFrom][nameTo])return ed[nameFrom][nameTo];if(ed[nameTo]&&ed[nameTo][nameFrom])return ed[nameTo][nameFrom]}return timeTo-timeFrom},Timer.prototype.parseInput=function(name,value,methodName){var num;if("string"!=typeof name)throw new TypeError((methodName||"Timer.parseInput")+": name must be string. Found: "+name);switch(typeof value){case"number":num=value;break;case"object":null!==value&&"function"==typeof value[name]&&(num=value[name].call(this.node.game));break;case"function":num=value.call(this.node.game);break;case"string":num=Number(value)}if("number"!=typeof num||num<0)throw new Error((methodName||"Timer.parseInput")+": "+name+" must be number >= 0. Found: "+num);return num},exports.GameTimer=GameTimer,GameTimer.STOPPED=-5,GameTimer.PAUSED=-3,GameTimer.UNINITIALIZED=-1,GameTimer.INITIALIZED=0,GameTimer.LOADING=3,GameTimer.RUNNING=5,GameTimer.DESTROYED=10,GameTimer.prototype.init=function(options){var i,len,node;if(checkDestroyed(this,"init"),this.status=GameTimer.UNINITIALIZED,this.timerId&&(clearInterval(this.timerId),this.timerId=null),options){if("object"!=typeof options)throw new TypeError("GameTimer.init: options must be object or undefined. Found: "+options);if(node=this.node,void 0!==options.milliseconds&&(this.milliseconds=node.timer.parseInput("milliseconds",options.milliseconds)),void 0!==options.update?this.update=node.timer.parseInput("update",options.update):this.update=this.update||this.milliseconds,options.timeup){if("function"!=typeof options.timeup&&"string"!=typeof options.timeup)throw new TypeError("GameTimer.init: options.timeup must be function or undefined. Found: "+options.timeup);this.timeup=options.timeup}else this.timeup=this.timeup||"TIMEUP";if(options.hooks)if(J.isArray(options.hooks))for(len=options.hooks.length,i=0;i<len;i++)this.addHook(options.hooks[i]);else this.addHook(options.hooks);this.startPaused="undefined"!==options.startPaused&&options.startPaused,"string"==typeof options.eventEmitterName&&(this.eventEmitterName=options.eventEmitterName),void 0!==options.stagerSync&&this.syncWithStager(options.stagerSync),void 0!==options.stagerProperty&&this.setStagerProperty(options.stagerProperty)}return this.timeLeft=this.milliseconds,this.timePassed=0,this.updateStart=0,this.updateRemaining=0,this._timeup=!1,null===checkInitialized(this)&&(this.status=GameTimer.INITIALIZED),this},GameTimer.prototype.fire=function(h){var hook,ctx;if(checkDestroyed(this,"fire"),"object"==typeof h&&(hook=h.hook,ctx=h.ctx,h=hook),"function"==typeof h)h.call(ctx||this.node.game,this.timeLeft,this);else{if("string"!=typeof h)throw new TypeError("GameTimer.fire: h must be function, string or object. Found: "+h);this.node.emit(h,this.timeLeft,this)}return this},GameTimer.prototype.start=function(){var error,that;if(checkDestroyed(this,"start"),null!==(error=checkInitialized(this)))throw new Error("GameTimer.start: "+error);if(this.isRunning())throw new Error("GameTimer.start: timer is already running");return this.status=GameTimer.LOADING,this.startPaused?(this.pause(),this):(this.updateStart=J.now(),void 0!==this.options.milliseconds&&this.options.milliseconds<=0?(this.doTimeup(),this):(this.updateRemaining=this.update,that=this,this.timerId=setInterval((function(){updateCallback(that)}),this.update),this))},GameTimer.prototype.addHook=function(hook,ctx,name){if(checkDestroyed(this,"addHook"),void 0===hook)throw new TypeError("GameTimer.addHook: hook must be function, string or object. Found: "+hook);if(ctx=ctx||this.node.game,hook.hook&&(ctx=hook.ctx||ctx,hook.name&&(name=hook.name),hook=hook.hook),name){if(this.hookNames[name])throw new Error("GameTimer.addHook: name already existing: "+name)}else name=J.uniqueKey(this.hookNames,"timerHook");return this.hookNames[name]=!0,this.hooks.push({hook:hook,ctx:ctx,name:name}),name},GameTimer.prototype.removeHook=function(name){var i;if(checkDestroyed(this,"removeHook"),this.hookNames[name])for(i=0;i<this.hooks.length;i++)if(this.hooks[i].name===name)return delete this.hookNames[name],this.hooks.splice(i,1);return!1},GameTimer.prototype.pause=function(){var timestamp;if(checkDestroyed(this,"pause"),this.isRunning())clearInterval(this.timerId),clearTimeout(this.timerId),this.timerId=null,this.status=GameTimer.PAUSED,0===this.updateStart?this.updateRemaining=this.update:(timestamp=J.now(),this.updateRemaining=this.update-(timestamp-this.updateStart));else{if(this.status===GameTimer.STOPPED)return this;if(this.isPaused())throw new Error("GameTimer.pause: timer was already paused");this.startPaused=!0}return this},GameTimer.prototype.resume=function(){var that;if(checkDestroyed(this,"resume"),this.status===GameTimer.UNINITIALIZED)return this.startPaused=!1,this;if(!this.isPaused()&&!this.startPaused)throw new Error("GameTimer.resume: timer was not paused");return this.status=GameTimer.LOADING,this.startPaused=!1,this.updateStart=J.now(),that=this,this.timerId=setTimeout((function(){updateCallback(that)&&(that.status=GameTimer.INITIALIZED,that.start(),that.status=GameTimer.RUNNING)}),this.updateRemaining),this},GameTimer.prototype.stop=function(){if(checkDestroyed(this,"stop"),this.isStopped())throw new Error("GameTimer.stop: timer was not running");return this.status=GameTimer.STOPPED,clearInterval(this.timerId),clearTimeout(this.timerId),this.timerId=null,this.timePassedAtStop=this.timePassed,this.timePassed=0,this.timeLeftAtStop=this.timeLeft,this.timeLeft=null,this.startPaused=null,this.updateRemaining=0,this.updateStart=0,this},GameTimer.prototype.reset=function(){return checkDestroyed(this,"reset"),this.isStopped()||this.stop(),this.options={},this.milliseconds=null,this.update=void 0,this.timeup="TIMEUP",this.hooks=[],this.hookNames={},this},GameTimer.prototype.restart=function(options){return checkDestroyed(this,"restart"),this.isStopped()||this.stop(),this.init(options),this.start()},GameTimer.prototype.isRunning=function(){return checkDestroyed(this,"isRunning"),this.status>0},GameTimer.prototype.isStopped=function(){return checkDestroyed(this,"isStopped"),this.status===GameTimer.UNINITIALIZED||this.status===GameTimer.INITIALIZED||this.status===GameTimer.STOPPED},GameTimer.prototype.isPaused=function(){return checkDestroyed(this,"isPaused"),this.status===GameTimer.PAUSED},GameTimer.prototype.isDestroyed=function(){return this.status===GameTimer.DESTROYED},GameTimer.prototype.isTimeUp=GameTimer.prototype.isTimeup=function(){return checkDestroyed(this,"isTimeup"),this._timeup},GameTimer.prototype.syncWithStager=function(sync,property){var that,ee;if(checkDestroyed(this,"syncWithStager"),void 0===sync)return this.stagerSync;if("boolean"!=typeof sync)throw new TypeError("GameTimer.syncWithStager: sync must be boolean or undefined. Found: "+sync);if(property){if("string"!=typeof property)throw new TypeError("GameTimer.syncWithStager: property must be string or undefined. Found: "+property);this.setStagerProperty(property)}return this.syncWithStager()===sync||(ee=this.node.events[this.eventEmitterName],!0===sync?(that=this,ee.on("PLAYING",(function(){var options;(options=that.getStepOptions())&&that.restart(options)}),this.name+"_PLAYING"),ee.on("REALLY_DONE",(function(){that.isStopped()||that.stop()}),this.name+"_REALLY_DONE")):(ee.off("PLAYING",this.name+"_PLAYING"),ee.off("REALLY_DONE",this.name+"_REALLY_DONE")),this.stagerSync=sync),sync},GameTimer.prototype.doTimeUp=GameTimer.prototype.doTimeup=function(){if(checkDestroyed(this,"doTimeup"),!this.isTimeup())return this.isStopped()||this.stop(),this._timeup=!0,this.fire(this.timeup)},GameTimer.prototype.setStagerProperty=function(property){if(checkDestroyed(this,"setStagerProperty"),"string"==typeof property)throw new TypeError("GameTimer.setStageProperty: property must be string. Found: "+property);this.stagerProperty=property},GameTimer.prototype.getStagerProperty=function(){return checkDestroyed(this,"getStagerProperty"),this.stagerProperty},GameTimer.prototype.getStepOptions=function(step,prop){var timer,timeup;if(checkDestroyed(this,"getStepOptions"),step=void 0!==step?step:this.node.game.getCurrentGameStage(),prop=prop||this.getStagerProperty(),null===(timer=this.node.game.plot.getProperty(step,prop)))return null;if("function"==typeof timer){if(null===(timer=timer.call(this.node.game)))return null}else"object"==typeof timer&&"function"==typeof(timer={milliseconds:timer.milliseconds,update:timer.update,timeup:timer.timeup,hooks:timer.hooks}).milliseconds&&(timer.milliseconds=timer.milliseconds.call(this.node.game));return"function"==typeof timer&&(timer=timer.call(this.node.game)),"number"==typeof timer&&(timer={milliseconds:timer}),"object"!=typeof timer||"number"!=typeof timer.milliseconds||timer.milliseconds<0?(this.node.warn("GameTimer.getStepOptions: invalid value for milliseconds. Found: "+timer.milliseconds),null):(void 0===timer.update&&(timer.update=timer.milliseconds),void 0===timer.timeup&&(timeup=this.node.game.plot.getProperty(step,"timeup"))&&(timer.timeup=timeup),timer)}}("undefined"!=typeof node?node:module.exports),function(exports,node){var fetchMatch,J=node.JSUS,Roler=node.Roler;function Matcher(options){options=options||{},this.x=null,this.y=null,this.matches=null,this.resolvedMatches=null,this.resolvedMatchesObj=null,this.resolvedMatchesById=null,this.ids=null,this.assignedIds=null,this.idsMap=null,this.assignedIdsMap=null,this.assignerCb=Matcher.randomAssigner,this.missingId=Matcher.missingId,this.bye=Matcher.bye,this.doObjLists=!0,this.doIdLists=!0,this.doRoles=!1,this.roler=options.roler||null,this.roler=options.roler||null,this.init(options)}function importMatchItem(i,j,item,map,miss){if("number"==typeof item)return void 0!==map[item]?map[item]:miss;if("string"==typeof item)return item;throw new TypeError("Matcher.match: items can be only string or number. Found: "+item+" at position "+i+","+j)}function resetResolvedData(matcher){matcher.resolvedMatches=null,matcher.resolvedMatchesObj=null,matcher.resolvedMatchesById=null,matcher.assignedIds=null,matcher.assignedIdsMap=null}function pairMatcher(alg,n,options){var ps,matches,bye,i,lenI,j,lenJ,jj,id1,id2,roundsLimit,cycle,cycleI,skipBye,fixedRolesNoSameMatch;if("number"==typeof n&&n>1)ps=J.seq(0,n-1);else{if(!(J.isArray(n)&&n.length>1))throw new TypeError("pairMatcher."+alg+": n must be number > 1 or array of length > 1.");ps=n.slice(),n=ps.length}if(bye=void 0!==(options=options||{}).bye?options.bye:-1,skipBye=options.skipBye||!1,n%2==1&&(ps.push(bye),n+=1),options.fixedRoles&&!1===options.canMatchSameRole&&(fixedRolesNoSameMatch=!0),"number"==typeof options.rounds){if(options.rounds<=0)throw new Error("pairMatcher."+alg+": options.rounds must be a positive number or undefined. Found: "+options.rounds);if(options.rounds>n-1)throw new Error("pairMatcher."+alg+": options.rounds cannot be greater than "+(n-1)+". Found: "+options.rounds);roundsLimit=options.rounds}else roundsLimit=fixedRolesNoSameMatch?Math.floor(n/2):n-1;if(void 0!==options.cycle){if("mirror_invert"!==(cycle=options.cycle)&&"mirror"!==cycle&&"repeat_invert"!==cycle&&"repeat"!==cycle)throw new Error("pairMatcher."+alg+': options.cycle must be equal to "mirror"/"mirror_invert", "repeat"/"repeat_invert" or undefined . Found: '+options.cycle);matches=new Array(2*roundsLimit)}else matches=new Array(roundsLimit);for(i=-1,lenI=roundsLimit;++i<lenI;){for("random"===alg&&(ps=J.shuffle(ps)),lenJ=n/2,matches[i]=new Array(skipBye?lenJ-1:lenJ),cycle&&(matches[cycleI="mirror"===cycle||"mirror_invert"===cycle?2*roundsLimit-i-1:i+roundsLimit]=new Array(skipBye?lenJ-1:lenJ)),jj=j=-1;++j<lenJ;)fixedRolesNoSameMatch?(id1=ps[2*j],id2=ps[(2*i+2*j+1)%n]):(id1=ps[j],id2=ps[n-1-j]),(!skipBye||id1!==bye&&id2!==bye)&&(jj++,matches[i][jj]=[id1,id2],"repeat"===cycle?matches[cycleI][jj]=[id1,id2]:"repeat_invert"===cycle?matches[cycleI][jj]=[id2,id1]:"mirror"===cycle?matches[cycleI][jj]=[id1,id2]:"mirror_invert"===cycle&&(matches[cycleI][jj]=[id2,id1]));fixedRolesNoSameMatch||ps.splice(1,0,ps.pop())}return matches}function hasOrGetNext(m,mod,x,y,id){var nRows;if(!J.isArray(this.resolvedMatches)||!this.resolvedMatches.length)throw new Error("Matcher."+m+": no resolved matches found.");if(nRows=this.resolvedMatches.length-1,void 0===x){if(void 0!==y)throw new Error("Matcher."+m+": cannot specify y without x.");return null===this.x?(this.x=0,this.y=0,fetchMatch[mod].call(this,0,0,id)):(x=this.x,y=this.y+1,x<=nRows?y<=this.resolvedMatches[x].length-1?!mod||(this.x=x,this.y=y,fetchMatch[mod].call(this,x,y,id)):(x+=1,y=0,mod&&(this.x=x,this.y=y),x<=nRows?fetchMatch[mod].call(this,x,y,id):!!mod&&null):!!mod&&null)}if("number"!=typeof x)throw new TypeError("Matcher."+m+": x must be number or undefined. Found: "+x);if(x<0||isNaN(x))throw new Error("Matcher."+m+": x cannot be negative or NaN. Found: "+x);if(x>nRows)return!!mod&&(this.x=x,this.y=0,null);if(void 0===y)return!mod||(this.x=x,this.y=this.resolvedMatches[nRows].length,fetchMatch[mod].call(this,x,y,id));if("number"!=typeof y)throw new TypeError("Matcher."+m+": y must be number or undefined.");if(y<0||isNaN(y))throw new Error("Matcher."+m+": y cannot be negative or NaN. Found: "+y);return y<=this.resolvedMatches[x].length-1?!mod||(this.x=x,this.y=y,fetchMatch[mod].call(this,x,y)):!!mod&&(this.x=x,this.y=y,null)}exports.Matcher=Matcher,Matcher.bye=-1,Matcher.missingId="bot",Matcher.randomAssigner=function(ids){return J.shuffle(ids)},Matcher.linearAssigner=function(ids){return J.clone(ids)},Matcher.prototype.init=function(options){if((options=options||{}).assignerCb&&this.setAssignerCb(options.assignerCb),options.ids&&this.setIds(options.ids),options.bye&&(this.bye=options.bye),options.missingId&&(this.missingId=options.missingId),null===options.x)this.x=null;else if("number"==typeof options.x){if(options.x<0)throw new Error("Matcher.init: options.x cannot be negative.Found: "+options.x);this.x=options.x}else if(options.x)throw new TypeError("Matcher.init: options.x must be number, null or undefined. Found: "+options.x);if(null===options.y)this.y=null;else if("number"==typeof options.y){if(options.y<0)throw new Error("Matcher.init: options.y cannot be negative.Found: "+options.y);this.y=options.y}else if(options.y)throw new TypeError("Matcher.init: options.y must be number, null or undefined. Found: "+options.y);options.doRoles||options.roles?(this.roler||(this.roler=new Roler),this.roler.init({missingId:this.missingId,roles:options.roles}),this.doRoles=!0):void 0!==options.doRoles&&(this.doRoles=!!options.doRoles),void 0!==options.doObjLists&&(this.doObjLists=!!options.doObjLists),void 0!==options.doIdLists&&(this.doIdLists=!!options.doIdLists)},Matcher.prototype.generateMatches=function(alg){var matches;if("string"!=typeof alg)throw new TypeError("Matcher.generateMatches: alg must be string. Found: "+alg);if("roundrobin"!==(alg=alg.toLowerCase())&&"round_robin"!==alg&&"random"!==alg&&"random_pairs"!==alg)throw new Error("Matcher.generateMatches: unknown algorithm: "+alg);return matches=pairMatcher(alg,arguments[1],arguments[2]),this.setMatches(matches),matches},Matcher.prototype.setMatches=function(matches){if(!J.isArray(matches)||!matches.length)throw new TypeError("Matcher.setMatches: matches must be a non-empty array. Found: "+matches);this.matches=matches,resetResolvedData(this)},Matcher.prototype.getMatches=function(){return this.matches},Matcher.prototype.setIds=function(ids){var i,len;if(!J.isArray(ids)||!ids.length)throw new TypeError("Matcher.setIds: ids must be a non-empty array. Found: "+ids);for(this.idsMap={},i=-1,len=ids.length;++i<len;)this.idsMap[ids[i]]=!0;this.ids=ids,resetResolvedData(this)},Matcher.prototype.getIds=function(){return this.ids},Matcher.prototype.assignIds=function(ids){var i,len;if(void 0!==ids&&this.setIds(ids),!J.isArray(this.ids)||!this.ids.length){if(!J.isArray(this.matches)||!this.matches.length)throw new TypeError("Matcher.assignIds: no ids and no matches found.");this.ids=J.seq(0,this.matches.length-1,1,(function(i){return""+i}))}for(this.assignedIds=this.assignerCb(this.ids),this.assignedIdsMap={},i=-1,len=this.assignedIds.length;++i<len;)this.assignedIdsMap[this.assignedIds[i]]=i},Matcher.prototype.setAssignerCb=function(cb){if("function"!=typeof cb)throw new TypeError("Matcher.setAssignerCb: cb must be function. Found: "+cb);this.assignerCb=cb},Matcher.prototype.match=function(assignIds){var i,lenI,j,lenJ,pair,matched,matchedObj,matchedId,id1,id2,roles,rolesObj,idRolesObj,r1,r2;if(!J.isArray(this.matches)||!this.matches.length)throw new Error("Matcher.match: no matches found");for(this.assignedIds&&!assignIds||(J.isArray(assignIds)?this.assignIds(assignIds):this.assignIds()),i=-1,lenI=this.matches.length,matched=new Array(lenI),matchedObj=this.doObjLists?new Array(lenI):null,matchedId=this.doIdLists?{}:null,this.doRoles?(roles=new Array(lenI),rolesObj=new Array(lenI),idRolesObj=new Array(lenI)):(roles=null,rolesObj=null,idRolesObj=null);++i<lenI;)for(j=-1,lenJ=this.matches[i].length,matched[i]=new Array(lenJ),this.doObjLists&&(matchedObj[i]={}),this.doRoles&&(roles[i]=new Array(lenJ),rolesObj[i]=new Array(lenJ),idRolesObj[i]=new Array(lenJ));++j<lenJ;)null,null,id1=importMatchItem(i,j,(pair=this.matches[i][j])[0],this.assignedIds,this.missingId),id2=importMatchItem(i,j,pair[1],this.assignedIds,this.missingId),matched[i][j]=[id1,id2],this.doObjLists&&(matchedObj[i][id1]=id2,matchedObj[i][id2]=id1),this.doIdLists&&(matchedId[id1]||(matchedId[id1]=new Array(lenI)),matchedId[id2]||(matchedId[id2]=new Array(lenI)),matchedId[id1][i]=id2,matchedId[id2][i]=id1),this.doRoles&&(roles[i][j]=this.roler.rolify(matched[i][j],i,j),r1=roles[i][j][0],r2=roles[i][j][1],rolesObj[i][j]={},r1!==r2?(rolesObj[i][j][r1]=id1,rolesObj[i][j][r2]=id2):rolesObj[i][j][r1]=[id1,id2],idRolesObj[i][j]={},idRolesObj[i][j][id1]=r1,idRolesObj[i][j][id2]=r2);this.resolvedMatches=matched,this.resolvedMatchesObj=matchedObj,this.resolvedMatchesById=matchedId,this.roles=roles,this.rolesObj=rolesObj,this.doRoles&&(this.roler.setRolifiedMatches(roles,!1),this.roler.setRole2IdMatches(rolesObj,!1),this.roler.setId2RoleMatches(idRolesObj,!1)),this.x=null,this.y=null},Matcher.prototype.hasNext=function(x,y){return hasOrGetNext.call(this,"hasNext",0,x,y)},Matcher.prototype.getMatch=function(x,y){return hasOrGetNext.call(this,"getMatch",1,x,y)},Matcher.prototype.getMatchFor=function(id,x){var out;if("string"!=typeof id)throw new TypeError("Matcher.getMatchFor: id must be string. Found:"+id);if(!this.resolvedMatchesById)throw new Error("Matcher.getMatchFor: no id-based matches found.");if(!(out=this.resolvedMatchesById[id]))return null;if(void 0===x)return out;if("number"==typeof x&&x>=0&&!isNaN(x))return x>out.length-1?null:out[x];throw new TypeError("Matcher.getMatchFor: x must be a positive number or undefined. Found: "+x)},Matcher.prototype.getMatchObject=function(x,y){if(!this.resolvedMatchesObj)throw new Error("Matcher.getMatchObject: no obj matches found.");return hasOrGetNext.call(this,"getMatchObject",3,x,y)},Matcher.prototype.normalizeRound=function(round){if(!this.matches)throw new TypeError("Matcher.normalizeRound: no matches found.");if("number"!=typeof round||isNaN(round)||round<1)throw new TypeError("Matcher.normalizeRound: round must be a number > 0. Found: "+round);return(round-1)%this.matches.length},Matcher.prototype.replaceId=function(oldId,newId){var m,i,len,j,lenJ,h,lenH,rowFound;if("string"!=typeof oldId)throw new TypeError("Matcher.replaceId: oldId should be string. Found: "+oldId);if("string"!=typeof newId||""===newId.trim())throw new TypeError("Matcher.replaceId: newId should be a non-empty string. Found: "+newId);if(!this.resolvedMatches)return!1;if(void 0===(m=this.idsMap[oldId]))return!1;for(this.idsMap[newId]=!0,delete this.idsMap[oldId],i=-1,len=(m=this.ids).length;++i<len;)if(m[i]===oldId){m[i]=newId;break}if((m=this.assignedIdsMap)[newId]=m[oldId],delete m[oldId],this.assignedIds[m[newId]]=newId,!(m=this.resolvedMatches))return!0;for(i=-1,len=m.length;++i<len;)for(j=-1,lenJ=m[i].length,rowFound=!1;++j<lenJ;){for(h=-1,lenH=m[i][j].length;++h<lenH;)if(m[i][j][h]===oldId){m[i][j][h]=newId,rowFound=!0;break}if(rowFound)break}for(i=-1,len=(m=this.resolvedMatchesObj).length;++i<len;)for(j in m[i])if(m[i].hasOwnProperty(j)&&j===oldId){m[i][newId]=m[i][oldId],m[i][m[i][oldId]]=newId,delete m[i][oldId];break}for(i in m=this.resolvedMatchesById)if(m.hasOwnProperty(i))if(i===oldId)m[newId]=m[oldId],delete m[oldId];else for(lenJ=m[i].length,j=-1;++j<lenJ;)m[i][j]===oldId&&(m[i][j]=newId);return!0},Matcher.prototype.clear=function(){this.x=null,this.y=null,this.matches=null,this.resolvedMatches=null,this.resolvedMatchesObj=null,this.ids=null,this.assignedIds=null,this.idsMap=null,this.assignedIdsMap=null,this.assignerCb=Matcher.randomAssigner,this.missingId=Matcher.missingId,this.bye=Matcher.bye},fetchMatch=[function(){return!0},function(x,y){return"number"==typeof y?this.resolvedMatches[x][y]:this.resolvedMatches[x]},function(x,y,id){return"number"==typeof x&&"number"==typeof y?this.resolvedMatchesById[id][x]:this.resolvedMatchesById[id]},function(x,y){var match,res;return"number"==typeof y?((res={})[(match=this.resolvedMatches[x][y])[0]]=match[1],res[match[1]]=match[0],res):this.resolvedMatchesObj[x]}]}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";exports.NodeGameClient=function(){this.info("node: loading."),this.nodename="ng",this.verbosity=constants.verbosity_levels.warn,this.remoteVerbosity=constants.verbosity_levels.error,this.remoteLogMap={},this.errorManager=new ErrorManager(this),this.events=new EventEmitterManager(this),this.emit=this.events.emit,this.emitAsync=this.events.emitAsync,this.on=function(event,listener){this.getCurrentEventEmitter().on(event,listener)},this.once=function(event,listener){this.getCurrentEventEmitter().once(event,listener)},this.off=function(event,func){return this.events.remove(event,func)},this.msg=new GameMsgGenerator(this),this.socket=new Socket(this),this.player={placeholder:!0},this.timer=new Timer(this),this.game=new Game(this),this.store=function(){},this.conf={},this.support={},this._setup={},this._env={},this.addDefaultSetupFunctions(),this.addDefaultAliases(),this.addDefaultIncomingListeners(),this.addDefaultInternalListeners(),this.info("node: object created.")};var ErrorManager=parent.ErrorManager,EventEmitterManager=parent.EventEmitterManager,GameMsgGenerator=parent.GameMsgGenerator,Socket=parent.Socket,Game=parent.Game,Timer=parent.Timer,constants=parent.constants}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,constants=parent.constants,LOG=constants.target.LOG,J=parent.JSUS;NGC.prototype.log=function(txt,level,prefix){var numLevel,info;void 0!==txt&&(level=level||"info",numLevel=constants.verbosity_levels[level],this.verbosity>=numLevel&&(info=this.nodename+"@"+this.player.stage.stage+"."+this.player.stage.step+"."+this.player.stage.round+" - "+J.getTimeM()+" > ",void 0!==prefix&&(info+=prefix),console.log(info+txt)),this.remoteVerbosity>=numLevel&&this.socket.isConnected()&&!this.player.placeholder&&(this.remoteLogMap[txt]||(this.remoteLogMap[txt]=!0,this.socket.send(this.msg.create({target:LOG,text:level,data:txt,to:"SERVER"})),this.remoteLogMap[txt]=null)))},NGC.prototype.info=function(txt){this.log(txt,"info","info - ")},NGC.prototype.warn=function(txt){this.log(txt,"warn","warn - ")},NGC.prototype.err=function(txt){this.log(txt,"error","error - ")},NGC.prototype.silly=function(txt){this.log(txt,"silly","silly - ")}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){"use strict";var J=node.JSUS,NGC=node.NodeGameClient;NGC.prototype.setup=function(property){var res,func,i,len,args;if("string"!=typeof property||""===property)throw new TypeError("node.setup: property must be a non-empty string. Found: "+property);if(!(func=this._setup[property]))throw new Error("node.setup: no such property to configure: "+property);switch(len=arguments.length){case 1:res=func.call(this);break;case 2:res=func.call(this,arguments[1]);break;case 3:res=func.call(this,arguments[1],arguments[2]);break;default:for(len-=1,args=new Array(len),i=-1;++i<len;)args[i]=arguments[i+1];res=func.apply(this,args)}"nodegame"!==property&&(this.conf[property]=res)},NGC.prototype.registerSetup=function(property,func){if("string"!=typeof property||""===property)throw new TypeError("node.setup: property must be a non-empty string. Found: "+property);if("function"!=typeof func)throw new TypeError("node.registerSetup: func must be function. Found: "+func);this._setup[property]=func},NGC.prototype.deregisterSetup=function(feature){if("string"!=typeof feature)throw new TypeError("node.deregisterSetup: property must be string. Found: "+feature);this._setup[feature]?this._setup[feature]=null:this.warn('node.deregisterSetup: feature "'+feature+'" not previously registered')},NGC.prototype.remoteSetup=function(feature,to){var msg,payload,i,len;if("string"!=typeof feature)throw new TypeError("node.remoteSetup: feature must be string. Found: "+feature);if(!to||"string"!=typeof to&&!J.isArray(to))throw new TypeError("node.remoteSetup: to must be string or array. Found: "+to);if((len=arguments.length)>2){if(3===len)payload=[arguments[2]];else if(4===len)payload=[arguments[2],arguments[3]];else for(payload=new Array(len-2),i=2;i<len;i++)payload[i-2]=arguments[i];if(!(payload=J.stringifyAll(payload)))return this.err("node.remoteSetup: an error occurred while stringifying payload."),!1}return msg=this.msg.create({target:this.constants.target.SETUP,to:to,text:feature,data:payload}),this.socket.send(msg)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){"use strict";var J=node.JSUS;node.NodeGameClient.prototype.alias=function(alias,events,modifier){var that;if("string"!=typeof alias)throw new TypeError("node.alias: alias must be string. Found: "+alias);if("string"==typeof events&&(events=[events]),!J.isArray(events))throw new TypeError("node.alias: events must be array or string. Found: "+events);if(modifier&&"function"!=typeof modifier)throw new TypeError("node.alias: modifier must be function or undefined. Found: "+modifier);that=this,this.on[alias]=function(func){var i,len,args;if(modifier){for(args=[],i=-1,len=arguments.length;++i<len;)args[i]=arguments[i];func=modifier.apply(that.game,args)}J.each(events,(function(event){that.on(event,(function(){func.apply(that.game,arguments)}))}))},this.once[alias]=function(func){var i,len,args;if(modifier){for(args=[],i=-1,len=arguments.length;++i<len;)args[i]=arguments[i];func=modifier.apply(that.game,args)}J.each(events,(function(event){that.on(event,(function g(){var i,len,args,toRemove;for(args=[],i=-1,len=arguments.length;++i<len;)args[i]=arguments[i];toRemove=func.apply(that.game,args),modifier&&!1===toRemove||that.off(event,g)}))}))}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";("undefined"!=typeof node?node:module.parent.exports).NodeGameClient.prototype.connect=function(){var channel,socketOptions;arguments.length>=2?(channel=arguments[0],socketOptions=arguments[1]):1===arguments.length&&("string"==typeof arguments[0]?channel=arguments[0]:socketOptions=arguments[0]),"undefined"!=typeof window&&(void 0===channel&&window.location&&window.location.pathname&&("/"!==(channel=window.location.pathname).charAt(0)&&(channel="/"+channel),"/"===channel.charAt(channel.length-1)&&(channel=channel.substring(0,channel.length-1))),channel&&"https://"!==channel.substr(0,8)&&"http://"!==channel.substr(0,7)&&window.location&&window.location.origin&&(channel=window.location.origin+channel),(!socketOptions||socketOptions&&!socketOptions.query)&&"undefined"!=typeof location&&location.search&&((socketOptions=socketOptions||{}).query=location.search.substr(1))),this.socket.connect(channel,socketOptions)}}("undefined"!=typeof node?node:module.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,Player=parent.Player,constants=parent.constants;NGC.prototype.createPlayer=function(player){if(this.player&&this.player.stateLevel>constants.stateLevels.STARTING&&this.player.stateLevel!==constants.stateLevels.GAMEOVER)throw new Error("node.createPlayer: cannot create player while game is running.");if(this.game.pl.exist(player.id))throw new Error("node.createPlayer: id already found in playerList: "+player.id);return(player=new Player(player)).stateLevel=this.player.stateLevel,player.stageLevel=this.player.stageLevel,this.player=player,this.player.strippedSid=this.player.sid.slice(2),this.emit("PLAYER_CREATED",this.player),this.player},NGC.prototype.setLanguage=function(lang,updateUriPrefix,sayIt){var language,langStr,shortName;if(!(language="string"==typeof lang?(shortName=(langStr=lang).toLowerCase().substr(0,2),{name:langStr,shortName:shortName,nativeName:langStr,path:shortName+"/"}):lang)||"object"!=typeof language)throw new TypeError("node.setLanguage: language must be object or string. Found: "+lang);if("string"!=typeof language.shortName)throw new TypeError("node.setLanguage: language.shortName must be string. Found: "+language.shortName);return this.player.lang=language,this.player.lang.path||(this.player.lang.path=language.shortName+"/"),updateUriPrefix&&(void 0!==this.window?this.window.setUriPrefix(this.player.lang.path):node.warn("node.setLanguage: updateUriPrefix is true, but window not found. Are you in a browser?")),sayIt&&node.socket.send(node.msg.create({target:"LANG",data:this.player.lang})),this.emit("LANGUAGE_SET"),this.player.lang}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,GameStage=parent.GameStage,STAGE_INIT=parent.constants.stateLevels.STAGE_INIT,STAGE_EXIT=parent.constants.stateLevels.STAGE_EXIT;NGC.prototype.getCurrentEventEmitter=function(){var gameStage,stateL;return this.game&&(gameStage=this.game.getCurrentGameStage())?0===GameStage.compare(gameStage,new GameStage)?this.events.ee.game:(stateL=this.game.getStateLevel())===STAGE_INIT||stateL===STAGE_EXIT?this.events.ee.stage:this.events.ee.step:this.events.ee.ng}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,J=parent.JSUS,stageLevels=parent.constants.stageLevels,GETTING_DONE=stageLevels.GETTING_DONE;NGC.prototype.say=function(label,to,payload){var msg;if("string"!=typeof label||""===label)throw new TypeError("node.say: label must be string. Found: "+label);if(to&&"string"!=typeof to&&(!J.isArray(to)||!to.length))throw new TypeError("node.say: to must be a non-empty array, string or undefined. Found: "+to);return msg=this.msg.create({target:this.constants.target.DATA,to:to,text:label,data:payload}),this.socket.send(msg)},NGC.prototype.set=function(o,to,text){var msg,tmp;if("string"==typeof o)tmp=o,(o={})[tmp]=!0;else if("object"!=typeof o)throw new TypeError("node.set: o must be object or string. Found: "+o);return msg=this.msg.create({action:this.constants.action.SET,target:this.constants.target.DATA,to:to||"SERVER",reliable:1,data:o}),text&&(msg.text=text),this.socket.send(msg)},NGC.prototype.get=function(key,cb,to,options){var msg,g,ee,that,res,timer,success,data,timeout,timeoutCb,executeOnce,target;if("string"!=typeof key)throw new TypeError("node.get: key must be string. Found: "+key);if(""===key)throw new TypeError("node.get: key cannot be empty.");if(key.split(".")>1)throw new TypeError('node.get: key cannot contain the dot "." character: '+key);if("function"!=typeof cb)throw new TypeError("node.get: cb must be function. Found: "+cb);if(void 0===to&&(to="SERVER"),"string"!=typeof to)throw new TypeError("node.get: to must be string or undefined. Found: "+to);if(options){if("object"!=typeof options)throw new TypeError("node.get: options must be object or undefined. Found: "+options);if(timeout=options.timeout,timeoutCb=options.timeoutCb,data=options.data,executeOnce=options.executeOnce,target=options.target,void 0!==timeout){if("number"!=typeof timeout)throw new TypeError("node.get: options.timeout must be number. Found: "+timeout);if(timeout<0&&-1!==timeout)throw new TypeError("node.get: options.timeout must be positive, 0, or -1. Found: "+timeout)}if(timeoutCb&&"function"!=typeof timeoutCb)throw new TypeError("node.get: options.timeoutCb must be function or undefined. Found: "+timeoutCb);if(target&&("string"!=typeof target||""===target.trim()))throw new TypeError("node.get: options.target must be a non-empty string or undefined. Found: "+target)}return msg=this.msg.create({action:this.constants.action.GET,target:target||this.constants.target.DATA,to:to,reliable:1,text:key,data:data}),res=this.socket.send(msg),key=key+"_"+msg.id,res&&(that=this,ee=this.getCurrentEventEmitter(),g=function(msg){msg.text===key&&(success=!0,executeOnce&&(ee.remove("in.say.DATA",g),void 0!==timer&&that.timer.destroyTimer(timer)),cb.call(that.game,msg.data))},ee.on("in.say.DATA",g),timeout>0&&(timer=this.timer.createTimer({milliseconds:timeout,timeup:function(){ee.remove("in.say.DATA",g),void 0!==timer&&that.timer.destroyTimer(timer),timeoutCb&&!success&&timeoutCb.call(that.game)}})).start()),res},NGC.prototype.done=function(param){var that,game,doneCb,stepTime,args,o;return stepTime=this.timer.getTimeSince("step"),(game=this.game).willBeDone||game.getStageLevel()>=GETTING_DONE?(this.err("node.done: done already called in step: "+game.getCurrentGameStage()),!1):!game.isWidgetStep()&&!game.timer.isTimeup()&&this.widgets&&this.widgets.isActionRequired({markAttempt:!0,highlight:!0})?(this.warn("node.done: there are widgets requiring action"),!1):(doneCb=game.plot.getProperty(game.getCurrentGameStage(),"done"))&&!1===(args=doneCb.call(game,param))?(this.silly("node.done: done callback returned false"),!1):(game.willBeDone=!0,args||(args=param),game.plot.getProperty(game.getCurrentGameStage(),"autoSet")&&("object"==typeof args?o=args:(o={},"string"!=typeof args&&"number"!=typeof args||(o[args]=!0)),o.time||(o.time=stepTime),void 0===o.timeup&&(o.timeup=game.timer.isTimeup()),game.role&&!o.role&&(o.role=game.role),game.partner&&!o.partner&&(o.partner=game.partner),o.stepId=game.getStepId(),o.stageId=game.getStageId(),o.done=!0,this.set(o,"SERVER","done")),this.game.setStageLevel(stageLevels.GETTING_DONE),that=this,setTimeout((function(){that.events.emit("DONE",param)}),0),!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,node){"use strict";var NGC=node.NodeGameClient,J=node.JSUS;NGC.prototype.redirect=function(url,who){var msg;if("string"!=typeof url)throw new TypeError("node.redirect: url must be string. Found: "+url);if("string"!=typeof who&&!J.isArray(who))throw new TypeError("node.redirect: who must be string. Found: "+who);msg=this.msg.create({target:this.constants.target.REDIRECT,data:url,to:who}),this.socket.send(msg)},NGC.prototype.remoteCommand=function(command,to,options){var msg;if("string"!=typeof command)throw new TypeError("node.remoteCommand: command must be string.");if(!node.constants.gamecommands[command])throw new Error("node.remoteCommand: unknown command: "+command);if("string"!=typeof to&&!J.isArray(to))throw new TypeError("node.remoteCommand: to must be string or array. Found: "+to);options&&(options=J.stringify(options)),msg=this.msg.create({target:this.constants.target.GAMECOMMAND,text:command,data:options,to:to}),this.socket.send(msg)},NGC.prototype.remoteAlert=function(text,to){var msg;if("string"!=typeof text)throw new TypeError("node.remoteAlert: text must be string. Found: "+text);if("string"!=typeof to&&!J.isArray(to))throw new TypeError("node.remoteAlert: to must be string or array. Found: "+to);msg=this.msg.create({target:this.constants.target.ALERT,text:text,to:to}),this.socket.send(msg)},NGC.prototype.disconnectClient=function(p){var msg;if("object"!=typeof p)throw new TypeError("node.disconnectClient: p must be object. Found: "+p);this.info("node.disconnectClient: "+p.id),msg=this.msg.create({target:"SERVERCOMMAND",text:"DISCONNECT",data:{id:p.id,sid:p.sid}}),this.socket.send(msg)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,J=parent.JSUS;NGC.prototype.env=function(env,func,ctx,params){var envValue,args;if("string"!=typeof env)throw new TypeError("node.env: env must be string.");if(func&&"function"!=typeof func)throw new TypeError("node.env: func must be function or undefined.");if(ctx&&"object"!=typeof ctx)throw new TypeError("node.env: ctx must be object or undefined.");if(args=[envValue=this._env[env]],params){if(!J.isArray(params))throw new TypeError("node.env: params must be array or undefined. Found: "+params);params=params.concat(args)}return func&&envValue&&func.apply(ctx||this,args),envValue},NGC.prototype.clearEnv=function(){this._env={}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";("undefined"!=typeof node?node:module.parent.exports).NodeGameClient.prototype.getJSON=function(uris,dataCb,doneCb){var that,loadedCount,currentUri,uriIdx,tempCb,cbIdx,scriptTag,scriptTagName;if("string"==typeof uris)uris=[uris];else if("object"!=typeof uris||"number"!=typeof uris.length)throw new Error("NGC.getJSON: uris must be an array or a string");if("function"!=typeof dataCb)throw new Error("NGC.getJSON: dataCb must be a function");if(void 0!==doneCb&&"function"!=typeof doneCb)throw new Error("NGC.getJSON: doneCb must be undefined or function");if(0!==uris.length)for(that=this,loadedCount=0,void 0===this.tempCallbacks?this.tempCallbacks={counter:0}:this.tempCallbacks.counter++,cbIdx=this.tempCallbacks.counter,tempCb=function(data){dataCb(data),delete that.tempCallbacks[cbIdx],JSUS.size(that.tempCallbacks)<=1&&delete that.tempCallbacks},this.tempCallbacks[cbIdx]=tempCb,uriIdx=0;uriIdx<uris.length;uriIdx++)currentUri=uris[uriIdx],scriptTag=document.createElement("script"),scriptTagName="tmp_script_"+cbIdx+"_"+uriIdx,scriptTag.id=scriptTagName,scriptTag.name=scriptTagName,scriptTag.src=currentUri+"?callback=node.tempCallbacks["+cbIdx+"]",document.body.appendChild(scriptTag),scriptTag.onload=function(uri,thisScriptTag){return function(){document.body.removeChild(thisScriptTag),++loadedCount>=uris.length&&doneCb&&doneCb()}}(0,scriptTag);else doneCb&&doneCb()}}("undefined"!=typeof node?node:module.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,PlayerList=parent.PlayerList,Player=parent.Player,J=parent.JSUS,action=parent.constants.action,say=action.SAY+".",set=action.SET+".",get=action.GET+".",IN=parent.constants.IN;function emitGameCommandMsg(node,msg){var opts;return"string"!=typeof msg.text?(node.err('"in.'+msg.action+'.GAMECOMMAND": msg.text must be string. Found: '+msg.text),!1):parent.constants.gamecommands[msg.text]?(opts="string"==typeof msg.data?J.parse(msg.data):msg.data,node.emit("NODEGAME_GAMECOMMAND_"+msg.text,opts)):(node.err('"in.'+msg.action+'.GAMECOMMAND": unknown game  command received: '+msg.text),!1)}NGC.prototype.addDefaultIncomingListeners=function(force){var node=this;return node.conf.incomingAdded&&!force?(node.err('node.addDefaultIncomingListeners: listeners already added. Use "force" to add again'),!1):(this.info("node: adding incoming listeners"),node.events.ng.on(IN+say+"BYE",(function(msg){msg.data,node.socket.disconnect(true)})),node.events.ng.on(IN+say+"PCONNECT",(function(msg){var p;"object"==typeof msg.data?(p=msg.data instanceof Player?node.game.pl.add(msg.data):node.game.pl.add(new Player(msg.data)),node.emit("UPDATED_PLIST","pconnect",p),node.game.shouldStep()&&node.game.step()):node.err("received PCONNECT, but invalid data: "+msg.data)})),node.events.ng.on(IN+say+"PDISCONNECT",(function(msg){var p;"object"==typeof msg.data?(p=node.game.pl.remove(msg.data.id),node.emit("UPDATED_PLIST","pdisconnect",p),node.game.shouldStep()&&node.game.step()):node.err("received PDISCONNECT, but invalid data: "+msg.data)})),node.events.ng.on(IN+say+"MCONNECT",(function(msg){"object"==typeof msg.data?(node.game.ml.add(new Player(msg.data)),node.emit("UPDATED_MLIST")):node.err("received MCONNECT, but invalid data: "+msg.data)})),node.events.ng.on(IN+say+"MDISCONNECT",(function(msg){"object"==typeof msg.data?(node.game.ml.remove(msg.data.id),node.emit("UPDATED_MLIST")):node.err("received MDISCONNECT, but invalid data: "+msg.data)})),node.events.ng.on(IN+say+"PLIST",(function(msg){msg.data&&(node.game.pl=new PlayerList({},msg.data),node.emit("UPDATED_PLIST","replace",node.game.pl))})),node.events.ng.on(IN+say+"MLIST",(function(msg){msg.data&&(node.game.ml=new PlayerList({},msg.data),node.emit("UPDATED_MLIST"))})),node.events.ng.on(IN+get+"DATA",(function(msg){var res;"string"==typeof msg.text&&""!==msg.text.trim()?(res=node.emit(get+msg.text,msg),J.isEmpty(res)||node.say(msg.text+"_"+msg.id,msg.from,res)):node.err('"in.get.DATA": msg.data must be a non-empty string.')})),node.events.ng.on(IN+set+"DATA",(function(msg){var o=msg.data;o.player=msg.from,o.stage=msg.stage,node.game.memory.add(o)})),node.events.ng.on(IN+say+"PLAYER_UPDATE",(function(msg){var p;p=node.game.pl.updatePlayer(msg.from,msg.data),node.emit("UPDATED_PLIST","pupdate",p),node.game.shouldStep()?node.game.step():node.game.shouldEmitPlaying()&&node.emit("PLAYING")})),node.events.ng.on(IN+say+"REDIRECT",(function(msg){return"string"!=typeof msg.data?(node.err('"in.say.REDIRECT": msg.data must be string: '+msg.data),!1):"undefined"!=typeof window&&window.location?void(window.location=msg.data):(node.err('"in.say.REDIRECT": window.location not found.'),!1)})),node.events.ng.on(IN+say+"SETUP",(function(msg){var payload,feature;"string"==typeof(feature=msg.text)?node._setup[feature]?(payload="string"==typeof msg.data?J.parse(msg.data):msg.data)?node.setup.apply(node,[feature].concat(payload)):node.err('"in.say.SETUP": error while parsing payload of incoming remote setup message.'):node.err('"in.say.SETUP": no such setup function: '+feature):node.err('"in.say.SETUP": msg.text must be string: '+feature)})),node.events.ng.on(IN+say+"GAMECOMMAND",(function(msg){emitGameCommandMsg(node,msg)})),node.events.ng.on(IN+get+"GAMECOMMAND",(function(msg){var res;res=emitGameCommandMsg(node,msg),J.isEmpty(res)||node.say(msg.text+"_"+msg.id,msg.from,res)})),node.events.ng.on(IN+say+"ALERT",(function(msg){if("string"==typeof msg.text&&""!==msg.text.trim())if("undefined"!=typeof window){if("undefined"==typeof alert)return void node.err('"in.say.ALERT": alert is not defined: '+msg.text);alert(msg.text)}else console.log("****** ALERT ******"),console.log(msg.text),console.log("*******************");else node.err('"in.say.ALERT": msg.text must be a non-empty string')})),node.events.ng.on(IN+get+"PLOT",(function(msg){return node.game.plot.stager?"state"===msg.text?node.game.plot.stager.getState():node.game.plot.stager.getSequence():null})),node.events.ng.on(IN+get+"PLIST",(function(){return node.game.pl.db})),node.events.ng.on(get+"PLAYER",(function(){return node.player})),node.events.ng.on(IN+get+"LANG",(function(){return node.player.lang})),node.events.ng.on(get+"LANG",(function(){return node.player.lang})),node.events.ng.on(IN+set+"LANG",(function(msg){node.setLanguage(msg.data)})),node.events.ng.on(get+"PING",(function(){return"pong"})),node.conf.incomingAdded=!0,node.silly("node: incoming listeners added."),!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,GameStage=parent.GameStage,constants=parent.constants,stageLevels=constants.stageLevels,gcommands=constants.gamecommands,CMD="NODEGAME_GAMECOMMAND_";NGC.prototype.addDefaultInternalListeners=function(force){var node=this;if(this.conf.internalAdded&&!force)return this.err("Default internal listeners already added once. Use the force flag to re-add."),!1;function done(){var res;node.game.willBeDone=!1,node.game.beDone=!1,node.emit("REALLY_DONE"),res=node.game.shouldStep(stageLevels.DONE),node.game.setStageLevel(stageLevels.DONE),res&&setTimeout((function(){node.game.step()}),0)}return this.info("node: adding internal listeners."),this.events.ng.on("DONE",(function(){node.game.willBeDone&&(node.game.getStageLevel()>=stageLevels.PLAYING?done():node.game.willBeDone=!0)})),this.events.ng.on("STEP_CALLBACK_EXECUTED",(function(){node.window&&!node.window.isReady()||node.emit("LOADED")})),this.events.ng.on("LOADED",(function(){var frame;node.game.setStageLevel(constants.stageLevels.LOADED),node.socket.shouldClearBuffer()&&node.socket.clearBuffer(),node.window&&(frame=node.window.getFrame())&&(frame.style.visibility=""),node.game.shouldEmitPlaying()&&node.emit("PLAYING")})),this.events.ng.on("PLAYING",(function(){var currentTime;node.emit("BEFORE_PLAYING"),node.game.setStageLevel(stageLevels.PLAYING),node.socket.clearBuffer(),currentTime=(new Date).getTime(),node.timer.setTimestamp(node.game.getCurrentGameStage().toString(),currentTime),node.timer.setTimestamp("step",currentTime),node.game.willBeDone&&done()})),this.events.ng.on(CMD+gcommands.start,(function(options){node.game.isStartable()?(node.emit("BEFORE_GAMECOMMAND",gcommands.start,options),node.game.start(options)):node.warn('"'+CMD+gcommands.start+'": game cannot be started now.')})),this.events.ng.on(CMD+gcommands.pause,(function(options){node.game.isPausable()?(node.emit("BEFORE_GAMECOMMAND",gcommands.pause,options),node.game.pause(options)):node.warn('"'+CMD+gcommands.pause+'": game cannot be paused now.')})),this.events.ng.on(CMD+gcommands.resume,(function(options){node.game.isResumable()?(node.emit("BEFORE_GAMECOMMAND",gcommands.resume,options),node.game.resume(options)):node.warn('"'+CMD+gcommands.resume+'": game cannot be resumed now.')})),this.events.ng.on(CMD+gcommands.step,(function(options){node.game.isSteppable()?(node.emit("BEFORE_GAMECOMMAND",gcommands.step,options),options.breakStage&&node.game.breakStage(!0),node.game.step()):node.warn('"'+CMD+gcommands.step+'": game cannot be stepped now.')})),this.events.ng.on(CMD+gcommands.stop,(function(options){node.game.isStoppable()?(node.emit("BEFORE_GAMECOMMAND",gcommands.stop,options),node.game.stop()):node.warn('"'+CMD+gcommands.stop+'": game cannot be stopped now.')})),this.events.ng.on(CMD+gcommands.goto_step,(function(options){var step;node.game.isSteppable()?(options.targetStep?(step=options.targetStep,delete options.targetStep):(step=options,options=void 0),node.emit("BEFORE_GAMECOMMAND",gcommands.goto_step,step,options),step===parent.GamePlot.GAMEOVER||(step=new GameStage(step),node.game.plot.getStep(step))?node.game.gotoStep(step,options):node.err('"'+CMD+gcommands.goto_step+'": step not found: '+step)):node.warn('"'+CMD+gcommands.goto_step+'": game cannot be stepped now')})),this.events.ng.on(CMD+gcommands.clear_buffer,(function(){node.emit("BEFORE_GAMECOMMAND",gcommands.clear_buffer),node.socket.clearBuffer()})),this.events.ng.on(CMD+gcommands.erase_buffer,(function(){node.emit("BEFORE_GAMECOMMAND",gcommands.clear_buffer),node.socket.eraseBuffer()})),node.events.ng.on(CMD+gcommands.push_step,(function(){var stageLevel;return node.warn("push_step command. ",node.player.stage),node.game.timer.isTimeup()||node.game.timer.doTimeup(),node.game.willBeDone||(stageLevel=node.game.getStageLevel())!==stageLevels.DONE_CALLED&&stageLevel!==stageLevels.GETTING_DONE&&stageLevel!==stageLevels.DONE&&(node.done()||node.emit("DONE")),"ok!"})),this.conf.internalAdded=!0,this.silly("node: internal listeners added."),!0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";var NGC=parent.NodeGameClient,J=parent.JSUS,constants=parent.constants;NGC.prototype.addDefaultSetupFunctions=function(force){return this.conf.setupsAdded&&!force?(this.err("node.addDefaultSetups: setup functions already added. Use the force flag to re-add."),!1):(this.info("node: registering setup functions."),this.registerSetup("nodegame",(function(options){var i,setupOptions;if(options&&"object"!=typeof options)throw new TypeError('node.setup("nodegame"): options must object or undefined.');for(i in options=options||{},this._setup)this._setup.hasOwnProperty(i)&&"function"==typeof this._setup[i]&&"nodegame"!==i&&"prototype"!==i&&(setupOptions=void 0===options[i]?void 0:options[i],this.conf[i]=this._setup[i].call(this,setupOptions))})),this.registerSetup("socket",(function(conf){if(void 0!==conf)return this.socket.setup(conf),conf})),this.registerSetup("host",(function(host){var tokens;if(host||"undefined"!=typeof window&&void 0!==window.location&&(host=window.location.href),host){if("string"!=typeof host)throw new TypeError('node.setup("host"): if set, host must be string. Found: '+host);(tokens=host.split("/").slice(0,-2)).length>1&&(host=tokens.join("/")),host.lastIndexOf("/")!==host.length&&(host+="/")}return host})),this.registerSetup("verbosity",(function(level){if(void 0===level)return this.verbosity;if("string"==typeof level){if(!constants.verbosity_levels.hasOwnProperty(level))throw new Error('setup("verbosity"): level not found: '+level);this.verbosity=constants.verbosity_levels[level]}else{if("number"!=typeof level)throw new TypeError('node.setup("verbosity"): level must be number or string. Found: '+level);this.verbosity=level}return level})),this.registerSetup("nodename",(function(newName){if("string"!=typeof(newName=newName||constants.nodename))throw new TypeError('setup("nodename"): newName must be string. Found: '+newName);return this.nodename=newName,newName})),this.registerSetup("debug",(function(enable){return enable=!!enable||!1,this.debug=enable,enable})),this.registerSetup("env",(function(conf){var i;if(void 0!==conf){if("object"!=typeof conf)throw new TypeError('node.setup("env"): conf must be object or undefined. Found: '+conf);for(i in conf)conf.hasOwnProperty(i)&&(this._env[i]=conf[i]);return conf}})),this.registerSetup("events",(function(conf){if(conf){if("object"!=typeof conf)throw new TypeError('node.setup("events"): conf must be object or undefined. Found: '+conf)}else conf={};return void 0===conf.history&&(conf.history=this.conf.history||!1),void 0===conf.dumpEvents&&(conf.dumpEvents=this.conf.dumpEvents||!1),conf})),this.registerSetup("settings",(function(settings){if(void 0!==settings){if("object"!=typeof settings)throw new TypeError('node.setup("settings"): settings must be object or undefined. Found: '+settings);J.mixin(this.game.settings,settings)}return this.game.settings})),this.registerSetup("metadata",(function(metadata){if(void 0!==metadata){if("object"!=typeof metadata)throw new TypeError('node.setup("metadata"): metadata must be object or undefined. Found: '+metadata);J.mixin(this.game.metadata,metadata)}return this.game.metadata})),this.registerSetup("player",(function(player){if(void 0!==player){if("object"!=typeof player)throw new TypeError('setup("player"): player must be object or undefined. Found: '+player);this.createPlayer(player)}return this.player})),this.registerSetup("lang",(function(lang){if(void 0!==lang)if(J.isArray(lang))this.setLanguage(lang[0],lang[1]);else{if("string"!=typeof lang&&"object"!=typeof lang)throw new TypeError('setup("lang"): lang must be string, array, object or undefined. Found: '+lang);this.setLanguage(lang)}return this.player.lang})),function(node){function setupTimer(opts){var name,timer;if(name=opts.name||node.game.timer.name,!(timer=node.timer.getTimer(name)))return node.warn('setup("timer"): timer not found: '+name),!1;switch(opts.options&&timer.init(opts.options),opts.action){case"start":timer.start();break;case"stop":timer.stop();break;case"restart":timer.restart();break;case"pause":timer.pause();break;case"resume":timer.resume()}return!0}node.registerSetup("timer",(function(opts){var i,len,res;if(opts){if("object"!=typeof opts)throw new TypeError('setup("timer"): opts must object or undefined. Found: '+opts);if(J.isArray(opts))for(res=!0,i=-1,len=opts.length;++i<len;)res=res&&setupTimer(opts[i]);else res=setupTimer(opts);return res?opts:null}}))}(this),this.registerSetup("plot",(function(stagerState,rule,gameStage){var plot,prop;switch(stagerState=stagerState||{},plot=this.game.plot,rule=rule||"replace"){case"replace":case"append":plot.stager.setState(stagerState,rule);break;case"tmpCache":for(prop in stagerState)stagerState.hasOwnProperty(prop)&&plot.tmpCache(prop,stagerState[prop]);break;case"updateStep":for(prop in gameStage=gameStage||this.game.getCurrentGameStage(),stagerState)stagerState.hasOwnProperty(prop)&&plot.setStepProperty(gameStage,prop,stagerState[prop]);break;case"updateStage":for(prop in gameStage=gameStage||this.game.getCurrentGameStage(),stagerState)stagerState.hasOwnProperty(prop)&&plot.setStageProperty(gameStage,prop,stagerState[prop]);break;default:throw new Error('setup("plot"): invalid rule: '+rule)}return this.game.plot.stager})),function(node){function updatePlayerList(dstListName,srcList,updateRule){var dstList;if(srcList||updateRule){if(dstList="pl"===dstListName?this.game.pl:this.game.ml,"replace"===(updateRule=updateRule||"replace"))dstList.clear(!0);else if("append"!==updateRule)throw new Error('setup("'+dstListName+'") is invalid updateRule: '+updateRule+".");return srcList&&dstList.importDB(srcList),{updateRule:updateRule,list:srcList}}}node.registerSetup("plist",(function(list,updateRule){return updatePlayerList.call(this,"pl",list,updateRule)})),node.registerSetup("mlist",(function(list,updateRule){return updatePlayerList.call(this,"ml",list,updateRule)}))}(this),this.conf.setupsAdded=!0,this.silly("node: setup functions added."),!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,parent){"use strict";("undefined"!=typeof node?node:module.parent.exports).NodeGameClient.prototype.addDefaultAliases=function(force){var that;return this.conf.aliasesAdded&&!force?(this.err("node.addDefaultAliases: aliases already added. Use the force flag to re-add."),!1):(that=this,this.info("node: adding default aliases."),this.alias("txt","in.say.TXT"),this.alias("data",["in.say.DATA","in.set.DATA"],(function(text,cb){if("string"!=typeof text||""===text)throw new TypeError("node.on.data: text must be a non-empty string. Found: "+text);return function(msg){if(msg.text!==text)return!1;cb.call(that.game,msg)}})),this.alias("done","in.set.DATA",(function(step,cb){return void 0===cb&&"function"==typeof step&&(cb=step,step=null),function(msg){if(!msg.data||!msg.data.done||step&&!that.game.isStep(step,msg.stage))return!1;cb.call(that.game,msg)}})),this.alias("stage","STEPPING",(function(cb){return function(curStep,newStep){if(curStep.stage===newStep.stage)return!1;cb(curStep,newStep)}})),this.alias("step","STEPPING"),this.alias("plist",["in.set.PLIST","in.say.PLIST"]),this.alias("pconnect","in.say.PCONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("pdisconnect","in.say.PDISCONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("preconnect","in.say.PRECONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("mconnect","in.say.MCONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("mreconnect","in.say.MRECONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("mdisconnect","in.say.MDISCONNECT",(function(cb){return function(msg){cb.call(that.game,msg.data)}})),this.alias("lang","in.say.LANG"),this.silly("node: aliases added."),!0)}}("undefined"!=typeof node?node:module.exports),function(exports,node){"use strict";function TriggerManager(options){this.options=options||{},this.triggers=[],this.returnAt=TriggerManager.first,this.init()}exports.TriggerManager=TriggerManager,TriggerManager.first="first",TriggerManager.last="last",TriggerManager.prototype.size=function(){return this.triggers.length},TriggerManager.prototype.init=function(options){if(options&&"object"!=typeof options)throw new TypeError("TriggerManager.init: options must be object or undefined.");options&&(options.returnAt&&this.setReturnAt(options.returnAt),this.options=options),this.resetTriggers()},TriggerManager.prototype.setReturnAt=function(returnAt){var f=TriggerManager.first,l=TriggerManager.last;if("string"!=typeof returnAt)throw new TypeError("TriggerManager.setReturnAt: returnAt must be string.");if(returnAt!==f&&returnAt!==l)throw new TypeError("TriggerManager.setReturnAt: returnAt must be "+f+" or "+l+". Given: "+returnAt+".");this.returnAt=returnAt},TriggerManager.prototype.initTriggers=function(triggers){var i;if(triggers)for(triggers instanceof Array||(triggers=[triggers]),i=0;i<triggers.length;i++)this.triggers.push(triggers[i])},TriggerManager.prototype.resetTriggers=function(){this.triggers=[],void 0!==this.options.triggers&&this.initTriggers(this.options.triggers)},TriggerManager.prototype.clear=function(clear){return clear?(this.triggers=[],clear):(node.warn("Do you really want to clear the current TriggerManager obj? Please use clear(true)"),!1)},TriggerManager.prototype.addTrigger=function(trigger,pos){return!!trigger&&("function"==typeof trigger&&(pos?this.triggers.splice(pos,0,trigger):this.triggers.push(trigger),!0))},TriggerManager.prototype.removeTrigger=function(trigger){var i;if(!trigger)return!1;for(i=0;i<this.triggers.length;i++)if(this.triggers[i]==trigger)return this.triggers.splice(i,1);return!1},TriggerManager.prototype.pullTriggers=function(o){var i,out;if(void 0!==o){if(!this.size())return o;for(i=this.triggers.length;i>0;i--)if(void 0!==(out=this.triggers[i-1].call(this,o))&&this.returnAt===TriggerManager.first)return out;return void 0!==out?out:o}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(){var tmp=new window.node.NodeGameClient;JSUS.mixin(tmp,window.node),window.node=tmp}(),function(window,node){"use strict";var DOM,constants,windowLevels,screenLevels,CB_EXECUTED,WIN_LOADING,validPositions,nextTimeout,adjustIt;if(!J)throw new Error("GameWindow: JSUS not found");if(!(DOM=J.require("DOM")))throw new Error('GameWindow: J.require("DOM") failed');function onLoad(iframe,cb){W.isIE?function(iframe,cb){var iframeWin;function completed(event){var iframeDoc;iframeDoc=J.getIFrameDocument(iframe),"load"!==event.type&&"complete"!==iframeDoc.readyState||(iframe.detachEvent("onreadystatechange",completed),iframeWin.detachEvent("onload",completed),cb&&setTimeout((function(){cb()}),120))}iframeWin=iframe.contentWindow,iframe.attachEvent("onreadystatechange",completed),iframeWin.attachEvent("onload",completed)}(iframe,cb):function(iframe,cb){var iframeWin;function completed(){iframe.removeEventListener("load",completed,!1),iframeWin.removeEventListener("load",completed,!1),cb&&setTimeout((function(){cb()}),120)}iframeWin=iframe.contentWindow,iframe.addEventListener("load",completed,!1),iframeWin.addEventListener("load",completed,!1)}(iframe,cb)}function GameWindow(){if(this.setStateLevel("UNINITIALIZED"),void 0===window)throw new Error("GameWindow: no window found. Are you in a browser?");if(void 0===node)throw new Error("GameWindow: nodeGame not found");node.silly("node-window: loading..."),this.frameName=null,this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null,this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.defaultHeaderPosition="top",this.conf={},this.uriChannel=null,this.areLoading=0,this.cacheSupported=null,this.directFrameDocumentAccess=null,this.cache={},this.currentURIs={},this.unprocessedUri=null,this.globalLibs=[],this.frameLibs={},this.uriPrefix=null,this.stateLevel=null,this.waitScreen=null,this.listenersAdded=null,this.screenState=node.constants.screenLevels.ACTIVE,this.styleElement=null,this.isIE=!!document.createElement("span").attachEvent,this.headerOffset=0,this.willResizeFrame=!1,this.addDefaultSetups(),this.addDefaultListeners(),setTimeout((function(){var scriptTag;(scriptTag=document.getElementsByTagName("noscript")).length>=1&&(scriptTag[0].style.display="none")}),1e3),this.init(GameWindow.defaults),node.silly("node-window: created.")}function handleFrameLoad(that,uri,iframe,frameName,loadCache,storeCache,func){var iframeDocumentElement,afterScripts;iframe=W.getElementById(frameName),iframeDocumentElement=W.getIFrameDocument(iframe).documentElement,loadCache&&(iframeDocumentElement.innerHTML=that.cache[uri].contents),frameName===that.frameName&&(that.frameWindow=iframe.contentWindow,that.frameDocument=that.getIFrameDocument(iframe),that.conf.rightClickDisabled&&J.disableRightClick(that.frameDocument),that.conf.noEscape&&(that.frameDocument.onkeydown=document.onkeydown)),that.styleElement=null,function(iframe){var idx,contentDocument,scriptNodes,scriptNode;for(contentDocument=W.getIFrameDocument(iframe),scriptNodes=W.getElementsByClassName(contentDocument,"injectedlib","script"),idx=0;idx<scriptNodes.length;idx++)(scriptNode=scriptNodes[idx]).parentNode.removeChild(scriptNode)}(iframe),afterScripts=function(){!function(iframe,libs){var headNode,scriptNode,libIdx,lib;for(headNode=W.getIFrameAnyChild(iframe),libIdx=0;libIdx<libs.length;libIdx++)lib=libs[libIdx],(scriptNode=document.createElement("script")).className="injectedlib",scriptNode.src=lib,headNode.appendChild(scriptNode)}(iframe,that.globalLibs.concat(that.frameLibs.hasOwnProperty(uri)?that.frameLibs[uri]:[])),storeCache&&(that.cache[uri].contents=iframeDocumentElement.innerHTML),func(),function(){var doc,imgs,len,counter,increment;(doc=W.getFrameDocument())&&(imgs=doc.images,len=imgs.length);if(!len)return void W.adjustFrameHeight(0,120);counter=0,increment=function(){++counter===len&&W.adjustFrameHeight()},[].forEach.call(imgs,(function(img){img.complete?increment():img.addEventListener("load",increment,!1)}))}()},loadCache?function(iframe,func){var contentDocument,headNode,tag,scriptNodes,scriptNodeIdx,scriptNode,attrIdx,attr,numLoading,needsLoad;for(contentDocument=W.getIFrameDocument(iframe),headNode=W.getIFrameAnyChild(iframe),numLoading=1,scriptNodes=contentDocument.getElementsByTagName("script"),scriptNodeIdx=0;scriptNodeIdx<scriptNodes.length;scriptNodeIdx++){for((tag=scriptNodes[scriptNodeIdx]).parentNode.removeChild(tag),scriptNode=document.createElement("script"),tag.innerHTML&&(scriptNode.innerHTML=tag.innerHTML),needsLoad=!1,attrIdx=0;attrIdx<tag.attributes.length;attrIdx++)attr=tag.attributes[attrIdx],scriptNode.setAttribute(attr.name,attr.value),"src"===attr.name&&(needsLoad=!0);needsLoad&&(++numLoading,scriptNode.onload=function(sn){return function(){sn.onload=null,--numLoading<=0&&func()}}(scriptNode)),headNode.appendChild(scriptNode)}--numLoading<=0&&func()}(iframe,afterScripts):afterScripts()}function updateAreLoading(that,update){return that.areLoading=that.areLoading+update,0===that.areLoading}function adaptFrame2HeaderPosition(oldHeaderPos){var position,frame,header;if(frame=W.getFrame())switch(header=W.getHeader(),position=W.headerPosition||"top","bottom"===oldHeaderPos&&"bottom"!==position&&W.getFrameRoot().insertBefore(W.headerElement,frame),W.removeClass(frame,"ng_mainframe-header-[a-z-]*"),position){case"right":W.addClass(frame,"ng_mainframe-header-vertical-r");break;case"left":W.addClass(frame,"ng_mainframe-header-vertical-l");break;case"top":W.addClass(frame,"ng_mainframe-header-horizontal-t"),header&&W.getFrameRoot().insertBefore(header,frame);break;case"bottom":W.addClass(frame,"ng_mainframe-header-horizontal-b"),header&&W.getFrameRoot().insertBefore(header,frame.nextSibling)}}constants=node.constants,windowLevels=constants.windowLevels,screenLevels=constants.screenLevels,CB_EXECUTED=constants.stageLevels.CALLBACK_EXECUTED,WIN_LOADING=windowLevels.LOADING,GameWindow.prototype=DOM,GameWindow.prototype.constructor=GameWindow,GameWindow.defaults={},GameWindow.defaults.promptOnleaveText="",GameWindow.defaults.promptOnleave=!0,GameWindow.defaults.noEscape=!0,GameWindow.defaults.waitScreen=void 0,GameWindow.defaults.disableRightClick=!1,GameWindow.defaults.cacheDefaults={loadCache:!0,storeCacheNow:!1,storeCacheLater:!1},GameWindow.defaults.infoPanel=void 0,GameWindow.prototype.init=function(options){var stageLevels,stageLevel;this.setStateLevel("INITIALIZING"),options=options||{},this.conf=J.merge(this.conf,options),this.conf.promptOnleave?this.promptOnleave():!1===this.conf.promptOnleave&&this.restoreOnleave(),void 0===this.conf.noEscape||this.conf.noEscape?this.noEscape():!1===this.conf.noEscape&&this.restoreEscape(),!1!==this.conf.waitScreen?(this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.waitScreen=new node.WaitScreen(this.conf.waitScreen),stageLevels=constants.stageLevels,(stageLevel=node.game.getStageLevel())!==stageLevels.UNINITIALIZED&&(node.game.paused?this.lockScreen(this.waitScreen.defaultTexts.paused):stageLevel===stageLevels.DONE?this.lockScreen(this.waitScreen.defaultTexts.waiting):stageLevel!==stageLevels.PLAYING&&this.lockScreen(this.waitScreen.defaultTexts.stepping))):this.waitScreen&&(this.waitScreen.destroy(),this.waitScreen=null),this.conf.defaultHeaderPosition&&(this.defaultHeaderPosition=this.conf.defaultHeaderPosition),this.conf.disableRightClick?this.disableRightClick():!1===this.conf.disableRightClick&&this.enableRightClick(),void 0!==this.conf.disableBackButton&&this.disableBackButton(this.conf.disableBackButton),void 0!==this.conf.uriPrefix&&this.setUriPrefix(this.conf.uriPrefix),this.setStateLevel("INITIALIZED"),node.silly("node-window: inited.")},GameWindow.prototype.reset=function(){this.isScreenLocked()&&this.unlockScreen(),node.widgets&&node.widgets.destroyAll(),this.getFrame()&&this.destroyFrame(),this.getHeader()&&this.destroyHeader(),this.areLoading=0,this.clearCache(),node.silly("node-window: reseted")},GameWindow.prototype.setStateLevel=function(level){if("string"!=typeof level)throw new TypeError("GameWindow.setStateLevel: level must be string. Found: "+level);if(void 0===windowLevels[level])throw new Error("GameWindow.setStateLevel: unrecognized level: "+level);this.stateLevel=windowLevels[level]},GameWindow.prototype.getStateLevel=function(){return this.stateLevel},GameWindow.prototype.isReady=function(){return this.stateLevel===windowLevels.LOADED||this.stateLevel===windowLevels.INITIALIZED},GameWindow.prototype.setScreenLevel=function(level){if("string"!=typeof level)throw new TypeError("GameWindow.setScreenLevel: level must be string. Found: "+level);if(void 0===screenLevels[level])throw new Error("GameWindow.setScreenLevel: unrecognized level: "+level);this.screenState=screenLevels[level]},GameWindow.prototype.getScreenLevel=function(){return this.screenState},GameWindow.prototype.getFrame=function(){return this.frameElement||this.frameName&&(this.frameElement=document.getElementById(this.frameName)),this.frameElement},GameWindow.prototype.getFrameName=function(){var iframe;return this.frameName&&this.stateLevel!==WIN_LOADING||(iframe=this.getFrame(),this.frameName=iframe?iframe.name||iframe.id:null),this.frameName},GameWindow.prototype.getFrameWindow=function(){var iframe;return this.frameWindow&&this.stateLevel!==WIN_LOADING||(iframe=this.getFrame(),this.frameWindow=iframe?iframe.contentWindow:null),this.frameWindow},GameWindow.prototype.getFrameDocument=function(){var iframe;if(!this.frameDocument||this.stateLevel===WIN_LOADING){if(!(iframe=this.getFrame()))return null;this.frameDocument=this.getIFrameDocument(iframe)}return this.directFrameDocumentAccess?this.frameDocument:J.getIFrameDocument(this.getFrame())},GameWindow.prototype.getFrameRoot=function(){var iframe;return this.frameRoot||(iframe=this.getFrame(),this.frameRoot=iframe?iframe.parentNode:null),this.frameRoot},GameWindow.prototype.generateFrame=function(root,frameName,force){var iframe;if(this.frameElement){if(!force)throw new Error("GameWindow.generateFrame: frame is already existing. Use force to regenerate.");this.destroyFrame()}if(root=root||this.frameRoot||document.body,!J.isElement(root))throw new Error("GameWindow.generateFrame: root must be undefined or HTMLElement. Found: "+root);if("string"!=typeof(frameName=frameName||"ng_mainframe")||""===frameName.trim())throw new Error("GameWindow.generateFrame: frameName must be undefined or a non-empty string. Found: "+frameName);if(document.getElementById(frameName))throw new Error("GameWindow.generateFrame: frameName is not unique in DOM: "+frameName);return(iframe=W.add("iframe",root,frameName)).contentWindow.location.replace("about:blank"),iframe.frameBorder=0,iframe.scrolling="no",this.setFrame(iframe,frameName,root),this.getHeader()&&adaptFrame2HeaderPosition(),node.events.ng.emit("FRAME_GENERATED",iframe),document.body.onresize=function(){W.adjustFrameHeight(0,120)},iframe},GameWindow.prototype.generateInfoPanel=function(opts,force){var infoPanelDiv,root,btn;if(opts=opts||{},void 0===force&&(force=opts.force),force&&this.infoPanel&&(this.infoPanel.destroy(),this.infoPanel=null),this.infoPanel?(this.infoPanel.toggleBtn&&void 0===opts.toggleBtn&&(opts.toggleBtn=!1),node.warn("W.generateInfoPanel: Info Panel already existing.")):this.infoPanel=new node.InfoPanel(opts),infoPanelDiv=this.infoPanel.infoPanelDiv,root=opts.root){if("string"==typeof root&&(root=W.gid(root)),!J.isElement(root))throw new Error("GameWindow.generateInfoPanel: root must be undefined or HTMLElement. Found: "+root);root.appendChild(infoPanelDiv)}else this.frameElement?document.body.insertBefore(infoPanelDiv,this.frameElement):this.headerElement?J.insertAfter(this.headerElement,infoPanelDiv):document.body.appendChild(infoPanelDiv);if(!1!==opts.toggleBtn){if(root=null,opts.toggleBtnRoot){if(root="string"==typeof opts.toggleBtnRoot?W.gid(opts.toggleBtnRoot):opts.toggleBtnRoot,!J.isElement(root))throw new Error("GameWindow.generateInfoPanel: toggleBtnRoot did not resolve to a valid HTMLElement: "+opts.toggleBtnRoot)}else this.headerElement&&(root=this.headerElement);root&&(btn=W.infoPanel.createToggleBtn(opts.toggleBtnLabel),root.appendChild(btn))}return opts.innerHTML&&(W.infoPanel.infoPanelDiv.innerHTML=opts.innerHTML),node.events.ng.emit("INFOPANEL_GENERATED",this.infoPanel),this.infoPanel},GameWindow.prototype.setFrame=function(iframe,iframeName,root){if(!J.isElement(iframe))throw new TypeError("GameWindow.setFrame: iframe must be HTMLElement. Found: "+iframe);if("string"!=typeof iframeName)throw new TypeError("GameWindow.setFrame: iframeName must be string. Found: "+iframeName);if(!J.isElement(root))throw new TypeError("GameWindow.setFrame: root must be HTMLElement. Found: "+root);return this.frameRoot=root,this.frameName=iframeName,this.frameElement=iframe,this.frameWindow=iframe.contentWindow,this.frameDocument=W.getIFrameDocument(iframe),iframe},GameWindow.prototype.destroyFrame=function(){this.clearFrame(),this.frameRoot&&this.frameRoot.removeChild(this.frameElement),this.frameElement=null,this.frameWindow=null,this.frameDocument=null,this.frameRoot=null,node.widgets.garbageCollection()},GameWindow.prototype.clearFrame=function(){var iframe,frameName,frameDocument;if(!(iframe=this.getFrame()))throw new Error("GameWindow.clearFrame: frame not found");frameName=iframe.name||iframe.id,iframe.onload=null,(frameDocument=this.getFrameDocument()).documentElement.innerHTML="",this.directFrameDocumentAccess?frameDocument.documentElement.innerHTML="":J.removeChildrenFromNode(frameDocument.documentElement),this.frameElement=iframe,this.frameWindow=window.frames[frameName],this.frameDocument=W.getIFrameDocument(iframe),node.widgets.garbageCollection()},GameWindow.prototype.generateHeader=function(root,headerName,force){var header;if(this.headerElement){if(!force)throw new Error("GameWindow.generateHeader: header is already existing. Use force to regenerate.");this.destroyHeader()}if(root=root||document.body||document.lastElementChild,!J.isElement(root))throw new Error("GameWindow.generateHeader: root must be undefined or HTMLElement. Found: "+root);if("string"!=typeof(headerName=headerName||"ng_header"))throw new Error("GameWindow.generateHeader: headerName must be string. Found: "+headerName);if(document.getElementById(headerName))throw new Error("GameWindow.generateHeader: headerName is not unique in DOM: "+headerName);return header=this.add("div",root,headerName),this.frameElement&&"bottom"!==this.defaultHeaderPosition&&this.getFrameRoot().insertBefore(header,this.frameElement),this.setHeader(header,headerName,root),this.setHeaderPosition(this.defaultHeaderPosition),header},GameWindow.prototype.setHeaderPosition=(validPositions={top:"ng_header_position-horizontal-t",bottom:"ng_header_position-horizontal-b",right:"ng_header_position-vertical-r",left:"ng_header_position-vertical-l"},function(position){var pos,oldPos;if("string"!=typeof position)throw new TypeError("GameWindow.setHeaderPosition: position must be string. Found: "+position);if(pos=position.toLowerCase(),this.headerPosition!==pos)if(void 0!==validPositions[pos]){if(!this.headerElement)throw new Error("GameWindow.setHeaderPosition: headerElement not found.");W.removeClass(this.headerElement,"ng_header_position-[a-z-]*"),W.addClass(this.headerElement,validPositions[pos]),oldPos=this.headerPosition,this.headerPosition=pos,this.frameElement&&adaptFrame2HeaderPosition(oldPos)}else node.err("GameWindow.setHeaderPosition: invalid header position: "+pos)}),GameWindow.prototype.setHeader=function(header,headerName,root){if(!J.isElement(header))throw new Error("GameWindow.setHeader: header must be HTMLElement. Found: "+header);if("string"!=typeof headerName)throw new Error("GameWindow.setHeader: headerName must be string. Found: "+headerName);if(!J.isElement(root))throw new Error("GameWindow.setHeader: root must be HTMLElement. Found: "+root);return this.headerElement=header,this.headerName=headerName,this.headerRoot=root,node.events.ng.emit("HEADER_GENERATED",header),this.headerElement},GameWindow.prototype.getHeader=function(){return this.headerElement||(this.headerElement=this.headerName?document.getElementById(this.headerName):null),this.headerElement},GameWindow.prototype.getHeaderName=function(){var header;return this.headerName||(header=this.getHeader(),this.headerName=header?header.id:null),this.headerName},GameWindow.prototype.getHeaderRoot=function(){var header;return this.headerRoot||(header=this.getHeader(),this.headerRoot=header?header.parentNode:null),this.headerRoot},GameWindow.prototype.destroyHeader=function(){this.clearHeader(),this.headerRoot.removeChild(this.headerElement),this.headerElement=null,this.headerName=null,this.headerRoot=null,this.headerPosition=null,this.headerOffset=0,this.adjustHeaderOffset(!0)},GameWindow.prototype.clearHeader=function(){if(!this.getHeader())throw new Error("GameWindow.clearHeader: cannot detect header");this.headerElement.innerHTML="",node.widgets.garbageCollection()},GameWindow.prototype.initLibs=function(globalLibs,frameLibs){if(globalLibs&&!J.isArray(globalLibs))throw new TypeError("GameWindow.initLibs: globalLibs must be array or undefined. Found: "+globalLibs);if(frameLibs&&"object"!=typeof frameLibs)throw new TypeError("GameWindow.initLibs: frameLibs must be object or undefined. Found: "+frameLibs);if(!globalLibs&&!frameLibs)throw new Error("GameWindow.initLibs: frameLibs and frameLibs cannot be both undefined.");this.globalLibs=this.globalLibs.concat(globalLibs||[]),J.mixin(this.frameLibs,frameLibs)},GameWindow.prototype.preCacheTest=function(cb,uri){var iframe;if("string"!=typeof(uri=uri||"/pages/testpage.htm"))throw new TypeError("GameWindow.precacheTest: uri must string or undefined. Found: "+uri);(iframe=document.createElement("iframe")).style.display="none",iframe.id="preCacheTest",iframe.name="preCacheTest",document.body.appendChild(iframe),iframe.contentWindow.location.replace(uri),onLoad(iframe,(function(){try{W.getIFrameDocument(iframe).documentElement.innerHTML="a",W.cacheSupported=!0}catch(e){W.cacheSupported=!1}document.body.removeChild(iframe),cb&&cb()}))},GameWindow.prototype.preCache=function(uris,callback){var that,loadedCount,currentUri,uriIdx,iframe,iframeName;if("string"==typeof uris&&(uris=[uris]),!J.isArray(uris))throw new TypeError("GameWindow.preCache: uris must be string or array. Found: "+uris);if(callback&&"function"!=typeof callback)throw new TypeError("GameWindow.preCache: callback must be function or undefined. Found: "+callback);if(uris.length)if(that=this,null!==this.cacheSupported){if(!1===this.cacheSupported)return node.warn("GameWindow.preCache: caching is not supported by your browser."),void(callback&&callback());for(loadedCount=0,uriIdx=0;uriIdx<uris.length;uriIdx++)currentUri=this.processUri(uris[uriIdx]),(iframe=document.createElement("iframe")).style.display="none",iframeName="tmp_iframe_"+uriIdx,iframe.id=iframeName,iframe.name=iframeName,document.body.appendChild(iframe),function(uri,thisIframe){onLoad(thisIframe,(function(){var frameDocumentElement;frameDocumentElement=W.getIFrameDocument(thisIframe).documentElement,that.cache[uri]={contents:frameDocumentElement.innerHTML,cacheOnClose:!1},document.body.removeChild(thisIframe),++loadedCount>=uris.length&&callback&&callback()}))}(currentUri,iframe),window.frames[iframeName].location.replace(currentUri)}else this.preCacheTest((function(){that.preCache(uris,callback)}));else callback&&callback()},GameWindow.prototype.clearCache=function(){this.cache={}},GameWindow.prototype.getElementById=GameWindow.prototype.gid=function(id){var el,frameDocument;return el=null,(frameDocument=this.getFrameDocument())&&frameDocument.getElementById&&(el=frameDocument.getElementById(id)),el||(el=document.getElementById(id)),el},GameWindow.prototype.getElementsByTagName=function(tag){var frameDocument;return(frameDocument=this.getFrameDocument())?frameDocument.getElementsByTagName(tag):document.getElementsByTagName(tag)},GameWindow.prototype.getElementsByClassName=function(className,tag){var doc;return doc=this.getFrameDocument()||document,J.getElementsByClassName(doc,className,tag)},GameWindow.prototype.loadFrame=function(uri,func,opts){var that,loadCache,storeCacheNow,storeCacheLater,scrollUp,autoParse,autoParsePrefix,autoParseMod,iframe,iframeName,iframeDocument,iframeWindow,frameDocumentElement,frameReady,lastURI;if("string"!=typeof uri)throw new TypeError("GameWindow.loadFrame: uri must be string. Found: "+uri);if(func&&"function"!=typeof func)throw new TypeError("GameWindow.loadFrame: func must be function or undefined. Found: "+func);if(opts&&"object"!=typeof opts)throw new TypeError("GameWindow.loadFrame: opts must be object or undefined. Found: "+opts);if(opts=opts||{},iframe=this.getFrame(),iframeName=this.frameName,!iframe)throw new Error("GameWindow.loadFrame: no frame found");if(!iframeName)throw new Error("GameWindow.loadFrame: frame has no name");if(this.setStateLevel("LOADING"),that=this,iframeWindow=iframe.contentWindow,frameReady="complete"===(frameReady=(iframeDocument=W.getIFrameDocument(iframe)).readyState),loadCache=GameWindow.defaults.cacheDefaults.loadCache,storeCacheNow=GameWindow.defaults.cacheDefaults.storeCacheNow,storeCacheLater=GameWindow.defaults.cacheDefaults.storeCacheLater,opts.cache){if(opts.cache.loadMode)if("reload"===opts.cache.loadMode)loadCache=!1;else{if("cache"!==opts.cache.loadMode)throw new Error("GameWindow.loadFrame: unkown cache load mode: "+opts.cache.loadMode);loadCache=!0}if(opts.cache.storeMode)if("off"===opts.cache.storeMode)storeCacheNow=!1,storeCacheLater=!1;else if("onLoad"===opts.cache.storeMode)storeCacheNow=!0,storeCacheLater=!1;else{if("onClose"!==opts.cache.storeMode)throw new Error("GameWindow.loadFrame: unkown cache store mode: "+opts.cache.storeMode);storeCacheNow=!1,storeCacheLater=!0}}if(void 0!==opts.autoParse){if("object"!=typeof opts.autoParse)throw new TypeError("GameWindow.loadFrame: opts.autoParse must be object or undefined. Found: "+opts.autoParse);if(void 0!==opts.autoParsePrefix){if("string"!=typeof opts.autoParsePrefix)throw new TypeError("GameWindow.loadFrame: opts.autoParsePrefix must be string or undefined. Found: "+opts.autoParsePrefix);autoParsePrefix=opts.autoParsePrefix}if(void 0!==opts.autoParseMod){if("string"!=typeof opts.autoParseMod)throw new TypeError("GameWindow.loadFrame: opts.autoParseMod must be string or undefined. Found: "+opts.autoParseMod);autoParseMod=opts.autoParseMod}autoParse=opts.autoParse}scrollUp=void 0===opts.scrollUp||opts.scrollUp,this.unprocessedUri=uri,null!==this.cacheSupported?(uri=this.processUri(uri),!1===this.cacheSupported?(storeCacheNow=!1,storeCacheLater=!1,loadCache=!1):(lastURI=this.currentURIs[iframeName],this.cache.hasOwnProperty(lastURI)&&this.cache[lastURI].cacheOnClose&&(frameDocumentElement=iframeDocument.documentElement,this.cache[lastURI].contents=frameDocumentElement.innerHTML),this.cache.hasOwnProperty(uri)||(this.cache[uri]={contents:null,cacheOnClose:!1}),this.cache[uri].cacheOnClose=storeCacheLater,null===this.cache[uri].contents&&(loadCache=!1)),this.currentURIs[iframeName]=uri,updateAreLoading(this,1),iframe.style.visibility="hidden",loadCache&&frameReady||onLoad(iframe,(function(){null===that.directFrameDocumentAccess&&function(that){try{that.frameDocument.getElementById("test"),that.directFrameDocumentAccess=!0}catch(e){that.directFrameDocumentAccess=!1}}(that),handleFrameLoad(that,uri,iframe,iframeName,loadCache,storeCacheNow,(function(){that.updateLoadFrameState(func,autoParse,autoParseMod,autoParsePrefix,scrollUp)}))})),loadCache?frameReady&&handleFrameLoad(this,uri,iframe,iframeName,loadCache,storeCacheNow,(function(){that.updateLoadFrameState(func,autoParse,autoParseMod,autoParsePrefix,scrollUp)})):iframeWindow.location.replace(uri),iframeWindow.node=node):this.preCacheTest((function(){that.loadFrame(uri,func,opts)}))},GameWindow.prototype.processUri=function(uri){return"/"!==uri.charAt(0)&&"http://"!==uri.substr(0,7)&&(this.uriPrefix&&(uri=this.uriPrefix+uri),this.uriChannel&&(uri=this.uriChannel+uri)),uri},GameWindow.prototype.updateLoadFrameState=function(func,autoParse,autoParseMod,autoParsePrefix,scrollUp){var loaded;(loaded=updateAreLoading(this,-1))&&this.setStateLevel("LOADED"),func&&func.call(node.game),autoParse&&this.searchReplace(autoParse,autoParseMod,autoParsePrefix),scrollUp&&window.scrollTo&&window.scrollTo(0,0),node.events.ee.game.emit("FRAME_LOADED"),node.events.ee.stage.emit("FRAME_LOADED"),node.events.ee.step.emit("FRAME_LOADED"),loaded?node.game.getStageLevel()===CB_EXECUTED&&node.emit("LOADED"):node.silly("game-window: "+this.areLoading+" frames still loading.")},GameWindow.prototype.clearPageBody=function(){this.reset(),document.body.innerHTML=""},GameWindow.prototype.clearPage=function(){this.reset();try{document.documentElement.innerHTML=""}catch(e){this.removeChildrenFromNode(document.documentElement)}},GameWindow.prototype.setUriPrefix=function(uriPrefix){if(null!==uriPrefix&&"string"!=typeof uriPrefix)throw new TypeError("GameWindow.setUriPrefix: uriPrefix must be string or null. Found: "+uriPrefix);this.conf.uriPrefix=this.uriPrefix=uriPrefix},GameWindow.prototype.setUriChannel=function(uriChannel){if("string"==typeof uriChannel)"/"!==uriChannel.charAt(0)&&(uriChannel="/"+uriChannel),"/"!==uriChannel.charAt(uriChannel.length-1)&&(uriChannel+="/");else if(null!==uriChannel)throw new TypeError("GameWindow.uriChannel: uriChannel must be string or null. Found: "+uriChannel);this.uriChannel=uriChannel},GameWindow.prototype.adjustFrameHeight=(adjustIt=function(userMinHeight){var iframe,minHeight,contentHeight;W.adjustHeaderOffset(),(iframe=W.getFrame())&&iframe.contentWindow&&(iframe.contentWindow.document.body?(!1===W.conf.adjustFrameHeight?minHeight="100vh":(minHeight=window.innerHeight||window.clientHeight,contentHeight=iframe.contentWindow.document.body.offsetHeight,contentHeight+=60,"top"===W.headerPosition&&(contentHeight+=W.headerOffset),minHeight<contentHeight&&(minHeight=contentHeight),minHeight<(userMinHeight||0)&&(minHeight=userMinHeight),minHeight+="px"),iframe.style["min-height"]=minHeight):W.adjustFrameHeight(userMinHeight,120))},function(userMinHeight,delay){void 0!==delay?W.willResizeFrame?nextTimeout=!0:W.willResizeFrame=setTimeout((function(){W.willResizeFrame=null,nextTimeout?(nextTimeout=!1,W.adjustFrameHeight(userMinHeight,delay)):adjustIt(userMinHeight)}),delay):adjustIt(userMinHeight)}),GameWindow.prototype.adjustHeaderOffset=function(force){var position,frame,header,infoPanel,offset,offsetPx;if(header=W.getHeader(),position=W.headerPosition,(force||!(!header&&W.headerOffset||"top"===position&&header.offsetHeight===W.headerOffset))&&(frame=W.getFrame(),infoPanel=W.infoPanel,frame||infoPanel)){switch(position){case"top":offsetPx=(offset=header?header.offsetHeight:0)+"px",infoPanel&&infoPanel.isVisible?(infoPanel.infoPanelDiv.style["padding-top"]=offsetPx,frame.style["padding-top"]=0):(infoPanel&&infoPanel.infoPanelDiv&&(infoPanel.infoPanelDiv.style["padding-top"]=0),frame.style["padding-top"]=offsetPx);break;case"bottom":offsetPx=(offset=header?header.offsetHeight:0)+"px",frame.style["padding-bottom"]=offsetPx,infoPanel&&infoPanel.infoPanelDiv&&(infoPanel.infoPanelDiv.style["padding-top"]=0);break;case"right":offsetPx=(offset=header?header.offsetWidth:0)+"px",frame&&(frame.style["padding-right"]=offsetPx),infoPanel&&infoPanel.isVisible&&(infoPanel.infoPanelDiv.style["padding-right"]=offsetPx);break;case"left":offsetPx=(offset=header?header.offsetWidth:0)+"px",frame&&(frame.style["padding-left"]=offsetPx),infoPanel&&infoPanel.isVisible&&(infoPanel.infoPanelDiv.style["padding-left"]=offsetPx);break;default:if(null!==position)throw new Error("GameWindow.adjustHeaderOffset: invalid header position. Found: "+position);if(header)throw new Error("GameWindow.adjustHeaderOffset: something is wrong. Header found, but position is null.");frame&&(frame.style.padding=0),infoPanel&&infoPanel.infoPanelDiv&&(infoPanel.infoPanelDiv.padding=0)}W.headerOffset=offset}},node.GameWindow=GameWindow}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(window,node){node.GameWindow.prototype.addDefaultSetups=function(){node.registerSetup("window",(function(conf){return this.window.init(conf),conf})),node.registerSetup("page",(function(conf){var tmp,body;if(conf)return conf.clearBody&&this.window.clearPageBody(),conf.clear&&this.window.clearPage(),"string"==typeof conf.title&&(conf.title={title:conf.title}),"object"==typeof conf.title&&(document.title=conf.title.title,conf.title.addToBody&&((tmp=document.createElement("h1")).className="ng-page-title",tmp.innerHTML=conf.title.title,""===(body=document.body).innerHTML?body.appendChild(tmp):body.insertBefore(tmp,body.firstChild))),conf})),node.registerSetup("frame",(function(conf){var url,cb,options,frameName,force,root,rootName;if(conf){if(conf.generate){if("object"!=typeof conf.generate)return void node.warn("node.setup.frame: conf.generate must be object or undefined.");if(conf.generate.root){if("string"!=typeof conf.generate.root)return void node.warn("node.setup.frame: conf.generate.root must be string or undefined.");rootName=conf.generate.root,force=conf.generate.force,frameName=conf.generate.name}if((root=this.window.getElementById(rootName))||(root=this.window.getScreen()),!root)return void node.warn("node.setup.frame: could not find valid root element to generate new frame.");this.window.generateFrame(root,frameName,force)}if(void 0!==conf.uriPrefix&&this.window.setUriPrefix(conf.uriPrefix),conf.load){if("object"==typeof conf.load)url=conf.load.url,cb=conf.load.cb,options=conf.load.options;else{if("string"!=typeof conf.load)return void node.warn("node.setup.frame: conf.load must be string, object or undefined.");url=conf.load}this.window.loadFrame(url,cb,options)}return conf.clear&&this.window.clearFrame(),conf.destroy&&this.window.destroyFrame(),conf}})),node.registerSetup("header",(function(conf){var headerName,force,root,rootName;if(conf){if(conf.generate){if("object"!=typeof conf.generate)return void node.warn("node.setup.header: conf.generate must be object or undefined.");if(conf.generate.root){if("string"!=typeof conf.generate.root)return void node.warn("node.setup.header: conf.generate.root must be string or undefined.");rootName=conf.generate.root,force=conf.generate.force,headerName=conf.generate.name}if((root=this.window.getElementById(rootName))||(root=this.window.getScreen()),!root)return void node.warn("node.setup.header: could not find valid root element to generate new header.");this.window.generateHeader(root,headerName,force)}if(conf.position){if("string"!=typeof conf.position)return void node.warn("node.setup.header: conf.position must be string or undefined.");this.window.setHeaderPosition(conf.position)}return conf.clear&&this.window.clearHeader(),conf.destroy&&this.window.destroyHeader(),conf}}))}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(window,node){"use strict";var GameWindow=node.GameWindow,J=node.JSUS;GameWindow.prototype.noEscape=function(){var frameDocument;window.document.onkeydown=function(e){if(27===(window.event?event.keyCode:e.keyCode))return!1},(frameDocument=this.getFrameDocument())&&(frameDocument.onkeydown=window.document.onkeydown),this.conf.noEscape=!0},GameWindow.prototype.restoreEscape=function(){var frameDocument;window.document.onkeydown=null,(frameDocument=this.getFrameDocument())&&(frameDocument.onkeydown=null),this.conf.noEscape=!1},GameWindow.prototype.promptOnleave=function(windowObj,text){windowObj=windowObj||window,text=void 0!==text?text:this.conf.promptOnleaveText,windowObj.onbeforeunload=function(e){return(e=e||window.event)&&(e.returnValue=text),text},this.conf.promptOnleave=!0},GameWindow.prototype.restoreOnleave=function(windowObj){(windowObj=windowObj||window).onbeforeunload=null,this.conf.promptOnleave=!1},GameWindow.prototype.disableRightClick=function(){this.frameElement&&J.disableRightClick(this.getFrameDocument()),J.disableRightClick(document),this.conf.rightClickDisabled=!0},GameWindow.prototype.enableRightClick=function(){this.frameElement&&J.enableRightClick(this.getFrameDocument()),J.enableRightClick(document),this.conf.rightClickDisabled=!1},GameWindow.prototype.disableBackButton=function(disable){this.conf.backButtonDisabled=J.disableBackButton(disable)}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(window,node){"use strict";var GameWindow=node.GameWindow,screenLevels=node.constants.screenLevels;GameWindow.prototype.lockScreen=function(text,countdown){if(!this.waitScreen)throw new Error("GameWindow.lockScreen: waitScreen not found");if(text&&"string"!=typeof text)throw new TypeError("GameWindow.lockScreen: text must be string or undefined. Found: "+text);if(countdown&&"number"!=typeof countdown||countdown<0)throw new TypeError("GameWindow.lockScreen: countdown must be a positive number or undefined. Found: "+countdown);this.setScreenLevel("LOCKING"),this.waitScreen.lock(text,countdown),this.setScreenLevel("LOCKED")},GameWindow.prototype.unlockScreen=function(){if(!this.waitScreen)throw new Error("GameWindow.unlockScreen: waitScreen not found.");if(!this.isScreenLocked())throw new Error("GameWindow.unlockScreen: screen is not locked.");this.setScreenLevel("UNLOCKING"),this.waitScreen.unlock(),this.setScreenLevel("ACTIVE")},GameWindow.prototype.isScreenLocked=function(){return this.getScreenLevel()!==screenLevels.ACTIVE}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(node){"use strict";node.GameWindow.prototype.addDefaultListeners=function(force){return this.listenersAdded&&!force?(node.err("node.window.addDefaultListeners: listeners already added once. Use the force flag to re-add."),!1):(node.on("NODEGAME_GAME_CREATED",(function(){W.init(node.conf.window)})),node.on("INPUT_DISABLE",(function(id){W.toggleInputs(id,!0)})),node.on("INPUT_ENABLE",(function(id){W.toggleInputs(id,!1)})),node.on("INPUT_TOGGLE",(function(id){W.toggleInputs(id)})),window.onunload=function(){var i;for(node.socket.disconnect(),i=-1;++i<1e5;);},this.listenersAdded=!0,node.silly("node-window: listeners added."),!0)}}("undefined"!=typeof node?node:void 0),function(exports,window){"use strict";var inputTags,len;function lockUnlockedInputs(container,disable){var j,i,inputs,nInputs;for(void 0===disable&&(disable=!0),j=-1;++j<len;)for(nInputs=(inputs=container.getElementsByTagName(inputTags[j])).length,i=-1;++i<nInputs;)disable?inputs[i].disabled||(inputs[i].disabled=!0,W.waitScreen.lockedInputs.push(inputs[i])):inputs[i].disabled&&(inputs[i].disabled=!1);disable||(W.waitScreen.lockedInputs=[])}function event_REALLY_DONE(text){var countdown;text=text||W.waitScreen.defaultTexts.waiting,node.game.shouldStep()||(W.isScreenLocked()?W.waitScreen.updateText(text):(node.game.timer.milliseconds&&(countdown=node.game.timer.milliseconds-node.timer.getTimeSince("step",!0)+2e3)<0&&(countdown=0),W.lockScreen(text,countdown)))}function event_STEPPING(){var text;text=W.waitScreen.defaultTexts.stepping,W.isScreenLocked()?W.waitScreen.updateText(text):W.lockScreen(text)}function event_PLAYING(){W.isScreenLocked()&&W.unlockScreen()}function event_PAUSED(text){text=text||W.waitScreen.defaultTexts.paused,W.isScreenLocked()?(W.waitScreen.beforePauseInnerHTML=W.waitScreen.contentDiv.innerHTML,W.waitScreen.updateText(text)):W.lockScreen(text)}function event_RESUMED(){W.isScreenLocked()&&(null!==W.waitScreen.beforePauseInnerHTML?(W.waitScreen.updateText(W.waitScreen.beforePauseInnerHTML),W.waitScreen.beforePauseInnerHTML=null):W.unlockScreen())}function WaitScreen(opts){opts=opts||{},this.id=opts.id||"ng_waitScreen",this.root=opts.root||null,this.waitingDiv=null,this.beforePauseInnerHTML=null,this.enabled=!1,this.contentDiv=null,this.countdownDiv=null,this.countdownSpan=null,this.countdown=null,this.displayCountdown=void 0===opts.displayCountdown||!!opts.displayCountdown,this.defaultTexts={locked:opts.lockedText||"Screen locked. Please wait...",waiting:opts.waitingText||"Waiting for other players to be done...",stepping:opts.steppingText||"Initializing game step, will be ready soon...",paused:opts.pausedText||"Game is paused. Please wait.",countdown:opts.countdownResumingText||"<br>Do not refresh the page!<br>Maximum Waiting Time: ",countdownResuming:opts.countdownResumingText||"Resuming soon...",formatCountdown:function(time){var out;return out="",(time=J.parseMilliseconds(time))[2]&&(out+=time[2]+" min "),time[3]&&(out+=time[3]+" sec"),out||0}},this.lockedInputs=[],this.enable()}exports.WaitScreen=WaitScreen,WaitScreen.version="0.10.0",WaitScreen.description="Shows a waiting screen",len=(inputTags=["button","select","textarea","input"]).length,WaitScreen.prototype.enable=function(){this.enabled||(node.events.ee.game.on("REALLY_DONE",event_REALLY_DONE),node.events.ee.game.on("STEPPING",event_STEPPING),node.events.ee.game.on("PLAYING",event_PLAYING),node.events.ee.game.on("PAUSED",event_PAUSED),node.events.ee.game.on("RESUMED",event_RESUMED),this.enabled=!0)},WaitScreen.prototype.disable=function(){this.enabled&&(node.events.ee.game.off("REALLY_DONE",event_REALLY_DONE),node.events.ee.game.off("STEPPING",event_STEPPING),node.events.ee.game.off("PLAYING",event_PLAYING),node.events.ee.game.off("PAUSED",event_PAUSED),node.events.ee.game.off("RESUMED",event_RESUMED),this.enabled=!1)},WaitScreen.prototype.lock=function(text,countdown){var frameDoc,t;t=this.defaultTexts,void 0===text&&(text=t.locked),void 0===document.getElementsByTagName&&node.warn("WaitScreen.lock: cannot lock inputs"),lockUnlockedInputs(document),(frameDoc=W.getFrameDocument())&&lockUnlockedInputs(frameDoc),this.waitingDiv||(this.root||(this.root=W.getFrameRoot()||document.body),this.waitingDiv=W.add("div",this.root,this.id),this.contentDiv=W.add("div",this.waitingDiv,"ng_waitscreen-content-div")),"none"===this.waitingDiv.style.display&&(this.waitingDiv.style.display=""),this.contentDiv.innerHTML=text,this.displayCountdown&&countdown?(this.countdownDiv||(this.countdownDiv=W.add("div",this.waitingDiv,"ng_waitscreen-countdown-div"),this.countdownDiv.innerHTML=t.countdown,this.countdownSpan=W.add("span",this.countdownDiv,"ng_waitscreen-countdown-span")),this.countdown=countdown,this.countdownSpan.innerHTML=t.formatCountdown(countdown),this.countdownDiv.style.display="",this.countdownInterval=setInterval((function(){var w;w=W.waitScreen,W.isScreenLocked()?(w.countdown-=1e3,w.countdown<0?(clearInterval(w.countdownInterval),w.countdownDiv.style.display="none",w.contentDiv.innerHTML=t.countdownResuming):w.countdownSpan.innerHTML=t.formatCountdown(w.countdown)):clearInterval(w.countdownInterval)}),1e3)):this.countdownDiv&&(this.countdownDiv.style.display="none")},WaitScreen.prototype.unlock=function(){var i,len;this.waitingDiv&&""===this.waitingDiv.style.display&&(this.waitingDiv.style.display="none"),this.countdownInterval&&clearInterval(this.countdownInterval);try{for(len=this.lockedInputs.length,i=-1;++i<len;)this.lockedInputs[i].removeAttribute("disabled");this.lockedInputs=[]}catch(e){lockUnlockedInputs(W.getIFrameDocument(W.getFrame()),!1)}},WaitScreen.prototype.updateText=function(text,append){if(append=append||!1,"string"!=typeof text)throw new TypeError("WaitScreen.updateText: text must be string. Found: "+text);append?this.contentDiv.innerHTML+=text:this.contentDiv.innerHTML=text},WaitScreen.prototype.destroy=function(){W.isScreenLocked()&&(W.setScreenLevel("UNLOCKING"),this.unlock(),W.setScreenLevel("ACTIVE")),this.waitingDiv&&this.waitingDiv.parentNode&&this.waitingDiv.parentNode.removeChild(this.waitingDiv),this.disable()}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(exports,window){"use strict";function InfoPanel(options){this.init(options||{})}exports.InfoPanel=InfoPanel,InfoPanel.prototype.init=function(options){var that;if(options=options||{},this.infoPanelDiv=document.createElement("div"),this.infoPanelDiv.id="ng_info-panel",this.actionsLog=[],this._buttons=[],this.toggleBtn=null,void 0===options.className)this.infoPanelDiv.className="";else{if("string"!=typeof options.className)throw new TypeError("InfoPanel constructor: options.className must be a string or undefined. Found: "+options.className);this.infoPanelDiv.className=options.className}if(void 0===options.isVisible)this.isVisible=!1;else{if("boolean"!=typeof options.isVisible)throw new TypeError("InfoPanel constructor: options.isVisible must be a boolean or undefined. Found: "+options.isVisible);this.isVisible=options.isVisible}if(this.infoPanelDiv.style.display=this.isVisible?"block":"none",this.actionsLog.push({created:J.now()}),void 0!==options.onStep){if("open"!==options.onStep&&"close"!==options.onStep&&"clear"!==options.onStep)throw new TypeError('InfoPanel constructor: options.onStep must be string "open", "close", "clear" or undefined. Found: '+options.onStep);this.onStep=options.onStep}else options.onStep=null;if(void 0!==options.onStage){if("open"!==options.onStage&&"close"!==options.onStage&&"clear"!==options.onStage)throw new TypeError('InfoPanel constructor: options.onStage must be string "open", "close", "clear" or undefined. Found: '+options.onStage);this.onStage=options.onStage}else options.onStage=null;(this.onStep||this.onStage)&&(that=this,node.events.game.on("STEPPING",(function(curStep,newStep){var newStage;newStage=curStep.stage!==newStep.stage,"close"===that.onStep&&that.isVisible||newStage&&"close"===that.onStage?that.close():"open"===that.onStep||newStage&&"open"===that.onStage?that.open():("clear"===that.onStep||newStage&&"clear"===that.onStage)&&that.clear()})))},InfoPanel.prototype.clear=function(){this.infoPanelDiv.innerHTML="",this.actionsLog.push({clear:J.now()}),W.adjustHeaderOffset(!0)},InfoPanel.prototype.getPanel=function(){return this.infoPanelDiv},InfoPanel.prototype.destroy=function(actionsLog){var i,len;for(actionsLog?this.actionsLog=[]:this.actionsLog.push({destroy:J.now()}),this.infoPanelDiv.parentNode&&this.infoPanelDiv.parentNode.removeChild(this.infoPanelDiv),this.isVisible=!1,this.infoPanelDiv=null,i=-1,len=this._buttons.length;++i<len;)this._buttons[i].parentNode&&this._buttons[i].parentNode.removeChild(this._buttons[i]);W.adjustHeaderOffset(!0)},InfoPanel.prototype.toggle=function(){this.isVisible?this.close():this.open()},InfoPanel.prototype.open=function(){this.isVisible||(this.actionsLog.push({open:J.now()}),this.infoPanelDiv.style.display="block",this.isVisible=!0,W.adjustHeaderOffset(!0),"function"==typeof this.infoPanelDiv.scrollIntoView&&this.infoPanelDiv.scrollIntoView({behavior:"smooth"}))},InfoPanel.prototype.close=function(){this.isVisible&&(this.actionsLog.push({close:J.now()}),this.infoPanelDiv.style.display="none",this.isVisible=!1,W.adjustHeaderOffset(!0))},InfoPanel.prototype.createToggleBtn=InfoPanel.prototype.createToggleButton=function(label){var that,button;if("string"!=typeof(label=label||"Info")||""===label.trim())throw new Error("InfoPanel.createToggleButton: label must be undefined or a non-empty string. Found: "+label);return(button=document.createElement("button")).className="btn btn-lg btn-warning",button.innerHTML=label,that=this,button.onclick=function(){that.toggle()},this._buttons.push(button),this.toggleBtn=button,button}}("undefined"!=typeof node?node:module.parent.exports.node,"undefined"!=typeof window?window:module.parent.exports.window),function(window,node){"use strict";var constants=node.constants,GameWindow=node.GameWindow;GameWindow.prototype.getRecipientSelector=function(id){var toSelector;return toSelector=document.createElement("select"),void 0!==id&&(toSelector.id=id),this.addStandardRecipients(toSelector),toSelector},GameWindow.prototype.addRecipientSelector=function(root,id){var toSelector;return!!root&&(toSelector=this.getRecipientSelector(id),root.appendChild(toSelector))},GameWindow.prototype.addStandardRecipients=function(toSelector){var opt;(opt=document.createElement("option")).value="ALL",opt.appendChild(document.createTextNode("ALL")),toSelector.appendChild(opt),(opt=document.createElement("option")).value="CHANNEL",opt.appendChild(document.createTextNode("CHANNEL")),toSelector.appendChild(opt),(opt=document.createElement("option")).value="ROOM",opt.appendChild(document.createTextNode("ROOM")),toSelector.appendChild(opt),(opt=document.createElement("option")).value="SERVER",opt.appendChild(document.createTextNode("SERVER")),toSelector.appendChild(opt)},GameWindow.prototype.populateRecipientSelector=function(toSelector,playerList){var players,opt;"object"==typeof playerList&&"object"==typeof toSelector&&(this.removeChildrenFromNode(toSelector),this.addStandardRecipients(toSelector),players=playerList.db||playerList,J.each(players,(function(p){(opt=document.createElement("option")).value=p.id,opt.appendChild(document.createTextNode(p.name||p.id)),toSelector.appendChild(opt)})))},GameWindow.prototype.getActionSelector=function(id){var actionSelector=document.createElement("select");return void 0!==id&&(actionSelector.id=id),this.populateSelect(actionSelector,constants.action),actionSelector},GameWindow.prototype.addActionSelector=function(root,id){var actionSelector;if(root)return actionSelector=this.getActionSelector(id),root.appendChild(actionSelector)},GameWindow.prototype.getTargetSelector=function(id){var targetSelector;return targetSelector=document.createElement("select"),void 0!==id&&(targetSelector.id=id),this.populateSelect(targetSelector,constants.target),targetSelector},GameWindow.prototype.addTargetSelector=function(root,id){if(root){var targetSelector=this.getTargetSelector(id);return root.appendChild(targetSelector)}}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(window,node){"use strict";var GameWindow=node.GameWindow,DOM=J.require("DOM");function toggleInputs(state,container){var inputTags,j,len,i,inputs,nInputs;for(container=container||document,len=(inputTags=["button","select","textarea","input"]).length,j=0;j<len;j++)for(nInputs=(inputs=container.getElementsByTagName(inputTags[j])).length,i=0;i<nInputs;i++)void 0===state&&(state=!inputs[i].disabled),state?inputs[i].disabled=state:inputs[i].removeAttribute("disabled")}function getElement(idOrObj,prefix){var el;if("string"==typeof idOrObj)el=W.getElementById(idOrObj);else{if(!J.isElement(idOrObj))throw new TypeError(prefix+": idOrObj must be string  or HTML Element. Found: "+idOrObj);el=idOrObj}return el}GameWindow.prototype.getScreen=function(){var el;return el=(el=this.getFrameDocument())?el.body||el:document.body||document.lastElementChild},GameWindow.prototype.cssRule=function(rule,clear){var root;if("string"!=typeof rule)throw new TypeError("Game.execStep: style property must be string. Found: "+rule);return this.styleElement?clear&&(this.styleElement.innerHTML=""):(root=W.getFrameDocument()||window.document,this.styleElement=W.append("style",root.head,{type:"text/css",id:"ng_style"})),this.styleElement.innerHTML+=rule,this.styleElement},GameWindow.prototype.write=function(text,root){if("string"==typeof root?root=this.getElementById(root):root||(root=this.getScreen()),!root)throw new Error("GameWindow.write: could not determine where to write");return DOM.write(root,text)},GameWindow.prototype.writeln=function(text,root,br){if("string"==typeof root?root=this.getElementById(root):root||(root=this.getScreen()),!root)throw new Error("GameWindow.writeln: could not determine where to write");return DOM.writeln(root,text,br)},GameWindow.prototype.generateUniqueId=function(prefix){var id,found;for(id=""+(prefix||J.randomInt(0,1e3)),found=this.getElementById(id);found;)id=prefix+"_"+J.randomInt(0,1e3),found=this.getElementById(id);return id},GameWindow.prototype.toggleInputs=function(id,disabled){var container;if(!document.getElementsByTagName)return node.err("GameWindow.toggleInputs: getElementsByTagName not found"),!1;if(id&&"string"==typeof id)throw new Error("GameWindow.toggleInputs: id must be string or undefined. Found: "+id);if(id){if(!(container=this.getElementById(id)))throw new Error("GameWindow.toggleInputs: no elements found with id "+id);toggleInputs(disabled,container)}else toggleInputs(disabled),(container=this.getFrameDocument())&&toggleInputs(disabled,container);return!0},GameWindow.prototype.getLoadingDots=function(len,id){var spanDots,i,limit,intervalId;if(len&len<0)throw new Error("GameWindow.getLoadingDots: len cannot be < 0. Found: "+len);for(len=len||5,(spanDots=document.createElement("span")).id=id||"span_dots",limit="",i=0;i<len;i++)limit+=".";return intervalId=setInterval((function(){spanDots.innerHTML!==limit?spanDots.innerHTML=spanDots.innerHTML+".":spanDots.innerHTML="."}),1e3),{span:spanDots,stop:function(){spanDots.innerHTML=".",clearInterval(intervalId)}}},GameWindow.prototype.addLoadingDots=function(root,len,id){var ld;return ld=this.getLoadingDots(len,id),root.appendChild(ld.span),ld},GameWindow.prototype.getEventButton=function(event,attributes){var b;if("string"!=typeof event)throw new TypeError("GameWindow.getEventButton: event must be string. Found: "+event);return"string"==typeof attributes?attributes={innerHTML:attributes}:attributes||(attributes={}),attributes.innerHTML||(attributes.innerHTML=event),(b=this.get("button",attributes)).onclick=function(){node.emit(event)},b},GameWindow.prototype.addEventButton=function(event,root,attributes){var eb;return eb=this.getEventButton(event,attributes),root||(root=this.getScreen()),root.appendChild(eb)},GameWindow.prototype.searchReplace=function(){var elements,mod,prefix,name,len,i;if(2===arguments.length?(mod="g",prefix=arguments[1]):arguments.length>2&&(mod=arguments[1],prefix=arguments[2]),void 0===prefix)prefix="ng_replace_";else if(null===prefix)prefix="";else if("string"!=typeof prefix)throw new TypeError("GameWindow.searchReplace: prefix must be string, null or undefined. Found: "+prefix);if(elements=arguments[0],J.isArray(elements))for(i=-1,len=elements.length;++i<len;)this.setInnerHTML(prefix+elements[i].search,elements[i].replace,elements[i].mod||mod);else{if("object"==typeof elements)throw new TypeError("GameWindow.setInnerHTML: elements must be object or arrray. Found: "+elements);for(name in elements)elements.hasOwnProperty(name)&&this.setInnerHTML(prefix+name,elements[name],mod)}},GameWindow.prototype.setInnerHTML=function(search,replace,mod){var el,i,len;if("string"!=typeof search&&"number"!=typeof search)throw new TypeError("GameWindow.setInnerHTML: search must be string or number. Found: "+search);if("string"!=typeof replace&&"number"!=typeof replace)throw new TypeError("GameWindow.setInnerHTML: replace must be string or number. Found: "+replace);if(void 0===mod)mod="id";else{if("string"!=typeof mod)throw new TypeError("GameWindow.setInnerHTML: mod must be string or undefined. Found: "+mod);if("g"!==mod&&"id"!==mod&&"className"!==mod)throw new Error("GameWindow.setInnerHTML: invalid mod value: "+mod)}if("id"!==mod&&"g"!==mod||(el=W.getElementById(search))&&el.className!==search&&(el.innerHTML=replace),("className"===mod||"g"===mod)&&(len=(el=W.getElementsByClassName(search)).length))for(i=-1;++i<len;)el[i].innerHTML=replace},GameWindow.prototype.hide=function(idOrObj){var el;return(el=getElement(idOrObj,"GameWindow.hide"))&&(el.style.display="none",W.adjustFrameHeight(0,0)),el},GameWindow.prototype.show=function(idOrObj,display){var el;if("string"!=typeof(display=display||""))throw new TypeError("GameWindow.show: display must be string or undefined. Found: "+display);return(el=getElement(idOrObj,"GameWindow.show"))&&(el.style.display=display,W.adjustFrameHeight(0,0)),el},GameWindow.prototype.toggle=function(idOrObj,display){var el;if("string"!=typeof(display=display||""))throw new TypeError("GameWindow.toggle: display must be string or undefined. Found: "+display);return(el=getElement(idOrObj,"GameWindow.toggle"))&&("none"===el.style.display?el.style.display=display:el.style.display="none",W.adjustFrameHeight(0,0)),el}}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(){"use strict";node.window=new node.GameWindow,"undefined"!=typeof window&&(window.W=node.window)}(),function(exports){"use strict";function Canvas(canvas){this.canvas=canvas,this.ctx=canvas.getContext("2d"),this.centerX=canvas.width/2,this.centerY=canvas.height/2,this.width=canvas.width,this.height=canvas.height}node.window.Canvas=Canvas,Canvas.prototype={constructor:Canvas,drawOval:function(settings){var x=settings.x/settings.scale_x,y=settings.y/settings.scale_y,radius=settings.radius||100;this.ctx.lineWidth=settings.lineWidth||1,this.ctx.strokeStyle=settings.color||"#000000",this.ctx.save(),this.ctx.scale(settings.scale_x,settings.scale_y),this.ctx.beginPath(),this.ctx.arc(x,y,radius,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(settings){var from_x=settings.x,from_y=settings.y,length=settings.length,angle=settings.angle,to_x=-Math.cos(angle)*length+settings.x,to_y=Math.sin(angle)*length+settings.y;this.ctx.lineWidth=settings.lineWidth||1,this.ctx.strokeStyle=settings.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(from_x,from_y),this.ctx.lineTo(to_x,to_y),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(x,y){this.ctx.scale(x,y),this.centerX=this.canvas.width/2/x,this.centerY=this.canvas.height/2/y},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var w=this.canvas.width;this.canvas.width=1,this.canvas.width=w}}}(),function(exports,window,node){"use strict";var document=window.document,TriggerManager=node.TriggerManager;if(!TriggerManager)throw new Error("HTMLRenderer requires node.TriggerManager to load.");function HTMLRenderer(options){this.options=options||{},this.tm=new TriggerManager,this.init(this.options)}exports.HTMLRenderer=HTMLRenderer,exports.HTMLRenderer.Entity=function(o){if(o=o||{},this.content=void 0!==o.content?o.content:"","string"==typeof o.id)this.id=o.id;else if(void 0!==o.id)throw new TypeError("Entity: id must be string or undefined.");if("string"==typeof o.className)this.className=o.className;else if(J.isArray(o.className))this.className=o.join(" ");else if(void 0!==o.className)throw new TypeError("Entity: className must be string, array, or undefined.")},HTMLRenderer.prototype.init=function(options){options=options||this.options,this.options=options,this.reset(),options.returnAt&&(this.tm.returnAt=options.returnAt),options.pipeline&&this.tm.initTriggers(options.pipeline)},HTMLRenderer.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},HTMLRenderer.prototype.addDefaultPipeline=function(){this.tm.addTrigger((function(el){return document.createTextNode(el.content)})),this.tm.addTrigger((function(el){var div,spanType,spanContent,key,str;if(el&&el.content&&("object"==typeof el.content||"function"==typeof el.content)){if(div=document.createElement("div"),(spanType=W.add("span",div)).innerHTML=typeof el.content,spanType.className="ng_clickable bold",(spanContent=W.add("span",div)).style.display="none",spanContent.className="ng_clickable","object"==typeof el.content)for(key in el.content)el.content.hasOwnProperty(key)&&(str=key+":\t"+el.content[key],spanContent.appendChild(document.createTextNode(str)),spanContent.appendChild(document.createElement("br")));else spanContent.innerHTML=el.content.toString();return spanType.onclick=function(){spanContent.style.display="",spanType.style.display="none"},spanContent.onclick=function(){spanContent.style.display="none",spanType.style.display=""},div}})),this.tm.addTrigger((function(el){var html;if(el)return el.content&&el.content.parse&&"function"==typeof el.content.parse&&(html=el.content.parse(),J.isElement(html)||J.isNode(html))?html:void 0})),this.tm.addTrigger((function(el){if(el)return J.isElement(el.content)||J.isNode(el.content)?el.content:void 0}))},HTMLRenderer.prototype.clear=function(clear){return this.tm.clear(clear)},HTMLRenderer.prototype.addRenderer=function(renderer,pos){return this.tm.addTrigger(renderer,pos)},HTMLRenderer.prototype.removeRenderer=function(renderer){return this.tm.removeTrigger(renderer)},HTMLRenderer.prototype.render=function(o){return this.tm.pullTriggers(o)},HTMLRenderer.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(exports,node){"use strict";var NDDB=node.NDDB,HTMLRenderer=node.window.HTMLRenderer,Entity=node.window.HTMLRenderer.Entity;function List(options,data){options=options||{},this.options=options,NDDB.call(this,options,data),this.id=options.id||"list_"+Math.round(1e3*Math.random()),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function Node(node){Entity.call(this,node),this.dt=void 0!==node.dt?node.dt:null,void 0!==node.dd&&(this.dd=node.dd)}exports.List=List,List.prototype=new NDDB,List.prototype.constructor=List,List.prototype.init=function(options){options=options||this.options,this.FIRST_LEVEL=options.first_level||"dl",this.SECOND_LEVEL=options.second_level||"dt",this.THIRD_LEVEL=options.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update=void 0!==options.auto_update?options.auto_update:this.auto_update;var lifo=this.lifo=void 0!==options.lifo?options.lifo:this.lifo;this.globalCompare=function(o1,o2){if(!o1&&!o2)return 0;if(!o2)return 1;if(!o1)return-1;if(lifo){if(o1.dt<o2.dt)return 1;if(o1.dt>o2.dt)return-1}else{if(o1.dt<o2.dt)return-1;if(o1.dt>o2.dt)return 1}if(o1.dt===o2.dt){if(void 0===o1.dd)return-1;if(void 0===o2.dd)return 1;if(o1.dd<o2.dd)return-1;if(o1.dd>o2.dd)return 1;if(o1.nddbid<o2.nddbid)return 1;if(o1.nddbid>o2.nddbid)return-1}return 0},this.DL=options.list||document.createElement(this.FIRST_LEVEL),this.DL.id=options.id||this.id,options.className&&(this.DL.className=options.className),this.options.title&&this.DL.appendChild(document.createTextNode(options.title)),this.htmlRenderer=new HTMLRenderer(options.render)},List.prototype._add=function(node){node&&(this.insert(node),this.auto_update&&this.parse())},List.prototype.addDT=function(elem,dt){if(void 0!==elem){this.last_dt++,dt=void 0!==dt?dt:this.last_dt,this.last_dd=0;var node=new Node({dt:dt,content:elem});return this._add(node)}},List.prototype.addDD=function(elem,dt,dd){if(void 0!==elem){var node=new Node({dt:dt=void 0!==dt?dt:this.last_dt,dd:dd=void 0!==dd?dd:this.last_dd++,content:elem});return this._add(node)}},List.prototype.parse=function(){this.sort();var appendDT=function(){var node=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(node),null,node,node},appendDD=function(){var node=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(node),node};if(this.DL){for(;this.DL.hasChildNodes();)this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var node,el=this.db[i];node=void 0===el.dd?appendDT.call(this):appendDD.call(this);var content=this.htmlRenderer.render(el);node.appendChild(content)}return this.DL},List.prototype.getRoot=function(){return this.DL},Node.prototype=new Entity,Node.prototype.constructor=Node}("undefined"!=typeof node?void 0!==node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(exports,window,node){"use strict";var document=window.document;exports.Table=Table,exports.Table.Cell=Cell;var NDDB=node.NDDB,HTMLRenderer=node.window.HTMLRenderer,Entity=node.window.HTMLRenderer.Entity;function Table(options,data){if((options=options||{}).update||(options.update={}),void 0===options.update.indexes&&(options.update.indexes=!0),NDDB.call(this,options,data),this.rowcol||this.index("rowcol",(function(c){return c.x+"."+c.y})),this.pointers={x:options.pointerX||null,y:options.pointerY||null},this.header=[],this.footer=[],this.left=[],this.table=options.table||document.createElement("table"),"string"==typeof options.id)this.table.id=options.id;else if(options.id)throw new TypeError("Table constructor: options.id must be string or undefined.");if("string"==typeof options.className)this.table.className=options.className;else if(J.isArray(options.className))this.table.className=options.className.join(" ");else if(options.className)throw new TypeError("Table constructor: options.className must be string, array, or undefined.");if(this.missingClassName="missing","string"==typeof options.missingClassName)this.missingClassName=options.missingClassName;else if(J.isArray(options.missingClassName))this.missingClassName=options.missingClassName.join(" ");else if(options.missingClassName)throw new TypeError("Table constructor: options.className must be string, array, or undefined.");if(this.autoParse=void 0!==options.autoParse&&options.autoParse,this.trs={},"function"==typeof options.tr)this.trCb=options.tr;else{if(void 0!==options.tr)throw new TypeError("Table constructor: options.tr must be function or undefined.");this.trCb=null}this.initRenderer(options.render)}function validateXY(method,x,y,mode){var xOk,yOk;if(void 0!==x){if("number"!=typeof x||x<0)throw new TypeError("Table."+method+": x must be a non-negative number or undefined.");xOk=!0}if(void 0!==y){if("number"!=typeof y||y<0)throw new TypeError("Table."+method+": y must be a non-negative number or undefined.");yOk=!0}if("either"===mode&&xOk&&yOk)throw new Error("Table."+method+": either x OR y can be defined.");if(!("both"!==mode||xOk&&yOk))throw new Error("Table."+method+": both x AND y must be defined.");if("any"===mode&&!xOk&&!yOk)throw new Error("Table."+method+": either x or y must be defined.");if("x"===mode&&!xOk)throw new Error("Table."+method+": x must be defined.");if("y"===mode&&!yOk)throw new Error("Table."+method+": y be defined.")}function validateInput(method,data,x,y,dataArray){if(validateXY(method,x,y),dataArray&&!J.isArray(data))throw new TypeError("Table."+method+": data must be array.")}function addSpecialCells(data){var out,i,len;for(out=[],i=-1,len=data.length;++i<len;)out.push({content:data[i]});return out}function Cell(cell){Entity.call(this,cell),this.x=void 0!==cell.x?cell.x:null,this.y=void 0!==cell.y?cell.y:null,this.HTMLElement=cell.HTMLElement||null,cell.colspan&&(this.colspan=cell.colspan)}Table.prototype=new NDDB,Table.prototype.constructor=Table,Table.cell=function(o){return new Cell(o)},Table.prototype.initRenderer=function(options){options=options||{},this.htmlRenderer=new HTMLRenderer(options),this.htmlRenderer.addRenderer((function(el){var tbl,key;if(el.content&&"object"==typeof el.content){for(key in tbl=new Table,el.content)el.content.hasOwnProperty(key)&&tbl.addRow([key,el.content[key]]);return tbl.parse()}}),2)},Table.prototype.renderCell=function(cell,tagName){var TD,content;if(cell)return tagName=tagName||"td",TD=document.createElement(tagName),content=this.htmlRenderer.render(cell),TD.appendChild(content),cell.className&&(TD.className=cell.className),cell.id&&(TD.id=cell.id),cell.colspan&&TD.setAttribute("colSpan",cell.colspan),cell.HTMLElement=TD,TD},Table.prototype.get=function(row,col){return validateXY("get",row,col,"any"),void 0===row?this.select("y","=",col):void 0===col?this.select("x","=",row):this.rowcol.get(row+"."+col)},Table.prototype.getTR=function(row){return"thead"!==row&&"tfoot"!==row&&validateXY("getTR",row,void 0,"x"),this.trs[row]||!1},Table.prototype.setHeader=function(header){validateInput("setHeader",header,void 0,void 0,!0),this.header=addSpecialCells(header)},Table.prototype.setLeft=function(left){validateInput("setLeft",left,void 0,void 0,!0),this.left=addSpecialCells(left)},Table.prototype.setFooter=function(footer){validateInput("setFooter",footer,void 0,void 0,!0),this.footer=addSpecialCells(footer)},Table.prototype.updatePointer=function(pointer,value){if(void 0===this.pointers[pointer])throw new Error("Table.updatePointer: invalid pointer: "+pointer);return(null===this.pointers[pointer]||value>this.pointers[pointer])&&(this.pointers[pointer]=value),this.pointers[pointer]},Table.prototype.addMultiple=function(data,dim,x,y){var i,lenI,j,lenJ;if(validateInput("addMultiple",data,x,y),dim&&"string"!=typeof dim||dim&&void 0===this.pointers[dim])throw new TypeError("Table.addMultiple: dim must be a valid dimension (x or y) or undefined.");for(dim=dim||"x",x=this.getCurrPointer("x",x),y=this.getNextPointer("y",y),x=void 0!==x?x:null===this.pointers.x?0:this.pointers.x,y=void 0!==y?y:null===this.pointers.y?0:this.pointers.y,J.isArray(data)||(data=[data]),i=-1,lenI=data.length;++i<lenI;)if(J.isArray(data[i]))for(j=-1,lenJ=data[i].length;++j<lenJ;)"x"===dim?this.add(data[i][j],x+i,y+j,"x"):this.add(data[i][j],x+j,y+i,"y");else"x"===dim?this.add(data[i],x,y+i,"x"):this.add(data[i],x+i,y,"y");this.autoParse&&this.parse()},Table.prototype.add=function(content,x,y,dim){var cell;if(validateInput("add",content,x,y),dim&&"string"!=typeof dim||dim&&void 0===this.pointers[dim])throw new TypeError("Table.add: dim must be a valid string (x, y) or undefined.");x="y"===(dim=dim||"x")?this.getCurrPointer("x",x):this.getNextPointer("x",x),y="y"===dim?this.getNextPointer("y",y):this.getCurrPointer("y",y),content&&"object"==typeof content&&void 0!==content.content?(void 0===content.x&&(content.x=x),void 0===content.y&&(content.y=y),cell=new Cell(content)):cell=new Cell({x:x,y:y,content:content}),this.insert(cell),this.updatePointer("x",x),this.updatePointer("y",y)},Table.prototype.addColumn=function(data,x,y){return validateInput("addColumn",data,x,y),this.addMultiple(data,"y",x||0,this.getNextPointer("y",y))},Table.prototype.addRow=function(data,x,y){return validateInput("addRow",data,x,y),this.addMultiple(data,"x",this.getNextPointer("x",x),y||0)},Table.prototype.getNextPointer=function(dim,value){return void 0!==value?value:null===this.pointers[dim]?0:this.pointers[dim]+1},Table.prototype.getCurrPointer=function(dim,value){return void 0!==value?value:null===this.pointers[dim]?0:this.pointers[dim]},Table.prototype.parse=function(){var TABLE,TR,TD,THEAD,TBODY,TFOOT,i,j,len,trid,f,old_y,old_left,diff;if(this.table&&this.table.children&&(this.table.innerHTML=""),TABLE=this.table,this.header&&this.header.length){for(THEAD=document.createElement("thead"),TR=document.createElement("tr"),this.trCb&&this.trCb(TR,"thead"),this.trs.thead=TR,this.left&&this.left.length&&TR.appendChild(document.createElement("th")),i=-1,len=this.header.length;++i<len;)TR.appendChild(this.renderCell(this.header[i],"th"));THEAD.appendChild(TR),TABLE.appendChild(THEAD)}if(this.size()){for(TBODY=document.createElement("tbody"),this.sort(["x","y"]),trid=-1,old_y=(f=this.first()).y,old_left=0,i=-1,len=this.db.length;++i<len;){if(trid!==this.db[i].x&&(TR=document.createElement("tr"),this.trCb&&this.trCb(TR,trid+1),this.trs[trid+1]=TR,TBODY.appendChild(TR),trid=this.db[i].x,old_y=f.y-1,this.left&&this.left.length&&(TD=document.createElement("td"),TR.appendChild(this.renderCell(this.left[old_left])),old_left++)),this.db[i].y>old_y+1)for(diff=this.db[i].y-(old_y+1),j=0;j<diff;j++)(TD=document.createElement("td")).className=this.missingClassName,TR.appendChild(TD);TR.appendChild(this.renderCell(this.db[i])),old_y=this.db[i].y}TABLE.appendChild(TBODY)}if(this.footer&&this.footer.length){for(TFOOT=document.createElement("tfoot"),TR=document.createElement("tr"),this.trCb&&this.trCb(TR,"tfoot"),this.trs.tfoot=TR,this.header&&this.header.length&&(TD=document.createElement("td"),TR.appendChild(TD)),i=-1,len=this.footer.length;++i<len;)TR.appendChild(this.renderCell(this.footer[i]));TFOOT.appendChild(TR),TABLE.appendChild(TFOOT)}return TABLE},Table.prototype.resetPointers=function(pointers){if(pointers&&"object"!=typeof pointers)throw new TypeError("Table.resetPointers: pointers must be object or undefined.");pointers=pointers||{},this.pointers={x:pointers.pointerX||0,y:pointers.pointerY||0}},Table.prototype.addClass=function(className,x,y){var db;if(J.isArray(className))className=className.join(" ");else if("string"!=typeof className)throw new TypeError("Table.addClass: className must be string or array.");return validateXY("addClass",x,y),db=this,void 0===x&&void 0===y||(void 0!==x&&(db=db.select("x","=",x)),void 0!==y&&(db=db.and("y","=",y))),db.each((function(el){W.addClass(el,className,!0),el.HTMLElement&&(el.HTMLElement.className=el.className)})),this},Table.prototype.removeClass=function(className,x,y){var func,db;if(J.isArray(className))func=function(el,className){for(var i=0;i<className.length;i++)W.removeClass(el,className[i])};else if("string"==typeof className)func=W.removeClass;else{if(null!==className)throw new TypeError("Table.removeClass: className must be string, array, or null.");func=function(el){el.className=""}}return validateXY("removeClass",x,y),db=this,void 0===x&&void 0===y||(void 0!==x&&(db=db.select("x","=",x)),void 0!==y&&(db=db.and("y","=",y))),db.each((function(el){func.call(this,el,className),el.HTMLElement&&(el.HTMLElement.className=el.className)})),this},Table.prototype.clear=function(){NDDB.prototype.clear.call(this,!0),this.resetPointers()},Cell.prototype=new Entity,Cell.prototype.constructor=Cell}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(node){"use strict";var J=node.JSUS,NDDB=node.NDDB;function Widget(){}function strGetter(that,name,collection,method,param){var res;if(!that.constructor[collection].hasOwnProperty(name))throw new Error(method+": name not found: "+name);if("function"==typeof(res=void 0!==that[collection][name]?that[collection][name]:that.constructor[collection][name])&&"string"!=typeof(res=res(that,param))&&!1!==res)throw new TypeError(method+': cb "'+name+'" did not return neither string or false. Found: '+res);return res}function strGetterMulti(that,collection,getMethod,method,keys,param){var out,k,len;if(keys||(keys=that.constructor[collection]),void 0===param&&(param={}),out={},J.isArray(keys))for(k=-1,len=keys.length;++k<len;)out[keys[k]]=that[getMethod](keys[k],param);else for(k in keys)keys.hasOwnProperty(k)&&(out[k]=that[getMethod](k,param));return out}function strSetterMulti(that,obj,collection,setMethod,method){var i;if("object"!=typeof obj&&void 0!==obj)throw new TypeError(method+": "+collection+" must be object or undefined. Found: "+obj);for(i in obj)obj.hasOwnProperty(i)&&that[setMethod](i,obj[i])}function strSetter(that,name,value,collection,method){if(void 0===that.constructor[collection][name])throw new TypeError(method+": name not found: "+name);if("string"!=typeof value&&"function"!=typeof value&&!1!==value)throw new TypeError(method+': value for item "'+name+'" must be string, function or false. Found: '+value);that[collection][name]=value}node.Widget=Widget,Widget.prototype.init=function(opts){},Widget.prototype.listeners=function(){},Widget.prototype.append=function(){},Widget.prototype.getValues=function(opts){},Widget.prototype.setValues=function(values){},Widget.prototype.reset=function(opts){},Widget.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError(J.funcName(this.constructor)+".highlight: border must be string or undefined. Found: "+border);this.isAppended()&&!this.isHighlighted()&&(this.highlighted=!0,this.bodyDiv.style.border=border||"3px solid red",this.emit("highlighted",border))},Widget.prototype.unhighlight=function(){this.isHighlighted()&&(this.highlighted=!1,this.bodyDiv.style.border="",this.emit("unhighlighted"))},Widget.prototype.isHighlighted=function(){return!!this.highlighted},Widget.prototype.isDocked=function(){return!!this.docked},Widget.prototype.isActionRequired=function(opts){var values;return!!this.required&&((opts=opts||{}).markAttempt=opts.markAttempt||!1,opts.highlight=opts.highlight||!1,!!(values=this.getValues(opts))&&(null===values.choice||!1===values.isCorrect))},Widget.prototype.collapse=function(){this.panelDiv&&(this.bodyDiv.style.display="none",this.collapsed=!0,this.collapseButton&&(this.collapseButton.src="/images/maximize_small2.png",this.collapseButton.title="Restore"),this.footer&&(this.footer.style.display="none"),this.collapseTarget&&this.collapseTarget.appendChild(this.panelDiv),this.emit("collapsed"))},Widget.prototype.uncollapse=function(){this.panelDiv&&(this.collapseTarget&&this.originalRoot.appendChild(this.panelDiv),this.bodyDiv.style.display="",this.collapsed=!1,this.collapseButton&&(this.collapseButton.src="/images/maximize_small.png",this.collapseButton.title="Minimize"),this.footer&&(this.footer.style.display=""),this.emit("uncollapsed"))},Widget.prototype.isCollapsed=function(){return!!this.collapsed},Widget.prototype.enable=function(options){this.disabled&&(this.disabled=!1,this.emit("enabled",options))},Widget.prototype.disable=function(options){this.disabled||(this.disabled=!0,this.emit("disabled",options))},Widget.prototype.isDisabled=function(){return!!this.disabled},Widget.prototype.hide=function(){this.panelDiv&&(this.hidden||(this.panelDiv.style.display="none",this.hidden=!0,this.emit("hidden")))},Widget.prototype.show=function(display){this.panelDiv&&"none"===this.panelDiv.style.display&&(this.panelDiv.style.display=display||"",this.hidden=!1,this.emit("shown"))},Widget.prototype.toggle=function(display){this.panelDiv&&(this.hidden?this.show():this.hide())},Widget.prototype.isHidden=function(){return!!this.hidden},Widget.prototype.destroy=null,Widget.prototype.setTitle=function(title,options){var tmp,that,link,img;if(!this.panelDiv)throw new Error("Widget.setTitle: panelDiv is missing.");if(title){if(!this.headingDiv){if(options){if("object"!=typeof options)throw new TypeError("Widget.setTitle: options must be object or undefined. Found: "+options)}else options={className:"card-header"};this.headingDiv=W.add("div",this.panelDiv,options),tmp=this.bodyDiv&&this.bodyDiv.childNodes[0]||null,this.panelDiv.insertBefore(this.headingDiv,tmp)}if(W.isElement(title))this.headingDiv.innerHTML="",this.headingDiv.appendChild(title);else{if("string"!=typeof title)throw new TypeError(J.funcName(this.constructor)+".setTitle: title must be string, HTML element or falsy. Found: "+title);this.headingDiv.innerHTML=title}this.collapsible&&(that=this,(link=document.createElement("span")).className="panel-collapse-link",(img=document.createElement("img")).src="/images/minimize_small.png",link.appendChild(img),link.onclick=function(){that.isCollapsed()?that.uncollapse():that.collapse()},that.headingDiv.appendChild(link)),this.closable&&function(that){var link,img;(link=document.createElement("span")).className="panel-collapse-link",(img=document.createElement("img")).src="/images/close_small.png",link.appendChild(img),link.onclick=function(){that.destroy()},that.headingDiv.appendChild(link)}(this),this.info&&function(that){var link,a;(link=W.add("span",that.headingDiv)).className="panel-collapse-link",(a=W.add("a",link)).href=that.info,a.target="_blank",W.add("img",a).src="/images/info.png"}(this)}else this.headingDiv&&(this.panelDiv.removeChild(this.headingDiv),this.headingDiv=null)},Widget.prototype.setFooter=function(footer,options){if(!this.panelDiv)throw new Error("Widget.setFooter: panelDiv is missing.");if(footer){if(!this.footerDiv){if(options){if("object"!=typeof options)throw new TypeError("Widget.setFooter: options must be object or undefined. Found: "+options)}else options={className:"card-footer"};this.footerDiv=W.add("div",this.panelDiv,options)}if(W.isElement(footer))this.footerDiv.innerHTML="",this.footerDiv.appendChild(footer);else{if("string"!=typeof footer)throw new TypeError(J.funcName(this.constructor)+".setFooter: footer must be string, HTML element or falsy. Found: "+footer);this.footerDiv.innerHTML=footer}}else this.footerDiv&&(this.panelDiv.removeChild(this.footerDiv),delete this.footerDiv)},Widget.prototype.setContext=function(){console.log("*** Deprecation warning: setContext no longer available in Bootstrap5.")},Widget.prototype.addFrame=function(context){if(void 0===context)context="default";else if("string"!=typeof context||""===context.trim())throw new TypeError(J.funcName(this.constructor)+".addFrame: context must be a non-empty string or undefined. Found: "+context);this.panelDiv&&-1===this.panelDiv.className.indexOf("panel-")&&W.addClass(this.panelDiv,"panel-"+context),this.bodyDiv&&-1===this.bodyDiv.className.indexOf("panel-body")&&W.addClass(this.bodyDiv,"panel-body")},Widget.prototype.removeFrame=function(){this.panelDiv&&W.removeClass(this.panelDiv,"panel-[a-z]*"),this.bodyDiv&&W.removeClass(this.bodyDiv,"panel-body")},Widget.prototype.isAppended=function(){return!!this.panelDiv},Widget.prototype.isDestroyed=function(){return!!this.destroyed},Widget.prototype.setSound=function(name,value){strSetter(this,name,value,"sounds","Widget.setSound")},Widget.prototype.setSounds=function(sounds){strSetterMulti(this,sounds,"sounds","setSound",J.funcName(this.constructor)+".setSounds")},Widget.prototype.getSound=function(name,param){return strGetter(this,name,"sounds",J.funcName(this.constructor)+".getSound",param)},Widget.prototype.getSounds=function(keys,param){return strGetterMulti(this,"sounds","getSound",J.funcName(this.constructor)+".getSounds",keys,param)},Widget.prototype.getAllSounds=function(param){return strGetterMulti(this,"sounds","getSound",J.funcName(this.constructor)+".getAllSounds",void 0,param)},Widget.prototype.setText=function(name,value){strSetter(this,name,value,"texts",J.funcName(this.constructor)+".setText")},Widget.prototype.setTexts=function(texts){strSetterMulti(this,texts,"texts","setText",J.funcName(this.constructor)+".setTexts")},Widget.prototype.getText=function(name,param){return strGetter(this,name,"texts",J.funcName(this.constructor)+".getText",param)},Widget.prototype.getTexts=function(keys,param){return strGetterMulti(this,"texts","getText",J.funcName(this.constructor)+".getTexts",keys,param)},Widget.prototype.getAllTexts=function(param){return strGetterMulti(this,"texts","getText",J.funcName(this.constructor)+".getAllTexts",void 0,param)},Widget.prototype.on=function(){NDDB.prototype.on.apply(this,arguments)},Widget.prototype.off=function(){NDDB.prototype.off.apply(this,arguments)},Widget.prototype.emit=function(){NDDB.prototype.emit.apply(this,arguments)},Widget.prototype.throwErr=function(type,method,err){var errMsg;if(errMsg=J.funcName(this.constructor)+"."+method+": ","object"==typeof err?errMsg+=err.stack||err:"string"==typeof err&&(errMsg+=err),"TypeError"===type)throw new TypeError(errMsg);throw new Error(errMsg)}}("undefined"!=typeof node?node:module.parent.exports.node),function(window,node){"use strict";function Widgets(){var that;this.widgets={},this.instances=[],this.lastAppended=null,this.docked=[],this.dockedHidden=[],this.boxSelector=null,this.collapseTarget=null,that=this,node.registerSetup("widgets",(function(conf){var name,root,collapseTarget;if(conf){if(conf.widgets)for(name in conf.widgets)conf.widgets.hasOwnProperty(name)&&that.register(name,conf.widgets[name]);if(conf.destroyAll&&that.destroyAll(),conf.append)for(name in conf.append)conf.append.hasOwnProperty(name)&&("function"==typeof(root=conf.append[name].root)?root=root():"string"==typeof root&&(root=W.getElementById(root)),root||(root=W.getScreen()),root?that.append(name,root,conf.append[name]):node.warn("setup widgets: could not find a root for widget "+name+". Requested: "+conf.append[name].root));return conf.collapseTarget&&("function"==typeof conf.collapseTarget?collapseTarget=conf.collapseTarget():"string"==typeof conf.collapseTarget?collapseTarget=W.getElementById(conf.collapseTarget):J.isElement(conf.collapseTarget)&&(collapseTarget=conf.collapseTarget),collapseTarget?that.collapseTarget=collapseTarget:node.warn("setup widgets: could not find collapse target.")),conf}})),node.on("FRAME_LOADED",(function(){node.widgets.garbageCollection()})),node.info("node-widgets: loading")}function checkDepErrMsg(w,d){var name=w.name||w.id;node.err(d+" not found. "+name+" cannot be loaded")}function closeDocked(wid,hide){var d,i,len,width,closed;for(len=(d=node.widgets.docked).length,i=0;i<len;i++)width?d[i].panelDiv.style.right=getPxNum(d[i].panelDiv.style.right)-width+"px":d[i].wid===wid&&(width=d[i].dockedOffsetWidth,closed=node.widgets.docked.splice(i,1)[0],hide&&(node.widgets.dockedHidden.push(closed),closed.hide(),node.widgets.boxSelector||(node.widgets.boxSelector=node.widgets.append("BoxSelector",document.body,{className:"docked-left",getId:function(i){return i.wid},getDescr:function(i){return i.title},onclick:function(i,id){i.show(),node.widgets.docked.push(i),setRightStyle(i),this.removeItem(id),0===this.items.length&&(this.destroy(),node.widgets.boxSelector=null)}})),node.widgets.boxSelector.addItem(closed)),len--,i--);return!!width}function setRightStyle(w){var lastDocked,right,ws,tmp;for(200,20,right=0,(ws=node.widgets).docked.length>1&&(right=getPxNum((lastDocked=ws.docked[ws.docked.length-2]).panelDiv.style.right),right+=lastDocked.panelDiv.offsetWidth),right+=20,w.panelDiv.style.right=right+"px",tmp=0,right+=w.panelDiv.offsetWidth+200;ws.docked.length>1&&right>window.innerWidth&&tmp<ws.docked.length-1;)closeDocked(ws.docked[tmp].wid,!0),tmp++;w.dockedOffsetWidth=w.panelDiv.offsetWidth+20}function getPxNum(str){return parseInt(str.substring(0,str.length-2),10)}Widgets.prototype.register=function(name,w){if("string"!=typeof name)throw new TypeError("Widgets.register: name must be string. Found: "+name);if("function"!=typeof w)throw new TypeError("Widgets.register: w must be function.Found: "+w);return void 0===w.sounds&&(w.sounds={}),void 0===w.texts&&(w.texts={}),J.mixout(w.prototype,new node.Widget),this.widgets[name]=w,this.widgets[name]},Widgets.prototype.get=function(widgetName,options){var WidgetPrototype,widget,changes,tmp;if("string"!=typeof widgetName)throw new TypeError("Widgets.get: widgetName must be string.Found: "+widgetName);if(options){if("object"!=typeof options)throw new TypeError("Widgets.get: "+widgetName+" options must be object or undefined. Found: "+options)}else options={};if(!1===options.storeRef&&!0===options.docked)throw new TypeError("Widgets.get: "+widgetName+"options.storeRef cannot be false if options.docked is true.");if(!(WidgetPrototype=J.getNestedValue(widgetName,this.widgets)))throw new Error("Widgets.get: "+widgetName+" not found");if(node.info("creating widget "+widgetName+" v."+WidgetPrototype.version),!this.checkDependencies(WidgetPrototype))throw new Error("Widgets.get: "+widgetName+" has unmet dependencies");if(widget=new WidgetPrototype(options),void 0!==(tmp=options.id)){if("number"==typeof tmp&&(tmp+=""),"string"!=typeof tmp)throw new TypeError("Widgets.get: options.id must be string, number or undefined. Found: "+tmp);if(void 0!==options.idPrefix){if("string"!=typeof options.idPrefix||"number"==typeof options.idPrefix)throw new TypeError("Widgets.get: options.idPrefix must be string, number or undefined. Found: "+options.idPrefix);tmp=options.idPrefix+tmp}widget.id=tmp}else options.widgetStep&&(widget.id=node.game.getStepId());if(void 0!==options.title?widget.title=options.title:void 0!==WidgetPrototype.title?widget.title=WidgetPrototype.title:widget.title="&nbsp;",widget.panel=void 0===options.panel?WidgetPrototype.panel:options.panel,widget.footer=void 0===options.footer?WidgetPrototype.footer:options.footer,widget.className=WidgetPrototype.className,J.isArray(options.className))widget.className+=" "+options.className.join(" ");else if("string"==typeof options.className)widget.className+=" "+options.className;else if(void 0!==options.className)throw new TypeError("Widgets.get: className must be array, string, or undefined. Found: "+options.className);return widget.context=void 0===options.context?WidgetPrototype.context:options.context,widget.sounds=void 0===options.sounds?WidgetPrototype.sounds:options.sounds,widget.texts=void 0===options.texts?WidgetPrototype.texts:options.texts,widget.collapsible=options.collapsible||!1,widget.closable=options.closable||!1,widget.collapseTarget=options.collapseTarget||this.collapseTarget||null,widget.info=options.info||!1,widget.hooks={hidden:[],shown:[],collapsed:[],uncollapsed:[],disabled:[],enabled:[],destroyed:[],highlighted:[],unhighlighted:[]},widget.destroyOnExit=!1!==options.destroyOnExit,(options.required||options.requiredChoice||void 0!==options.correctChoice)&&(widget.required=!0),widget.widgetName=widgetName,widget.wid=""+J.randomInt(0,1e19),widget.disabled=null,widget.highlighted=null,widget.collapsed=null,widget.hidden=null,widget.docked=null,options.disabled&&(widget._disabled=!0),options.highlighted&&(widget._highlighted=!0),options.collapsed&&(widget._collapsed=!0),options.hidden&&(widget._hidden=!0),options.docked&&(widget._docked=!0),widget.init(options),!1!==options.listeners&&(node.events.setRecordChanges(!0),widget.listeners.call(widget),changes=node.events.getChanges(!0),node.events.setRecordChanges(!1)),widget.destroy=function(){var i,len,ee,eeName;if(function(){try{widget.panelDiv&&widget.panelDiv.parentNode&&widget.panelDiv.parentNode.removeChild(widget.panelDiv)}catch(e){node.warn(widgetName+".destroy: error caught: "+e)}}(),changes)for(eeName in changes)if(changes.hasOwnProperty(eeName)){for(i=-1,len=(ee=changes[eeName]).added.length;++i<len;)node.events.ee[eeName].off(ee.added[i].type,ee.added[i].listener);for(i=-1,len=changes[eeName].removed.length;++i<len;)node.events.ee[eeName].on(ee.removed[i].type,ee.removed[i].listener)}if(!1!==widget.storeRef){for(i=-1,len=node.widgets.instances.length;++i<len;)if(node.widgets.instances[i].wid===widget.wid){node.widgets.instances.splice(i,1);break}node.widgets.lastAppended&&node.widgets.lastAppended.wid===this.wid&&(node.warn("node.widgets.lastAppended destroyed."),node.widgets.lastAppended=null)}this.docked?closeDocked(widget.wid,!1):node.window&&node.window.adjustFrameHeight(void 0,120),this.destroyed=!0,this.emit("destroyed")},!1!==options.storeRef?this.instances.push(widget):widget.storeRef=!1,widget},Widgets.prototype.append=function(w,root,options){var tmp;if("string"!=typeof w&&"object"!=typeof w)throw new TypeError("Widgets.append: w must be string or object. Found: "+w);if(root){if("string"==typeof root){if(!(tmp=W.gid(root)))throw new Error('Widgets.append: element with id "'+root+'" not found');root=tmp}}else(root=W.getFrameDocument())&&(root=root.body),root||(root=document.body);if(!J.isElement(root))throw new TypeError("Widgets.append: root must be HTMLElement, string or undefined. Found: "+root);if(options&&"object"!=typeof options)throw new TypeError("Widgets.append: options must be object or undefined. Found: "+options);return void 0===(options=options||{}).panel&&root===W.getHeader()&&(options.panel=!1),"string"==typeof w&&(w=this.get(w,options)),tmp=!1===options.panel||!1===w.panel,tmp=options.bootstrap5?{className:tmp?["ng_widget","no-panel",w.className]:["ng_widget","card",w.className]}:{className:tmp?["ng_widget","no-panel",w.className]:["ng_widget","panel","panel-default",w.className]},(options.docked||w._docked)&&(tmp.className.push("docked"),this.docked.push(w),w.docked=!0),w.panelDiv=W.get("div",tmp),!1!==options.title&&w.title&&(tmp=options.bootstrap5?!1===options.panel?"no-panel-heading":"card-header":!1===options.panel?"no-panel-heading":"panel-heading",w.setTitle(w.title,{className:tmp})),tmp=options.bootstrap5?!1!==options.panel?"card-body":"no-panel-body":!1!==options.panel?"panel-body":"no-panel-body",w.bodyDiv=W.append("div",w.panelDiv,{className:tmp}),w.footer&&(tmp=options.bootstrap5?!1===options.panel?"no-panel-heading":"card-footer":!1===options.panel?"no-panel-heading":"panel-heading",w.setFooter(w.footer)),w.context&&w.setContext(w.context),(options.hidden||w._hidden)&&w.hide(),(options.collapsed||w._collapsed)&&w.collapse(),root.appendChild(w.panelDiv),w.originalRoot=root,w.append(),(options.highlighted||w._highlighted)&&w.highlight(),(options.disabled||w._disabled)&&w.disable(),w.docked?setRightStyle(w):w.isHidden()||w.isCollapsed()||W.adjustFrameHeight(void 0,150),!1!==w.storeRef&&(this.lastAppended=w),w},Widgets.prototype.add=function(w,root,options){return console.log("***Widgets.add is deprecated. Use Widgets.append instead.***"),this.append(w,root,options)},Widgets.prototype.isWidget=function(w,strict){return strict?w instanceof node.Widget:"object"==typeof w&&"function"==typeof w.append&&"function"==typeof w.getValues&&"function"==typeof w.isHidden&&"function"==typeof w.isCollapsed},Widgets.prototype.destroyAll=function(){var i,len;for(i=-1,len=this.instances.length;++i<len;)this.instances[0].destroy();this.lastAppended=null,this.instances.length&&node.warn("node.widgets.destroyAll: some widgets could not be destroyed.")},Widgets.prototype.checkDependencies=function(w,quiet){var parents,d,lib,found,i;if(!w.dependencies)return!0;for(lib in parents=[window,node,this.widgets,node.window],d=w.dependencies)if(d.hasOwnProperty(lib)){for(found=!1,i=0;i<parents.length;i++)if(J.getNestedValue(lib,parents[i])){found=!0;break}if(!found)return quiet||checkDepErrMsg(w,lib),!1}return!0},Widgets.prototype.garbageCollection=function(){function contains(target,widget){var parentNode;if(target.contains)return target.contains(widget.panelDiv);for(parentNode=widget.panelDiv.parentNode;null!=parentNode;){if(parentNode==target)return!0;parentNode=parentNode.parentNode}return!1}return function(){var w,i,fd,res;for(res=[],fd=W.getFrameDocument(),w=node.widgets.instances,i=0;i<w.length;i++)w[i].isAppended()&&fd&&!contains(fd,w[i])&&!contains(document.body,w[i])&&(res.push(w[i]),w[i].destroy(),i--);return res}}(),Widgets.prototype.isActionRequired=function(opts){var w,i,lastErrored,res;for(w=node.widgets.instances,res=!1,i=0;i<w.length;i++)w[i].required&&w[i].isActionRequired(opts)&&(res=!0,lastErrored=w[i]);return lastErrored&&opts.highlight&&"function"==typeof lastErrored.bodyDiv.scrollIntoView&&lastErrored.bodyDiv.scrollIntoView({behavior:"smooth"}),res},node.widgets=new Widgets}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(node){"use strict";function BackButton(options){var that;if(that=this,"object"==typeof options.button)this.button=options.button;else{if(void 0!==options.button)throw new TypeError("BackButton constructor: options.button must be object or undefined. Found: "+options.button);this.button=document.createElement("input"),this.button.type="button"}this.button.onclick=function(){that.disable(),!1===node.game.stepBack(that.stepOptions)&&that.enable()},this.stepOptions={acrossStages:null,acrossRounds:null,noZeroStep:!0}}node.widgets.register("BackButton",BackButton),BackButton.version="0.4.0",BackButton.description="Creates a button that if pressed goes to the previous step.",BackButton.title=!1,BackButton.className="backbutton",BackButton.texts.back="Back",BackButton.dependencies={JSUS:{}},BackButton.prototype.init=function(opts){var tmp;if(void 0===(opts=opts||{}).id)tmp=BackButton.className;else if("string"==typeof opts.id)tmp=opts.id;else{if(!1!==opts.id)throw new TypeError("BackButton.init: opts.id must be string, false, or undefined. Found: "+opts.id);tmp=""}if(this.button.id=tmp,void 0===opts.className)tmp="btn btn-lg btn-secondary";else if(!1===opts.className)tmp="";else if("string"==typeof opts.className)tmp=opts.className;else{if(!J.isArray(opts.className))throw new TypeError("BackButton.init: opts.className must be string, array, or undefined. Found: "+opts.className);tmp=opts.className.join(" ")}this.button.className=tmp,this.button.value="string"==typeof opts.text?opts.text:this.getText("back"),this.stepOptions.acrossStages=void 0!==opts.acrossStages&&!!opts.acrossStages,this.stepOptions.acrossRounds=void 0===opts.acrossRounds||!!opts.acrossRounds},BackButton.prototype.append=function(){node.game.getPreviousStep(1,this.stepOptions)||this.disable(),this.bodyDiv.appendChild(this.button)},BackButton.prototype.listeners=function(){var that=this;node.events.game.on("DONE",(function(){that.disable()})),node.events.game.on("PLAYING",(function(){var prop,step;step=node.game.getPreviousStep(1,that.stepOptions),prop=node.game.getProperty("backbutton"),!step||!1===prop||prop&&!1===prop.enableOnPlaying?that.disable():step&&that.enable(),"string"==typeof prop?that.button.value=prop:prop&&prop.text&&(that.button.value=prop.text)}))},BackButton.prototype.disable=function(){this.button.disabled="disabled"},BackButton.prototype.enable=function(){this.button.disabled=!1}}(node),function(node){"use strict";node.NDDB;function BoxSelector(){this.button=null,this.buttonText="",this.items=[],this.onclick=null,this.getDescr=null,this.getId=function(item){return item.id},this.ul=null}node.widgets.register("BoxSelector",BoxSelector),BoxSelector.version="1.0.0",BoxSelector.description="Creates a simple box that opens a menu of items to choose from.",BoxSelector.panel=!1,BoxSelector.title=!1,BoxSelector.className="boxselector",BoxSelector.dependencies={JSUS:{}},BoxSelector.prototype.init=function(options){if(options.onclick){if("function"!=typeof options.onclick)throw new Error("BoxSelector.init: options.getId must be function or undefined. Found: "+options.getId);this.onclick=options.onclick}if("function"!=typeof options.getDescr)throw new Error("BoxSelector.init: options.getDescr must be function. Found: "+options.getDescr);if(this.getDescr=options.getDescr,options.getId&&"function"!=typeof options.getId)throw new Error("BoxSelector.init: options.getId must be function or undefined. Found: "+options.getId);this.getId=options.getId},BoxSelector.prototype.append=function(){var that,ul,btn,btnGroup,toggled;(btnGroup=W.add("div",this.bodyDiv)).role="group",btnGroup["aria-label"]="Select Items",btnGroup.className="btn-group dropup",(btn=this.button=W.add("button",btnGroup)).className="btn btn-default btn dropdown-toggle",btn["data-toggle"]="dropdown",btn["aria-haspopup"]="true",btn["aria-expanded"]="false",btn.innerHTML=this.buttonText+"&nbsp;",W.add("span",btn,{className:"caret"}),(ul=this.ul=W.add("ul",btnGroup)).className="dropdown-menu",ul.style.display="none",toggled=!1,btn.onclick=function(){toggled?(ul.style.display="none",toggled=!1):(ul.style.display="block",toggled=!0)},this.onclick&&(that=this,ul.onclick=function(eventData){var id,i,len;if(id=eventData.target,ul.style.display="",toggled=!1,(id=id.parentNode.id)||(id=eventData.target.parentNode.parentNode.id),id)for(len=that.items.length,i=0;i<len;i++)if(that.getId(that.items[i])===id){that.onclick.call(that,that.items[i],id);break}})},BoxSelector.prototype.addItem=function(item){var ul,li,a,tmp;if(ul=this.ul,li=document.createElement("li"),!(tmp=this.getDescr(item))||"string"!=typeof tmp)throw new Error("BoxSelector.addItem: getDescr did not return a string. Found: "+tmp+". Item: "+item);if(this.onclick?((a=document.createElement("a")).href="#",a.innerHTML=tmp,li.appendChild(a)):li.innerHTML=tmp,!(tmp=this.getId(item))||"string"!=typeof tmp)throw new Error("BoxSelector.addItem: getId did not return a string. Found: "+tmp+". Item: "+item);li.id=tmp,li.className="dropdown-header",ul.appendChild(li),this.items.push(item)},BoxSelector.prototype.removeItem=function(id){var i,len,elem;for(len=this.items.length,i=0;i<len;i++)if(this.getId(this.items[i])===id)return elem=W.gid(id),this.ul.removeChild(elem),this.items.splice(i,1);return!1},BoxSelector.prototype.getValues=function(){return this.items}}(node),function(node){"use strict";var NDDB=node.NDDB;function Chat(){this.chatEvent=null,this.stats={received:0,sent:0,unread:0},this.submitButton=null,this.useSubmitButton=null,this.useSubmitEnter=null,this.receiverOnly=!1,this.storeMsgs=!1,this.db=null,this.chatDiv=null,this.textarea=null,this.initialMsg=null,this.recipientsIds=null,this.recipientsIdsQuitted=null,this.senderToNameMap=null,this.recipientToNameMap=null,this.senderToRecipientMap=null,this.recipientToSenderMap=null,this.showIsTyping=null,this.amTypingTimeout=null,this.isTypingTimeouts={},this.isTypingDivs={},this.preprocessMsg=null}function sendAmTyping(that){var to;that.isDisabled()||that.amTypingTimeout||(to=that.recipientsIds).length&&(1===to.length&&(to=to[0]),that.amTypingTimeout=setTimeout((function(){that.amTypingTimeout=null}),4e3),node.say(that.chatEvent+"_TYPING",to))}node.widgets.register("Chat",Chat),Chat.texts={outgoing:function(w,data){return data.msg},incoming:function(w,data){var str;return str="<span>",w.recipientsIds.length>1&&(str+='<span class="chat_id_other">'+(w.senderToNameMap[data.id]||data.id)+"</span>: "),str+=data.msg+"</span>"},quit:function(w,data){return(w.senderToNameMap[data.id]||data.id)+" left the chat"},noMoreParticipants:function(){return"No active participant left. Chat disabled."},collapse:function(w,data){return(w.senderToNameMap[data.id]||data.id)+" "+(data.collapsed?"mini":"maxi")+"mized the chat"},textareaPlaceholder:function(w){return w.useSubmitEnter?"Type something and press enter to send":"Type something"},submitButton:"Send",isTyping:"is typing..."},Chat.version="1.5.0",Chat.description="Offers a uni-/bi-directional communication interface between players, or between players and the server.",Chat.title="Chat",Chat.className="chat",Chat.panel=!1,Chat.dependencies={JSUS:{}},Chat.prototype.init=function(opts){var tmp,i,rec,sender,that;if(opts=opts||{},that=this,this.receiverOnly=!!opts.receiverOnly,"function"==typeof(tmp=opts.preprocessMsg))this.preprocessMsg=tmp;else if(tmp)throw new TypeError("Chat.init: preprocessMsg must be function or undefined. Found: "+tmp);if(tmp=opts.chatEvent){if("string"!=typeof tmp)throw new TypeError("Chat.init: chatEvent must be a non-empty string or undefined. Found: "+tmp);this.chatEvent=opts.chatEvent}else this.chatEvent="CHAT";if(this.storeMsgs=!!opts.storeMsgs,this.storeMsgs&&(this.db||(this.db=new NDDB)),this.useSubmitButton=void 0===opts.useSubmitButton?J.isMobileAgent():!!opts.useSubmitButton,this.useSubmitEnter=void 0===opts.useSubmitEnter||!!opts.useSubmitEnter,tmp=opts.participants,!J.isArray(tmp)||!tmp.length)throw new TypeError("Chat.init: participants must be a non-empty array. Found: "+tmp);for(this.recipientsIds=new Array(tmp.length),this.recipientsIdsQuitted=[],this.recipientToSenderMap={},this.recipientToNameMap={},this.senderToNameMap={},this.senderToRecipientMap={},i=0;i<tmp.length;i++)if("string"==typeof tmp[i])this.recipientsIds[i]=tmp[i],this.recipientToNameMap[tmp[i]]=tmp[i],this.recipientToSenderMap[tmp[i]]=tmp[i],this.senderToRecipientMap[tmp[i]]=tmp[i],this.senderToNameMap[tmp[i]]=tmp[i];else{if("object"!=typeof tmp[i])throw new TypeError("Chat.init: participants array must contain string or object. Found: "+tmp[i]);rec=tmp[i].recipient,sender=tmp[i].sender,this.recipientsIds[i]=rec,this.recipientToSenderMap[rec]=sender||rec,this.recipientToNameMap[rec]=tmp[i].name||rec,this.senderToRecipientMap[sender]=rec,this.senderToNameMap[sender]=this.recipientToNameMap[rec]}if(this.uncollapseOnMsg=opts.uncollapseOnMsg||!1,this.printStartTime=opts.printStartTime||!1,this.printNames=opts.printNames||!1,opts.initialMsg){if("object"!=typeof opts.initialMsg)throw new TypeError("Chat.init: initialMsg must be object or undefined. Found: "+opts.initialMsg);this.initialMsg=opts.initialMsg}this.on("uncollapsed",(function(){that.setTitle(that.title),that.recipientsIds.length&&node.say(that.chatEvent+"_COLLAPSE",that.recipientsIds,!1)})),this.on("collapsed",(function(){that.recipientsIds.length&&node.say(that.chatEvent+"_COLLAPSE",that.recipientsIds,!0)})),this.on("destroyed",(function(){that.recipientsIds.length&&node.say(that.chatEvent+"_QUIT",that.recipientsIds)})),this.showIsTyping=void 0===opts.showIsTyping||!!opts.showIsTyping},Chat.prototype.append=function(){var that,inputGroup,initialText;that=this,this.chatDiv=W.get("div",{className:"chat_chat"}),this.bodyDiv.appendChild(this.chatDiv),this.receiverOnly||((inputGroup=document.createElement("div")).className="chat_inputgroup",this.textarea=W.get("textarea",{className:"chat_textarea form-control",placeholder:this.getText("textareaPlaceholder")}),inputGroup.appendChild(this.textarea),this.useSubmitButton&&(this.submitButton=W.get("button",{className:"btn-sm btn-info form-control chat_submit",innerHTML:this.getText("submitButton")}),this.submitButton.onclick=function(){that.sendMsg(),"function"==typeof that.textarea.focus&&that.textarea.focus()},inputGroup.appendChild(this.submitButton)),(this.useSubmitEnter||this.showIsTyping)&&(this.textarea.onkeydown=function(e){that.useSubmitEnter?13===((e=e||window.event).keyCode||e.which)?that.sendMsg():sendAmTyping(that):that.showIsTyping&&sendAmTyping(that)}),this.bodyDiv.appendChild(inputGroup)),this.printStartTime&&(W.add("div",this.chatDiv,{innerHTML:Date(J.getDate()),className:"chat_event"}),initialText=!0),this.printNames&&(W.add("div",this.chatDiv,{className:"chat_event",innerHTML:"Participants: "+J.keys(this.senderToNameMap).join(", ")}),initialText=!0),initialText&&W.add("div",this.chatDiv,{className:"chat_event",innerHTML:"&nbsp;"}),this.initialMsg&&this.writeMsg(this.initialMsg.id?"incoming":"outgoing",this.initialMsg)},Chat.prototype.readTextarea=function(){var txt;return txt=this.textarea.value,this.textarea.value="",txt.trim()},Chat.prototype.writeMsg=function(code,data){var c;return c="incoming"===code||"outgoing"===code?code:"event",c=W.add("div",this.chatDiv,{innerHTML:this.getText(code,data),className:"chat_msg chat_msg_"+c}),this.scrollToBottom(),c},Chat.prototype.renderMsg=function(data,code){return"function"==typeof this.preprocessMsg&&this.preprocessMsg(data,code),"function"==typeof data.msg?data.msg(data,code):data.msg},Chat.prototype.scrollToBottom=function(){this.chatDiv.scrollTop=this.chatDiv.scrollHeight},Chat.prototype.listeners=function(){var that=this;node.on.data(this.chatEvent,(function(msg){that.handleMsg(msg)&&(that.stats.received++,that.storeMsgs&&that.db.insert({from:msg.from,text:msg.data,time:node.timer.getTimeSince("step"),timestamp:J.now()}),that.clearIsTyping(msg.from),msg={msg:that.renderMsg(msg.data,"incoming"),id:msg.from},that.writeMsg("incoming",msg))})),node.on.data(this.chatEvent+"_QUIT",(function(msg){var i,len,rec;if(that.handleMsg(msg)){for(that.writeMsg("quit",{id:msg.from}),len=that.recipientsIds.length,i=0;i<len;i++)if(that.recipientsIds[i]===that.senderToRecipientMap[msg.from]){rec=that.recipientsIds.splice(i,1),that.recipientsIdsQuitted.push(rec),0===that.recipientsIds.length&&(that.writeMsg("noMoreParticipants"),that.disable());break}node.warn("Chat: participant quitted not found: "+msg.from)}})),node.on.data(this.chatEvent+"_COLLAPSE",(function(msg){that.handleMsg(msg)&&that.writeMsg("collapse",{id:msg.from,collapsed:msg.data})})),node.on.data(this.chatEvent+"_TYPING",(function(msg){that.handleMsg(msg)&&that.addIsTyping(msg.from)}))},Chat.prototype.addIsTyping=function(id){var t,div,that;(t=this.isTypingTimeouts[id])&&clearTimeout(t),(div=this.isTypingDivs[id])?(this.chatDiv.appendChild(div),div.style.display=""):this.isTypingDivs[id]=this.writeMsg("incoming",{msg:this.getText("isTyping"),id:id}),this.scrollToBottom(),that=this,this.isTypingTimeouts[id]=setTimeout((function(){that.clearIsTyping(id),that.isTypingTimeouts[id]=null}),3e3)},Chat.prototype.clearIsTyping=function(id){this.isTypingTimeouts[id]&&(clearTimeout(this.isTypingTimeouts[id]),this.isTypingTimeouts[id]=null),this.isTypingDivs[id]&&(this.isTypingDivs[id].style.display="none")},Chat.prototype.handleMsg=function(msg){var from;return(from=msg.from)===node.player.id||from===node.player.sid?(node.warn("Chat: your own message came back: "+msg.id),!1):(this.isCollapsed()&&(this.uncollapseOnMsg?(this.uncollapse(),this.stats.unread=0):(this.setTitle("<strong>"+this.title+"</strong>"),this.stats.unread++)),!0)},Chat.prototype.disable=function(){this.submitButton&&(this.submitButton.disabled=!0),this.textarea.disabled=!0,this.disabled=!0},Chat.prototype.enable=function(){this.submitButton&&(this.submitButton.disabled=!1),this.textarea.disabled=!1,this.disabled=!1},Chat.prototype.getValues=function(){var out;return out={participants:this.participants,totSent:this.stats.sent,totReceived:this.stats.received,totUnread:this.stats.unread,initialMsg:this.initialMsg},this.db&&(out.msgs=this.db.fetch()),out},Chat.prototype.sendMsg=function(opts){var to,ids,that;if(this.isDisabled())node.warn("Chat is disable, msg not sent.");else{if("object"==typeof opts){if(void 0!==opts.msg&&"object"==typeof opts.msg)throw new TypeError("Chat.sendMsg: opts.msg cannot be object. Found: "+opts.msg)}else if(void 0===opts)opts={msg:this.readTextarea()};else{if("string"!=typeof opts&&"number"!=typeof opts)throw new TypeError("Chat.sendMsg: opts must be string, number, object, or undefined. Found: "+opts);opts={msg:opts}}opts.msg=this.renderMsg(opts,"outgoing"),""!==opts.msg?0!==(ids=opts.recipients||this.recipientsIds).length?(to=1===ids.length?ids[0]:ids,node.say(this.chatEvent,to,opts),opts.silent||(that=this,this.writeMsg("outgoing",opts),that.textarea&&setTimeout((function(){that.textarea.value=""}))),this.amTypingTimeout&&(clearTimeout(this.amTypingTimeout),this.amTypingTimeout=null)):node.warn("Chat: empty recipient list, message not sent."):node.warn("Chat: message has no text, not sent.")}}}(node),function(node){"use strict";var Table=W.Table;function ChernoffFaces(options){var that=this;this.options=null,this.table=null,this.sc=null,this.fp=null,this.canvas=null,this.changes=[],this.onChange=null,this.onChangeCb=function(f,updateControls){void 0===updateControls&&(updateControls=!1),f||(f=that.sc?that.sc.getValues():FaceVector.random()),that.draw(f,updateControls)},this.timeFrom="step",this.features=null}function FacePainter(canvas,settings){this.canvas=new W.Canvas(canvas),this.scaleX=canvas.width/ChernoffFaces.width,this.scaleY=canvas.height/ChernoffFaces.heigth,this.face=null}function FaceVector(faceVector,defaults){var key;if(void 0===faceVector)for(key in FaceVector.defaults)FaceVector.defaults.hasOwnProperty(key)&&("color"===key?this.color="red":"lineWidth"===key?this.lineWidth=1:"scaleX"===key?this.scaleX=1:"scaleY"===key?this.scaleY=1:this[key]=FaceVector.defaults[key].min+Math.random()*FaceVector.defaults[key].range);else{if("object"!=typeof faceVector)throw new TypeError("FaceVector constructor: faceVector must be object or undefined.");for(key in this.scaleX=faceVector.scaleX||1,this.scaleY=faceVector.scaleY||1,this.color=faceVector.color||"green",this.lineWidth=faceVector.lineWidth||1,defaults=defaults||FaceVector.defaults)defaults.hasOwnProperty(key)&&(faceVector.hasOwnProperty(key)?this[key]=faceVector[key]:this[key]=defaults?defaults[key]:FaceVector.defaults[key].value)}}node.widgets.register("ChernoffFaces",ChernoffFaces),ChernoffFaces.version="0.6.2",ChernoffFaces.description="Display parametric data in the form of a Chernoff Face.",ChernoffFaces.title="ChernoffFaces",ChernoffFaces.className="chernofffaces",ChernoffFaces.dependencies={JSUS:{},Table:{},Canvas:{},SliderControls:{}},ChernoffFaces.FaceVector=FaceVector,ChernoffFaces.FacePainter=FacePainter,ChernoffFaces.width=100,ChernoffFaces.height=100,ChernoffFaces.onChange="CF_CHANGE",ChernoffFaces.prototype.init=function(options){this.options=options,options.features?this.features=new FaceVector(options.features):this.features||(this.features=FaceVector.random()),this.fp&&this.fp.draw(this.features),!1===options.onChange||null===options.onChange?this.onChange&&(node.off(this.onChange,this.onChangeCb),this.onChange=null):(this.onChange=void 0===options.onChange?ChernoffFaces.onChange:options.onChange,node.on(this.onChange,this.onChangeCb))},ChernoffFaces.prototype.getCanvas=function(){return this.canvas},ChernoffFaces.prototype.buildHTML=function(){var controlsOptions,tblOptions,options;this.table||(options=this.options,tblOptions={},this.id&&(tblOptions.id=this.id),"string"==typeof options.className?tblOptions.className=options.className:!1!==options.className&&(tblOptions.className="cf_table"),this.table=new Table(tblOptions),this.canvas||this.buildCanvas(),(void 0===options.controls||options.controls)&&(controlsOptions={id:"cf_controls",features:J.mergeOnKey(FaceVector.defaults,this.features,"value"),onChange:this.onChange,submit:"Send"},"object"==typeof options.controls?this.sc=options.controls:this.sc=node.widgets.get("SliderControls",controlsOptions)),this.sc?this.table.addRow([{content:this.sc,id:this.id+"_td_controls"},{content:this.canvas,id:this.id+"_td_cf"}]):this.table.add({content:this.canvas,id:this.id+"_td_cf"}),this.table.parse())},ChernoffFaces.prototype.buildCanvas=function(){var options;this.canvas||((options=this.options).canvas||(options.canvas={},void 0!==options.height&&(options.canvas.height=options.height),void 0!==options.width&&(options.canvas.width=options.width)),this.canvas=W.get("canvas",options.canvas),this.canvas.id="ChernoffFaces_canvas",this.fp=new FacePainter(this.canvas),this.fp.draw(this.features))},ChernoffFaces.prototype.append=function(){this.table||this.buildHTML(),this.bodyDiv.appendChild(this.table.table)},ChernoffFaces.prototype.draw=function(features,updateControls){var time;if("object"!=typeof features)throw new TypeError("ChernoffFaces.draw: features must be object.");this.options.trackChanges&&(time="string"==typeof this.timeFrom?node.timer.getTimeSince(this.timeFrom):Date.now?Date.now():(new Date).getTime(),this.changes.push({time:time,change:features})),this.features=features instanceof FaceVector?features:new FaceVector(features,this.features),this.fp.redraw(this.features),this.sc&&!1!==updateControls&&(this.sc.init({features:J.mergeOnKey(FaceVector.defaults,features,"value")}),this.sc.refresh())},ChernoffFaces.prototype.getValues=function(options){return options&&options.changes?{changes:this.changes,cf:this.features}:this.fp.face},ChernoffFaces.prototype.randomize=function(){var fv;return fv=FaceVector.random(),this.fp.redraw(fv),this.sc&&(this.sc.init({features:J.mergeOnValue(FaceVector.defaults,fv),onChange:this.onChange}),this.sc.refresh()),!0},FacePainter.prototype.draw=function(face,x,y){face&&(this.face=face,this.fit2Canvas(face),this.canvas.scale(face.scaleX,face.scaleY),x=x||this.canvas.centerX,y=y||this.canvas.centerY,this.drawHead(face,x,y),this.drawEyes(face,x,y),this.drawPupils(face,x,y),this.drawEyebrow(face,x,y),this.drawNose(face,x,y),this.drawMouth(face,x,y))},FacePainter.prototype.redraw=function(face,x,y){this.canvas.clear(),this.draw(face,x,y)},FacePainter.prototype.scale=function(x,y){this.canvas.scale(this.scaleX,this.scaleY)},FacePainter.prototype.fit2Canvas=function(face){var ratio;this.canvas?(ratio=this.canvas.width>this.canvas.height?this.canvas.width/face.head_radius*face.head_scale_x:this.canvas.height/face.head_radius*face.head_scale_y,face.scaleX=ratio/2,face.scaleY=ratio/2):console.log("No canvas found")},FacePainter.prototype.drawHead=function(face,x,y){var radius=face.head_radius;this.canvas.drawOval({x:x,y:y,radius:radius,scale_x:face.head_scale_x,scale_y:face.head_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawEyes=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.eye_height,y),spacing=face.eye_spacing,radius=face.eye_radius;this.canvas.drawOval({x:x-spacing,y:height,radius:radius,scale_x:face.eye_scale_x,scale_y:face.eye_scale_y,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawOval({x:x+spacing,y:height,radius:radius,scale_x:face.eye_scale_x,scale_y:face.eye_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawPupils=function(face,x,y){var radius=face.pupil_radius,spacing=face.eye_spacing,height=FacePainter.computeFaceOffset(face,face.eye_height,y);this.canvas.drawOval({x:x-spacing,y:height,radius:radius,scale_x:face.pupil_scale_x,scale_y:face.pupil_scale_y,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawOval({x:x+spacing,y:height,radius:radius,scale_x:face.pupil_scale_x,scale_y:face.pupil_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawEyebrow=function(face,x,y){var height=FacePainter.computeEyebrowOffset(face,y),spacing=face.eyebrow_spacing,length=face.eyebrow_length,angle=face.eyebrow_angle;this.canvas.drawLine({x:x-spacing,y:height,length:length,angle:angle,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawLine({x:x+spacing,y:height,length:0-length,angle:-angle,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawNose=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.nose_height,y),nastril_r_x=x+face.nose_width/2,nastril_r_y=height+face.nose_length,nastril_l_x=nastril_r_x-face.nose_width,nastril_l_y=nastril_r_y;this.canvas.ctx.lineWidth=face.lineWidth,this.canvas.ctx.strokeStyle=face.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(x,height),this.canvas.ctx.lineTo(nastril_r_x,nastril_r_y),this.canvas.ctx.lineTo(nastril_l_x,nastril_l_y),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},FacePainter.prototype.drawMouth=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.mouth_height,y),startX=x-face.mouth_width/2,endX=x+face.mouth_width/2,top_y=height-face.mouth_top_y,bottom_y=height+face.mouth_bottom_y;this.canvas.ctx.moveTo(startX,height),this.canvas.ctx.quadraticCurveTo(x,top_y,endX,height),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(startX,height),this.canvas.ctx.quadraticCurveTo(x,bottom_y,endX,height),this.canvas.ctx.stroke()},FacePainter.computeFaceOffset=function(face,offset,y){return(y=y||0)-face.head_radius+2*face.head_radius*offset},FacePainter.computeEyebrowOffset=function(face,y){y=y||0;return FacePainter.computeFaceOffset(face,face.eye_height,y)-2-face.eyebrow_eyedistance},FaceVector.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"},scaleX:{min:0,max:20,step:.01,value:.2,label:"Scale X"},scaleY:{min:0,max:20,step:.01,value:.2,label:"Scale Y"},color:{min:0,max:20,step:.01,value:.2,label:"color"},lineWidth:{min:0,max:20,step:.01,value:.2,label:"lineWidth"}},function(defaults){var key;for(key in defaults)defaults.hasOwnProperty(key)&&(defaults[key].range=defaults[key].max-defaults[key].min)}(FaceVector.defaults),FaceVector.random=function(){return console.log("*** FaceVector.random is deprecated. Use new FaceVector() instead."),new FaceVector}}(node),function(node){"use strict";var Table=W.Table;function ChernoffFaces(options){this.options=options,this.id=options.id,this.table=new Table({id:"cf_table"}),this.root=options.root||document.createElement("div"),this.root.id=this.id,this.sc=node.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.dims=null,this.change="CF_CHANGE";var that=this;this.changeFunc=function(){that.draw(that.sc.getAllValues())},this.features=null,this.controls=null}function FacePainter(canvas,settings){this.canvas=new W.Canvas(canvas),this.scaleX=canvas.width/ChernoffFaces.defaults.canvas.width,this.scaleY=canvas.height/ChernoffFaces.defaults.canvas.heigth}function FaceVector(faceVector){for(var key in faceVector=faceVector||{},this.scaleX=faceVector.scaleX||1,this.scaleY=faceVector.scaleY||1,this.color=faceVector.color||"green",this.lineWidth=faceVector.lineWidth||1,FaceVector.defaults)FaceVector.defaults.hasOwnProperty(key)&&(faceVector.hasOwnProperty(key)?this[key]=faceVector[key]:this[key]=FaceVector.defaults[key].value)}node.widgets.register("ChernoffFacesSimple",ChernoffFaces),ChernoffFaces.defaults={},ChernoffFaces.defaults.id="ChernoffFaces",ChernoffFaces.defaults.canvas={},ChernoffFaces.defaults.canvas.width=100,ChernoffFaces.defaults.canvas.heigth=100,ChernoffFaces.version="0.4",ChernoffFaces.description="Display parametric data in the form of a Chernoff Face.",ChernoffFaces.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},ChernoffFaces.FaceVector=FaceVector,ChernoffFaces.FacePainter=FacePainter,ChernoffFaces.prototype.init=function(options){this.id=options.id||this.id;var PREF=this.id+"_";this.features=options.features||this.features||FaceVector.random(),this.controls=void 0===options.controls||options.controls;var idCanvas=options.idCanvas?options.idCanvas:PREF+"canvas";this.dims={width:options.width?options.width:ChernoffFaces.defaults.canvas.width,height:options.height?options.height:ChernoffFaces.defaults.canvas.heigth},this.canvas=W.getCanvas(idCanvas,this.dims),this.fp=new FacePainter(this.canvas),this.fp.draw(new FaceVector(this.features));var sc_options={id:"cf_controls",features:J.mergeOnKey(FaceVector.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=node.widgets.get("Controls.Slider",sc_options),this.controls&&this.table.add(this.sc),void 0===options.change?node.on(this.change,this.changeFunc):(options.change?node.on(options.change,this.changeFunc):node.removeListener(this.change,this.changeFunc),this.change=options.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},ChernoffFaces.prototype.getRoot=function(){return this.root},ChernoffFaces.prototype.getCanvas=function(){return this.canvas},ChernoffFaces.prototype.append=function(root){return root.appendChild(this.root),this.table.parse(),this.root},ChernoffFaces.prototype.listeners=function(){},ChernoffFaces.prototype.draw=function(features){if(features){var fv=new FaceVector(features);this.fp.redraw(fv),this.sc.init({features:J.mergeOnKey(FaceVector.defaults,features,"value")}),this.sc.refresh()}},ChernoffFaces.prototype.getAllValues=function(){return this.fp.face},ChernoffFaces.prototype.randomize=function(){var fv=FaceVector.random();this.fp.redraw(fv);var sc_options={features:J.mergeOnKey(FaceVector.defaults,fv,"value"),change:this.change};return this.sc.init(sc_options),this.sc.refresh(),!0},FacePainter.prototype.draw=function(face,x,y){face&&(this.face=face,this.fit2Canvas(face),this.canvas.scale(face.scaleX,face.scaleY),x=x||this.canvas.centerX,y=y||this.canvas.centerY,this.drawHead(face,x,y),this.drawEyes(face,x,y),this.drawPupils(face,x,y),this.drawEyebrow(face,x,y),this.drawNose(face,x,y),this.drawMouth(face,x,y))},FacePainter.prototype.redraw=function(face,x,y){this.canvas.clear(),this.draw(face,x,y)},FacePainter.prototype.scale=function(x,y){this.canvas.scale(this.scaleX,this.scaleY)},FacePainter.prototype.fit2Canvas=function(face){var ratio;this.canvas?(ratio=this.canvas.width>this.canvas.height?this.canvas.width/face.head_radius*face.head_scale_x:this.canvas.height/face.head_radius*face.head_scale_y,face.scaleX=ratio/2,face.scaleY=ratio/2):console.log("No canvas found")},FacePainter.prototype.drawHead=function(face,x,y){var radius=face.head_radius;this.canvas.drawOval({x:x,y:y,radius:radius,scale_x:face.head_scale_x,scale_y:face.head_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawEyes=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.eye_height,y),spacing=face.eye_spacing,radius=face.eye_radius;this.canvas.drawOval({x:x-spacing,y:height,radius:radius,scale_x:face.eye_scale_x,scale_y:face.eye_scale_y,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawOval({x:x+spacing,y:height,radius:radius,scale_x:face.eye_scale_x,scale_y:face.eye_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawPupils=function(face,x,y){var radius=face.pupil_radius,spacing=face.eye_spacing,height=FacePainter.computeFaceOffset(face,face.eye_height,y);this.canvas.drawOval({x:x-spacing,y:height,radius:radius,scale_x:face.pupil_scale_x,scale_y:face.pupil_scale_y,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawOval({x:x+spacing,y:height,radius:radius,scale_x:face.pupil_scale_x,scale_y:face.pupil_scale_y,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawEyebrow=function(face,x,y){var height=FacePainter.computeEyebrowOffset(face,y),spacing=face.eyebrow_spacing,length=face.eyebrow_length,angle=face.eyebrow_angle;this.canvas.drawLine({x:x-spacing,y:height,length:length,angle:angle,color:face.color,lineWidth:face.lineWidth}),this.canvas.drawLine({x:x+spacing,y:height,length:0-length,angle:-angle,color:face.color,lineWidth:face.lineWidth})},FacePainter.prototype.drawNose=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.nose_height,y),nastril_r_x=x+face.nose_width/2,nastril_r_y=height+face.nose_length,nastril_l_x=nastril_r_x-face.nose_width,nastril_l_y=nastril_r_y;this.canvas.ctx.lineWidth=face.lineWidth,this.canvas.ctx.strokeStyle=face.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(x,height),this.canvas.ctx.lineTo(nastril_r_x,nastril_r_y),this.canvas.ctx.lineTo(nastril_l_x,nastril_l_y),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},FacePainter.prototype.drawMouth=function(face,x,y){var height=FacePainter.computeFaceOffset(face,face.mouth_height,y),startX=x-face.mouth_width/2,endX=x+face.mouth_width/2,top_y=height-face.mouth_top_y,bottom_y=height+face.mouth_bottom_y;this.canvas.ctx.moveTo(startX,height),this.canvas.ctx.quadraticCurveTo(x,top_y,endX,height),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(startX,height),this.canvas.ctx.quadraticCurveTo(x,bottom_y,endX,height),this.canvas.ctx.stroke()},FacePainter.computeFaceOffset=function(face,offset,y){return(y=y||0)-face.head_radius+2*face.head_radius*offset},FacePainter.computeEyebrowOffset=function(face,y){y=y||0;return FacePainter.computeFaceOffset(face,face.eye_height,y)-2-face.eyebrow_eyedistance},
/*!
     *
     * A description of a Chernoff Face.
     *
     * This class packages the 11-dimensional vector of numbers from 0 through
     * 1 that completely describe a Chernoff face.
     *
     */
FaceVector.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},FaceVector.random=function(){var out={};for(var key in FaceVector.defaults)FaceVector.defaults.hasOwnProperty(key)&&(J.inArray(key,["color","lineWidth","scaleX","scaleY"])||(out[key]=FaceVector.defaults[key].min+Math.random()*FaceVector.defaults[key].max));return out.scaleX=1,out.scaleY=1,out.color="green",out.lineWidth=1,new FaceVector(out)},FaceVector.prototype.shuffle=function(){for(var key in this)this.hasOwnProperty(key)&&FaceVector.defaults.hasOwnProperty(key)&&"color"!==key&&(this[key]=FaceVector.defaults[key].min+Math.random()*FaceVector.defaults[key].max)},FaceVector.prototype.distance=function(face){return FaceVector.distance(this,face)},FaceVector.distance=function(face1,face2){var diff,sum=0;for(var key in face1)face1.hasOwnProperty(key)&&(sum+=(diff=face1[key]-face2[key])*diff);return Math.sqrt(sum)},FaceVector.prototype.toString=function(){var out="Face: ";for(var key in this)this.hasOwnProperty(key)&&(out+=key+" "+this[key]);return out}}(node),function(node){"use strict";function ChoiceManager(){this.dl=null,this.mainText=null,this.spanMainText=null,this.forms=null,this.formsById=null,this.order=null,this.shuffleForms=null,this.group=null,this.groupOrder=null,this.formsOptions={title:!1,frame:!1,storeRef:!1},this.simplify=null,this.freeText=null,this.textarea=null,this.required=null}node.widgets.register("ChoiceManager",ChoiceManager),ChoiceManager.version="1.4.1",ChoiceManager.description="Groups together and manages a set of survey forms (e.g., ChoiceTable).",ChoiceManager.title=!1,ChoiceManager.className="choicemanager",ChoiceManager.dependencies={},ChoiceManager.prototype.init=function(options){var tmp;if(tmp=void 0!==options.shuffleForms&&!!options.shuffleForms,this.shuffleForms=tmp,"string"==typeof options.group||"number"==typeof options.group)this.group=options.group;else if(void 0!==options.group)throw new TypeError("ChoiceManager.init: options.group must be string, number or undefined. Found: "+options.group);if("number"==typeof options.groupOrder)this.groupOrder=options.groupOrder;else if(void 0!==options.group)throw new TypeError("ChoiceManager.init: options.groupOrder must be number or undefined. Found: "+options.groupOrder);if("string"==typeof options.mainText)this.mainText=options.mainText;else if(void 0!==options.mainText)throw new TypeError("ChoiceManager.init: options.mainText must be string or undefined. Found: "+options.mainText);if(void 0!==options.formsOptions){if("object"!=typeof options.formsOptions)throw new TypeError("ChoiceManager.init: options.formsOptions must be object or undefined. Found: "+options.formsOptions);if(options.formsOptions.hasOwnProperty("name"))throw new Error("ChoiceManager.init: options.formsOptions cannot contain property name. Found: "+options.formsOptions);this.formsOptions=J.mixin(this.formsOptions,options.formsOptions)}this.freeText="string"==typeof options.freeText?options.freeText:!!options.freeText,void 0!==options.required&&(this.required=!!options.required),this.simplify=!!options.simplify,void 0!==options.forms&&this.setForms(options.forms)},ChoiceManager.prototype.setForms=function(forms){var form,formsById,i,len,parsedForms,name;if("function"==typeof forms){if(parsedForms=forms.call(node.game),!J.isArray(parsedForms))throw new TypeError("ChoiceManager.setForms: forms is a callback, but did not returned an array. Found: "+parsedForms)}else{if(!J.isArray(forms))throw new TypeError("ChoiceManager.setForms: forms must be array or function. Found: "+forms);parsedForms=forms}if(!(len=parsedForms.length))throw new Error("ChoiceManager.setForms: forms is an empty array.");for(formsById={},forms=new Array(len),i=-1;++i<len;){if(form=parsedForms[i],node.widgets.isWidget(form)||(name=form.name||"ChoiceTable",J.mixout(form,this.formsOptions),form=node.widgets.get(name,form)),form.id){if(formsById[form.id])throw new Error("ChoiceManager.setForms: duplicated form id: "+form.id)}else form.id=form.className+"_"+i;if(forms[i]=form,formsById[form.id]=forms[i],form.required||form.requiredChoice||form.correctChoice){if(!1===this.required)throw new Error('ChoiceManager.setForms: required is false, but form "'+form.id+'" has required truthy');this.required=!0}}this.forms=forms,this.formsById=formsById,this.order=J.seq(0,len-1),this.shuffleForms&&(this.order=J.shuffle(this.order))},ChoiceManager.prototype.buildDl=function(){var i,len,dt,form;for(i=-1,len=this.forms.length;++i<len;)(dt=document.createElement("dt")).className="question",form=this.forms[this.order[i]],node.widgets.append(form,dt),this.dl.appendChild(dt)},ChoiceManager.prototype.append=function(){if(W.getElementById(this.id))throw new Error("ChoiceManager.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=document.createElement("span"),this.spanMainText.className=ChoiceManager.className+"-maintext",this.spanMainText.innerHTML=this.mainText,this.bodyDiv.appendChild(this.spanMainText)),this.dl=document.createElement("dl"),this.buildDl(),this.bodyDiv.appendChild(this.dl),this.freeText&&(this.textarea=document.createElement("textarea"),this.id&&(this.textarea.id=this.id+"_text"),"string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),this.textarea.className=ChoiceManager.className+"-freetext",this.bodyDiv.appendChild(this.textarea))},ChoiceManager.prototype.listeners=function(){var that=this;node.on("INPUT_DISABLE",(function(){that.disable()})),node.on("INPUT_ENABLE",(function(){that.enable()}))},ChoiceManager.prototype.disable=function(){var i,len;if(!this.disabled){for(i=-1,len=this.forms.length;++i<len;)this.forms[i].disable();this.disabled=!0,this.emit("disabled")}},ChoiceManager.prototype.enable=function(){var i,len;if(this.disabled){for(i=-1,len=this.forms.length;++i<len;)this.forms[i].enable();this.disabled=!1,this.emit("enabled")}},ChoiceManager.prototype.verifyChoice=function(markAttempt){var i,len,obj,form;for(obj={id:this.id,order:this.order,forms:{}},markAttempt=void 0===markAttempt||markAttempt,i=-1,len=this.forms.length;++i<len;)form=this.forms[i],obj.forms[form.id]=form.verifyChoice(markAttempt),obj.form[form.id]||(obj.fail=!0);return obj},ChoiceManager.prototype.setCurrentChoice=function(choice){var i,len;for(i=-1,len=this.forms[i].length;++i<len;)this.forms[i].setCurrentChoice(choice)},ChoiceManager.prototype.unsetCurrentChoice=function(choice){var i,len;for(i=-1,len=this.forms[i].length;++i<len;)this.forms[i].unsetCurrentChoice(choice)},ChoiceManager.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("ChoiceManager.highlight: border must be string or undefined. Found: "+border);this.dl&&!0!==this.highlighted&&(this.dl.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted"))},ChoiceManager.prototype.unhighlight=function(){this.dl&&!0===this.highlighted&&(this.dl.style.border="",this.highlighted=!1,this.emit("unhighlighted"))},ChoiceManager.prototype.reset=function(opts){var i,len;for(i=-1,len=this.forms.length;++i<len;)this.forms[i].reset(opts)},ChoiceManager.prototype.getValues=function(opts){var obj,i,len,form,lastErrored,res;for(obj={order:this.order,forms:{},missValues:[]},void 0!==this.id&&(obj.id=this.id),void 0===(opts=opts||{}).markAttempt&&(opts.markAttempt=!0),void 0===opts.highlight&&(opts.highlight=!0),opts.markAttempt&&(obj.isCorrect=!0),i=-1,len=this.forms.length;++i<len;)if((form=this.forms[i]).isHidden()||form.isDisabled())(res=form.getValues({markAttempt:!1,highlight:!1}))&&(obj.forms[form.id]=res);else{if(!(res=form.getValues(opts)))continue;obj.forms[form.id]=res,(form.required||form.requiredChoice)&&(null===obj.forms[form.id].choice||form.selectMultiple&&!obj.forms[form.id].choice.length)&&(obj.missValues.push(form.id),lastErrored=form),opts.markAttempt&&!1===obj.forms[form.id].isCorrect&&(lastErrored=form)}return lastErrored&&(opts.highlight&&"function"==typeof lastErrored.bodyDiv.scrollIntoView&&lastErrored.bodyDiv.scrollIntoView({behavior:"smooth"}),obj._scrolledIntoView=!0,obj.isCorrect=!1,W.adjustFrameHeight()),this.textarea&&(obj.freetext=this.textarea.value),(opts.simplify||this.simplify)&&(res=obj,obj=obj.forms,!1===res.isCorrect&&(obj.isCorrect=!1),res.freetext&&(obj.freetext=res.freetext)),obj},ChoiceManager.prototype.setValues=function(opts){var i,len;if(!this.forms||!this.forms.length)throw new Error("ChoiceManager.setValues: no forms found.");for(opts=opts||{},i=-1,len=this.forms.length;++i<len;)this.forms[i].setValues(opts);this.textarea&&(this.textarea.value=J.randomString(100,"!Aa0"))}}(node),function(node){"use strict";function ChoiceTable(){var that;that=this,this.table=null,this.choicesSetSize=null,this.trs=[],this.listener=function(e){var value,td,i,len,removed;if(e=e||window.event,td=e.target||e.srcElement,void 0===that.choicesIds[td.id]){if(!(td=td.parentNode))return;if(void 0===that.choicesIds[td.id]&&(!(td=td.parentNode)||void 0===that.choicesIds[td.id]))return}if("string"==typeof that.timeFrom?that.timeCurrentChoice=node.timer.getTimeSince(that.timeFrom):that.timeCurrentChoice=Date.now?Date.now():(new Date).getTime(),1!==(value=td.id.split(that.separator)).length&&(value[0],value=parseInt(value[1],10),!that.disabledChoices[value])){if(that.numberOfClicks++,that.isChoiceCurrent(value)){if(that.unsetCurrentChoice(value),J.removeClass(td,"selected"),that.selectMultiple){for(i=-1,len=that.selected.length;++i<len;)if(that.selected[i].id===td.id){that.selected.splice(i,1);break}}else that.selected=null;removed=!0}else{if("number"==typeof that.selectMultiple&&that.selected.length===that.selectMultiple)return;J.addClass(td,"selected"),that.oneTimeClick?setTimeout((function(){J.removeClass(td,"selected")}),60):(that.setCurrentChoice(value),that.selectMultiple?that.selected.push(td):(that.selected&&J.removeClass(that.selected,"selected"),that.selected=td))}that.isHighlighted()&&that.unhighlight(),that.onclick&&(value=parseInt(value,10),that.onclick.call(that,value,removed,td))}},this.onclick=null,this.mainText=null,this.hint=null,this.spanMainText=null,this.choices=null,this.choicesValues={},this.choicesIds={},this.choicesCells=null,this.left=null,this.leftCell=null,this.right=null,this.rightCell=null,this.errorBox=null,this.successBox=null,this.timeCurrentChoice=null,this.timeFrom="step",this.order=null,this.correctChoice=null,this.requiredChoice=null,this.attempts=[],this.numberOfClicks=0,this.selected=null,this.currentChoice=null,this.selectMultiple=null,this.oneTimeClick=null,this.shuffleChoices=null,this.renderer=null,this.orientation="H",this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null,this.separator=ChoiceTable.separator,this.tabbable=null,this.disabledChoices={},this.sameWidthCells=!0}function checkCorrectChoiceParam(that,choice){if("string"==typeof choice&&(choice=parseInt(choice,10)),"number"!=typeof choice)throw new TypeError("ChoiceTable.setCorrectChoice: each choice must be number or string. Found: "+choice);if(void 0===that.choicesValues[choice])throw new TypeError("ChoiceTable.setCorrectChoice: choice not found: "+choice);return choice}function createTR(that){var tr;return(tr=document.createElement("tr")).id="tr"+that.separator+that.id,that.table.appendChild(tr),that.trs.push(tr),tr}function getValueFromChoice(choice,display){return"string"==typeof choice||"number"==typeof choice?choice:J.isArray(choice)?choice[display?1:0]:"object"==typeof choice?choice[display?"display":"value"]:J.isElement(choice)||J.isNode(choice)?choice.innerHTML:null}node.widgets.register("ChoiceTable",ChoiceTable),ChoiceTable.version="1.8.1",ChoiceTable.description="Creates a configurable table where each cell is a selectable choice.",ChoiceTable.title="Make your choice",ChoiceTable.className="choicetable",ChoiceTable.texts={autoHint:function(w){var res;return!(!w.requiredChoice&&!w.selectMultiple)&&(w.selectMultiple?(res="(",w.requiredChoice?"number"==typeof w.selectMultiple?w.selectMultiple===w.requiredChoice?res+="select "+w.requiredChoice:res+="select between "+w.requiredChoice+" and "+w.selectMultiple:res+="select at least "+w.requiredChoice:"number"==typeof w.selectMultiple?res+="select up to "+w.selectMultiple:res+="multiple selection allowed",res+=")",w.requiredChoice&&(res+=" *"),res):"*")},error:function(w,value){return null===value||"number"!=typeof w.correctChoice&&"string"!=typeof w.correctChoice?"Selection required.":"Not correct, try again."}},ChoiceTable.separator="::",ChoiceTable.dependencies={JSUS:{}},ChoiceTable.prototype.init=function(opts){var tmp,that;if(that=this,!this.id)throw new TypeError("ChoiceTable.init: opts.id is missing");if(void 0===opts.orientation)tmp="H";else{if("string"!=typeof opts.orientation)throw new TypeError("ChoiceTable.init: opts.orientation must be string, or undefined. Found: "+opts.orientation);if("horizontal"===(tmp=opts.orientation.toLowerCase().trim())||"h"===tmp)tmp="H";else{if("vertical"!==tmp&&"v"!==tmp)throw new Error("ChoiceTable.init: opts.orientation is invalid: "+tmp);tmp="V"}}if(this.orientation=tmp,tmp=void 0!==opts.shuffleChoices&&!!opts.shuffleChoices,this.shuffleChoices=tmp,void 0===(tmp=opts.selectMultiple))tmp=!1;else if("boolean"!=typeof tmp&&!(tmp=J.isInt(tmp,1)))throw new Error("ChoiceTable.init: selectMultiple must be undefined or an integer > 1. Found: "+tmp);if(this.selectMultiple=tmp,tmp&&(this.selected=[],this.currentChoice=[]),"number"==typeof opts.requiredChoice){if(!J.isInt(opts.requiredChoice,0))throw new Error("ChoiceTable.init: if number, requiredChoice must a positive integer. Found: "+opts.requiredChoice);if("number"==typeof this.selectMultiple&&opts.requiredChoice>this.selectMultiple)throw new Error("ChoiceTable.init: requiredChoice cannot be larger than selectMultiple. Found: "+opts.requiredChoice+" > "+this.selectMultiple);this.requiredChoice=opts.requiredChoice}else if("boolean"==typeof opts.requiredChoice)this.requiredChoice=opts.requiredChoice?1:null;else if(void 0!==opts.requiredChoice)throw new TypeError("ChoiceTable.init: opts.requiredChoice be number, boolean or undefined. Found: "+opts.requiredChoice);if(void 0!==opts.oneTimeClick&&(this.oneTimeClick=!!opts.oneTimeClick),"string"==typeof opts.group||"number"==typeof opts.group)this.group=opts.group;else if(void 0!==opts.group)throw new TypeError("ChoiceTable.init: opts.group must be string, number or undefined. Found: "+opts.group);if("number"==typeof opts.groupOrder)this.groupOrder=opts.groupOrder;else if(void 0!==opts.groupOrder)throw new TypeError("ChoiceTable.init: opts.groupOrder must be number or undefined. Found: "+opts.groupOrder);if("function"==typeof opts.listener)this.listener=function(e){opts.listener.call(this,e)};else if(void 0!==opts.listener)throw new TypeError("ChoiceTable.init: opts.listener must be function or undefined. Found: "+opts.listener);if("function"==typeof opts.onclick)this.onclick=opts.onclick;else if(void 0!==opts.onclick)throw new TypeError("ChoiceTable.init: opts.onclick must be function or undefined. Found: "+opts.onclick);if("string"==typeof opts.mainText)this.mainText=opts.mainText;else if(void 0!==opts.mainText)throw new TypeError("ChoiceTable.init: opts.mainText must be string or undefined. Found: "+opts.mainText);if("string"==typeof opts.hint||!1===opts.hint)this.hint=opts.hint,this.requiredChoice&&(this.hint+=" *");else{if(void 0!==opts.hint)throw new TypeError("ChoiceTable.init: opts.hint must be a string, false, or undefined. Found: "+opts.hint);this.hint=this.getText("autoHint")}if(!1===opts.timeFrom||"string"==typeof opts.timeFrom)this.timeFrom=opts.timeFrom;else if(void 0!==opts.timeFrom)throw new TypeError("ChoiceTable.init: opts.timeFrom must be string, false, or undefined. Found: "+opts.timeFrom);if("string"==typeof opts.separator)this.separator=opts.separator;else if(void 0!==opts.separator)throw new TypeError("ChoiceTable.init: opts.separator must be string, or undefined. Found: "+opts.separator);if(tmp=this.id+this.separator.substring(0,this.separator.length-1),-1!==this.id.indexOf(this.separator)||-1!==tmp.indexOf(this.separator))throw new Error("ChoiceTable.init: separator cannot be included in the id or in the concatenation (id + separator). Please specify the right separator option. Found: "+this.separator);if("string"==typeof opts.left||"number"==typeof opts.left)this.left=""+opts.left;else if(J.isNode(opts.left)||J.isElement(opts.left))this.left=opts.left;else if(void 0!==opts.left)throw new TypeError("ChoiceTable.init: opts.left must be string, number, an HTML Element or undefined. Found: "+opts.left);if("string"==typeof opts.right||"number"==typeof opts.right)this.right=""+opts.right;else if(J.isNode(opts.right)||J.isElement(opts.right))this.right=opts.right;else if(void 0!==opts.right)throw new TypeError("ChoiceTable.init: opts.right must be string, number, an HTML Element or undefined. Found: "+opts.right);if(void 0===opts.className)this.className=ChoiceTable.className;else if(!1===opts.className)this.className=!1;else if("string"==typeof opts.className)this.className=ChoiceTable.className+" "+opts.className;else{if(!J.isArray(opts.className))throw new TypeError("ChoiceTable.init: opts.className must be string, array, or undefined. Found: "+opts.className);this.className=[ChoiceTable.className].concat(opts.className)}if(!1!==opts.tabbable&&(this.tabbable=!0),"function"==typeof opts.renderer)this.renderer=opts.renderer;else if(void 0!==opts.renderer)throw new TypeError("ChoiceTable.init: opts.renderer must be function or undefined. Found: "+opts.renderer);if("object"==typeof opts.table)this.table=opts.table;else if(void 0!==opts.table&&!1!==opts.table)throw new TypeError("ChoiceTable.init: opts.table must be object, false or undefined. Found: "+opts.table);if(this.table=opts.table,this.freeText="string"==typeof opts.freeText?opts.freeText:!!opts.freeText,void 0!==opts.choicesSetSize){if(!J.isInt(opts.choicesSetSize,0))throw new Error("ChoiceTable.init: choicesSetSize must be undefined or an integer > 0. Found: "+opts.choicesSetSize);if(this.left||this.right)throw new Error("ChoiceTable.init: choicesSetSize option cannot be specified when either left or right options are set.");this.choicesSetSize=opts.choicesSetSize}if(void 0!==opts.choices&&this.setChoices(opts.choices),void 0!==opts.correctChoice){if(this.requiredChoice)throw new Error("ChoiceTable.init: cannot specify both opts requiredChoice and correctChoice");this.setCorrectChoice(opts.correctChoice)}if(void 0!==opts.disabledChoices){if(!J.isArray(opts.disabledChoices))throw new Error("ChoiceTable.init: disabledChoices must be undefined or array. Found: "+opts.disabledChoices);(tmp=opts.disabledChoices.length)&&function(){for(var i=0;i<tmp;i++)that.disableChoice(opts.disabledChoices[i])}()}void 0===opts.sameWidthCells&&(this.sameWidthCells=!!opts.sameWidthCells)},ChoiceTable.prototype.disableChoice=function(value){this.disabledChoices[value]=!0},ChoiceTable.prototype.enableChoice=function(value){this.disabledChoices[value]=null},ChoiceTable.prototype.setChoices=function(choices){var len;if(!J.isArray(choices))throw new TypeError("ChoiceTable.setChoices: choices must be array");if(!choices.length)throw new Error("ChoiceTable.setChoices: choices array is empty");this.choices=choices,len=choices.length,this.order=J.seq(0,len-1),this.shuffleChoices&&(this.order=J.shuffle(this.order)),this.table?this.buildTableAndChoices():this.buildChoices()},ChoiceTable.prototype.buildChoices=function(){var i,len;for(i=-1,len=this.choices.length,this.choicesCells=new Array(len);++i<len;)this.renderChoice(this.choices[this.order[i]],i);this.left&&this.renderSpecial("left",this.left),this.right&&this.renderSpecial("right",this.right)},ChoiceTable.prototype.buildTable=function(){function makeSet(i,len,H,doSets){var tr,counter;for(counter=0,H&&(tr=createTR(this),this.leftCell&&tr.appendChild(this.leftCell));++i<len&&(H||(tr=createTR(this),0===i&&this.leftCell&&(tr.appendChild(this.leftCell),tr=createTR(this))),tr.appendChild(this.choicesCells[i]),!(doSets&&++counter>=this.choicesSetSize)););this.rightCell&&(H||(tr=createTR(this)),tr.appendChild(this.rightCell)),i!==len&&makeSet.call(this,i,len,H,doSets)}return function(){var len,H,doSets;if(!this.choicesCells)throw new Error("ChoiceTable.buildTable: choices not set, cannot build table. Id: "+this.id);H="H"===this.orientation,len=this.choicesCells.length,doSets="number"==typeof this.choicesSetSize,makeSet.call(this,-1,len,H,doSets),this.enable()}}(),ChoiceTable.prototype.buildTableAndChoices=function(){var i,len,tr,td,H;for(len=this.choices.length,this.choicesCells=new Array(len),i=-1,(H="H"===this.orientation)&&(tr=createTR(this),this.left&&(td=this.renderSpecial("left",this.left),tr.appendChild(td)));++i<len;)H||(tr=createTR(this),0===i&&this.left&&(td=this.renderSpecial("left",this.left),tr.appendChild(td),tr=createTR(this))),td=this.renderChoice(this.choices[this.order[i]],i),tr.appendChild(td);this.right&&(H||(tr=createTR(this)),td=this.renderSpecial("right",this.right),tr.appendChild(td)),this.enable()},ChoiceTable.prototype.renderSpecial=function(type,special){var td,className;if(td=document.createElement("td"),"string"==typeof special?td.innerHTML=special:td.appendChild(special),"left"===type)className=this.className?this.className+"-left":"left",this.leftCell=td;else{if("right"!==type)throw new Error("ChoiceTable.renderSpecial: unknown type: "+type);className=this.className?this.className+"-right":"right",this.rightCell=td}return td.className=className,td.id=this.id+this.separator+"special-cell-"+type,td},ChoiceTable.prototype.renderChoice=function(choice,idx){var td,value,width;if(td=document.createElement("td"),this.tabbable&&J.makeTabbable(td),this.sameWidthCells&&"H"===this.orientation&&(width=this.left?70:100,this.right&&(width-=30),width/=this.choicesSetSize||this.choices.length,td.style.width=width.toFixed(2)+"%"),this.renderer)void 0===(value=this.renderer(td,choice,idx))&&(value=idx);else if(J.isArray(choice)?(choice[0],choice=choice[1]):"object"==typeof choice&&(choice.value,choice=choice.display),value=this.shuffleChoices?this.order[idx]:idx,"string"==typeof choice||"number"==typeof choice)td.innerHTML=choice;else if(J.isElement(choice)||J.isNode(choice))td.appendChild(choice);else{if(!node.widgets.isWidget(choice))throw new Error("ChoiceTable.renderChoice: invalid choice: "+choice);node.widgets.append(choice,td)}if(void 0!==this.choicesValues[value])throw new Error("ChoiceTable.renderChoice: value already in use: "+value);return td.id&&""!==td.id||(td.id=this.id+this.separator+value),this.choicesValues[value]=idx,this.choicesCells[idx]=td,this.choicesIds[td.id]=td,td},ChoiceTable.prototype.setCorrectChoice=function(choice){var i,len;if(this.selectMultiple){if(!J.isArray(choice)||!choice.length)throw new TypeError("ChoiceTable.setCorrectChoice: choice must be non-empty array. Found: "+choice);for(i=-1,len=choice.length;++i<len;)choice[i]=checkCorrectChoiceParam(this,choice[i])}else choice=checkCorrectChoiceParam(this,choice);this.correctChoice=choice},ChoiceTable.prototype.append=function(){var tmp;if(W.getElementById(this.id))throw new Error("ChoiceTable.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=W.append("span",this.bodyDiv,{className:"choicetable-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.spanMainText||this.bodyDiv,{className:"choicetable-hint",innerHTML:this.hint}),!1!==this.table&&(void 0===this.table&&(this.table=document.createElement("table"),this.buildTable()),this.table.id=this.id,tmp=this.className?[this.className]:[],"H"!==this.orientation&&tmp.push("choicetable-vertical"),tmp.length?J.addClass(this.table,tmp):this.table.className="",this.bodyDiv.appendChild(this.table)),this.errorBox=W.append("div",this.bodyDiv,{className:"errbox"}),this.freeText&&(this.textarea=document.createElement("textarea"),this.id&&(this.textarea.id=this.id+"_text"),"string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),tmp=this.className?this.className+"-freetext":"freetext",this.textarea.className=tmp,this.bodyDiv.appendChild(this.textarea))},ChoiceTable.prototype.setError=function(err){this.errorBox&&(this.errorBox.innerHTML=err||""),err?this.highlight():this.unhighlight()},ChoiceTable.prototype.listeners=function(){var that=this;node.on("INPUT_DISABLE",(function(){that.disable()})),node.on("INPUT_ENABLE",(function(){that.enable()}))},ChoiceTable.prototype.disable=function(){!0!==this.disabled&&(this.disabled=!0,this.table&&(J.removeClass(this.table,"clickable"),this.table.removeEventListener("click",this.listener),this.tabbable&&J.makeClickable(this.table,!1)),this.emit("disabled"))},ChoiceTable.prototype.enable=function(){if(!1!==this.disabled){if(!this.table)throw new Error("ChoiceTable.enable: table not defined");this.disabled=!1,J.addClass(this.table,"clickable"),this.table.addEventListener("click",this.listener),this.tabbable&&J.makeClickable(this.table),this.emit("enabled")}},ChoiceTable.prototype.verifyChoice=function(markAttempt){var i,len,j,lenJ,c,clone,found,correctChoice;if(null!==this.requiredChoice)return this.selectMultiple?this.currentChoice.length>=this.requiredChoice:null!==this.currentChoice;if(void 0===this.correctChoice)return null;if((markAttempt=void 0===markAttempt||markAttempt)&&this.attempts.push(this.currentChoice),this.selectMultiple){if((len=(correctChoice=J.isArray(this.correctChoice)?this.correctChoice:[this.correctChoice]).length)!==(lenJ=this.currentChoice.length))return!1;for(i=-1,clone=this.currentChoice.slice(0);++i<len;){for(found=!1,c=correctChoice[i],j=-1;++j<lenJ;)if(clone[j]===c){found=!0;break}if(!found)return!1}return!0}return this.currentChoice===this.correctChoice},ChoiceTable.prototype.setCurrentChoice=function(choice){this.selectMultiple?this.currentChoice.push(choice):this.currentChoice=choice},ChoiceTable.prototype.unsetCurrentChoice=function(choice){var i,len;if(this.selectMultiple&&void 0!==choice){if("string"!=typeof choice&&"number"!=typeof choice)throw new TypeError("ChoiceTable.unsetCurrentChoice: choice must be string, number or undefined. Found: "+choice);for(i=-1,len=this.currentChoice.length;++i<len;)if(this.currentChoice[i]===choice){this.currentChoice.splice(i,1);break}}else this.currentChoice=null},ChoiceTable.prototype.isChoiceCurrent=function(choice){var i,len;if("string"==typeof choice)choice=parseInt(choice,10);else if("number"!=typeof choice)throw new TypeError("ChoiceTable.isChoiceCurrent: choice must be string or number. Found: "+choice);if(!this.selectMultiple)return this.currentChoice===choice;for(i=-1,len=this.currentChoice.length;++i<len;)if(this.currentChoice[i]===choice)return!0;return!1},ChoiceTable.prototype.getChoiceAtPosition=function(i){if(this.choices&&this.order)return this.choices[this.order[parseInt(i,10)]]},ChoiceTable.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("ChoiceTable.highlight: border must be string or undefined. Found: "+border);this.table&&!this.highlighted&&(this.table.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},ChoiceTable.prototype.unhighlight=function(){this.table&&!0===this.highlighted&&(this.table.style.border="",this.highlighted=!1,this.setError(),this.emit("unhighlighted"))},ChoiceTable.prototype.getValues=function(opts){var obj,resetOpts,i,len;if(opts=opts||{},obj={id:this.id,choice:opts.reset?this.currentChoice:J.clone(this.currentChoice),time:this.timeCurrentChoice,nClicks:this.numberOfClicks},void 0===opts.highlight&&(opts.highlight=!0),opts.processChoice&&(obj.choice=opts.processChoice.call(this,obj.choice)),this.shuffleChoices&&(obj.order=this.order),!1!==opts.addValue&&!1!==opts.getValue)if(this.selectMultiple)if(len=obj.choice.length,obj.value=new Array(len),1===len)obj.value[0]=getValueFromChoice(this.choices[obj.choice[0]]);else{for(i=-1;++i<len;)obj.value[i]=getValueFromChoice(this.choices[obj.choice[i]]);!1!==opts.sortValue&&obj.value.sort()}else obj.value=getValueFromChoice(this.choices[obj.choice]);return(0===this.group||this.group)&&(obj.group=this.group),(0===this.groupOrder||this.groupOrder)&&(obj.groupOrder=this.groupOrder),null===this.correctChoice&&null===this.requiredChoice||(obj.isCorrect=this.verifyChoice(opts.markAttempt),obj.attempts=this.attempts,!obj.isCorrect&&opts.highlight&&this.highlight()),this.textarea&&(obj.freetext=this.textarea.value),!1===obj.isCorrect?this.setError(this.getText("error",obj.value)):opts.reset&&(resetOpts="object"!=typeof opts.reset?{}:opts.reset,this.reset(resetOpts)),obj},ChoiceTable.prototype.setValues=function(options){var choice,correctChoice,tmp,i,len,j,lenJ;if(!this.choices||!this.choices.length)throw new Error("ChoiceTable.setValues: no choices found.");if(options=options||{},!this.choicesCells||!this.choicesCells.length)throw new Error("Choicetable.setValues: table was not built yet.");if(options.correct&&null!==this.correctChoice)for(i=-1,len=(correctChoice=J.isArray(this.correctChoice)?this.correctChoice:[this.correctChoice]).length;++i<len;){if(choice=parseInt(correctChoice[i],10),this.shuffleChoices)for(j=-1,lenJ=this.order.length;++j<lenJ;)if(this.order[j]===choice){choice=j;break}this.choicesCells[choice].click()}else{if(i=-1,void 0!==options.values){if(J.isArray(options.values)||(tmp=[options.values]),len=tmp.length,this.selectMultiple){if(len>(tmp="number"==typeof this.selectMultiple?this.selectMultiple:this.choices.length))throw new Error("ChoiceTable.setValues: values array cannot be larger than max allowed set: "+len+" > "+tmp);tmp=options.values}for(;++i<len;){if(!1===(choice=J.isInt(tmp[i],-1,this.choices.length-1,1,1)))throw new Error("ChoiceTable.setValues: invalid choice value. Found: "+tmp[i]);this.choicesCells[choice].click()}}else for(len=1,this.selectMultiple&&(len="number"==typeof this.selectMultiple?this.selectMultiple:this.choicesCells.length,tmp=this.requiredChoice,len=J.randomInt("number"==typeof tmp?tmp-1:0,len));++i<len;)choice=J.randomInt(-1,this.choicesCells.length-1),this.disabledChoices[choice]||this.isChoiceCurrent(choice)?len<300&&len++:(j=this.choicesValues[choice],this.choicesCells[j].click());this.textarea&&(this.textarea.value=J.randomString(100,"!Aa0"))}},ChoiceTable.prototype.reset=function(options){var i,len;if(options=options||{},this.attempts=[],this.numberOfClicks=0,this.timeCurrentChoice=null,this.selectMultiple){for(i=-1,len=this.selected.length;++i<len;)J.removeClass(this.selected[i],"selected");this.selected=[],this.currentChoice=[]}else this.selected&&(J.removeClass(this.selected,"selected"),this.selected=null,this.currentChoice=null);this.textarea&&(this.textarea.value=""),this.isHighlighted()&&this.unhighlight(),options.shuffleChoices&&this.shuffle()},ChoiceTable.prototype.shuffle=function(){var order,H,i,len,cell,choice,choicesValues,choicesCells,parentTR;for(H="H"===this.orientation,i=-1,len=(order=J.shuffle(this.order)).length,choicesValues={},choicesCells=new Array(len);++i<len;)choice=order[i],cell=this.choicesCells[this.choicesValues[choice]],choicesCells[i]=cell,choicesValues[choice]=i,H?this.trs[0].appendChild(cell):(parentTR=cell.parentElement||cell.parentNode,this.table.appendChild(parentTR));this.rightCell&&(H?this.trs[0].appendChild(this.rightCell):(parentTR=this.rightCell.parentElement||this.rightCell.parentNode,this.table.appendChild(parentTR))),this.order=order,this.choicesCells=choicesCells,this.choicesValues=choicesValues}}(node),function(node){"use strict";function ChoiceTableGroup(){var that;that=this,this.table=null,this.trs=[],this.listener=function(e){var name,value,item,td,oldSelected,time,removed;time="string"==typeof that.timeFrom?node.timer.getTimeSince(that.timeFrom):Date.now?Date.now():(new Date).getTime(),td=(e=e||window.event).target||e.srcElement,(void 0!==that.choicesById[td.id]||(td=td.parentNode)&&void 0!==that.choicesById[td.id])&&1!==(value=td.id.split(that.separator)).length&&(name=value[0],value=value[1],(item=that.itemsById[name])&&(item.timeCurrentChoice=time,item.numberOfClicks++,item.selectMultiple||((oldSelected=item.selected)&&J.removeClass(oldSelected,"selected"),item.isChoiceCurrent(value)?(item.unsetCurrentChoice(value),removed=!0):(item.currentChoice=value,J.addClass(td,"selected"),item.selected=td)),that.isHighlighted()&&that.unhighlight(),that.onclick&&(value=parseInt(value,10),that.onclick.call(that,name,value,removed,td))))},this.onclick=null,this.mainText=null,this.spanMainText=null,this.hint=null,this.errorBox=null,this.items=null,this.itemsById={},this.itemsMap={},this.choices=null,this.choicesById={},this.itemsSettings=null,this.order=null,this.originalOrder=null,this.shuffleItems=null,this.requiredChoice=null,this.orientation="H",this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null,this.header=null,this.timeFrom="step",this.selectMultiple=null,this.renderer=null,this.separator=ChoiceTableGroup.separator,this.shuffleChoices=null,this.tabbable=null}function getChoiceTable(that,i){var ct,s,idx;if(idx=that.order[i],s=function(that,s,i){if("string"==typeof s)s={id:s};else if(J.isArray(s))s={id:s[0],left:s[1]};else if("object"!=typeof s)throw new TypeError("ChoiceTableGroup.buildTable: item must be string or object. Found: "+s);return s.group=that.id,s.groupOrder=i+1,s.orientation=that.orientation,s.title=!1,s.listeners=!1,s.separator=that.separator,void 0===s.choices&&that.choices&&(s.choices=that.choices),!s.renderer&&that.renderer&&(s.renderer=that.renderer),void 0===s.requiredChoice&&that.requiredChoice&&(s.requiredChoice=that.requiredChoice),void 0===s.selectMultiple&&null!==that.selectMultiple&&(s.selectMultiple=that.selectMultiple),void 0===s.shuffleChoices&&that.shuffleChoices&&(s.shuffleChoices=that.shuffleChoices),void 0===s.timeFrom&&(s.timeFrom=that.timeFrom),void 0===s.left&&(s.left=s.id),s.storeRef=!1,s}(that,that.itemsSettings[idx],i),ct=node.widgets.get("ChoiceTable",s),that.itemsById[ct.id])throw new Error("ChoiceTableGroup.buildTable: an item with the same id already exists: "+ct.id);if(!ct.leftCell)throw new Error("ChoiceTableGroup.buildTable: item is missing a left cell: "+s.id);return that.itemsById[ct.id]=ct,that.items[idx]=ct,that.itemsMap[ct.id]=idx,ct}function createTR(that,trid){var tr,sep;return tr=document.createElement("tr"),that.table.appendChild(tr),sep=that.separator,tr.id=that.id+sep+"tr"+sep+trid,that.trs.push(tr),tr}node.widgets.register("ChoiceTableGroup",ChoiceTableGroup),ChoiceTableGroup.version="1.8.0",ChoiceTableGroup.description="Groups together and manages sets of ChoiceTable widgets.",ChoiceTableGroup.title="Make your choice",ChoiceTableGroup.className="choicetable choicetablegroup",ChoiceTableGroup.separator="::",ChoiceTableGroup.texts={autoHint:function(w){return!!w.requiredChoice&&"*"},error:"Selection required."},ChoiceTableGroup.dependencies={JSUS:{}},ChoiceTableGroup.prototype.init=function(opts){var tmp;if(!this.id)throw new TypeError("ChoiceTableGroup.init: id is missing.");if(void 0===opts.orientation)tmp="H";else{if("string"!=typeof opts.orientation)throw new TypeError("ChoiceTableGroup.init: orientation must be string, or undefined. Found: "+opts.orientation);if("horizontal"===(tmp=opts.orientation.toLowerCase().trim())||"h"===tmp)tmp="H";else{if("vertical"!==tmp&&"v"!==tmp)throw new Error("ChoiceTableGroup.init: orientation is invalid: "+tmp);tmp="V"}}if(this.orientation=tmp,tmp=void 0!==opts.shuffleItems&&!!opts.shuffleItems,this.shuffleItems=tmp,"number"==typeof opts.requiredChoice)this.requiredChoice=opts.requiredChoice;else if("boolean"==typeof opts.requiredChoice)this.requiredChoice=opts.requiredChoice?1:0;else if(void 0!==opts.requiredChoice)throw new TypeError("ChoiceTableGroup.init: opts.requiredChoice be number or boolean or undefined. Found: "+opts.requiredChoice);if("string"==typeof opts.group||"number"==typeof opts.group)this.group=opts.group;else if(void 0!==opts.group)throw new TypeError("ChoiceTableGroup.init: group must be string, number or undefined. Found: "+opts.group);if("number"==typeof opts.groupOrder)this.groupOrder=opts.groupOrder;else if(void 0!==opts.group)throw new TypeError("ChoiceTableGroup.init: groupOrder must be number or undefined. Found: "+opts.groupOrder);if("function"==typeof opts.listener)this.listener=function(e){opts.listener.call(this,e)};else if(void 0!==opts.listener)throw new TypeError("ChoiceTableGroup.init: listener must be function or undefined. Found: "+opts.listener);if("function"==typeof opts.onclick)this.onclick=opts.onclick;else if(void 0!==opts.onclick)throw new TypeError("ChoiceTableGroup.init: onclick must be function or undefined. Found: "+opts.onclick);if("string"==typeof opts.mainText)this.mainText=opts.mainText;else if(void 0!==opts.mainText)throw new TypeError("ChoiceTableGroup.init: mainText must be string or undefined. Found: "+opts.mainText);if("string"==typeof opts.hint||!1===opts.hint)this.hint=opts.hint;else{if(void 0!==opts.hint)throw new TypeError("ChoiceTableGroup.init: hint must be a string, false, or undefined. Found: "+opts.hint);this.hint=this.getText("autoHint")}if(!1===opts.timeFrom||"string"==typeof opts.timeFrom)this.timeFrom=opts.timeFrom;else if(void 0!==opts.timeFrom)throw new TypeError("ChoiceTableGroup.init: timeFrom must be string, false, or undefined. Found: "+opts.timeFrom);if(void 0!==opts.shuffleChoices&&(this.shuffleChoices=!!opts.shuffleChoices),"function"==typeof opts.renderer)this.renderer=opts.renderer;else if(void 0!==opts.renderer)throw new TypeError("ChoiceTableGroup.init: renderer must be function or undefined. Found: "+opts.renderer);if(void 0!==opts.choices&&(this.choices=opts.choices),void 0===opts.className)this.className=ChoiceTableGroup.className;else{if(!1!==opts.className&&"string"!=typeof opts.className&&!J.isArray(opts.className))throw new TypeError("ChoiceTableGroup.init: className must be string, array, or undefined. Found: "+opts.className);this.className=opts.className}if(!1!==opts.tabbable&&(this.tabbable=!0),opts.separator&&(this.separator=opts.separator),"object"==typeof opts.table)this.table=opts.table;else if(void 0!==opts.table&&!1!==opts.table)throw new TypeError("ChoiceTableGroup.init: table must be object, false or undefined. Found: "+opts.table);if(this.table=opts.table,this.freeText="string"==typeof opts.freeText?opts.freeText:!!opts.freeText,opts.header){if(!J.isArray(opts.header)||opts.header.length!==opts.choices.length)throw new Error("ChoiceTableGroup.init: header must be an array of length "+opts.choices.length+" or undefined. Found: "+opts.header);this.header=opts.header}void 0!==opts.items&&this.setItems(opts.items)},ChoiceTableGroup.prototype.setItems=function(items){var len;if(!J.isArray(items))throw new TypeError("ChoiceTableGroup.setItems: items must be array. Found: "+items);if(!items.length)throw new Error("ChoiceTableGroup.setItems: items is an empty array.");len=items.length,this.itemsSettings=items,this.items=new Array(len),this.order=J.seq(0,len-1),this.shuffleItems&&(this.order=J.shuffle(this.order)),this.originalOrder=this.order,this.table&&this.buildTable()},ChoiceTableGroup.prototype.buildTable=function(){var i,len,tr,H,ct,j,lenJ,lenJOld,hasRight,cell;if(H="H"===this.orientation,i=-1,len=this.itemsSettings.length,H){if(this.header){for(tr=W.add("tr",this.table),W.add("td",tr,{className:"header"});++i<this.header.length;)W.add("td",tr,{innerHTML:this.header[i],className:"header"});i=-1}for(;++i<len;){if((tr=createTR(this,(ct=getChoiceTable(this,i)).id)).appendChild(ct.leftCell),j=-1,lenJ=ct.choicesCells.length,0===i)lenJOld=lenJ;else if(lenJ!==lenJOld)throw new Error("ChoiceTableGroup.buildTable: item do not have same number of choices: "+ct.id);for(;++j<lenJ;)cell=ct.choicesCells[j],tr.appendChild(cell),this.choicesById[cell.id]=cell;ct.rightCell&&tr.appendChild(ct.rightCell)}}else{for(tr=createTR(this,"header");++i<len;){if(lenJ=(ct=getChoiceTable(this,i)).choicesCells.length,0===i)lenJOld=lenJ;else if(lenJ!==lenJOld)throw new Error("ChoiceTableGroup.buildTable: item do not have same number of choices: "+ct.id);if(void 0===hasRight)hasRight=!!ct.rightCell;else if(!ct.rightCell&&hasRight||ct.rightCell&&!hasRight)throw new Error("ChoiceTableGroup.buildTable: either all items or no item must have the right cell: "+ct.id);tr.appendChild(ct.leftCell)}for(hasRight&&lenJ++,j=-1;++j<lenJ;)for(tr=createTR(this,"row"+(j+1)),i=-1;++i<len;)hasRight&&j===lenJ-1?tr.appendChild(this.items[i].rightCell):(cell=this.items[i].choicesCells[j],tr.appendChild(cell),this.choicesById[cell.id]=cell)}this.enable(!0)},ChoiceTableGroup.prototype.append=function(){if(W.getElementById(this.id))throw new Error("ChoiceTableGroup.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=W.append("span",this.bodyDiv,{className:"choicetable-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.spanMainText||this.bodyDiv,{className:"choicetable-hint",innerHTML:this.hint}),!1!==this.table&&(void 0===this.table&&(this.table=document.createElement("table"),this.items&&this.buildTable()),this.table.id=this.id,this.className?J.addClass(this.table,this.className):this.table.className="",this.bodyDiv.appendChild(this.table)),this.errorBox=W.append("div",this.bodyDiv,{className:"errbox"}),this.freeText&&(this.textarea=document.createElement("textarea"),this.id&&(this.textarea.id=this.id+"_text"),this.textarea.className=ChoiceTableGroup.className+"-freetext","string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),this.bodyDiv.appendChild(this.textarea))},ChoiceTableGroup.prototype.listeners=function(){var that=this;node.on("INPUT_DISABLE",(function(){that.disable()})),node.on("INPUT_ENABLE",(function(){that.enable()}))},ChoiceTableGroup.prototype.disable=function(){!0!==this.disabled&&this.table&&(this.disabled=!0,J.removeClass(this.table,"clickable"),this.table.removeEventListener("click",this.listener),this.tabbable&&J.makeClickable(this.table,!1),this.emit("disabled"))},ChoiceTableGroup.prototype.enable=function(force){this.table&&(force||this.disabled)&&(this.disabled=!1,J.addClass(this.table,"clickable"),this.table.addEventListener("click",this.listener),this.tabbable&&J.makeClickable(this.table),this.emit("enabled"))},ChoiceTableGroup.prototype.verifyChoice=function(markAttempt){var i,len,out;for(out={},markAttempt=void 0===markAttempt||markAttempt,i=-1,len=this.items.length;++i<len;)out[this.items[i].id]=this.items[i].verifyChoice(markAttempt);return out},ChoiceTableGroup.prototype.setCurrentChoice=function(choice){var i,len;for(i=-1,len=this.items[i].length;++i<len;)this.items[i].setCurrentChoice(choice)},ChoiceTableGroup.prototype.unsetCurrentChoice=function(choice){var i,len;for(i=-1,len=this.items.length;++i<len;)this.items[i].unsetCurrentChoice(choice)},ChoiceTableGroup.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("ChoiceTableGroup.highlight: border must be string or undefined. Found: "+border);this.table&&!0!==this.highlighted&&(this.table.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},ChoiceTableGroup.prototype.unhighlight=function(){this.table&&!0===this.highlighted&&(this.table.style.border="",this.highlighted=!1,this.setError(),this.emit("unhighlighted"))},ChoiceTableGroup.prototype.getValues=function(opts){var obj,i,len,tbl,toHighlight,toReset;for(obj={id:this.id,order:this.order,items:{},isCorrect:!0},void 0===(opts=opts||{}).highlight&&(opts.highlight=!0),toReset=opts.reset,opts.reset=!1,i=-1,len=this.items.length;++i<len;)tbl=this.items[i],obj.items[tbl.id]=tbl.getValues(opts),null===obj.items[tbl.id].choice&&(obj.missValues=!0,tbl.requiredChoice&&(toHighlight=!0,obj.isCorrect=!1)),!1===obj.items[tbl.id].isCorrect&&opts.highlight&&(toHighlight=!0);return opts.highlight&&toHighlight?this.setError(this.getText("error")):toReset&&this.reset(toReset),opts.reset=toReset,this.textarea&&(obj.freetext=this.textarea.value),obj},ChoiceTableGroup.prototype.setError=function(err){this.errorBox.innerHTML=err||"",err?this.highlight():this.unhighlight()},ChoiceTableGroup.prototype.setValues=function(opts){var i,len;if(!this.items||!this.items.length)throw new Error("ChoiceTableGroup.setValues: no items found.");for(opts=opts||{},i=-1,len=this.items.length;++i<len;)this.items[i].setValues(opts);this.textarea&&(this.textarea.value=J.randomString(100,"!Aa0"))},ChoiceTableGroup.prototype.reset=function(opts){var i,len;for(opts=opts||{},i=-1,len=this.items.length;++i<len;)this.items[i].reset(opts);this.textarea&&(this.textarea.value=""),opts.shuffleItems&&this.shuffle(),this.isHighlighted()&&this.unhighlight()},ChoiceTableGroup.prototype.shuffle=function(opts){var order,i,len,that,cb,newOrder;if(this.items&&(len=this.items.length)){if(that=this,newOrder=new Array(len),cb=function(el,newPos,oldPos){var i;i=el.id.split(that.separator),i="H"===that.orientation?i[2]:i[0],i=that.itemsMap[i],that.items[i].groupOrder=newPos+1,newOrder[newPos]=i},order=J.shuffle(this.order),"H"===this.orientation)J.shuffleElements(this.table,order,cb);else for(len=this.trs.length,i=-1;++i<len;)J.shuffleElements(this.trs[i],order,cb),cb=void 0;this.order=newOrder}}}(node),function(node){"use strict";function Consent(){this.consent=null,this.showPrint=null}node.widgets.register("Consent",Consent),Consent.version="0.3.0",Consent.description="Displays a configurable consent form.",Consent.title=!1,Consent.panel=!1,Consent.className="consent",Consent.texts={areYouSure:"You did not consent and are about to leave the study. Are you sure?",printText:"<br/><p>If you need a copy of this consent form, you may print a copy of this page for your records.</p>",printBtn:"Print this page",consentTerms:"Do you understand and consent to these terms?",agree:"Yes, I agree",notAgree:"No, I do not agree",showHideConsent:function(w,s){return("hide"===s?"Hide":"Show")+" Consent Form"}},Consent.prototype.init=function(opts){if(opts=opts||{},this.consent=opts.consent||node.game.settings.CONSENT,this.consent&&"object"!=typeof this.consent)throw new TypeError("Consent: consent must be object or undefined. Found: "+this.consent);this.showPrint=!1!==opts.showPrint},Consent.prototype.enable=function(){var a,na;this.notAgreed||((a=W.gid("agree"))&&(a.disabled=!1),(na=W.gid("notAgree"))&&(na.disabled=!1))},Consent.prototype.disable=function(){var a,na;this.notAgreed||((a=W.gid("agree"))&&(a.disabled=!0),(na=W.gid("notAgree"))&&(na.disabled=!0))},Consent.prototype.append=function(){var consent,html;W.hide("notAgreed"),consent=W.gid("consent"),html="",this.showPrint&&(html=this.getText("printText"),html+='<input class="btn" type="button" value="'+this.getText("printBtn")+'" onclick="window.print()" /><br/><br/>'),html+="<strong>"+this.getText("consentTerms")+"</strong><br/>",html+='<div style="margin-top: 20px;"><button class="btn btn-lg btn-info" id="agree" style="margin-right: 30px">'+this.getText("agree")+'</button><button class="btn btn-lg btn-danger" id="notAgree">'+this.getText("notAgree")+"</button></div>",consent.innerHTML+=html,setTimeout((function(){W.adjustFrameHeight()}))},Consent.prototype.listeners=function(){var that=this,consent=this.consent;node.on("FRAME_LOADED",(function(){var a,na,p,id;if(consent)for(p in consent)consent.hasOwnProperty(p)&&(id=(id=p.toLowerCase()).replace(new RegExp("_","g"),"-"),W.setInnerHTML(id,consent[p]));if(a=W.gid("agree"),na=W.gid("notAgree"),!a)throw new Error("Consent: agree button not found");if(!na)throw new Error("Consent: notAgree button not found");a.onclick=function(){node.done({consent:!0})},na.onclick=function(){var showIt;confirm(that.getText("areYouSure"))&&(node.emit("CONSENT_REJECTING"),that.notAgreed=!0,node.set({consent:!1,time:node.timer.getTimeSince("step"),timeup:!1}),a.disabled=!0,na.disabled=!0,a.onclick=null,na.onclick=null,node.socket.disconnect(),W.hide("consent"),W.show("notAgreed"),(showIt=W.gid("show-consent"))&&(showIt.onclick=function(){var s;s=""===W.toggle("consent").style.display?"hide":"show",this.innerHTML=that.getText("showHideConsent",s)}),node.emit("CONSENT_REJECTED"))}}))}}(node),function(node){"use strict";function ContentBox(){this.mainText=null,this.content=null,this.hint=null}node.widgets.register("ContentBox",ContentBox),ContentBox.version="0.2.0",ContentBox.description="Simply displays some content",ContentBox.title=!1,ContentBox.panel=!1,ContentBox.className="contentbox",ContentBox.dependencies={},ContentBox.prototype.init=function(opts){if("string"==typeof opts.mainText)this.mainText=opts.mainText;else if(void 0!==opts.mainText)throw new TypeError("ContentBox.init: mainText must be string or undefined. Found: "+opts.mainText);if("string"==typeof opts.content)this.content=opts.content;else if(void 0!==opts.content)throw new TypeError("ContentBox.init: content must be string or undefined. Found: "+opts.content);if("string"==typeof opts.hint)this.hint=opts.hint;else if(void 0!==opts.hint)throw new TypeError("ContentBox.init: hint must be string or undefined. Found: "+opts.hint)},ContentBox.prototype.append=function(){this.mainText&&W.append("span",this.bodyDiv,{className:"contentbox-maintext",innerHTML:this.mainText}),this.content&&W.append("div",this.bodyDiv,{className:"contentbox-content",innerHTML:this.content}),this.hint&&W.append("span",this.bodyDiv,{className:"contentbox-hint",innerHTML:this.hint})}}(node),function(node){"use strict";function Controls(options){this.options=options,this.listRoot=null,this.submit=null,this.changeEvent="Controls_change",this.hasChanged=!1}function SliderControls(options){Controls.call(this,options)}function jQuerySliderControls(options){Controls.call(this,options)}function RadioControls(options){Controls.call(this,options),this.groupName=void 0!==options.name?options.name:W.generateUniqueId(),this.radioElem=null}node.widgets.register("Controls",Controls),Controls.version="0.5.1",Controls.description="Wraps a collection of user-inputs controls.",Controls.title="Controls",Controls.className="controls",Controls.prototype.add=function(root,id,attributes){},Controls.prototype.getItem=function(id,attributes){},Controls.prototype.init=function(options){this.hasChanged=!1,void 0!==options.change&&(options.change?this.changeEvent=options.change:this.changeEvent=!1),this.list=new W.List(options),this.listRoot=this.list.getRoot(),options.features&&(this.features=options.features,this.populate())},Controls.prototype.append=function(){var that=this,idButton="submit_Controls";this.list.parse(),this.bodyDiv.appendChild(this.listRoot),this.options.submit&&(this.options.submit.id&&(idButton=this.options.submit.id,this.option.submit=this.option.submit.name),this.submit=W.add("button",this.bodyDiv,J.merge(this.options.attributes,{id:idButton,innerHTML:this.options.submit})),this.submit.onclick=function(){that.options.change&&node.emit(that.options.change)})},Controls.prototype.parse=function(){return this.list.parse()},Controls.prototype.populate=function(){var key,id,attributes,container,elem,that=this;for(key in this.features)this.features.hasOwnProperty(key)&&(id=key,(attributes=this.features[key]).id&&(id=attributes.id,delete attributes.id),container=document.createElement("div"),elem=this.add(container,id,attributes),this.changeEvent&&(elem.onchange=function(){node.emit(that.changeEvent)}),attributes.label&&W.add("label",container,{for:elem.id,innerHTML:attributes.label}),this.list.addDT(container))},Controls.prototype.listeners=function(){var that=this;node.on(this.changeEvent,(function(){that.hasChanged=!0}))},Controls.prototype.refresh=function(){var key,el;for(key in this.features)this.features.hasOwnProperty(key)&&(el=W.getElementById(key))&&(el.value=this.features[key].value);return!0},Controls.prototype.getValues=function(){var out,el,key;for(key in out={},this.features)this.features.hasOwnProperty(key)&&(el=W.getElementById(key))&&(out[key]=Number(el.value));return out},Controls.prototype.highlight=function(code){return W.highlight(this.listRoot,code)},SliderControls.prototype.__proto__=Controls.prototype,SliderControls.prototype.constructor=SliderControls,SliderControls.version="0.2.2",SliderControls.description="Collection of Sliders.",SliderControls.title="Slider Controls",SliderControls.className="slidercontrols",SliderControls.dependencies={Controls:{}},node.widgets.register("SliderControls",SliderControls),SliderControls.prototype.add=function(root,id,attributes){return(attributes=attributes||{}).id=id,attributes.type="range",W.add("input",root,attributes)},SliderControls.prototype.getItem=function(id,attributes){return(attributes=attributes||{}).id=id,W.get("input",attributes)},jQuerySliderControls.prototype.__proto__=Controls.prototype,jQuerySliderControls.prototype.constructor=jQuerySliderControls,jQuerySliderControls.version="0.14",jQuerySliderControls.description="Collection of jQuery Sliders.",jQuerySliderControls.title="jQuery Slider Controls",jQuerySliderControls.className="jqueryslidercontrols",jQuerySliderControls.dependencies={jQuery:{},Controls:{}},node.widgets.register("jQuerySliderControls",jQuerySliderControls),jQuerySliderControls.prototype.add=function(root,id,attributes){return jQuery("<div/>",{id:id}).slider().appendTo(root)[0]},jQuerySliderControls.prototype.getItem=function(id,attributes){return jQuery("<div/>",{id:id}).slider()},RadioControls.prototype.__proto__=Controls.prototype,RadioControls.prototype.constructor=RadioControls,RadioControls.version="0.1.2",RadioControls.description="Collection of Radio Controls.",RadioControls.title="Radio Controls",RadioControls.className="radiocontrols",RadioControls.dependencies={Controls:{}},node.widgets.register("RadioControls",RadioControls),RadioControls.prototype.populate=function(){var key,id,attributes,elem,that;for(key in that=this,this.radioElem||(this.radioElem=document.createElement("radio"),this.radioElem.group=this.name||"radioGroup",this.radioElem.group=this.className||"radioGroup",this.bodyDiv.appendChild(this.radioElem)),this.features)this.features.hasOwnProperty(key)&&(id=key,(attributes=this.features[key]).id&&(id=attributes.id,delete attributes.id),elem=this.add(this.radioElem,id,attributes),this.changeEvent&&(elem.onchange=function(){node.emit(that.changeEvent)}),this.list.addDT(elem))},RadioControls.prototype.add=function(root,id,attributes){var elem;return void 0===attributes.name&&(attributes.name=this.groupName),attributes.id=id,attributes.type="radio",(elem=W.add("input",root,attributes)).appendChild(document.createTextNode(attributes.label)),elem},RadioControls.prototype.getItem=function(id,attributes){return void 0===(attributes=attributes||{}).name&&(attributes.name=this.groupName),attributes.id=id,attributes.type="radio",W.get("input",attributes)},RadioControls.prototype.getValues=function(){var key,el;for(key in this.features)if(this.features.hasOwnProperty(key)&&(el=W.getElementById(key)).checked)return el.value;return!1}}(node),function(node){"use strict";node.widgets.register("CustomInput",CustomInput),CustomInput.version="0.12.0",CustomInput.description="Creates a configurable input form",CustomInput.title=!1,CustomInput.panel=!1,CustomInput.className="custominput",CustomInput.types={text:!0,number:!0,float:!0,int:!0,date:!0,list:!0,us_city_state_zip:!0,us_state:!0,us_zip:!0};var usTerrByAbbr,usStatesByAbbr,usStatesTerr,usStatesTerrByAbbr,usStatesLow,usTerrLow,usTerrByAbbrLow,usStatesByAbbrLow,usStatesTerrLow,usStatesTerrByAbbrLow,sepNames={",":"comma"," ":"space",".":"dot"},usStates={Alabama:"AL",Alaska:"AK",Arizona:"AZ",Arkansas:"AR",California:"CA",Colorado:"CO",Connecticut:"CT",Delaware:"DE",Florida:"FL",Georgia:"GA",Hawaii:"HI",Idaho:"ID",Illinois:"IL",Indiana:"IN",Iowa:"IA",Kansas:"KS",Kentucky:"KY",Louisiana:"LA",Maine:"ME",Maryland:"MD",Massachusetts:"MA",Michigan:"MI",Minnesota:"MN",Mississippi:"MS",Missouri:"MO",Montana:"MT",Nebraska:"NE",Nevada:"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND",Ohio:"OH",Oklahoma:"OK",Oregon:"OR",Pennsylvania:"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD",Tennessee:"TN",Texas:"TX",Utah:"UT",Vermont:"VT",Virginia:"VA",Washington:"WA","West Virginia":"WV",Wisconsin:"WI",Wyoming:"WY"},usTerr={"American Samoa":"AS","District of Columbia":"DC","Federated States of Micronesia":"FM",Guam:"GU","Marshall Islands":"MH","Northern Mariana Islands":"MP",Palau:"PW","Puerto Rico":"PR","Virgin Islands":"VI"};function CustomInput(){this.input=null,this.placeholder=null,this.inputWidth=null,this.type=null,this.preprocess=null,this.validation=null,this.userValidation=null,this.validationSpeed=500,this.postprocess=null,this.oninput=null,this.params={},this.errorBox=null,this.mainText=null,this.hint=null,this.requiredChoice=null,this.required=null,this.timeBegin=null,this.timeEnd=null,this.checkbox=null,this.checkboxText=null,this.checkboxCb=null,this.orientation=null}function getParsedDate(d,p){var res,day;if("string"==typeof d&&!(day=(d="today"===d?new Date:new Date(d)).getDate()))return!1;try{res={day:day||d.getDate(),month:d.getMonth()+1,year:d.getFullYear(),obj:d}}catch(e){return!1}return res.str=(p.dayPos?res.day+p.sep+res.month:res.month+p.sep+res.day)+p.sep,res.str+=2===p.yearDigits?res.year.substring(3,4):res.year,res}function getUsStatesList(s){switch(s){case"usStatesTerrByAbbrLow":return usStatesTerrByAbbrLow||(getUsStatesList("usStatesTerrLow"),usStatesTerrByAbbrLow=J.reverseObj(usStatesTerr,toLK)),usStatesTerrByAbbrLow;case"usStatesTerrByAbbr":return usStatesTerrByAbbr||(getUsStatesList("usStatesTerr"),usStatesTerrByAbbr=J.reverseObj(usStatesTerr)),usStatesTerrByAbbr;case"usTerrByAbbrLow":return usTerrByAbbrLow||(usTerrByAbbrLow=J.reverseObj(usTerr,toLK)),usTerrByAbbrLow;case"usTerrByAbbr":return usTerrByAbbr||(usTerrByAbbr=J.reverseObj(usTerr)),usTerrByAbbr;case"usStatesByAbbrLow":return usStatesByAbbrLow||(usStatesByAbbrLow=J.reverseObj(usStates,toLK)),usStatesByAbbrLow;case"usStatesByAbbr":return usStatesByAbbr||(usStatesByAbbr=J.reverseObj(usStates)),usStatesByAbbr;case"usStatesTerrLow":return usStatesTerrLow||(usStatesLow||(usStatesLow=objToLK(usStates)),usTerrLow||(usTerrLow=objToLK(usTerr)),usStatesTerrLow=J.merge(usStatesLow,usTerrLow)),usStatesTerrLow;case"usStatesTerr":return usStatesTerr||(usStatesTerr=J.merge(usStates,usTerr)),usStatesTerr;case"usStatesLow":return usStatesLow||(usStatesLow=objToLK(usStates)),usStatesLow;case"usStates":return usStates;case"usTerrLow":return usTerrLow||(usTerrLow=objToLK(usTerr)),usTerrLow;case"usTerr":return usTerr;default:throw new Error("getUsStatesList: unknown request: "+s)}}function toLK(key,value){return[key.toLowerCase(),value]}function objToLK(obj){var p,objLow;for(p in objLow={},obj)obj.hasOwnProperty(p)&&(objLow[p.toLowerCase()]=obj[p]);return objLow}function isValidUSZip(z){return 5===z.length&&J.isInt(z,0)}CustomInput.texts={listErr:"Check that there are no empty items; do not end with the separator",listSizeErr:function(w,param){return w.params.fixedSize?w.params.minItems+" items required":"min"===param?"Too few items. Min: "+w.params.minItems:"Too many items. Max: "+w.params.maxItems},usStateAbbrErr:"Not a valid state abbreviation (must be 2 characters)",usStateErr:"Not a valid state (full name required)",usZipErr:"Not a valid ZIP code (must be 5 digits)",autoHint:function(w){var res,sep;return"list"===w.type?res="(if more than one, separate with "+(sep=sepNames[w.params.listSep]||w.params.listSep)+")":"us_state"===w.type?res=w.params.abbr?"(Use 2-letter abbreviation)":"(Type the full name of the state)":"us_zip"===w.type?res="(Use 5-digit ZIP code)":"us_city_state_zip"===w.type?res="(Format: Town"+(sep=w.params.listSep)+" State"+sep+" ZIP code)":"date"===w.type?res=w.params.minDate&&w.params.maxDate?"(Must be between "+w.params.minDate.str+" and "+w.params.maxDate.str+")":w.params.minDate?"(Must be after "+w.params.minDate.str+")":w.params.maxDate?"(Must be before "+w.params.maxDate.str+")":"(Format: "+w.params.format+")":"number"!==w.type&&"int"!==w.type&&"float"!==w.type||(w.params.min&&w.params.max?res="(Must be between "+w.params.min+" and "+w.params.max+")":w.params.min?res="(Must be after "+w.params.min+")":w.params.max&&(res="(Must be before "+w.params.max+")")),w.required?(res||"")+" *":res||!1},numericErr:function(w){var str,p;return(p=w.params).exactly?"Must enter "+p.lower:(str="Must be ","float"===w.type?str+="a floating point number":"int"===w.type&&(str+="an integer"),p.between?(str+=" "+(p.leq?"&ge; ":"<")+p.lower,str+=" and ",str+=(p.ueq?"&le; ":"> ")+p.upper):void 0!==p.lower?str+=" "+(p.leq?"&ge; ":"< ")+p.lower:void 0!==p.upper&&(str+=" "+(p.ueq?"&le; ":"> ")+p.upper),str)},textErr:function(w,param){var str,p;return"num"===param?"Cannot contain numbers":(str="Must be ",(p=w.params).exactly?str+="exactly "+(p.lower+1):p.between?str+="between "+p.lower+" and "+p.upper:void 0!==p.lower?str+=" more than "+(p.lower-1):void 0!==p.upper&&(str+=" less than "+(p.upper+1)),str+=" characters long",p.between&&(str+=" (extremes included)"),str+=". Current length: "+param)},dateErr:function(w,param){return"invalid"===param?"Date is invalid":"min"===param?"Date must be after "+w.params.minDate.str:"max"===param?"Date must be before "+w.params.maxDate.str:"Must follow format "+w.params.format},emptyErr:"Cannot be empty"},CustomInput.dependencies={JSUS:{}},CustomInput.prototype.init=function(opts){var tmp,that,e,isText,setValues,cb;if(that=this,e="CustomInput.init: ",void 0===opts.orientation)tmp="V";else{if("string"!=typeof opts.orientation)throw new TypeError("CustomInput.init: orientation must be string, or undefined. Found: "+opts.orientation);if("h"===(tmp=opts.orientation.toLowerCase().trim()))tmp="H";else{if("v"!==tmp)throw new Error("CustomInput.init: unknown orientation: "+tmp);tmp="V"}}if(this.orientation=tmp,void 0!==opts.required&&(this.required=this.requiredChoice=!!opts.required),void 0!==opts.requiredChoice){if(!!this.required!=!!opts.requiredChoice)throw new TypeError("CustomInput.init: required and requiredChoice are incompatible. Option requiredChoice will be deprecated.");this.required=this.requiredChoice=!!opts.requiredChoice}if(void 0===this.required&&(this.required=this.requiredChoice=!1),opts.userValidation){if("function"!=typeof opts.userValidation)throw new TypeError("CustomInput.init: userValidation must be function or undefined. Found: "+opts.userValidation);this.userValidation=opts.userValidation}if(opts.type){if(!CustomInput.types[opts.type])throw new Error(e+"type not supported: "+opts.type);this.type=opts.type}else this.type="text";if(opts.validation){if("function"!=typeof opts.validation)throw new TypeError(e+"validation must be function or undefined. Found: "+opts.validation);tmp=opts.validation}else if("number"===this.type||"float"===this.type||"int"===this.type||"text"===this.type){if(isText="text"===this.type,void 0!==opts.min){if(!1===(tmp=J.isNumber(opts.min)))throw new TypeError(e+"min must be number or undefined. Found: "+opts.min);this.params.lower=opts.min,this.params.leq=!0}if(void 0!==opts.max){if(!1===(tmp=J.isNumber(opts.max)))throw new TypeError(e+"max must be number or undefined. Found: "+opts.max);this.params.upper=opts.max,this.params.ueq=!0}if(opts.strictlyGreater&&(this.params.leq=!1),opts.strictlyLess&&(this.params.ueq=!1),void 0!==this.params.lower&&void 0!==this.params.upper){if(this.params.lower>this.params.upper)throw new TypeError(e+"min cannot be greater than max. Found: "+opts.min+"> "+opts.max);if(this.params.lower===this.params.upper){if(!this.params.leq||!this.params.ueq)throw new TypeError(e+"min cannot be equal to max when strictlyGreater or strictlyLess are set. Found: "+opts.min);if(("int"===this.type||"text"===this.type)&&J.isFloat(this.params.lower))throw new TypeError(e+'min cannot be a floating point number and equal to max, when type is not "float". Found: '+opts.min);this.params.exactly=!0}else this.params.between=!0}if(isText){if(this.params.noNumbers=opts.noNumbers,void 0!==this.params.lower){if(this.params.lower<0)throw new TypeError(e+'min cannot be negative when type is "text". Found: '+this.params.lower);this.params.leq||this.params.lower++}if(void 0!==this.params.upper){if(this.params.upper<0)throw new TypeError(e+'max cannot be negative when type is "text". Found: '+this.params.upper);this.params.ueq||this.params.upper--}tmp=function(value){var len,p,out,err;return p=that.params,len=value.length,out={value:value},p.noNumbers&&/\d/.test(value)?err=that.getText("textErr","num"):(p.exactly?err=len!==p.lower:(void 0!==p.lower&&len<p.lower||void 0!==p.upper&&len>p.upper)&&(err=!0),err&&(err=that.getText("textErr",len))),err&&(out.err=err),out},setValues=function(){var a,b;return a=void 0!==that.params.lower?that.params.lower+1:5,b=void 0!==that.params.upper?that.params.upper:a+5,J.randomString(J.randomInt(a,b))}}else cb="float"===that.type?J.isFloat:"int"===that.type?J.isInt:J.isNumber,tmp=function(value){var res,p;return p=that.params,!1!==(res=cb(value,p.lower,p.upper,p.leq,p.ueq))?{value:res}:{value:value,err:that.getText("numericErr")}},setValues=function(){var p,a,b;return p=that.params,"float"===that.type?J.random():(a=0,void 0!==p.lower&&(a=p.leq?p.lower-1:p.lower),b=void 0!==p.upper?p.ueq?p.upper:p.upper-1:100+a,J.randomInt(a,b))};this.params.upper&&(this.params.upper<10?this.inputWidth="100px":this.params.upper<20&&(this.inputWidth="200px"))}else if("date"===this.type){if(void 0!==opts.format){if("mm-dd-yy"!==opts.format&&"dd-mm-yy"!==opts.format&&"mm-dd-yyyy"!==opts.format&&"dd-mm-yyyy"!==opts.format&&"mm.dd.yy"!==opts.format&&"dd.mm.yy"!==opts.format&&"mm.dd.yyyy"!==opts.format&&"dd.mm.yyyy"!==opts.format&&"mm/dd/yy"!==opts.format&&"dd/mm/yy"!==opts.format&&"mm/dd/yyyy"!==opts.format&&"dd/mm/yyyy"!==opts.format)throw new Error(e+"date format is invalid. Found: "+opts.format);this.params.format=opts.format}else this.params.format="mm/dd/yyyy";if(this.params.sep=this.params.format.charAt(2),tmp=this.params.format.split(this.params.sep),this.params.yearDigits=tmp[2].length,this.params.dayPos="d"===tmp[0].charAt(0)?0:1,this.params.monthPos=this.params.dayPos?0:1,this.params.dateLen=tmp[2].length+6,opts.minDate){if(!(tmp=getParsedDate(opts.minDate,this.params)))throw new Error(e+"minDate must be a Date object. Found: "+opts.minDate);this.params.minDate=tmp}if(opts.maxDate){if(!(tmp=getParsedDate(opts.maxDate,this.params)))throw new Error(e+"maxDate must be a Date object. Found: "+opts.maxDate);if(this.params.minDate&&this.params.minDate.obj>tmp.obj)throw new Error(e+"maxDate cannot be prior to minDate. Found: "+tmp.str+" < "+this.params.minDate.str);this.params.maxDate=tmp}2===this.params.yearDigits?this.inputWidth="100px":this.inputWidth="150px",this.placeholder=this.params.format,tmp=function(value){var p,tokens,tmp,res,dayNum,l1,l2;return p=that.params,3!==(tokens=value.split(p.sep)).length||tokens[2].length!==p.yearDigits?{err:that.getText("dateErr")}:(res={},2===p.yearDigits?(l1=-1,l2=100):(l1=-1,l2=1e4),!1!==(tmp=J.isInt(tokens[2],l1,l2))?res.year=tmp:res.err=!0,(tmp=J.isInt(tokens[p.monthPos],1,12,1,1))?res.month=tmp:res.err=!0,dayNum=1===tmp||3===tmp||5===tmp||7===tmp||8===tmp||10===tmp||12===tmp?31:2!==tmp?30:res.year%4==0&&res.year%100!=0||res.year%400==0?29:28,res.month=tmp,(tmp=J.isInt(tokens[p.dayPos],1,dayNum,1,1))?res.day=tmp:res.err=!0,res.err?res.err=that.getText("dateErr","invalid"):(p.minDate||p.maxDate)&&(tmp=new Date(value),p.minDate.obj&&p.minDate.obj>tmp?res.err=that.getText("dateErr","min"):p.maxDate.obj&&p.maxDate.obj<tmp&&(res.err=that.getText("dateErr","max"))),res.err||(res.value=value,res={value:res}),res)},setValues=function(){var p,minD,maxD,d,day,month,year;return minD=(p=that.params).minDate?p.minDate.obj:new Date("01/01/1900"),maxD=p.maxDate?p.maxDate.obj:void 0,day=(d=J.randomDate(minD,maxD)).getDate(),month=d.getMonth()+1,year=d.getFullYear(),2===p.yearDigits&&(year=(""+year).substr(2)),d=0===p.monthPos?month+p.sep+day:day+p.sep+month,d+=p.sep+year}}else if("us_state"===this.type)opts.abbreviation?(this.params.abbr=!0,this.inputWidth="100px"):this.inputWidth="200px",!1!==opts.territories?(this.terr=!0,tmp=this.params.abbr?getUsStatesList("usStatesTerrByAbbrLow"):getUsStatesList("usStatesTerrLow")):tmp=this.params.abbr?getUsStatesList("usStatesByAbbrLow"):getUsStatesList("usStatesLow"),this.params.usStateVal=tmp,tmp=function(value){var res;return res={value:value},that.params.usStateVal[value.toLowerCase()]||(res.err=that.getText("usStateErr")),res},setValues=function(){return J.randomKey(that.params.usStateVal)};else if("us_zip"===this.type)tmp=function(value){var res;return res={value:value},isValidUSZip(value)||(res.err=that.getText("usZipErr")),res},setValues=function(){return Math.floor(9e4*Math.random())+1e4};else if("list"===this.type||"us_city_state_zip"===this.type){if(opts.listSeparator){if("string"!=typeof opts.listSeparator)throw new TypeError(e+"listSeparator must be string or undefined. Found: "+opts.listSeperator);this.params.listSep=opts.listSeparator}else this.params.listSep=",";if("us_city_state_zip"===this.type)getUsStatesList("usStatesTerrByAbbr"),this.params.minItems=this.params.maxItems=3,this.params.fixedSize=!0,this.params.itemValidation=function(item,idx){if(2===idx){if(!usStatesTerrByAbbr[item.toUpperCase()])return{err:that.getText("usStateAbbrErr")}}else if(3===idx&&!isValidUSZip(item))return{err:that.getText("usZipErr")}},this.placeholder="Town"+this.params.listSep+" State"+this.params.listSep+" ZIP";else{if(void 0!==opts.minItems){if(!1===(tmp=J.isInt(opts.minItems,0)))throw new TypeError(e+"minItems must be a positive integer. Found: "+opts.minItems);this.params.minItems=tmp}else this.required&&(this.params.minItems=1);if(void 0!==opts.maxItems){if(!1===(tmp=J.isInt(opts.maxItems,0)))throw new TypeError(e+"maxItems must be a positive integer. Found: "+opts.maxItems);if(this.params.minItems&&this.params.minItems>tmp)throw new TypeError(e+"maxItems must be larger than minItems. Found: "+tmp+" < "+this.params.minItems);this.params.maxItems=tmp}}tmp=function(value){var i,len,v,iVal,err;if(!(len=(value=value.split(that.params.listSep)).length))return value;if(iVal=that.params.itemValidation,i=0,!(v=value[0].trim()))return{err:that.getText("listErr")};if(iVal&&(err=iVal(v,1)))return err;if(value[i++]=v,len>1){if(!(v=value[1].trim()))return{err:that.getText("listErr")};if(iVal&&(err=iVal(v,i+1)))return err;value[i++]=v}if(len>2){if(!(v=value[2].trim()))return{err:that.getText("listErr")};if(iVal&&(err=iVal(v,i+1)))return err;value[i++]=v}if(len>3)for(;i<len;){if(!(v=value[i].trim()))return{err:that.getText("listErr")};if(iVal&&(err=iVal(v,i+1)))return err;value[i++]=v}return that.params.minItems&&i<that.params.minItems?{err:that.getText("listSizeErr","min")}:that.params.maxItems&&i>that.params.maxItems?{err:that.getText("listSizeErr","max")}:{value:value}},setValues="us_city_state_zip"===this.type?function(){var sep;return sep=that.params.listSep+" ",J.randomString(8)+sep+J.randomKey(usStatesTerrByAbbr)+sep+(Math.floor(9e4*Math.random())+1e4)}:function(opts){var p,minItems,nItems,i,str,sample;for(minItems=(p=that.params).minItems||0,opts.availableValues?(nItems=J.randomInt(minItems,opts.availableValues.length),nItems--,sample=J.sample(0,nItems-1)):(nItems=J.randomInt(minItems,p.maxItems||minItems+5),nItems--),str="",i=0;i<nItems;i++)0!==i&&(str+=p.listSep+" "),str+=sample?opts.availableValues[sample[i]]:J.randomString(J.randomInt(3,10));return str}}if(this.validation=function(value){var res;return res={value:value},""===value.trim()?that.required&&(res.err=that.getText("emptyErr")):tmp&&(res=tmp(value)),that.userValidation&&that.userValidation(res),res},this._setValues=setValues,opts.preprocess){if("function"!=typeof opts.preprocess)throw new TypeError(e+"preprocess must be function or undefined. Found: "+opts.preprocess);this.preprocess=opts.preprocess}else!1!==opts.preprocess&&("date"===this.type?this.preprocess=function(input){var sep,len;len=input.value.length,sep=that.params.sep,2===len?2===input.selectionStart&&input.value.charAt(1)!==sep&&(input.value+=sep):5===len?5===input.selectionStart&&input.value.charAt(4)!==sep&&input.value.split(sep).length-1==1&&(input.value+=sep):len>this.params.dateLen&&(input.value=input.value.substring(0,this.params.dateLen))}:"list"!==this.type&&"us_city_state_zip"!==this.type||""!==this.params.listSep.trim()&&(this.preprocess=function(input){var sep,len;len=input.value.length,sep=that.params.listSep,len>1&&len===input.selectionStart&&input.value.charAt(len-1)===sep&&input.value.charAt(len-2)!==sep&&(input.value+=" ")}));if(opts.postprocess){if("function"!=typeof opts.postprocess)throw new TypeError(e+"postprocess must be function or undefined. Found: "+opts.postprocess);this.postprocess=opts.postprocess}if(opts.oninput){if("function"!=typeof opts.oninput)throw new TypeError(e+"oninput must be function or undefined. Found: "+opts.oninput);this.oninput=opts.oninput}if(void 0!==opts.validationSpeed){if(!1===(tmp=J.isInt(opts.valiadtionSpeed,0,void 0,!0)))throw new TypeError(e+"validationSpeed must a non-negative number or undefined. Found: "+opts.validationSpeed);this.validationSpeed=tmp}if(opts.mainText){if("string"!=typeof opts.mainText)throw new TypeError(e+"mainText must be string or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}if(void 0!==opts.hint){if(!1!==opts.hint&&"string"!=typeof opts.hint)throw new TypeError(e+"hint must be a string, false, or undefined. Found: "+opts.hint);this.hint=opts.hint,this.required&&(this.hint+=" *")}else this.hint=this.getText("autoHint");if(opts.placeholder){if("string"!=typeof opts.placeholder)throw new TypeError(e+"placeholder must be string or undefined. Found: "+opts.placeholder);this.placeholder=opts.placeholder}if(opts.width){if("string"!=typeof opts.width)throw new TypeError(e+"width must be string or undefined. Found: "+opts.width);this.inputWidth=opts.width}if(opts.checkboxText){if("string"!=typeof opts.checkboxText)throw new TypeError(e+"checkboxText must be string or undefined. Found: "+opts.checkboxText);this.checkboxText=opts.checkboxText}if(opts.checkboxCb){if(!this.checkboxText)throw new TypeError(e+"checkboxCb cannot be defined if checkboxText is not defined");if("function"!=typeof opts.checkboxCb)throw new TypeError(e+"checkboxCb must be function or undefined. Found: "+opts.checkboxCb);this.checkboxCb=opts.checkboxCb}},CustomInput.prototype.append=function(){var that,timeout;that=this,this.mainText&&(this.spanMainText=W.append("span",this.bodyDiv,{className:"custominput-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.spanMainText||this.bodyDiv,{className:"custominput-hint",innerHTML:this.hint}),this.input=W.append("input",this.bodyDiv),this.placeholder&&(this.input.placeholder=this.placeholder),this.inputWidth&&(this.input.style.width=this.inputWidth),this.errorBox=W.append("div",this.bodyDiv,{className:"errbox"}),this.input.oninput=function(){that.timeBegin?that.timeEnd=node.timer.getTimeSince("step"):that.timeEnd=that.timeBegin=node.timer.getTimeSince("step"),timeout&&clearTimeout(timeout),that.isHighlighted()&&that.unhighlight(),that.preprocess&&that.preprocess(that.input),timeout=setTimeout((function(){var res;that.validation&&(res=that.validation(that.input.value)).err&&that.setError(res.err),that.oninput&&that.oninput(res,that)}),that.validationSpeed)},this.input.onclick=function(){that.isHighlighted()&&that.unhighlight()},this.checkboxText&&(this.checkbox=W.append("input",this.bodyDiv,{type:"checkbox",className:"custominput-checkbox"}),W.append("span",this.bodyDiv,{className:"custominput-checkbox-text",innerHTML:this.checkboxText}),this.checkboxCb&&J.addEvent(this.checkbox,"change",(function(){that.checkboxCb(that.checkbox.checked,that)})))},CustomInput.prototype.setError=function(err){this.errorBox.innerHTML=err,this.highlight()},CustomInput.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("CustomInput.highlight: border must be string or undefined. Found: "+border);this.input&&!this.highlighted&&(this.input.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},CustomInput.prototype.unhighlight=function(){this.input&&!0===this.highlighted&&(this.input.style.border="",this.highlighted=!1,this.errorBox.innerHTML="",this.emit("unhighlighted"))},CustomInput.prototype.disable=function(opts){this.disabled||this.isAppended()&&(this.disabled=!0,this.input.disabled=!0,!this.checkbox||opts&&!1===opts.checkbox||(this.checkbox.disable=!0),this.emit("disabled"))},CustomInput.prototype.enable=function(opts){!0===this.disabled&&this.isAppended()&&(this.disabled=!1,this.input.disabled=!1,!this.checkbox||opts&&!1===opts.checkbox||(this.checkbox.disable=!1),this.emit("enabled"))},CustomInput.prototype.reset=function(){this.input&&(this.input.value=""),this.isHighlighted()&&this.unhighlight(),this.timeBegin=this.timeEnd=null},CustomInput.prototype.getValues=function(opts){var res,valid;return opts=opts||{},res=this.input.value,opts.valuesOnly||(void 0===opts.markAttempt&&(opts.markAttempt=!0),void 0===opts.highlight&&(opts.highlight=!0),valid=!(res=this.validation?this.validation(res):{value:res}).err,res.timeBegin=this.timeBegin,res.timeEnd=this.timeEnd,this.postprocess&&(res.value=this.postprocess(res.value,valid)),valid?(opts.markAttempt&&(res.isCorrect=!0),opts.reset&&this.reset()):(opts.highlight&&this.setError(res.err),opts.markAttempt&&(res.isCorrect=!1)),this.checkbox&&(res.checked=this.checkbox.checked),res.id=this.id),res},CustomInput.prototype.setValues=function(opts){var value,tmp;if(void 0!==(opts=opts||{}).value)value=opts.value;else if(void 0!==opts.values)value=opts.values;else if(opts.availableValues){if(tmp=opts.availableValues,!J.isArray(tmp)||!tmp.length)throw new TypeError("CustomInput.setValues: availableValues must be a non-empty array or undefined. Found: "+tmp);if("list"===this.type){if(tmp.length<this.params.minItems)throw new Error("CustomInput.setValues: availableValues must be a non-empty array or undefined. Found: "+tmp);value=this._setValues(opts)}else value=tmp[J.randomInt(0,tmp.length)-1]}else value=this._setValues(opts);this.input.value=value,this.preprocess&&this.preprocess(this.input)}}(node),function(node){"use strict";function CustomInputGroup(){this.table=null,this.trs=[],this.mainText=null,this.spanMainText=null,this.hint=null,this.items=null,this.itemsById={},this.itemsMap={},this.choices=null,this.choicesById={},this.itemsSettings=null,this.order=null,this.originalOrder=null,this.shuffleItems=null,this.requiredChoice=null,this.required=null,this.orientation="V",this.group=null,this.groupOrder=null,this.freeText=null,this.textarea=null,this.timeFrom="step",this.separator=CustomInputGroup.separator,this.shuffleChoices=null,this.sharedOptions={},this.summaryInput=null,this.errorBox=null,this.validation=null,this._validation=null,this.oninput=null,this._oninput=null}function addCustomInput(that,tr,i){var ci,s,td,idx;if(idx=that.order[i],s=function(that,s,i){if("string"==typeof s)s={id:s};else if("object"!=typeof s)throw new TypeError("CustomInputGroup.buildTable: item must be string or object. Found: "+s);return s.group=that.id,s.groupOrder=i+1,s.orientation=that.orientation,s.title=!1,that.oninput&&(s.oninput=that.oninput),void 0===s.requiredChoice&&that.requiredChoice&&(s.requiredChoice=that.requiredChoice),void 0===s.timeFrom&&(s.timeFrom=that.timeFrom),(s=J.mixout(s,that.sharedOptions)).storeRef=!1,s}(that,that.itemsSettings[idx],i),td=document.createElement("td"),tr.appendChild(td),ci=node.widgets.append("CustomInput",td,s),that.itemsById[ci.id])throw new Error("CustomInputGroup.buildTable: an input with the same id already exists: "+ci.id);if(that.itemsById[ci.id]=ci,that.items[idx]=ci,that.itemsMap[ci.id]=idx,s.required||s.requiredChoice||s.correctChoice){if(!1===that.required)throw new Error('CustomInputGroup.buildTable: required is false, but item "'+s.id+'" has required truthy');that.required=!0}return ci}function createTR(that,trid){var tr,sep;return tr=document.createElement("tr"),that.table.appendChild(tr),sep=that.separator,tr.id=that.id+sep+"tr"+sep+trid,that.trs.push(tr),tr}node.widgets.register("CustomInputGroup",CustomInputGroup),CustomInputGroup.version="0.3.0",CustomInputGroup.description="Groups together and manages sets of CustomInput widgets.",CustomInputGroup.title=!1,CustomInputGroup.className="custominput custominputgroup",CustomInputGroup.separator="::",CustomInputGroup.texts.autoHint=function(w){return!!w.requiredChoice&&"*"},CustomInputGroup.texts.inputErr="One or more errors detected.",CustomInputGroup.dependencies={JSUS:{}},CustomInputGroup.prototype.init=function(opts){var tmp,that;if(that=this,!this.id)throw new TypeError("CustomInputGroup.init: id is missing.");if(void 0===opts.orientation)tmp="V";else{if("string"!=typeof opts.orientation)throw new TypeError("CustomInputGroup.init: orientation must be string, or undefined. Found: "+opts.orientation);if("horizontal"===(tmp=opts.orientation.toLowerCase().trim())||"h"===tmp)tmp="H";else{if("vertical"!==tmp&&"v"!==tmp)throw new Error("CustomInputGroup.init: orientation is invalid: "+tmp);tmp="V"}}if(this.orientation=tmp,tmp=void 0!==opts.shuffleItems&&!!opts.shuffleItems,this.shuffleItems=tmp,"number"==typeof opts.requiredChoice)this.requiredChoice=opts.requiredChoice;else if("boolean"==typeof opts.requiredChoice)this.requiredChoice=opts.requiredChoice?1:0;else if(void 0!==opts.requiredChoice)throw new TypeError("CustomInputGroup.init: requiredChoice be number or boolean or undefined. Found: "+opts.requiredChoice);if(void 0!==opts.required&&(this.required=!!opts.required),"string"==typeof opts.group||"number"==typeof opts.group)this.group=opts.group;else if(void 0!==opts.group)throw new TypeError("CustomInputGroup.init: group must be string, number or undefined. Found: "+opts.group);if("number"==typeof opts.groupOrder)this.groupOrder=opts.groupOrder;else if(void 0!==opts.group)throw new TypeError("CustomInputGroup.init: groupOrder must be number or undefined. Found: "+opts.groupOrder);if("function"==typeof opts.validation)this._validation=opts.validation,this.validation=function(res,values){return values||(values=that.getValues({valuesOnly:!0})),that._validation(res||{},values,that)};else if(void 0!==opts.validation)throw new TypeError("CustomInputGroup.init: validation must be function or undefined. Found: "+opts.validation);if("function"==typeof opts.oninput)this._oninput=opts.oninput,this.oninput=function(res,input){that._oninput(res,input,that)};else if(void 0!==opts.oninput)throw new TypeError("CustomInputGroup.init: oninput must be function or undefined. Found: "+opts.oninput);if("string"==typeof opts.mainText)this.mainText=opts.mainText;else if(void 0!==opts.mainText)throw new TypeError("CustomInputGroup.init: mainText must be string or undefined. Found: "+opts.mainText);if("string"==typeof opts.hint)this.hint=opts.hint,this.requiredChoice&&(this.hint+=" *");else{if(void 0!==opts.hint)throw new TypeError("CustomInputGroup.init: hint must be a string, or undefined. Found: "+opts.hint);this.hint=this.getText("autoHint")}if(!1===opts.timeFrom||"string"==typeof opts.timeFrom)this.timeFrom=opts.timeFrom;else if(void 0!==opts.timeFrom)throw new TypeError("CustomInputGroup.init: timeFrom must be string, false, or undefined. Found: "+opts.timeFrom);if(void 0!==opts.shuffleChoices&&(this.shuffleChoices=!!opts.shuffleChoices),void 0===opts.className)this.className=CustomInputGroup.className;else{if(!1!==opts.className&&"string"!=typeof opts.className&&!J.isArray(opts.className))throw new TypeError("CustomInputGroup.init: className must be string, array, or undefined. Found: "+opts.className);this.className=opts.className}if(void 0!==opts.sharedOptions){if("object"!=typeof opts.sharedOptions)throw new TypeError("CustomInputGroup.init: sharedOptions must be object or undefined. Found: "+opts.sharedOptions);if(opts.sharedOptions.hasOwnProperty("name"))throw new Error("CustomInputGroup.init: sharedOptions cannot contain property name. Found: "+opts.sharedOptions);this.sharedOptions=J.mixin(this.sharedOptions,opts.sharedOptions)}if(void 0!==opts.summary){if("string"==typeof opts.summary)opts.summary={mainText:opts.summary};else if("object"!=typeof opts.summary)throw new TypeError("CustomInputGroup.init: summary must be object or undefined. Found: "+opts.summary);this.summaryInput=opts.summary}if("object"==typeof opts.table)this.table=opts.table;else if(void 0!==opts.table&&!1!==opts.table)throw new TypeError("CustomInputGroup.init: table must be object, false or undefined. Found: "+opts.table);this.table=opts.table,this.freeText="string"==typeof opts.freeText?opts.freeText:!!opts.freeText,void 0!==opts.items&&this.setItems(opts.items)},CustomInputGroup.prototype.setItems=function(items){var len;if(!J.isArray(items))throw new TypeError("CustomInputGroup.setItems: items must be array. Found: "+items);if(!items.length)throw new Error("CustomInputGroup.setItems: items is an empty array.");len=items.length,this.itemsSettings=items,this.items=new Array(len),this.order=J.seq(0,len-1),this.shuffleItems&&(this.order=J.shuffle(this.order)),this.originalOrder=this.order,this.table&&this.buildTable()},CustomInputGroup.prototype.buildTable=function(){var i,len,tr,H;for(H="H"===this.orientation,i=-1,len=this.itemsSettings.length,H&&(tr=createTR(this,"row1"));++i<len;)H||(tr=createTR(this,"row"+(i+1))),addCustomInput(this,tr,i);this.summaryInput&&(H||(tr=createTR(this,"row"+(i+1))),function(that,tr,i){var ci,s,td;s=J.mixout({id:that.id+"_summary",storeRef:!1,title:!1,panel:!1,className:"custominputgroup-summary",disabled:!0},that.sharedOptions),s=J.mixin(s,that.summaryInput),td=document.createElement("td"),tr.appendChild(td),ci=node.widgets.append("CustomInput",td,s),that.summaryInput=ci}(this,tr));var that=this;this.table.onclick=function(){that.isHighlighted()&&that.unhighlight()},this.enable(!0)},CustomInputGroup.prototype.append=function(){if(W.getElementById(this.id))throw new Error("CustomInputGroup.append: id is not unique: "+this.id);this.mainText&&(this.spanMainText=W.append("span",this.bodyDiv,{className:"custominputgroup-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.spanMainText||this.bodyDiv,{className:"custominputgroup-hint",innerHTML:this.hint}),!1!==this.table&&(void 0===this.table&&(this.table=document.createElement("table"),this.items&&this.buildTable()),this.table.id=this.id,this.className?J.addClass(this.table,this.className):this.table.className="",this.bodyDiv.appendChild(this.table)),this.errorBox=W.append("div",this.bodyDiv,{className:"errbox"}),this.freeText&&(this.textarea=document.createElement("textarea"),this.textarea.id=this.id+"_text",this.textarea.className=CustomInputGroup.className+"-freetext","string"==typeof this.freeText&&(this.textarea.placeholder=this.freeText),this.bodyDiv.appendChild(this.textarea))},CustomInputGroup.prototype.listeners=function(){var that=this;node.on("INPUT_DISABLE",(function(){that.disable()})),node.on("INPUT_ENABLE",(function(){that.enable()}))},CustomInputGroup.prototype.disable=function(){!0!==this.disabled&&this.table&&(this.disabled=!0,this.emit("disabled"))},CustomInputGroup.prototype.enable=function(force){this.table&&(force||this.disabled)&&(this.disabled=!1,this.emit("enabled"))},CustomInputGroup.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("CustomInputGroup.highlight: border must be string or undefined. Found: "+border);this.table&&!0!==this.highlighted&&(this.table.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},CustomInputGroup.prototype.unhighlight=function(){this.table&&!0===this.highlighted&&(this.table.style.border="",this.highlighted=!1,this.errorBox.innerHTML="",this.emit("unhighlighted"))},CustomInputGroup.prototype.getValues=function(opts){var res,i,len,input,toReset,values;if(opts=opts||{},i=-1,len=this.items.length,opts.valuesOnly){for(res={};++i<len;)res[this.items[i].id]=this.items[i].getValues({valuesOnly:!0});return res}for(res={id:this.id,order:this.order,items:{},isCorrect:!0},void 0===opts.highlight&&(opts.highlight=!0),toReset=opts.reset,opts.reset=!1,this.validation&&(values={});++i<len;)input=this.items[i],res.items[input.id]=input.getValues(opts),""===res.items[input.id].value&&(res.missValues=!0,(input.requiredChoice||input.required||input.correctChoice)&&(res.err=!0,res.isCorrect=!1)),!1===res.items[input.id].isCorrect&&opts.highlight&&(res.err=!0),values&&(values[input.id]=res.items[input.id].value);return!res.err&&values?(this.validation(res,values),opts.highlight&&res.err&&this.setError(res.err),res.err&&(res.isCorrect=!1)):toReset&&this.reset(toReset),!res.isCorrect&&opts.highlight&&this.highlight(),opts.reset=toReset,this.textarea&&(res.freetext=this.textarea.value),res},CustomInputGroup.prototype.setValues=function(opts){var i,len;if(!this.items||!this.items.length)throw new Error("CustomInputGroup.setValues: no items found.");for(opts=opts||{},i=-1,len=this.items.length;++i<len;)this.items[i].setValues(opts);this.textarea&&(this.textarea.value=J.randomString(100,"!Aa0"))},CustomInputGroup.prototype.reset=function(opts){var i,len;for(opts=opts||{},i=-1,len=this.items.length;++i<len;)this.items[i].reset(opts);this.textarea&&(this.textarea.value=""),opts.shuffleItems&&this.shuffle(),this.isHighlighted()&&this.unhighlight()},CustomInputGroup.prototype.shuffle=function(opts){var order,i,len,that,cb,newOrder;if(this.items&&(len=this.items.length)){if(that=this,newOrder=new Array(len),cb=function(el,newPos,oldPos){var i;i=el.id.split(that.separator),i="H"===that.orientation?i[2]:i[0],i=that.itemsMap[i],that.items[i].groupOrder=newPos+1,newOrder[newPos]=i},order=J.shuffle(this.order),"H"===this.orientation)J.shuffleElements(this.table,order,cb);else for(len=this.trs.length,i=-1;++i<len;)J.shuffleElements(this.trs[i],order,cb),cb=void 0;this.order=newOrder}},CustomInputGroup.prototype.setError=function(err){this.errorBox.innerHTML=err,this.highlight()}}(node),function(node){"use strict";function D3(options){this.id=options.id||D3.id,this.event=options.event||"D3",this.svg=null;var that=this;node.on(this.event,(function(value){that.tick.call(that,value)}))}function D3ts(options){var o,x,y;D3.call(this,options),this.options=o=J.merge(D3ts.defaults,options),this.n=o.n,this.data=[0],this.margin=o.margin,this.width=o.width-this.margin.left-this.margin.right,this.height=o.height-this.margin.top-this.margin.bottom,this.x=x=d3.scale.linear().domain(o.domain.x).range(o.range.x),this.y=y=d3.scale.linear().domain(o.domain.y).range(o.range.y),this.line=d3.svg.line().x((function(d,i){return x(i)})).y((function(d,i){return y(d)}))}node.widgets.register("D3",D3),node.widgets.register("D3ts",D3ts),D3.prototype.__proto__=node.Widget.prototype,D3.prototype.constructor=D3,D3.defaults={},D3.defaults.id="D3",D3.defaults.fieldset={legend:"D3 plot"},D3.version="0.1",D3.description="Real time plots for nodeGame with d3.js",D3.dependencies={d3:{},JSUS:{}},D3.prototype.append=function(root){return this.root=root,this.svg=d3.select(root).append("svg"),root},D3.prototype.tick=function(){},D3ts.id="D3ts",D3ts.version="0.1",D3ts.description="Time series plot for nodeGame with d3.js",D3ts.dependencies={D3:{},JSUS:{}},D3ts.prototype.__proto__=D3.prototype,D3ts.prototype.constructor=D3ts,D3ts.defaults={},D3ts.defaults.width=400,D3ts.defaults.height=200,D3ts.defaults.margin={top:10,right:10,bottom:20,left:40},D3ts.defaults.domain={x:[0,10],y:[0,1]},D3ts.defaults.range={x:[0,D3ts.defaults.width],y:[D3ts.defaults.height,0]},D3ts.prototype.init=function(options){console.log("init!");var x=this.x,y=this.y,height=this.height,width=this.width,margin=this.margin;this.svg.attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(d3.svg.axis().scale(x).orient("bottom")),this.svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(y).orient("left")),this.path=this.svg.append("g").attr("clip-path","url(#clip)").append("path").data([this.data]).attr("class","line").attr("d",this.line)},D3ts.prototype.tick=function(value){this.alreadyInit=this.alreadyInit||!1,this.alreadyInit||(this.init(),this.alreadyInit=!0);var x=this.x;console.log("tick!"),this.data.push(value),this.path.attr("d",this.line).attr("transform",null),this.data.length>this.n&&(this.path.transition().duration(500).ease("linear").attr("transform","translate("+x(-1)+")"),this.data.shift())}}(node),function(node){"use strict";var Table=W.Table;function DebugInfo(){this.table=null,this.interval=null,this.intervalTime=1e3}node.widgets.register("DebugInfo",DebugInfo),DebugInfo.version="0.6.2",DebugInfo.description="Display basic info a client's status.",DebugInfo.title="Debug Info",DebugInfo.className="debuginfo",DebugInfo.dependencies={Table:{}},DebugInfo.prototype.init=function(options){var that;"number"==typeof options.intervalTime&&(this.intervalTime=options.intervalTime),that=this,this.on("destroyed",(function(){clearInterval(that.interval),that.interval=null,node.silly("DebugInfo destroyed.")}))},DebugInfo.prototype.append=function(){var that;this.table=new Table,this.bodyDiv.appendChild(this.table.table),this.updateAll(),that=this,this.interval=setInterval((function(){that.updateAll()}),this.intervalTime)},DebugInfo.prototype.updateAll=function(){var stage,stageNo,stageId,playerId,stageLevel,stateLevel,winLevel,errMsg,connected,treatment,tmp;this.bodyDiv?("-",stageId="-",stageNo="-",(stage=node.game.getCurrentGameStage())&&(stageId=(tmp=node.game.plot.getStep(stage))?tmp.id:"-",stageNo=stage.toString()),stageLevel=J.getKeyByValue(node.constants.stageLevels,node.game.getStageLevel()),stateLevel=J.getKeyByValue(node.constants.stateLevels,node.game.getStateLevel()),winLevel=J.getKeyByValue(node.constants.windowLevels,W.getStateLevel()),playerId=node.player?node.player.id:"-",errMsg=node.errorManager.lastErr||"-",treatment=node.game.settings&&node.game.settings.treatmentName?node.game.settings.treatmentName:"-",connected=node.socket.connected?"yes":"no",this.table.clear(!0),this.table.addRow(["Treatment: ",treatment]),this.table.addRow(["Connected: ",connected]),this.table.addRow(["Player Id: ",playerId]),this.table.addRow(["Stage  No: ",stageNo]),this.table.addRow(["Stage  Id: ",stageId]),this.table.addRow(["Stage Lvl: ",stageLevel]),this.table.addRow(["State Lvl: ",stateLevel]),this.table.addRow(["Players  : ",node.game.pl.size()]),this.table.addRow(["Win   Lvl: ",winLevel]),this.table.addRow(["Win Loads: ",W.areLoading]),this.table.addRow(["Last  Err: ",errMsg]),this.table.parse()):node.err("DebugInfo.updateAll: bodyDiv not found.")}}(node),function(node){"use strict";function DebugWall(){this.buttonsDiv=null,this.hiddenTypes={},this.counterIn=0,this.counterOut=0,this.counterLog=0,this.wall=null,this.wallDiv=null,this.origMsgInCb=null,this.origMsgOutCb=null,this.origLogCb=null}node.widgets.register("DebugWall",DebugWall),DebugWall.version="1.1.0",DebugWall.description="Intercepts incoming and outgoing messages, and logs and prints them numbered and timestamped. Warning! Modifies core functions, therefore its usage in production is not recommended.",DebugWall.title="Debug Wall",DebugWall.className="debugwall",DebugWall.dependencies={JSUS:{}},DebugWall.prototype.init=function(opts){var that;if(that=this,!1!==opts.msgIn&&(this.origMsgInCb=node.socket.onMessage,node.socket.onMessage=function(msg){that.write("in",that.makeTextIn(msg)),that.origMsgInCb.call(node.socket,msg)}),!1!==opts.msgOut&&(this.origMsgOutCb=node.socket.send,node.socket.send=function(msg){that.write("out",that.makeTextOut(msg)),that.origMsgOutCb.call(node.socket,msg)}),!1!==opts.log&&(this.origLogCb=node.log,node.log=function(txt,level,prefix){that.write(level||"info",that.makeTextLog(txt,level,prefix)),that.origLogCb.call(node,txt,level,prefix)}),opts.hiddenTypes){if("object"!=typeof opts.hiddenTypes)throw new TypeError("DebugWall.init: hiddenTypes must be object. Found: "+opts.hiddenTypes);this.hiddenTypes=opts.hiddenTypes}this.on("destroyed",(function(){that.origLogCb&&(node.log=that.origLogCb),that.origMsgOutCb&&(node.socket.send=that.origMsgOutCb),that.origMsgInCb&&(node.socket.onMessage=that.origMsgInCb)}))},DebugWall.prototype.append=function(){var displayIn,displayOut,displayLog,that,btnGroup,cb;this.buttonsDiv=W.add("div",this.bodyDiv,{className:"wallbuttonsdiv"}),btnGroup=W.add("div",this.buttonsDiv,{className:"btn-group",role:"group","aria-label":"Toggle visibility of messages on wall"}),W.add("input",btnGroup,{id:"debug-wall-incoming",className:"btn-check",autocomplete:"off",checked:!0,type:"checkbox"}),displayIn=W.add("label",btnGroup,{className:"btn btn-outline-primary",for:"debug-wall-incoming",innerHTML:"Incoming"}),W.add("input",btnGroup,{id:"debug-wall-outgoing",className:"btn-check",autocomplete:"off",checked:!0,type:"checkbox"}),displayOut=W.add("label",btnGroup,{className:"btn btn-outline-primary",for:"debug-wall-outgoing",innerHTML:"Outgoing"}),W.add("input",btnGroup,{id:"debug-wall-log",className:"btn-check",autocomplete:"off",checked:!0,type:"checkbox"}),displayLog=W.add("label",btnGroup,{className:"btn btn-outline-primary",for:"debug-wall-log",innerHTML:"Log"}),that=this,W.add("button",this.buttonsDiv,{className:"btn btn-outline-danger me-2",innerHTML:"Clear"}).onclick=function(){that.clear()},this.buttonsDiv.appendChild(btnGroup),cb=function(type){var items,i,vis,className;if(className="wall_"+type,(items=that.wall.getElementsByClassName(className))&&items.length){for(vis=""===items[0].style.display?"none":"",i=0;i<items.length;i++)items[i].style.display=vis;that.hiddenTypes[type]=!!vis}},displayIn.onclick=function(){cb("in")},displayOut.onclick=function(){cb("out")},displayLog.onclick=function(){cb("log")},this.wallDiv=W.add("div",this.bodyDiv,{className:"walldiv"}),this.wall=W.add("table",this.wallDiv)},DebugWall.prototype.shouldHide=function(type){return this.hiddenTypes[type]},DebugWall.prototype.clear=function(){this.wall.innerHTML=""},DebugWall.prototype.write=function(type,text){var spanContainer,spanDots,spanExtra,counter,className,TR,TDtext;this.isAppended()?(counter="in"===type?++this.counterIn:"out"===type?++this.counterOut:++this.counterLog,200,className="wall_"+type,TR=W.add("tr",this.wall,{className:className}),"in"!==type&&"out"!==type&&(TR.className+=" wall_log"),this.shouldHide(type,text)&&(TR.style.display="none"),W.add("td",TR,{innerHTML:counter}),W.add("td",TR,{innerHTML:type}),W.add("td",TR,{innerHTML:J.getTimeM()}),TDtext=W.add("td",TR),text.length>200?(spanContainer=W.add("span",TDtext,{className:className+"_click",innerHTML:text.substr(0,200)}),spanExtra=W.add("span",spanContainer,{className:className+"_extra",innerHTML:text.substr(200,text.length),id:"wall_"+type+"_"+counter,style:{display:"none"}}),spanDots=W.add("span",spanContainer,{className:className+"_dots",innerHTML:" ...",id:"wall_"+type+"_"+counter}),spanContainer.onclick=function(){"none"===spanDots.style.display?(spanDots.style.display="",spanExtra.style.display="none"):(spanDots.style.display="none",spanExtra.style.display="")}):spanContainer=W.add("span",TDtext,{innerHTML:text}),this.wallDiv.scrollTop=this.wallDiv.scrollHeight):node.warn("Wall not appended, cannot write.")},DebugWall.prototype.makeTextIn=function(msg){var text,d;return text=(d=new Date(msg.created)).getHours()+":"+d.getMinutes()+":"+d.getSeconds()+":"+d.getMilliseconds(),text+=" | "+msg.to+" | "+msg.target+" | "+msg.action+" | "+msg.text+" | "+msg.data},DebugWall.prototype.makeTextOut=function(msg){return msg.from+" | "+msg.target+" | "+msg.action+" | "+msg.text+" | "+msg.data},DebugWall.prototype.makeTextLog=function(text){return text}}(node),function(node){"use strict";function DisconnectBox(){this.showStatus=null,this.showDiscBtn=null,this.statusSpan=null,this.disconnectBtn=null,this.userDiscFlag=null,this.ee=null,this.disconnectCb=null,this.connectCb=null}node.widgets.register("DisconnectBox",DisconnectBox),DisconnectBox.version="0.4.0",DisconnectBox.description="Monitors and handles disconnections",DisconnectBox.title=!1,DisconnectBox.panel=!1,DisconnectBox.className="disconnectbox",DisconnectBox.texts={leave:"Leave Task",left:"You Left",disconnected:"Disconnected!",connected:"Connected"},DisconnectBox.dependencies={},DisconnectBox.prototype.init=function(opts){if(opts.connectCb){if("function"!=typeof opts.connectCb)throw new TypeError("DisconnectBox.init: connectCb must be function or undefined. Found: "+opts.connectCb);this.connectCb=opts.connectCb}if(opts.disconnectCb){if("function"!=typeof opts.disconnectCb)throw new TypeError("DisconnectBox.init: disconnectCb must be function or undefined. Found: "+opts.disconnectCb);this.disconnectCb=opts.disconnectCb}this.showDiscBtn=!!opts.showDiscBtn,this.showStatus=!!opts.showStatus},DisconnectBox.prototype.append=function(){var that,con;that=this,con=node.socket.isConnected(),this.showStatus&&(this.statusSpan=W.add("span",this.bodyDiv),this.updateStatus(con?"connected":"disconnected")),this.showDiscBtn&&(this.disconnectBtn=W.add("button",this.bodyDiv,{innerHTML:this.getText(con?"leave":"left"),className:"btn",style:{"margin-left":"10px"}}),con||(this.disconnectBtn.disabled=!0),this.disconnectBtn.onclick=function(){that.disconnectBtn.disabled=!0,that.userDiscFlag=!0,node.socket.disconnect()})},DisconnectBox.prototype.updateStatus=function(status){this.statusSpan?(this.statusSpan.innerHTML=this.getText(status),this.statusSpan.className="disconnected"===status?"text-danger":""):node.warn("DisconnectBox.updateStatus: display disabled.")},DisconnectBox.prototype.listeners=function(){var that;that=this,this.ee=node.getCurrentEventEmitter(),this.ee.on("SOCKET_DISCONNECT",(function(){that.statusSpan&&that.updateStatus("disconnected"),that.disconnectBtn&&(that.disconnectBtn.disabled=!0,that.disconnectBtn.innerHTML=that.getText("left")),that.disconnectCb&&that.disconnectCb(that.userDiscFlag)})),this.ee.on("SOCKET_CONNECT",(function(){that.statusSpan&&that.updateStatus("connected"),that.disconnectBtn&&(that.disconnectBtn.disabled=!1,that.disconnectBtn.innerHTML=that.getText("leave")),that.connectCb&&that.disconnectCb(),that.userDiscFlag=!1}))}}(node),function(node){"use strict";function DoneButton(options){var that;if(that=this,"object"==typeof options.button)this.button=options.button;else{if(void 0!==options.button)throw new TypeError("DoneButton constructor: options.button must be object or undefined. Found: "+options.button);this.button=document.createElement("input"),this.button.type="button"}this.button.onclick=function(){that.onclick&&!1===that.onclick()||node.done()&&that.disable()},this.onclick=null,this.disableOnDisconnect=null,this.delayOnPlaying=800}node.widgets.register("DoneButton",DoneButton),DoneButton.version="1.1.0",DoneButton.description="Creates a button that if pressed emits node.done().",DoneButton.title=!1,DoneButton.className="donebutton",DoneButton.texts.done="Done",DoneButton.dependencies={JSUS:{}},DoneButton.prototype.init=function(opts){var tmp;if(void 0===(opts=opts||{}).id)tmp=DoneButton.className;else if("string"==typeof opts.id)tmp=opts.id;else{if(!1!==opts.id)throw new TypeError("DoneButton.init: id must be string, false, or undefined. Found: "+opts.id);tmp=!1}if(tmp&&(this.button.id=tmp),void 0===opts.className)tmp="btn btn-lg btn-primary";else if(!1===opts.className)tmp="";else if("string"==typeof opts.className)tmp=opts.className;else{if(!J.isArray(opts.className))throw new TypeError("DoneButton.init: className must be string, array, or undefined. Found: "+opts.className);tmp=opts.className.join(" ")}if(this.button.className=tmp,this.button.value="string"==typeof opts.text?opts.text:this.getText("done"),this.disableOnDisconnect=void 0===opts.disableOnDisconnect||!!opts.disableOnDisconnect,"number"==typeof(tmp=opts.delayOnPlaying))this.delayOnPlaying=tmp;else if(void 0!==tmp)throw new TypeError("DoneButton.init: delayOnPlaying must be number or undefined. Found: "+tmp);if(tmp=opts.onclick){if("function"!=typeof tmp)throw new TypeError("DoneButton.init: onclick must function or undefined. Found: "+tmp);this.onclick=tmp}},DoneButton.prototype.append=function(){node.game.isReady()||(this.disabled=!0,this.button.disabled=!0),this.bodyDiv.appendChild(this.button)},DoneButton.prototype.listeners=function(){var that,disabled;that=this,node.on("PLAYING",(function(){var prop,step,delay;step=node.game.getCurrentGameStage(),!1===(prop=node.game.plot.getProperty(step,"donebutton"))||prop&&!1===prop.enableOnPlaying?that.disable():(delay=prop&&prop.hasOwnProperty&&prop.hasOwnProperty("delayOnPlaying")?prop.delayOnPlaying:that.delayOnPlaying)?setTimeout((function(){disabled||that.enable()}),delay):that.enable(),"string"==typeof prop?that.button.value=prop:prop&&prop.text&&(that.button.value=prop.text)})),this.disableOnDisconnect&&(node.on("SOCKET_DISCONNECT",(function(){that.isDisabled()||(that.disable(),disabled=!0)})),node.on("SOCKET_CONNECT",(function(){disabled&&(that.isDisabled()&&that.enable(),disabled=!1)})))},DoneButton.prototype.updateText=function(text,duration){var oldText,that;duration&&(that=this,oldText=this.button.value,node.timer.setTimeout((function(){that.button.value=oldText}),duration)),this.button.value=text},DoneButton.prototype.disable=function(opts){this.disabled||(this.disabled=!0,this.button.disabled=!0,this.emit("disabled",opts))},DoneButton.prototype.enable=function(opts){this.disabled&&(this.disabled=!1,this.button.disabled=!1,this.emit("enabled",opts))}}(node),function(node){function Dropdown(){var that;that=this,this.id=null,this.mainText=null,this.labelText=null,this.placeHolder=null,this.choices=null,this.tag=null,this.menu=null,this.listener=function(e){var menu,timeout;menu=(e=e||window.event).target||e.srcElement,that.currentChoice=menu.value,0===that.currentChoice.length&&(that.currentChoice=null),"string"==typeof that.timeFrom?that.timeCurrentChoice=node.timer.getTimeSince(that.timeFrom):that.timeCurrentChoice=Date.now?Date.now():(new Date).getTime(),that.numberOfChanges++,that.isHighlighted()&&that.unhighlight(),timeout&&clearTimeout(timeout),timeout=setTimeout((function(){that.verifyChoice(),that.verifyChoice().err&&that.setError(that.verifyChoice().err)}),that.validationSpeed),that.onchange&&that.onchange(that.currentChoice,that)},this.onchange=null,this.timeCurrentChoice=null,this.timeFrom="step",this.numberOfChanges=0,this.currentChoice=null,this.shuffleChoices=null,this.order=null,this.errorBox=null,this.correctChoice=null,this.requiredChoice=null,this.fixedChoice=null,this.inputWidth=null,this.validation=null,this.validationSpeed=500}node.widgets.register("Dropdown",Dropdown),Dropdown.version="0.1.0",Dropdown.description="Creates a configurable dropdown menu.",Dropdown.texts={error:function(w,value){return null!==value&&w.fixedChoice&&w.choices.indexOf(value)<0?"No custom values allowed.":null!==value&&null!==w.correctChoice?"Not correct, try again.":null!==value&&w.verifyChoice().err?w.verifyChoice().err:"Answer required."}},Dropdown.title=!1,Dropdown.className="dropdown",Dropdown.prototype.init=function(options){var tmp;if(!this.id)throw new TypeError("Dropdown.init: options.id is missing");if("string"==typeof options.mainText)this.mainText=options.mainText;else if(void 0!==options.mainText)throw new TypeError("Dropdown.init: options.mainText must be string or undefined. Found: "+options.mainText);if("string"==typeof options.labelText)this.labelText=options.labelText;else if(void 0!==options.labelText)throw new TypeError("Dropdown.init: options.labelText must be string or undefined. Found: "+options.labelText);if("string"==typeof options.placeHolder)this.placeHolder=options.placeHolder;else if(void 0!==options.placeHolder)throw new TypeError("Dropdown.init: options.placeHolder must be string or undefined. Found: "+options.placeHolder);if(void 0!==options.choices&&(this.choices=options.choices),"boolean"==typeof options.requiredChoice)this.requiredChoice=options.requiredChoice;else if(void 0!==options.requiredChoice)throw new TypeError("Dropdown.init: options.requiredChoice be boolean or undefined. Found: "+options.requiredChoice);if(void 0!==options.correctChoice){if(this.requiredChoice)throw new Error("Dropdown.init: cannot specify both options requiredChoice and correctChoice");if(J.isArray(options.correctChoice)&&options.correctChoice.length>options.choices.length)throw new Error("Dropdown.init: options.correctChoice length cannot exceed options.choices length");this.correctChoice=options.correctChoice}if("boolean"==typeof options.fixedChoice)this.fixedChoice=options.fixedChoice;else if(void 0!==options.fixedChoice)throw new TypeError("Dropdown.init: options.fixedChoice be boolean or undefined. Found: "+options.fixedChoice);if(void 0!==options.tag&&"datalist"!==options.tag&&"select"!==options.tag)throw new TypeError('Dropdown.init: options.tag must be "datalist" or "select". Found: '+options.tag);if(this.tag=options.tag,"function"==typeof options.listener)this.listener=function(e){options.listener.call(this,e)};else if(void 0!==options.listener)throw new TypeError("Dropdown.init: opts.listener must be function or undefined. Found: "+options.listener);if("function"==typeof options.onchange)this.onchange=options.onchange;else if(void 0!==options.onchange)throw new TypeError("Dropdownn.init: opts.onchange must be function or undefined. Found: "+options.onchange);if("function"==typeof options.validation)this.validation=options.validation;else if(void 0!==options.validation)throw new TypeError("Dropdownn.init: opts.validation must be function or undefined. Found: "+options.validation);if(tmp=void 0!==options.shuffleChoices&&!!options.shuffleChoices,this.shuffleChoices=tmp,options.width){if("string"!=typeof options.width)throw new TypeError("Dropdownn.init:width must be string or undefined. Found: "+options.width);this.inputWidth=options.width}if(void 0!==options.validationSpeed){if(!1===(tmp=J.isInt(options.valiadtionSpeed,0,void 0,!0)))throw new TypeError("Dropdownn.init: validationSpeed must a non-negative number or undefined. Found: "+options.validationSpeed);this.validationSpeed=tmp}},Dropdown.prototype.append=function(){if(W.gid(this.id))throw new Error("Dropdown.append: id is not unique: "+this.id);var text=this.text,label=this.label;(text=W.get("p")).innerHTML=this.mainText,text.id="p",this.bodyDiv.appendChild(text),(label=W.get("label")).innerHTML=this.labelText,this.bodyDiv.appendChild(label),this.setChoices(this.choices,!0),this.errorBox=W.append("div",this.bodyDiv,{className:"errbox",id:"errbox"})},Dropdown.prototype.setChoices=function(choices,append){var tag=this.tag,option=this.option,placeHolder=this.placeHolder,order=this.order;if(this.choices=choices,append){var create=!1;if(this.menu?this.menu.innerHTML="":create=!0,create)if("datalist"===(tag=this.tag)||void 0===tag){var datalist=this.datalist,input=this.input;(datalist=W.get("datalist")).id="dropdown",(input=W.get("input")).setAttribute("list",datalist.id),input.id=this.id,input.autocomplete="off",placeHolder&&(input.placeholder=placeHolder),this.inputWidth&&(input.style.width=this.inputWidth),this.bodyDiv.appendChild(input),this.bodyDiv.appendChild(datalist),this.menu=input}else if("select"===tag){var select=this.select;(select=W.get("select")).id=this.id,this.inputWidth&&(select.style.width=this.inputWidth),placeHolder&&((option=W.get("option")).value="",option.innerHTML=placeHolder,option.setAttribute("disabled",""),option.setAttribute("selected",""),option.setAttribute("hidden",""),select.appendChild(option)),this.bodyDiv.appendChild(select),this.menu=select}var len=choices.length;order=J.seq(0,len-1),this.shuffleChoices&&(order=J.shuffle(order));for(var i=0;i<len;i++)(option=W.get("option")).value=choices[order[i]],option.innerHTML=choices[order[i]],"datalist"===tag||void 0===tag?datalist.appendChild(option):"select"===tag&&select.appendChild(option);this.enable()}},Dropdown.prototype.verifyChoice=function(){var that=this,correct=this.correctChoice,current=this.currentChoice,res={value:""};if("select"===this.tag&&0===this.numberOfChanges&&(current=this.currentChoice=this.menu.value),this.requiredChoice&&(res.value=null!==current),void 0===correct&&(res.value=null),"string"==typeof correct&&(res.value=current===correct),"number"==typeof correct&&(res.value=current===this.choices[correct]),J.isArray(correct)){var correctOptions=correct.map((function(x){return that.choices[x]}));res.value=correctOptions.indexOf(current)>=0}if(this.fixedChoice&&this.choices.indexOf(current)<0&&(res.value=!1),this.validation){if(void 0===typeof res)throw new TypeError("something");this.validation(this.currentChoice,res)}return res},Dropdown.prototype.setError=function(err){this.errorBox&&(this.errorBox.innerHTML=err||""),err?this.highlight():this.unhighlight()},Dropdown.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("Dropdown.highlight: border must be string or undefined. Found: "+border);this.highlighted||(this.menu.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},Dropdown.prototype.unhighlight=function(){!0===this.highlighted&&(this.menu.style.border="",this.highlighted=!1,this.setError(),this.emit("unhighlighted"))},Dropdown.prototype.getValues=function(opts){var obj;opts=opts||{};var verif=this.verifyChoice().value;return obj={id:this.id,choice:this.fixedChoice?this.choices.indexOf(this.currentChoice):this.currentChoice,time:this.timeCurrentChoice,nChanges:this.numberOfChanges},void 0===opts.highlight&&(opts.highlight=!0),this.shuffleChoices&&(obj.order=this.order),!1!==opts.addValue&&!1!==opts.getValue&&(obj.value=this.currentChoice),null===this.correctChoice&&null===this.requiredChoice&&null===this.fixedChoice||(obj.isCorrect=verif,!obj.isCorrect&&opts.highlight&&this.highlight()),!1===obj.isCorrect&&this.setError(this.getText("error",obj.value)),obj},Dropdown.prototype.listeners=function(){var that=this;node.on("INPUT_DISABLE",(function(){that.disable()})),node.on("INPUT_ENABLE",(function(){that.enable()}))},Dropdown.prototype.disable=function(){!0!==this.disabled&&(this.disabled=!0,this.menu&&this.menu.removeEventListener("change",this.listener),this.emit("disabled"))},Dropdown.prototype.enable=function(){if(!1!==this.disabled){if(!this.menu)throw new Error("Dropdown.enable: menu is not defined");this.disabled=!1,this.menu.addEventListener("change",this.listener),this.emit("enabled")}}}(node),function(node){"use strict";function EmailForm(opts){if(opts.onsubmit){if("object"!=typeof opts.onsubmit)throw new TypeError("EmailForm constructor: opts.onsubmit must be object or undefined. Found: "+opts.onsubmit);this.onsubmit=opts.onsubmit}else this.onsubmit={emailOnly:!0,send:!0,updateUI:!0};this._email=opts.email||null,this.attempts=[],this.timeInput=null,this.formElement=null,this.inputElement=null,this.buttonElement=null,this.setMsg=!!opts.setMsg||!1,this.showSubmitBtn=void 0===opts.showSubmitBtn||!!opts.showSubmitBtn}function getEmail(){return this.inputElement?this.inputElement.value:this._email}node.widgets.register("EmailForm",EmailForm),EmailForm.version="0.13.1",EmailForm.description="Displays a configurable email form.",EmailForm.title=!1,EmailForm.className="emailform",EmailForm.texts={label:"Enter your email:",errString:"Not a valid email address, please correct it and submit it again.",sent:"Sent!"},EmailForm.prototype.createForm=function(){var that,formElement,labelElement,inputElement,buttonElement;return that=this,(formElement=document.createElement("form")).className="emailform-form",(labelElement=document.createElement("label")).innerHTML=this.getText("label"),(inputElement=document.createElement("input")).setAttribute("type","text"),inputElement.setAttribute("placeholder","Email"),inputElement.className="emailform-input form-control",formElement.appendChild(labelElement),formElement.appendChild(inputElement),this.formElement=formElement,this.inputElement=inputElement,this.showSubmitBtn&&((buttonElement=document.createElement("input")).setAttribute("type","submit"),buttonElement.setAttribute("value","Submit email"),buttonElement.className="btn btn-lg btn-primary emailform-submit",formElement.appendChild(buttonElement),J.addEvent(formElement,"submit",(function(event){event.preventDefault(),that.getValues(that.onsubmit)}),!0),J.addEvent(formElement,"input",(function(){that.timeInput||(that.timeInput=J.now()),that.isHighlighted()&&that.unhighlight()}),!0),this.buttonElement=buttonElement),this._email&&(this.formElement.value=this._email),this._email=null,formElement},EmailForm.prototype.verifyInput=function(markAttempt,updateUI){var email,res;return email=getEmail.call(this),(res=J.isEmail(email))&&updateUI?(this.inputElement&&(this.inputElement.disabled=!0),this.buttonElement&&(this.buttonElement.disabled=!0,this.buttonElement.value=this.getText("sent"))):(updateUI&&this.buttonElement&&(this.buttonElement.value=this.getText("errString")),(void 0===markAttempt||markAttempt)&&this.attempts.push(email)),res},EmailForm.prototype.append=function(){this.createForm(),this.bodyDiv.appendChild(this.formElement)},EmailForm.prototype.setValues=function(options){var email;email=(options=options||{}).email?options.email:J.randomEmail(),this.inputElement?this.inputElement.value=email:this._email=email,this.timeInput=J.now()},EmailForm.prototype.getValues=function(opts){var email,res;return void 0!==(opts=opts||{}).say&&(console.log("***EmailForm.getValues: option say is deprecated,  use send.***"),opts.send=opts.say),void 0!==opts.sayAnyway&&(console.log("***EmailForm.getValues: option sayAnyway is deprecated, use sendAnyway.***"),opts.sendAnyway=opts.sayAnyway),void 0===opts.markAttempt&&(opts.markAttempt=!0),void 0===opts.highlight&&(opts.highlight=!0),email=getEmail.call(this),!1!==opts.verify&&(res=this.verifyInput(opts.markAttempt,opts.updateUI)),opts.emailOnly||(email={time:this.timeInput,email:email,attempts:this.attempts},opts.markAttempt&&(email.isCorrect=res)),!1===res&&((opts.updateUI||opts.highlight)&&this.highlight(),this.timeInput=null),(opts.send&&res||opts.sendAnyway)&&this.sendValues({values:email}),opts.reset&&this.reset(),email},EmailForm.prototype.sendValues=function(opts){var values;return values=(opts=opts||{emailOnly:!0}).values||this.getValues(opts),this.setMsg?("string"==typeof values&&(values={email:values}),node.set(values,opts.to||"SERVER")):node.say("email",opts.to||"SERVER",values),values},EmailForm.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("EmailForm.highlight: border must be string or undefined. Found: "+border);this.inputElement&&!0!==this.highlighted&&(this.inputElement.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},EmailForm.prototype.unhighlight=function(){this.inputElement&&!0===this.highlighted&&(this.inputElement.style.border="",this.highlighted=!1,this.emit("unhighlighted"))},EmailForm.prototype.reset=function(){this.attempts=[],this.timeInput=null,this._email=null,this.inputElement&&(this.inputElement.value=""),this.isHighlighted()&&this.unhighlight()}}(node),function(node){"use strict";function EndScreen(options){this.showEmailForm=!0,this.showFeedbackForm=!0,this.showTotalWin=!0,this.showExitCode=!0,this.totalWinCurrency="USD",this.totalWinCb=null,this.emailForm=null,this.feedback=null,this.endScreenHTML=null,this.askServer=options.askServer||!1}node.widgets.register("EndScreen",EndScreen),EndScreen.version="0.7.2",EndScreen.description="Game end screen. With end game message, email form, and exit code.",EndScreen.title=!1,EndScreen.className="endscreen",EndScreen.texts={headerMessage:"Thank you for participating!",message:"You have now completed this task and your data has been saved. Please go back to the Amazon Mechanical Turk web site and submit the HIT.",totalWin:"Your total win:",exitCode:"Your exit code:",errTotalWin:"Error: invalid total win.",errExitCode:"Error: invalid exit code.",copyButton:"Copy",exitCopyMsg:"Exit code copied to clipboard.",exitCopyError:"Failed to copy exit code. Please copy it manually."},EndScreen.dependencies={Feedback:{},EmailForm:{}},EndScreen.prototype.init=function(options){if(!1===options.email)this.showEmailForm=!1;else if("boolean"==typeof options.showEmailForm)this.showEmailForm=options.showEmailForm;else if(void 0!==options.showEmailForm)throw new TypeError("EndScreen.init: options.showEmailForm must be boolean or undefined. Found: "+options.showEmailForm);if(!1===options.feedback)this.showFeedbackForm=!1;else if("boolean"==typeof options.showFeedbackForm)this.showFeedbackForm=options.showFeedbackForm;else if(void 0!==options.showFeedbackForm)throw new TypeError("EndScreen.init: options.showFeedbackForm must be boolean or undefined. Found: "+options.showFeedbackForm);if(!1===options.totalWin)this.showTotalWin=!1;else if("boolean"==typeof options.showTotalWin)this.showTotalWin=options.showTotalWin;else if(void 0!==options.showTotalWin)throw new TypeError("EndScreen.init: options.showTotalWin must be boolean or undefined. Found: "+options.showTotalWin);if(!1===options.exitCode)options.showExitCode;else if("boolean"==typeof options.showExitCode)this.showExitCode=options.showExitCode;else if(void 0!==options.showExitCode)throw new TypeError("EndScreen.init: options.showExitCode must be boolean or undefined. Found: "+options.showExitCode);if("string"==typeof options.totalWinCurrency&&""!==options.totalWinCurrency.trim())this.totalWinCurrency=options.totalWinCurrency;else if(void 0!==options.totalWinCurrency)throw new TypeError("EndScreen.init: options.totalWinCurrency must be undefined or a non-empty string. Found: "+options.totalWinCurrency);if(options.totalWinCb){if("function"!=typeof options.totalWinCb)throw new TypeError("EndScreen.init: options.totalWinCb must be function or undefined. Found: "+options.totalWinCb);this.totalWinCb=options.totalWinCb}this.showEmailForm&&!this.emailForm&&(this.emailForm=node.widgets.get("EmailForm",J.mixin({onsubmit:{send:!0,emailOnly:!0,updateUI:!0},storeRef:!1,texts:{label:"If you would like to be contacted for future studies, please enter your email (optional):",errString:"Please enter a valid email and retry"},setMsg:!0},options.email))),this.showFeedbackForm&&(this.feedback=node.widgets.get("Feedback",J.mixin({storeRef:!1,minChars:50,setMsg:!0},options.feedback)))},EndScreen.prototype.append=function(){this.endScreenHTML=this.makeEndScreen(),this.bodyDiv.appendChild(this.endScreenHTML),this.askServer&&setTimeout((function(){node.say("WIN")}))},EndScreen.prototype.makeEndScreen=function(){var endScreenElement,headerElement,messageElement,totalWinElement,totalWinParaElement,totalWinInputElement,exitCodeElement,exitCodeParaElement,exitCodeInputElement,exitCodeBtn,exitCodeGroup,that=this;return(endScreenElement=document.createElement("div")).className="endscreen",(headerElement=document.createElement("h1")).innerHTML=this.getText("headerMessage"),endScreenElement.appendChild(headerElement),(messageElement=document.createElement("p")).innerHTML=this.getText("message"),endScreenElement.appendChild(messageElement),this.showTotalWin&&(totalWinElement=document.createElement("div"),(totalWinParaElement=document.createElement("p")).innerHTML="<strong>"+this.getText("totalWin")+"</strong>",(totalWinInputElement=document.createElement("input")).className="endscreen-total form-control",totalWinInputElement.setAttribute("disabled","true"),totalWinParaElement.appendChild(totalWinInputElement),totalWinElement.appendChild(totalWinParaElement),endScreenElement.appendChild(totalWinElement),this.totalWinInputElement=totalWinInputElement),this.showExitCode&&((exitCodeElement=document.createElement("div")).className="input-group",(exitCodeParaElement=document.createElement("span")).innerHTML="<strong>"+this.getText("exitCode")+"</strong>",(exitCodeInputElement=document.createElement("input")).id="exit_code",exitCodeInputElement.className="endscreen-exit-code form-control",exitCodeInputElement.setAttribute("disabled","true"),(exitCodeGroup=document.createElement("span")).className="input-group-btn",(exitCodeBtn=document.createElement("button")).className="btn btn-default endscreen-copy-btn",exitCodeBtn.innerHTML=this.getText("copyButton"),exitCodeBtn.type="button",exitCodeBtn.onclick=function(){that.copy(exitCodeInputElement.value)},exitCodeGroup.appendChild(exitCodeBtn),endScreenElement.appendChild(exitCodeParaElement),exitCodeElement.appendChild(exitCodeGroup),exitCodeElement.appendChild(exitCodeInputElement),endScreenElement.appendChild(exitCodeElement),this.exitCodeInputElement=exitCodeInputElement),this.showEmailForm&&node.widgets.append(this.emailForm,endScreenElement,{title:!1,panel:!1}),this.showFeedbackForm&&node.widgets.append(this.feedback,endScreenElement,{title:!1,panel:!1}),endScreenElement},EndScreen.prototype.listeners=function(){var that;that=this,node.on.data("WIN",(function(message){that.updateDisplay(message.data)}))},EndScreen.prototype.copy=function(text){var inp=document.createElement("input");try{document.body.appendChild(inp),inp.value=text,inp.select(),document.execCommand("copy",!1),inp.remove(),alert(this.getText("exitCopyMsg"))}catch(err){alert(this.getText("exitCopyError"))}},EndScreen.prototype.updateDisplay=function(data){var preWin,totalWin,totalRaw,exitCode,totalHTML,exitCodeHTML,ex,err;if(this.totalWinCb)totalWin=this.totalWinCb(data,this);else{if(void 0===data.total&&void 0===data.totalRaw)throw new Error("EndScreen.updateDisplay: data.total and data.totalRaw cannot be both undefined.");void 0!==data.total&&!1===(totalWin=J.isNumber(data.total))&&(node.err("EndScreen.updateDisplay: invalid data.total: "+data.total),totalWin=this.getText("errTotalWin"),err=!0),preWin="",void 0!==data.basePay&&(preWin=data.basePay),void 0!==data.bonus&&!1!==data.showBonus&&(""!==preWin&&(preWin+=" + "),preWin+=data.bonus),data.partials&&(J.isArray(data.partials)?(""!==preWin&&(preWin+=" + "),preWin+=data.partials.join(" + ")):node.err("EndScreen error, invalid partials win: "+data.partials)),void 0!==data.totalRaw&&(preWin?preWin+=" = ":preWin="",preWin+=data.totalRaw,void 0!==(ex=void 0!==data.exchangeRate?data.exchangeRate:node.game.settings.EXCHANGE_RATE)&&(preWin+="*"+ex),void 0===totalWin&&(totalRaw=J.isNumber(data.totalRaw,0),totalWin=parseFloat(ex*totalRaw).toFixed(2),!1===(totalWin=J.isNumber(totalWin,0))&&(node.err("EndScreen.updateDisplay: invalid : totalWin calculation from totalRaw."),totalWin=this.getText("errTotalWin"),err=!0))),err||(totalWin!==preWin&""!==preWin&&(totalWin=preWin+" = "+totalWin),totalWin+=" "+this.totalWinCurrency)}"string"!=typeof(exitCode=data.exit)&&(node.err("EndScreen error, invalid exit code: "+exitCode),exitCode=this.getText("errExitCode")),totalHTML=this.totalWinInputElement,exitCodeHTML=this.exitCodeInputElement,totalHTML&&this.showTotalWin&&(totalHTML.value=totalWin),exitCodeHTML&&this.showExitCode&&(exitCodeHTML.value=exitCode)}}(node),function(node){"use strict";function Feedback(options){var tmp;if(void 0!==options.maxLength&&(console.log("***Feedback constructor: maxLength is deprecated, use maxChars instead***"),options.maxChars=options.maxLength),void 0!==options.minLength&&(console.log("***Feedback constructor: minLength is deprecated, use minChars instead***"),options.minChars=options.minLength),this.mainText=null,this.hint=null,this.spanMainText=null,void 0===options.maxChars)this.maxChars=0;else{if(!1===(tmp=J.isInt(options.maxChars,0)))throw new TypeError("Feedback constructor: maxChars must be an integer >= 0 or undefined. Found: "+options.maxChars);this.maxChars=tmp}if(void 0===options.minChars)this.minChars=0;else{if(!1===(tmp=J.isInt(options.minChars,0,void 0,!0)))throw new TypeError("Feedback constructor: minChars must be an integer >= 0 or undefined. Found: "+options.minChars);if(this.maxChars&&tmp>this.maxChars)throw new TypeError("Feedback constructor: minChars cannot be greater than maxChars. Found: "+tmp+" > "+this.maxChars);this.minChars=tmp}if(void 0===options.maxWords)this.maxWords=0;else{if(!1===(tmp=J.isInt(options.maxWords,0,void 0,!0)))throw new TypeError("Feedback constructor: maxWords must be an integer >= 0 or undefined. Found: "+options.maxWords);this.maxWords=options.maxWords}if(void 0===options.minWords)this.minWords=0;else{if(!1===(tmp=J.isInt(options.minWords,0,void 0,!0)))throw new TypeError("Feedback constructor: minWords must be an integer >= 0 or undefined. Found: "+options.minWords);if(this.minWords=options.minWords,this.maxChars&&(tmp=(this.maxChars+1)/2,this.minWords>tmp))throw new TypeError("Feedback constructor: minWords cannot be larger than (maxChars+1)/2. Found: "+this.minWords+" > "+tmp)}if(this.maxWords){if(this.maxChars&&this.maxChars<this.maxWords)throw new TypeError("Feedback constructor: maxChars cannot be smaller than maxWords. Found: "+this.maxChars+" > "+this.maxWords);if(this.minChars>this.maxWords)throw new TypeError("Feedback constructor: minChars cannot be greater than maxWords. Found: "+this.minChars+" > "+this.maxWords)}if(void 0===options.rows)this.rows=3;else{if(!1===J.isInt(options.rows,0))throw new TypeError("Feedback constructor: rows must be an integer > 0 or undefined. Found: "+options.rows);this.rows=options.rows}if(void 0===options.maxAttemptLength)this.maxAttemptLength=0;else{if(!1===(tmp=J.isNumber(options.maxAttemptLength,0)))throw new TypeError("Feedback constructor: options.maxAttemptLength must be a number > 0 or undefined. Found: "+options.maxAttemptLength);this.maxAttemptLength=tmp}if(this.showSubmit=void 0===options.showSubmit||!!options.showSubmit,options.onsubmit){if("object"!=typeof options.onsubmit)throw new TypeError("Feedback constructor: onsubmit must be string or object. Found: "+options.onsubmit);this.onsubmit=options.onsubmit}else this.onsubmit={feedbackOnly:!0,send:!0,updateUI:!0};this._feedback=options.feedback||null,this.attempts=[],this.timeInputBegin=null,this.feedbackForm=null,this.textareaElement=null,this.charCounter=null,this.wordCounter=null,this.submitButton=null,this.setMsg=!!options.setMsg||!1}function getFeedback(){var out;return(out=this.textareaElement?this.textareaElement.value:this._feedback)?out.trim():out}node.widgets.register("Feedback",Feedback),Feedback.version="1.6.0",Feedback.description="Displays a configurable feedback form",Feedback.title="Feedback",Feedback.className="feedback",Feedback.texts={autoHint:function(w){var res,res2;return w.minChars&&w.maxChars?res="between "+w.minChars+" and "+w.maxChars+" characters":w.minChars?(res="at least "+w.minChars+" character",w.minChars>1&&(res+="s")):w.maxChars&&(res="at most "+w.maxChars+" character",w.maxChars>1&&(res+="s")),w.minWords&&w.maxWords?res2="beetween "+w.minWords+" and "+w.maxWords+" words":w.minWords?(res2="at least "+w.minWords+" word",w.minWords>1&&(res2+="s")):w.maxWords&&(res2="at most "+w.maxWords+" word",w.maxWords>1&&(res2+="s")),res?(res="("+res,res2&&(res+=", and "+res2),res+")"):!!res2&&"("+res2+")"},submit:"Submit feedback",label:"Any feedback? Let us know here:",sent:"Sent!",counter:function(w,param){var res;return res=param.chars?" character":" word",1!==param.len&&(res+="s"),param.needed?res+=" needed":param.over?res+=" over":param.justcount||(res+=" remaining"),res}},Feedback.dependencies={JSUS:{}},Feedback.prototype.init=function(options){if("string"==typeof options.mainText)this.mainText=options.mainText;else{if(void 0!==options.mainText)throw new TypeError("Feedback.init: options.mainText must be string or undefined. Found: "+options.mainText);this.mainText=this.getText("label")}if("string"==typeof options.hint||!1===options.hint)this.hint=options.hint;else{if(void 0!==options.hint)throw new TypeError("Feedback.init: options.hint must be a string, false, or undefined. Found: "+options.hint);this.hint=this.getText("autoHint")}},Feedback.prototype.verifyFeedback=function(markAttempt,updateUI){var feedback,length,res,submitButton,charCounter,wordCounter,tmp,updateCharCount,updateCharColor,updateWordCount,updateWordColor;return length=(feedback=getFeedback.call(this))?feedback.length:0,submitButton=this.submitButton,charCounter=this.charCounter,wordCounter=this.wordCounter,res=!0,length<this.minChars?(res=!1,updateCharCount=(tmp=this.minChars-length)+this.getText("counter",{chars:!0,needed:!0,len:tmp}),updateCharColor="#a32020"):this.maxChars&&length>this.maxChars?(res=!1,updateCharCount=(tmp=length-this.maxChars)+this.getText("counter",{chars:!0,over:!0,len:tmp}),updateCharColor="#a32020"):(updateCharCount=(tmp=this.maxChars?this.maxChars-length:length)+this.getText("counter",{chars:!0,len:tmp,justcount:!this.maxChars}),updateCharColor="#78b360"),wordCounter&&((length=(tmp=feedback?feedback.match(/\b[-?(\w+)?]+\b/gi):0)?tmp.length:0)<this.minWords?(res=!1,updateWordCount=(tmp=tmp=this.minWords-length)+this.getText("counter",{needed:!0,len:tmp}),updateWordColor="#a32020"):this.maxWords&&length>this.maxWords?(res=!1,updateWordCount=(tmp=length-this.maxWords)+this.getText("counter",{over:!0,len:tmp}),updateWordColor="#a32020"):(updateWordCount=(tmp=this.maxWords?this.maxWords-length:length)+this.getText("counter",{len:tmp,justcount:!this.maxWords}),updateWordColor="#78b360")),updateUI&&(submitButton&&(submitButton.disabled=!res),charCounter&&(charCounter.style.backgroundColor=updateCharColor,charCounter.innerHTML=updateCharCount),wordCounter&&(wordCounter.style.backgroundColor=updateWordColor,wordCounter.innerHTML=updateWordCount)),res||void 0!==markAttempt&&!markAttempt||(this.maxAttemptLength&&length>this.maxAttemptLength&&(feedback=feedback.substr(0,this.maxAttemptLength)),this.attempts.push(feedback)),res},Feedback.prototype.append=function(){var that;that=this,this.feedbackForm=W.append("form",this.bodyDiv,{className:"feedback-form"}),this.mainText&&(this.spanMainText=W.append("span",this.feedbackForm,{className:"feedback-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.spanMainText||this.feedbackForm,{className:"feedback-hint",innerHTML:this.hint}),this.textareaElement=W.append("textarea",this.feedbackForm,{className:"form-control feedback-textarea",type:"text",rows:this.rows}),this.showSubmit&&(this.submitButton=W.append("input",this.feedbackForm,{className:"btn btn-lg btn-primary",type:"submit",value:this.getText("submit")}),J.addEvent(this.feedbackForm,"submit",(function(event){event.preventDefault(),that.getValues(that.onsubmit)}))),this.showCounters(),J.addEvent(this.feedbackForm,"input",(function(){that.isHighlighted()&&that.unhighlight(),that.verifyFeedback(!1,!0)})),J.addEvent(this.feedbackForm,"click",(function(){that.isHighlighted()&&that.unhighlight()})),this.verifyFeedback(!1,!0)},Feedback.prototype.setValues=function(options){var feedback,maxChars,minChars,nWords,i;if((options=options||{}).feedback)feedback=options.feedback;else if(minChars=this.minChars||0,maxChars=this.maxChars?this.maxChars:this.maxWords?4*this.maxWords:minChars?minChars+80:80,feedback=J.randomString(J.randomInt(minChars,maxChars),"aA_1"),this.minWords&&(nWords=this.minWords-feedback.split(" ").length)>0)for(i=0;i<nWords;i++)feedback+=" "+i;this.textareaElement?this.textareaElement.value=feedback:this._feedback=feedback,this.timeInputBegin=J.now(),!1!==options.verify&&this.verifyFeedback(options.markAttempt,!0)},Feedback.prototype.getValues=function(opts){var feedback,res;return void 0!==(opts=opts||{}).say&&(console.log("***EmailForm.getValues: option say is deprecated,  use send.***"),opts.send=opts.say),void 0!==opts.sayAnyway&&(console.log("***EmailForm.getValues: option sayAnyway is deprecated, use sendAnyway.***"),opts.sendAnyway=opts.sayAnyway),void 0===opts.markAttempt&&(opts.markAttempt=!0),void 0===opts.highlight&&(opts.highlight=!0),feedback=getFeedback.call(this),opts.keepBreaks&&(feedback=feedback.replace(/\n\r?/g,"<br />")),!1!==opts.verify&&(res=this.verifyFeedback(opts.markAttempt,opts.updateUI)),!1===res&&(opts.updateUI||opts.highlight)&&this.highlight(),opts.feedbackOnly||(feedback={timeBegin:this.timeInputBegin,feedback:feedback,attempts:this.attempts,valid:res},opts.markAttempt&&(feedback.isCorrect=res)),""!==feedback&&(opts.send&&res||opts.sendAnyway)&&(this.sendValues({values:feedback}),opts.updateUI&&(this.submitButton.setAttribute("value",this.getText("sent")),this.submitButton.disabled=!0,this.textareaElement.disabled=!0)),opts.reset&&this.reset(),feedback},Feedback.prototype.sendValues=function(opts){var values;return values=(opts=opts||{feedbackOnly:!0}).values||this.getValues(opts),this.setMsg?("string"==typeof values&&(values={feedback:values}),node.set(values,opts.to||"SERVER")):node.say("feedback",opts.to||"SERVER",values),values},Feedback.prototype.highlight=function(border){if(border&&"string"!=typeof border)throw new TypeError("Feedback.highlight: border must be string or undefined. Found: "+border);this.isAppended()&&!0!==this.highlighted&&(this.textareaElement.style.border=border||"3px solid red",this.highlighted=!0,this.emit("highlighted",border))},Feedback.prototype.unhighlight=function(){this.isAppended()&&!0===this.highlighted&&(this.textareaElement.style.border="",this.highlighted=!1,this.emit("unhighlighted"))},Feedback.prototype.reset=function(){this.attempts=[],this.timeInputBegin=null,this._feedback=null,this.textareaElement&&(this.textareaElement.value=""),this.isHighlighted()&&this.unhighlight()},Feedback.prototype.disable=function(){this.textareaElement&&!this.textareaElement.disabled&&(this.disabled=!0,this.submitElement&&(this.submitElement.disabled=!0),this.textareaElement.disabled=!0,this.emit("disabled"))},Feedback.prototype.enable=function(){this.textareaElement&&this.textareaElement.disabled&&(this.disabled=!1,this.submitElement&&(this.submitElement.disabled=!1),this.textareaElement.disabled=!1,this.emit("enabled"))},Feedback.prototype.showCounters=function(){this.charCounter?this.charCounter.style.display="":(this.minChars||this.maxChars)&&(this.charCounter=W.append("span",this.feedbackForm,{className:"feedback-char-count badge",innerHTML:this.maxChars})),this.wordCounter?this.wordCounter.style.display="":(this.minWords||this.maxWords)&&(this.wordCounter=W.append("span",this.feedbackForm,{className:"feedback-char-count badge",innerHTML:this.maxWords}),this.charCounter&&(this.wordCounter.style["margin-left"]="10px"))},Feedback.prototype.hideCounters=function(){this.charCounter&&(this.charCounter.style.display="none"),this.wordCounter&&(this.wordCounter.style.display="none")}}(node),function(node){"use strict";node.widgets.register("GroupMalleability",GroupMalleability),GroupMalleability.version="0.1.0",GroupMalleability.description="Displays an interface to measure perception for group malleability.",GroupMalleability.title="Group Malleability",GroupMalleability.className="group-malleability";var items=["As hard as it is to admit, it is impossible to change the central characteristics of nationalities and groups.","Groups that are characterized by extreme and violent traits will never change as these traits are inherently ingrained in their nature.","Groups can sometimes change their outward behavior, but can never change who they really are.","Every nationality or group has a fixed set of beliefs and values that cannot be changed.","Social and political processes can lead to changes in a group's values and morality."],choices=[1,2,3,4,5,6,7],header=["Strongly Oppose","Somewhat Oppose","Slightly Oppose","Neutral","Slightly Favor","Somewhat Favor","Strongly Favor"];function GroupMalleability(){this.ctg=null,this.choices=choices,this.header=header,this.mainText=null}GroupMalleability.texts={mainText:"Show how much you favor or oppose each idea below by selecting a number from 1 to 7 on the scale below. <em>You can work quickly, your first feeling is generally best.</em>"},GroupMalleability.dependencies={},GroupMalleability.prototype.init=function(opts){if((opts=opts||{}).choices){if(!J.isArray(opts.choices)||opts.choices.length<2)throw new Error("GroupMalleability.init: choices must be an array of length > 1 or undefined. Found: "+opts.choices);this.choices=opts.choices}if(opts.header){if(!J.isArray(opts.header)||opts.header.length!==this.choices.length)throw new Error("GroupMalleability.init: header must be an array of length equal to the number of choices or undefined. Found: "+opts.header);this.header=opts.header}if(opts.mainText){if("string"!=typeof opts.mainText&&!1!==opts.mainText)throw new Error("GroupMalleability.init: mainText must be string, false, or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}else!1!==opts.mainText&&(this.mainText=this.getText("mainText"))},GroupMalleability.prototype.append=function(){this.ctg=node.widgets.add("ChoiceTableGroup",this.panelDiv,{id:this.id||"groupmalleability_choicetable",items:items.map((function(item,i){return["GM_"+(i+1),item]})),choices:this.choices,mainText:this.mainText,title:!1,panel:!1,requiredChoice:this.required,header:this.header})},GroupMalleability.prototype.getValues=function(opts){return opts=opts||{},this.ctg.getValues(opts)},GroupMalleability.prototype.setValues=function(opts){return opts=opts||{},this.ctg.setValues(opts)},GroupMalleability.prototype.enable=function(opts){return this.ctg.enable(opts)},GroupMalleability.prototype.disable=function(opts){return this.ctg.disable(opts)},GroupMalleability.prototype.highlight=function(opts){return this.ctg.highlight(opts)},GroupMalleability.prototype.unhighlight=function(opts){return this.ctg.unhighlight(opts)}}(node),function(node){"use strict";function LanguageSelector(options){var that=this;this.options=options,this.availableLanguages={en:{name:"English",nativeName:"English",shortName:"en"}},this.currentLanguage=null,this.buttonListLength=null,this.displayForm=null,this.optionsLabel={},this.optionsDisplay={},this.loadingDiv=null,this.languagesLoaded=!1,this.usingButtons=!0,this.updatePlayer="ondone",this.setUriPrefix=!0,this.notifyServer=!0,this.onLangCallback=function(msg){for(var language;that.displayForm.firstChild;)that.displayForm.removeChild(that.displayForm.firstChild);if(that.availableLanguages=msg.data,that.usingButtons)for(language in msg.data)msg.data.hasOwnProperty(language)&&(that.optionsLabel[language]=W.get("label",{id:language+"Label",for:language+"RadioButton"}),that.optionsDisplay[language]=W.get("input",{id:language+"RadioButton",type:"radio",name:"languageButton",value:msg.data[language].name}),that.optionsDisplay[language].onclick=makeSetLanguageOnClick(language),that.optionsLabel[language].appendChild(that.optionsDisplay[language]),that.optionsLabel[language].appendChild(document.createTextNode(msg.data[language].nativeName)),W.add("br",that.displayForm),that.optionsLabel[language].className="unselectedButtonLabel",that.displayForm.appendChild(that.optionsLabel[language]));else{for(language in that.displaySelection=W.get("select","selectLanguage"),msg.data)that.optionsLabel[language]=document.createTextNode(msg.data[language].nativeName),that.optionsDisplay[language]=W.get("option",{id:language+"Option",value:language}),that.optionsDisplay[language].appendChild(that.optionsLabel[language]),that.displaySelection.appendChild(that.optionsDisplay[language]);that.displayForm.appendChild(that.displaySelection),that.displayForm.onchange=function(){that.setLanguage(that.displaySelection.value,"onselect"===that.updatePlayer)}}function makeSetLanguageOnClick(langStr){return function(){that.setLanguage(langStr,"onselect"===that.updatePlayer)}}that.loadingDiv.style.display="none",that.languagesLoaded=!0,that.setLanguage(node.player.lang.shortName||"en",!1),that.onLangCallbackExtension&&(that.onLangCallbackExtension(msg),that.onLangCallbackExtension=null)},this.onLangCallbackExtension=null}node.widgets.register("LanguageSelector",LanguageSelector),LanguageSelector.version="0.6.2",LanguageSelector.description="Display information about the current language and allows to change language.",LanguageSelector.title="Language",LanguageSelector.className="languageselector",LanguageSelector.texts.loading="Loading language information...",LanguageSelector.dependencies={JSUS:{}},LanguageSelector.prototype.init=function(options){if(J.mixout(options,this.options),this.options=options,void 0!==this.options.usingButtons&&(this.usingButtons=!!this.options.usingButtons),void 0!==this.options.notifyServer)if(!1===this.options.notifyServer)this.options.notifyServer="never";else{if("string"!=typeof this.options.notifyServer)throw new Error("LanguageSelector.init: options.notifyServer must be "+this.options.notifyServer);if("never"!==this.options.notifyServer&&"onselect"!==this.options.notifyServer&&"ondone"!==this.options.notifyServer)throw new Error('LanguageSelector.init: invalid value for notifyServer: "'+this.options.notifyServer+'". Valid values: "never","onselect", "ondone".');this.notifyServer=this.options.notifyServer}void 0!==this.options.setUriPrefix&&(this.setUriPrefix=!!this.options.setUriPrefix),node.on.lang(this.onLangCallback),this.displayForm=W.get("form","radioButtonForm"),this.loadingDiv=W.add("div",this.displayForm),this.loadingDiv.innerHTML=this.getText("loading"),this.loadLanguages()},LanguageSelector.prototype.append=function(){this.bodyDiv.appendChild(this.displayForm)},LanguageSelector.prototype.setLanguage=function(langName,updatePlayer){this.usingButtons&&null!==this.currentLanguage&&this.currentLanguage!==this.availableLanguages[langName]&&(this.optionsDisplay[this.currentLanguage].checked="unchecked",this.optionsLabel[this.currentLanguage].className="unselectedButtonLabel"),this.currentLanguage=langName,this.usingButtons?(this.optionsDisplay[this.currentLanguage].checked="checked",this.optionsLabel[this.currentLanguage].className="selectedButtonLabel"):this.displaySelection.value=this.currentLanguage,!1!==updatePlayer&&node.setLanguage(this.availableLanguages[this.currentLanguage],this.setUriPrefix,this.notifyServer)},LanguageSelector.prototype.updateAvalaibleLanguages=function(options){options&&options.callback&&(this.onLangCallbackExtension=options.callback),node.socket.send(node.msg.create({target:"LANG",to:"SERVER",action:"get"}))},LanguageSelector.prototype.loadLanguages=function(options){this.languagesLoaded?options&&options.callback&&options.callback():this.updateAvalaibleLanguages(options)},LanguageSelector.prototype.listeners=function(){var that;that=this,node.events.step.on("REALLY_DONE",(function(){"ondone"===that.updatePlayer&&node.setLanguage(that.availableLanguages[that.currentLanguage],that.setUriPrefix,that.notifyServer)}))}}(node),function(node){"use strict";function MoneyTalks(){this.spanCurrency=null,this.spanMoney=null,this.currency="ECU",this.money=0,this.precision=2,this.showCurrency=!0,this.classnameCurrency="moneytalkscurrency",this.classnameMoney="moneytalksmoney"}node.widgets.register("MoneyTalks",MoneyTalks),MoneyTalks.version="0.5.0",MoneyTalks.description="Displays the earnings of a player.",MoneyTalks.title="Earnings",MoneyTalks.className="moneytalks",MoneyTalks.dependencies={JSUS:{}},MoneyTalks.prototype.init=function(options){"string"==typeof(options=options||{}).currency&&(this.currency=options.currency),void 0!==options.showCurrency&&(this.showCurrency=!!options.showCurrency),"number"==typeof options.money&&(this.money=options.money),"number"==typeof options.precision&&(this.precision=options.precision),"string"==typeof options.MoneyClassName&&(this.classnameMoney=options.MoneyClassName),"string"==typeof options.currencyClassName&&(this.classnameCurrency=options.currencyClassName)},MoneyTalks.prototype.append=function(){this.spanMoney||(this.spanMoney=document.createElement("span")),this.spanCurrency||(this.spanCurrency=document.createElement("span")),this.showCurrency||(this.spanCurrency.style.display="none"),this.spanMoney.className=this.classnameMoney,this.spanCurrency.className=this.classnameCurrency,this.spanCurrency.innerHTML=this.currency,this.spanMoney.innerHTML=this.money,this.bodyDiv.appendChild(this.spanMoney),this.bodyDiv.appendChild(this.spanCurrency)},MoneyTalks.prototype.listeners=function(){var that=this;node.on("MONEYTALKS",(function(amount,clear){that.update(amount,clear)}))},MoneyTalks.prototype.update=function(amount,clear){var parsedAmount;if(!1!==(parsedAmount=J.isNumber(amount)))return clear&&(this.money=0),this.money+=parsedAmount,this.spanMoney.innerHTML=this.money.toFixed(this.precision),this.money;node.err("MoneyTalks.update: invalid amount: "+amount)},MoneyTalks.prototype.getValues=function(){return this.money}}(node),function(node){"use strict";function MoodGauge(options){this.methods={},this.method="I-PANAS-SF",this.mainText=null,this.gauge=null,this.addMethod("I-PANAS-SF",I_PANAS_SF)}function I_PANAS_SF(options){var items,emotions,choices,right,i,len;for(choices=options.choices||["1","2","3","4","5"],emotions=options.emotions||["Upset","Hostile","Alert","Ashamed","Inspired","Nervous","Determined","Attentive","Afraid","Active"],options.left||"never",right=options.right||"always",len=emotions.length,items=new Array(len),i=-1;++i<len;)items[i]={id:emotions[i],left:'<span class="emotion">'+emotions[i]+":</span> never",right:right,choices:choices};return node.widgets.get("ChoiceTableGroup",{id:options.id||"ipnassf",items:items,mainText:this.mainText||this.getText("mainText"),title:!1,requiredChoice:!0,storeRef:!1})}node.widgets.register("MoodGauge",MoodGauge),MoodGauge.version="0.4.0",MoodGauge.description="Displays an interface to measure mood and emotions.",MoodGauge.title="Mood Gauge",MoodGauge.className="moodgauge",MoodGauge.texts.mainText="Thinking about yourself and how you normally feel, to what extent do you generally feel: ",MoodGauge.dependencies={JSUS:{}},MoodGauge.prototype.init=function(opts){var gauge;if(void 0!==opts.method){if("string"!=typeof opts.method)throw new TypeError("MoodGauge.init: method must be string or undefined: "+opts.method);if(!this.methods[opts.method])throw new Error("MoodGauge.init: method is invalid: "+opts.method);this.method=opts.method}if(opts.mainText){if("string"!=typeof opts.mainText)throw new TypeError("MoodGauge.init: mainText must be string or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}gauge=this.methods[this.method].call(this,opts),function(method,gauge){if(!gauge)throw new Error("MoodGauge.init: method "+method+"did not create element gauge.");if("function"!=typeof gauge.getValues)throw new Error("MoodGauge.init: method "+method+": gauge missing function getValues.");if("function"!=typeof gauge.enable)throw new Error("MoodGauge.init: method "+method+": gauge missing function enable.");if("function"!=typeof gauge.disable)throw new Error("MoodGauge.init: method "+method+": gauge missing function disable.");if("function"!=typeof gauge.append)throw new Error("MoodGauge.init: method "+method+": gauge missing function append.")}(this.method,gauge),this.gauge=gauge,this.on("enabled",(function(){gauge.enable()})),this.on("disabled",(function(){gauge.disable()})),this.on("highlighted",(function(){gauge.highlight()})),this.on("unhighlighted",(function(){gauge.unhighlight()}))},MoodGauge.prototype.append=function(){node.widgets.append(this.gauge,this.bodyDiv,{panel:!1})},MoodGauge.prototype.addMethod=function(name,cb){if("string"!=typeof name)throw new Error("MoodGauge.addMethod: name must be string: "+name);if("function"!=typeof cb)throw new Error("MoodGauge.addMethod: cb must be function: "+cb);if(this.methods[name])throw new Error("MoodGauge.addMethod: name already existing: "+name);this.methods[name]=cb},MoodGauge.prototype.getValues=function(opts){return this.gauge.getValues(opts)},MoodGauge.prototype.setValues=function(opts){return this.gauge.setValues(opts)}}(node),function(node){"use strict";function Requirements(options){this.requirements=[],this.stillChecking=0,this.withTimeout=options.withTimeout||!0,this.timeoutTime=options.timeoutTime||1e4,this.timeoutId=null,this.summary=null,this.summaryUpdate=null,this.summaryResults=null,this.dots=null,this.hasFailed=!1,this.results=[],this.completed={},this.sayResults=options.sayResults||!1,this.sayResultsLabel=options.sayResultLabel||"requirements",this.addToResults=options.addToResults||null,this.onComplete=null,this.onSuccess=null,this.onFailure=null,this.callbacksExecuted=!1,this.list=new W.List({render:{pipeline:function(o){var imgPath,img,span,text;imgPath="/images/"+(o.content.success?"success-icon.png":"delete-icon.png"),(img=document.createElement("img")).src=imgPath,"object"==typeof o.content.text&&(o.content.text=extractErrorMsg(o.content.text));return text=document.createTextNode(o.content.text),(span=document.createElement("span")).className="requirement",span.appendChild(img),span.appendChild(text),span},returnAt:"first"}})}function resultCb(that,name,i){var req,update,res;if(update=function(success,errors,data){if(that.completed[name])throw new Error("Requirements.checkRequirements: test already completed: "+name);if(that.completed[name]=!0,that.updateStillChecking(-1),success||(that.hasFailed=!0),"string"==typeof errors&&(errors=[errors]),errors){if(!J.isArray(errors))throw new Error("Requirements.checkRequirements: errors must be array or undefined. Found: "+errors);that.displayResults(errors)}that.results.push({name:name,success:success,errors:errors,data:data}),that.isCheckingFinished()&&that.checkingFinished()},"function"==typeof(req=that.requirements[i]))res=req(update);else{if("object"!=typeof req)throw new TypeError("Requirements.checkRequirements: invalid requirement: "+name+".");res=req.cb(update,req.params||{})}res&&update(res.success,res.errors,res.data)}function extractErrorMsg(e){var errMsg;return errMsg=e.msg?e.msg:e.message?e.message:e.description?errMsg.description:e.toString()}node.widgets.register("Requirements",Requirements),Requirements.version="0.7.2",Requirements.description="Checks a set of requirements and display the results",Requirements.title="Requirements",Requirements.className="requirements",Requirements.texts.errStr="One or more function is taking too long. This is likely to be due to a compatibility issue with your browser or to bad network connectivity.",Requirements.texts.testPassed="All tests passed.",Requirements.dependencies={JSUS:{},List:{}},Requirements.prototype.init=function(conf){if("object"!=typeof conf)throw new TypeError("Requirements.init: conf must be object. Found: "+conf);if(conf.requirements){if(!J.isArray(conf.requirements))throw new TypeError("Requirements.init: conf.requirements must be array or undefined. Found: "+conf.requirements);this.requirements=conf.requirements}if(void 0!==conf.onComplete){if(null!==conf.onComplete&&"function"!=typeof conf.onComplete)throw new TypeError("Requirements.init: conf.onComplete must be function, null or undefined. Found: "+conf.onComplete);this.onComplete=conf.onComplete}if(void 0!==conf.onSuccess){if(null!==conf.onSuccess&&"function"!=typeof conf.onSuccess)throw new TypeError("Requirements.init: conf.onSuccess must be function, null or undefined. Found: "+conf.onSuccess);this.onSuccess=conf.onSuccess}if(void 0!==conf.onFailure){if(null!==conf.onFailure&&"function"!=typeof conf.onFailure)throw new TypeError("Requirements.init: conf.onFailure must be function, null or undefined. Found: "+conf.onFailure);this.onFailure=conf.onFailure}if(conf.maxExecTime){if(null!==conf.maxExecTime&&"number"!=typeof conf.maxExecTime)throw new TypeError("Requirements.init: conf.onMaxExecTime must be number, null or undefined. Found: "+conf.maxExecTime);this.withTimeout=!!conf.maxExecTime,this.timeoutTime=conf.maxExecTime}},Requirements.prototype.addRequirements=function(){var i,len;for(i=-1,len=arguments.length;++i<len;){if("function"!=typeof arguments[i]&&"object"!=typeof arguments[i])throw new TypeError("Requirements.addRequirements: requirements must be function or object. Found: "+arguments[i]);this.requirements.push(arguments[i])}},Requirements.prototype.checkRequirements=function(display){var i,len,errors,cbName,errMsg;if(!this.requirements.length)throw new Error("Requirements.checkRequirements: no requirements to check.");for(this.updateStillChecking(this.requirements.length,!0),errors=[],i=-1,len=this.requirements.length;++i<len;){cbName=this.requirements[i]&&this.requirements[i].name?this.requirements[i].name:i+1;try{resultCb(this,cbName,i)}catch(e){this.hasFailed=!0,errMsg=extractErrorMsg(e),this.updateStillChecking(-1),errors.push("An error occurred in requirement n."+cbName+": "+errMsg)}}return this.withTimeout&&this.addTimeout(),void 0===display&&this.displayResults(errors),this.isCheckingFinished()&&this.checkingFinished(),errors},Requirements.prototype.addTimeout=function(){var that=this;this.timeoutId=setTimeout((function(){that.stillChecking>0&&that.displayResults([that.getText("errStr")]),that.timeoutId=null,that.hasFailed=!0,that.checkingFinished()}),this.timeoutTime)},Requirements.prototype.clearTimeout=function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)},Requirements.prototype.updateStillChecking=function(update,absolute){var total,remaining;this.stillChecking=absolute?update:this.stillChecking+update,remaining=(total=this.requirements.length)-this.stillChecking,this.summaryUpdate.innerHTML=" ("+remaining+" / "+total+")"},Requirements.prototype.isCheckingFinished=function(){return this.stillChecking<=0},Requirements.prototype.checkingFinished=function(force){var results;this.callbacksExecuted&&!force||(this.callbacksExecuted=!0,this.timeoutId&&clearTimeout(this.timeoutId),this.dots.stop(),this.sayResults&&(results={success:!this.hasFailed,results:this.results},this.addToResults&&J.mixin(results,this.addToResults()),node.say(this.sayResultsLabel,"SERVER",results)),this.onComplete&&this.onComplete(),this.hasFailed?this.onFailure&&this.onFailure():this.onSuccess&&this.onSuccess())},Requirements.prototype.displayResults=function(results){var i,len;if(!this.list)throw new Error("Requirements.displayResults: list not found. Have you called .append() first?");if(!J.isArray(results))throw new TypeError("Requirements.displayResults: results must be array. Found: "+results);if(!this.hasFailed&&this.stillChecking<=0)this.list.addDT({success:!0,text:this.getText("testPassed")});else for(i=-1,len=results.length;++i<len;)this.list.addDT({success:!1,text:results[i]});this.list.parse()},Requirements.prototype.append=function(){this.summary=document.createElement("span"),this.summary.appendChild(document.createTextNode("Evaluating requirements")),this.summaryUpdate=document.createElement("span"),this.summary.appendChild(this.summaryUpdate),this.dots=W.getLoadingDots(),this.summary.appendChild(this.dots.span),this.summaryResults=document.createElement("div"),this.summary.appendChild(document.createElement("br")),this.summary.appendChild(this.summaryResults),this.bodyDiv.appendChild(this.summary),this.bodyDiv.appendChild(this.list.getRoot())},Requirements.prototype.listeners=function(){var that;that=this,node.registerSetup("requirements",(function(conf){if(conf){if("object"==typeof conf)return that.init(conf),!1!==conf.doChecking&&that.checkRequirements(),conf;node.warn("requirements widget: invalid setup object: "+conf)}})),this.on("destroyed",(function(){node.deregisterSetup("requirements")}))}}(node),function(node){"use strict";function RiskGauge(){this.methods={},this.method="Holt_Laury",this.mainText=null,this.gauge=null,this.addMethod("Holt_Laury",holtLaury),this.addMethod("Bomb",bomb)}function makeProbString(p1,v1,p2,v2,opts){var of,cur,sep,out;return of=(opts=opts||{}).of||" chance to win ",cur=opts.currency||"$",sep=opts.sep||'<span class="sep">and</span>',out=p1+of,out+=opts.currencyAfter?v1+cur:cur+v1,(out+=sep+p2+of)+(opts.currencyAfter?v2+cur:cur+v2)}function holtLaury(options){var items,i,j,tmp,v1,v2,v3,v4,p1,p2;for(tmp=options.values||[2,1.6,3.85,.1],options.scale&&(tmp=tmp.map((function(i){return i*options.scale}))),v1=tmp[0].toFixed(2),v2=tmp[1].toFixed(2),v3=tmp[2].toFixed(2),v4=tmp[3].toFixed(2),10,items=new Array(10),i=0;i<10;i++)p1=(j=i+1)+"/10",p2=10-j+"/10",items[i]={id:"hl_"+j,left:j+". ",choices:[makeProbString(p1,v1,p2,v2,options),makeProbString(p1,v3,p2,v4,options)]};return node.widgets.get("ChoiceTableGroup",{id:options.id||"holt_laury",items:items,mainText:this.mainText||this.getText("holt_laury_mainText"),title:!1,requiredChoice:!0,storeRef:!1})}function bomb(opts){var that,probBomb,bombBox,infoDiv,bombResult,slider,button,isWinner,finalValue;if(that=this,opts.boxHeight){if("string"!=typeof opts.boxHeight)throw new Error("Bomb.init: boxHeight must be string or undefined. Found: "+opts.boxHeight);W.cssRule("div.riskgauge .bomb-box { height: "+opts.boxHeight+"}")}if(void 0!==opts.probBomb){if(!1===J.isNumber(opts.probBomb,0,1,!0,!0))throw new Error("Bomb.init: probBomb must be a number between 0 and 1 or undefined. Found: "+opts.probBomb);probBomb=opts.probBomb}else probBomb=1;if(this._highlight=this.highlight,this._unhighlight=this.unhighlight,void 0!==opts.boxValue){if(this.boxValue=J.isNumber(opts.boxValue,0),!this.boxValue)throw new TypeError("Bomb.init: boxValue must be an a number > 0 or undefined. Found: "+opts.boxValue)}else this.boxValue=.01;if(this.currency=opts.currency||"USD",this.revealProbBomb=void 0===opts.revealProbBomb||!!opts.revealProbBomb,void 0!==opts.totBoxes){if(!J.isInt(opts.totBoxes,0,1e4,!1,!0))throw new TypeError("Bomb.init: maxBoxes must be an integer > 0 and <= 10000 or undefined. Found: "+opts.totBoxes);this.totBoxes=opts.totBoxes}else this.totBoxes=100;if(void 0!==opts.maxBoxes){if(!J.isInt(opts.maxBoxes,0,this.totBoxes))throw new TypeError("Bomb.init: maxBoxes must be a positive integer <= "+this.totBoxes+" or undefined. Found: "+opts.maxBoxes);this.maxBoxes=opts.maxBoxes}else this.maxBoxes=1===probBomb?this.totBoxes-1:this.totBoxes;if(void 0!==opts.boxesInRow){if(!J.isInt(opts.boxesInRow,0))throw new TypeError("Bomb.init: boxesInRow must be a positive integer or undefined. Found: "+opts.boxesInRow);this.boxesInRow=opts.boxesInRow>this.totBoxes?this.totBoxes:opts.boxesInRow}else this.boxesInRow=this.totBoxes<10?this.totBoxes:10;return this.withPrize=void 0===opts.withPrize||!!opts.withPrize,bombBox=Math.random()>=probBomb?-1:Math.ceil(Math.random()*this.totBoxes),{setValues:function(opts){slider.setValues(opts)},getValues:function(opts){var out,values,nb,ic;return opts=opts||{},values=slider.getValues(),void 0!==finalValue?(nb=finalValue,ic=!0):(nb=parseInt(slider.slider.value,10),ic=!1),(out={value:nb,isCorrect:ic,totalMove:values.totalMove,isWinner:isWinner,time:values.time,reward:0}).isCorrect||void 0!==opts.highlight&&!opts.highlight||slider.highlight(),!0===isWinner&&(out.reward=finalValue*that.boxValue),out},highlight:function(){slider.highlight()},unhighlight:function(){slider.unhighlight()},append:function(){var nRows;W.add("div",that.bodyDiv,{innerHTML:that.mainText||that.getText("bomb_mainText",probBomb)}),slider=node.widgets.add("Slider",that.bodyDiv,{min:0,max:that.maxBoxes,hint:that.getText("bomb_sliderHint"),title:!1,initialValue:0,displayValue:!1,displayNoChange:!1,type:"flat",required:!0,panel:!1,onmove:function(value){var i,c,v;for(that._unhighlight(),value>0?(button.style.display="",button.disabled=!1,bombResult.innerHTML=""):(button.style.display="none",bombResult.innerHTML=that.getText("bomb_warn"),button.disabled=!0),i=0;i<that.maxBoxes;i++)W.gid(getBoxId(i)).style.background=value>i?"#1be139":"#000000";W.gid("bomb_numBoxes").innerText=value,c=that.currency,v=that.boxValue,that.withPrize&&(W.gid("bomb_boxValue").innerText=v+c,W.gid("bomb_totalWin").innerText=Number(value*v).toFixed(2)+c)},storeRef:!1,width:"100%"}),nRows=Math.ceil(that.totBoxes/that.boxesInRow),W.add("div",that.bodyDiv,{innerHTML:makeTable(nRows,that.boxesInRow,that.totBoxes)}),infoDiv=W.add("div",that.bodyDiv,{className:"risk-info"}),W.add("p",infoDiv,{innerHTML:that.getText("bomb_numBoxes")+'&nbsp;<span id="bomb_numBoxes">0</span>'}),that.withPrize&&(W.add("p",infoDiv,{innerHTML:that.getText("bomb_boxValue")+'&nbsp;<span id="bomb_boxValue">'+this.boxValue+"</span>"}),W.add("p",infoDiv,{innerHTML:that.getText("bomb_totalWin")+'&nbsp;<span id="bomb_totalWin">0</span>'})),bombResult=W.add("p",infoDiv,{id:"bomb_result"}),(button=W.add("button",that.bodyDiv,{className:"btn-danger",innerHTML:that.getText("bomb_openButton")})).style.display="none",button.onclick=function(){var cl;finalValue=parseInt(slider.slider.value,10),bombBox>-1?(W.gid(getBoxId(bombBox-1)).style.background="#fa0404",isWinner=finalValue<bombBox):isWinner=!0,slider.hide(),W.hide(button),cl="bomb_"+(isWinner?"won":"lost"),bombResult.innerHTML=that.getText(cl),bombResult.className+=" "+cl}}}}function getBoxId(i){return"bc_"+i}function makeBoxRow(rowId,boxesInRow,colSpan){var i,out;for(out="<tr>",i=0;i<boxesInRow;i++){if(colSpan&&i>colSpan){out=out+'<td colspan="'+(boxesInRow-colSpan)+'"></td>';break}out=out+'<td><div class="bomb-box square" id="'+getBoxId(i+boxesInRow*rowId)+'"></td>'}return out+="</tr>"}function makeTable(nRows,boxesInRow,totBoxes){var rowId,out,colSpan;for(out='<table class="bomb-table">',rowId=0;rowId<nRows;rowId++)(rowId+1)*boxesInRow>totBoxes&&(colSpan=totBoxes-rowId*boxesInRow-1),out+=makeBoxRow(rowId,boxesInRow,colSpan);return out+="</table><br>"}node.widgets.register("RiskGauge",RiskGauge),RiskGauge.version="0.8.0",RiskGauge.description="Displays an interface to measure risk preferences with different methods.",RiskGauge.title="Risk Gauge",RiskGauge.className="riskgauge",RiskGauge.texts={holt_laury_mainText:"Below you find a series of hypothetical lotteries, each contains two lotteries with different probabalities of winning. In each row, select the lottery you would rather take part in.",bomb_mainText:function(widget,probBomb){var str;return str='<p style="margin-bottom: 0.3em">',str+="Below there are "+widget.totBoxes+" black boxes. ",str+="Every box contains a prize of "+widget.boxValue+" "+widget.currency+", but ",1===probBomb?str+="one random box contains a <em>bomb</em>.":widget.revealProbBomb?str+="with probability "+probBomb+" one random box contains a <em>bomb</em>.":str+="one random box might contain a <em>bomb</em>.",str+=" You must decide how many boxes you want to open.",str+="</p>",widget.withPrize&&(str+='<p style="margin-bottom: 0.3em">',str+="You will receive a reward equal to the sum of all the prizes in every opened box. However, if you open the box with the bomb, you get nothing.</p>"),str+='<p style="margin-bottom: 0.5em">',str+="<strong>How many boxes do you want to open ",str+="between 1 and "+widget.maxBoxes+"?</strong></p>"},bomb_sliderHint:'Move the slider to choose the number of boxes to open, then click "Open Boxes"',bomb_boxValue:"Prize per box: ",bomb_numBoxes:"Number of boxes: ",bomb_totalWin:"Total reward: ",bomb_openButton:"Open Boxes",bomb_warn:"Open at least one box.",bomb_won:"You won! You did not open the box with the bomb.",bomb_lost:"You lost! You opened the box with the bomb."},RiskGauge.texts.mainText=RiskGauge.texts.holt_laury_mainText,RiskGauge.dependencies={JSUS:{}},RiskGauge.prototype.init=function(opts){var gauge,that;if(void 0!==opts.method){if("string"!=typeof opts.method)throw new TypeError("RiskGauge.init: method must be string or undefined: "+opts.method);if(!this.methods[opts.method])throw new Error("RiskGauge.init: method is invalid: "+opts.method);this.method=opts.method}if(opts.mainText){if("string"!=typeof opts.mainText)throw new TypeError("RiskGauge.init: mainText must be string or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}if(gauge=this.methods[this.method].call(this,opts),that=this,gauge.isHidden=function(){return that.isHidden()},gauge.isCollapsed=function(){return that.isCollapsed()},!node.widgets.isWidget(gauge))throw new Error("RiskGauge.init: method "+this.method+" created invalid gauge: missing default widget methods.");this.gauge=gauge,this.on("enabled",(function(){gauge.enable&&gauge.enable()})),this.on("disabled",(function(){gauge.disable&&gauge.disable()})),this.on("highlighted",(function(){gauge.highlight&&gauge.highlight()})),this.on("unhighlighted",(function(){gauge.unhighlight&&gauge.unhighlight()}))},RiskGauge.prototype.append=function(){node.widgets.append(this.gauge,this.bodyDiv,{panel:!1})},RiskGauge.prototype.addMethod=function(name,cb){if("string"!=typeof name)throw new TypeError("RiskGauge.addMethod: name must be string: "+name);if("function"!=typeof cb)throw new TypeError("RiskGauge.addMethod: cb must be function: "+cb);if(this.methods[name])throw new Error("RiskGauge.addMethod: name already existing: "+name);this.methods[name]=cb},RiskGauge.prototype.getValues=function(opts){return this.gauge.getValues(opts)},RiskGauge.prototype.setValues=function(opts){return this.gauge.setValues(opts)}}(node),function(node){"use strict";node.widgets.register("SDO",SDO),SDO.version="0.3.0",SDO.description="Displays an interface to measure Social Dominance Orientation (S.D.O.).",SDO.title="SDO",SDO.className="SDO";var scales={SDO7:["Some groups of people must be kept in their place.","It's probably a good thing that certain groups are at the top and other groups are at the bottom.","An ideal society requires some groups to be on top and others to be on the bottom.","Some groups of people are simply inferior to other groups.","Groups at the bottom are just as deserving as groups at the top.","No one group should dominate in society.","Groups at the bottom should not have to stay in their place.","Group dominance is a poor principle.","We should not push for group equality.","We shouldn't try to guarantee that every group has the same quality of life.","It is unjust to try to make groups equal.","Group equality should not be our primary goal.","We should work to give all groups an equal chance to succeed.","We should do what we can to equalize conditions for different groups.","No matter how much effort it takes, we ought to strive to ensure that all groups have the same chance in life.","Group equality should be our ideal."],SDO16:["Some groups of people are simply inferior to other groups.","In getting what you want, it is sometimes necessary to use force against other groups.","It's OK if some groups have more of a chance in life than others.","To get ahead in life, it is sometimes necessary to step on other groups.","If certain groups stayed in their place, we would have fewer problems.","It's probably a good thing that certain groups are at the top and other groups are at the bottom.","Inferior groups should stay in their place.","Sometimes other groups must be kept in their place.","It would be good if groups could be equal.","Group equality should be our ideal.","All groups should be given an equal chance in life.","We should do what we can to equalize conditions for different groups.","Increased social equality is beneficial to society.","We would have fewer problems if we treated people more equally.","We should strive to make incomes as equal as possible.","No group should dominate in society."]};scales.SDO7s=[scales.SDO7[2],scales.SDO7[3],scales.SDO7[5],scales.SDO7[6],scales.SDO7[11],scales.SDO7[10],scales.SDO7[13],scales.SDO7[12]];var choices=[1,2,3,4,5,6,7],header=["Strongly Oppose","Somewhat Oppose","Slightly Oppose","Neutral","Slightly Favor","Somewhat Favor","Strongly Favor"];function SDO(){this.sdo=null,this.scale="SDO7s",this.choices=choices,this.header=header,this.mainText=null}SDO.texts={mainText:"Show how much you favor or oppose each idea below by selecting a number from 1 to 7 on the scale below. <em>You can work quickly, your first feeling is generally best.</em>"},SDO.dependencies={},SDO.prototype.init=function(opts){if((opts=opts||{}).scale){if("SDO16"!==opts.scale&&"SDO7"!==opts.scale&&"SDO7s"!==opts.scale)throw new Error("SDO.init: scale must be SDO16, SDO7, SDO7s or undefined. Found: "+opts.scale);this.scale=opts.scale}if(opts.choices){if(!J.isArray(opts.choices)||opts.choices.length<2)throw new Error("SDO.init: choices must be an array of length > 1 or undefined. Found: "+opts.choices);this.choices=opts.choices}if(opts.header){if(!J.isArray(opts.header)||opts.header.length!==this.choices.length)throw new Error("SDO.init: header must be an array of length equal to the number of choices or undefined. Found: "+opts.header);this.header=opts.header}if(opts.mainText){if("string"!=typeof opts.mainText&&!1!==opts.mainText)throw new Error("SDO.init: mainText must be string, false, or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}},SDO.prototype.append=function(){this.sdo=node.widgets.add("ChoiceTableGroup",this.panelDiv,{id:this.id||"SDO_choicetable",items:this.getItems(this.scale),choices:this.choices,mainText:this.mainText||this.getText("mainText"),title:!1,panel:!1,requiredChoice:this.required,header:this.header})},SDO.prototype.getItems=function(){var s=this.scale;return scales[s].map((function(item,idx){return[s+"_"+(idx+1),item]}))},SDO.prototype.getValues=function(opts){return opts=opts||{},this.sdo.getValues(opts)},SDO.prototype.setValues=function(opts){return opts=opts||{},this.sdo.setValues(opts)},SDO.prototype.enable=function(opts){return this.sdo.enable(opts)},SDO.prototype.disable=function(opts){return this.sdo.disable(opts)},SDO.prototype.highlight=function(opts){return this.sdo.highlight(opts)},SDO.prototype.unhighlight=function(opts){return this.sdo.unhighlight(opts)}}(node),function(node){"use strict";function Slider(){var that;that=this,this.slider=null,this.rangeFill=null,this.scale=1,this.currentValue=50,this.initialValue=50,this.mainText=null,this.required=null,this.requiredChoice=null,this.hint=null,this.min=0,this.max=100,this.correctValue=null,this.displayValue=!0,this.valueSpan=null,this.displayNoChange=!0,this.noChangeSpan=null,this.totalMove=0,this.type="volume",this.hoverColor="#2076ea";var timeOut=null;this.listener=function(noChange){!noChange&&timeOut||(that.isHighlighted()&&that.unhighlight(),timeOut=setTimeout((function(){var percent,diffPercent;diffPercent=(percent=(that.slider.value-that.min)*that.scale)-that.currentValue,that.currentValue=percent,"volume"===that.type?(percent>99&&(percent=99),that.rangeFill.style.width=percent+"%"):that.rangeFill.style.width="99%",that.displayValue&&(that.valueSpan.innerHTML=that.getText("currentValue",that.slider.value)),that.displayNoChange&&!0!==noChange&&that.noChangeCheckbox.checked&&(that.noChangeCheckbox.checked=!1,J.removeClass(that.noChangeSpan,"italic")),that.totalMove+=Math.abs(diffPercent),that.onmove&&that.onmove.call(that,that.slider.value,diffPercent),timeOut=null}),0))},this.onmove=null,this.timeFrom="step"}node.widgets.register("Slider",Slider),Slider.version="0.4.0",Slider.description="Creates a configurable slider",Slider.title=!1,Slider.className="slider",Slider.texts={currentValue:function(widget,value){return"Value: "+value},noChange:"No change"},Slider.prototype.init=function(opts){var tmp,e;if(e="Slider.init: ",void 0!==opts.min){if("number"!=typeof(tmp=J.isInt(opts.min)))throw new TypeError(e+"min must be an integer or undefined. Found: "+opts.min);this.min=tmp}if(void 0!==opts.max){if("number"!=typeof(tmp=J.isInt(opts.max)))throw new TypeError(e+"max must be an integer or undefined. Found: "+opts.max);this.max=tmp}if(this.scale=100/(this.max-this.min),void 0!==(tmp=opts.initialValue)){if("random"===tmp)tmp=J.randomInt(this.min-1,this.max);else if("number"!=typeof(tmp=J.isInt(tmp,this.min,this.max,!0,!0)))throw new TypeError(e+"initialValue must be an integer >= "+this.min+" and =< "+this.max+" or undefined. Found: "+opts.initialValue);this.initialValue=this.currentValue=tmp}if(void 0!==opts.displayValue&&(this.displayValue=!!opts.displayValue),void 0!==opts.displayNoChange&&(this.displayNoChange=!!opts.displayNoChange),opts.type){if("volume"!==opts.type&&"flat"!==opts.type)throw new TypeError(e+'type must be "volume", "flat", or undefined. Found: '+opts.type);this.type=opts.type}if(void 0!==(tmp=opts.requiredChoice)?console.log("***Slider.init: requiredChoice is deprecated. Use required instead.***"):void 0!==opts.required&&(tmp=opts.required),void 0!==tmp&&(this.requiredChoice=this.required=!!tmp),opts.mainText){if("string"!=typeof opts.mainText)throw new TypeError(e+"mainText must be string or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}if(void 0!==opts.hint){if(!1!==opts.hint&&"string"!=typeof opts.hint)throw new TypeError(e+"hint must be a string, false, or undefined. Found: "+opts.hint);this.hint=opts.hint}if(this.required&&!1!==this.hint&&(this.hint||(this.hint="Movement required"),this.hint+=" *"),opts.onmove){if("function"!=typeof opts.onmove)throw new TypeError(e+"onmove must be a function or undefined. Found: "+opts.onmove);this.onmove=opts.onmove}if(opts.width){if("string"!=typeof opts.width)throw new TypeError(e+"width must be string or undefined. Found: "+opts.width);this.sliderWidth=opts.width}if(opts.hoverColor){if("string"!=typeof opts.hoverColor)throw new TypeError(e+"hoverColor must be string or undefined. Found: "+opts.hoverColor);this.hoverColor=opts.hoverColor}if(void 0!==opts.correctValue){if(!1===J.isNumber(opts.correctValue,this.min,this.max,!0,!0))throw new Error(e+"correctValue must be a number between "+this.min+" and "+this.max+". Found: "+opts.correctValue);this.correctValue=opts.correctValue}},Slider.prototype.append=function(){var container,tmpColor,that=this;this.mainText&&(this.spanMainText=W.append("span",this.bodyDiv,{className:"slider-maintext",innerHTML:this.mainText})),this.hint&&W.append("span",this.bodyDiv,{className:"slider-hint",innerHTML:this.hint}),container=W.add("div",this.bodyDiv,{className:"container-slider"}),this.rangeFill=W.add("div",container,{className:"fill-slider"}),this.slider=W.add("input",container,{className:"volume-slider",name:"rangeslider",type:"range",min:this.min,max:this.max}),this.slider.onmouseover=function(){tmpColor=that.rangeFill.style.background||"black",that.rangeFill.style.background=that.hoverColor},this.slider.onmouseout=function(){that.rangeFill.style.background=tmpColor},this.sliderWidth&&(this.slider.style.width=this.sliderWidth),this.displayValue&&(this.valueSpan=W.add("span",this.bodyDiv,{className:"slider-display-value"})),this.displayNoChange&&(this.noChangeSpan=W.add("span",this.bodyDiv,{className:"slider-display-nochange",innerHTML:this.getText("noChange")+"&nbsp;"}),this.noChangeCheckbox=W.add("input",this.noChangeSpan,{type:"checkbox"}),this.noChangeCheckbox.onclick=function(){if(that.noChangeCheckbox.checked){if(that.slider.value===that.initialValue)return;that.slider.value=that.initialValue,that.listener(!0),J.addClass(that.noChangeSpan,"italic")}else J.removeClass(that.noChangeSpan,"italic")}),this.slider.oninput=this.listener,this.slider.value=this.initialValue,this.slider.oninput()},Slider.prototype.getValues=function(opts){var res,value,nochange;return res=!0,void 0===(opts=opts||{}).highlight&&(opts.highlight=!0),value=this.currentValue,nochange=this.noChangeCheckbox&&this.noChangeCheckbox.checked,(this.required&&0===this.totalMove&&!nochange||null!==this.correctValue&&this.correctValue!==value)&&(opts.highlight&&this.highlight(),res=!1),{value:value,noChange:!!nochange,initialValue:this.initialValue,totalMove:this.totalMove,isCorrect:res,time:node.timer.getTimeSince(this.timeFrom)}},Slider.prototype.setValues=function(opts){opts=opts||{},this.slider.value=opts.value,this.slider.oninput()}}(node),function(node){"use strict";function SVOGauge(){this.methods={},this.method="Slider",this.mainText=null,this.gauge=null,this.addMethod("Slider",SVO_Slider)}function SVO_Slider(options){var items,sliders,mainText,i,len,renderer;for(sliders=options.sliders||[[[85,85],[85,76],[85,68],[85,59],[85,50],[85,41],[85,33],[85,24],[85,15]],[[85,15],[87,19],[89,24],[91,28],[93,33],[94,37],[96,41],[98,46],[100,50]],[[50,100],[54,98],[59,96],[63,94],[68,93],[72,91],[76,89],[81,87],[85,85]],[[50,100],[54,89],[59,79],[63,68],[68,58],[72,47],[76,36],[81,26],[85,15]],[[100,50],[94,56],[88,63],[81,69],[75,75],[69,81],[63,88],[56,94],[50,100]],[[100,50],[98,54],[96,59],[94,63],[93,68],[91,72],[89,76],[87,81],[85,85]]],this.sliders=sliders,renderer=options.renderer||function(td,choice,idx){td.innerHTML=choice[0]+"<hr/>"+choice[1]},len=sliders.length,items=new Array(len),i=-1;++i<len;)items[i]={id:i+1,left:this.getText("left"),choices:sliders[i]};return this.mainText?mainText=this.mainText:!1!==this.mainText&&(mainText=this.getText("mainText")),node.widgets.get("ChoiceTableGroup",{id:options.id||"svo_slider",items:items,mainText:mainText,title:!1,renderer:renderer,requiredChoice:this.required,storeRef:!1})}node.widgets.register("SVOGauge",SVOGauge),SVOGauge.version="0.8.1",SVOGauge.description="Displays an interface to measure social value orientation (S.V.O.).",SVOGauge.title="SVO Gauge",SVOGauge.className="svogauge",SVOGauge.texts={mainText:"You and another randomly selected participant will receive an <em>extra bonus</em>.<br/>Choose the preferred bonus amounts (in cents) for you and the other participant in each row.<br/>We will select <em>one row at random</em> and add the bonus to your and the other participant's payment. Your choice will remain <em>anonymous</em>.",left:"Your Bonus:<hr/>Other's Bonus:"},SVOGauge.dependencies={},SVOGauge.prototype.init=function(opts){var gauge,that;if(void 0!==opts.method){if("string"!=typeof opts.method)throw new TypeError("SVOGauge.init: method must be string or undefined. Found: "+opts.method);if(!this.methods[opts.method])throw new Error("SVOGauge.init: method is invalid: "+opts.method);this.method=opts.method}if(void 0!==opts.mainText){if(!1!==opts.mainText&&"string"!=typeof opts.mainText)throw new TypeError("SVOGauge.init: mainText must be string false, or undefined. Found: "+opts.mainText);this.mainText=opts.mainText}if(gauge=this.methods[this.method].call(this,opts),that=this,gauge.isHidden=function(){return that.isHidden()},gauge.isCollapsed=function(){return that.isCollapsed()},!node.widgets.isWidget(gauge))throw new Error("SVOGauge.init: method "+this.method+" created invalid gauge: missing default widget methods.");this.gauge=gauge,this.on("enabled",(function(){gauge.enable()})),this.on("disabled",(function(){gauge.disable()})),this.on("highlighted",(function(){gauge.highlight()})),this.on("unhighlighted",(function(){gauge.unhighlight()}))},SVOGauge.prototype.append=function(){node.widgets.append(this.gauge,this.bodyDiv)},SVOGauge.prototype.addMethod=function(name,cb){if("string"!=typeof name)throw new Error("SVOGauge.addMethod: name must be string: "+name);if("function"!=typeof cb)throw new Error("SVOGauge.addMethod: cb must be function: "+cb);if(this.methods[name])throw new Error("SVOGauge.addMethod: name already existing: "+name);this.methods[name]=cb},SVOGauge.prototype.getValues=function(opts){return void 0===(opts=opts||{}).processChoice&&(opts.processChoice=function(choice){return null===choice?null:this.choices[choice]}),this.gauge.getValues(opts)},SVOGauge.prototype.setValues=function(opts){return this.gauge.setValues(opts)}}(node),function(node){"use strict";function VisualRound(){this.options=null,this.displayMode=null,this.stager=null,this.gamePlot=null,this.curStage=null,this.totStage=null,this.curRound=null,this.totRound=null,this.stageOffset=null,this.totStageOffset=null,this.oldStageId=null,this.separator=" / ",this.layout=null}function CountUpStages(visualRound,options){generalConstructor(this,visualRound,"COUNT_UP_STAGES",options),generalInit(this,"stagediv",this.visualRound.getText("stage"))}function CountDownStages(visualRound,options){generalConstructor(this,visualRound,"COUNT_DOWN_STAGES",options),generalInit(this,"stagediv",visualRound.getText("stageLeft"))}function CountUpSteps(visualRound,options){generalConstructor(this,visualRound,"COUNT_UP_STEPS",options),generalInit(this,"stepdiv",this.visualRound.getText("step"))}function CountDownSteps(visualRound,options){generalConstructor(this,visualRound,"COUNT_DOWN_STEPS",options),generalInit(this,"stepdiv",this.visualRound.getText("stepLeft"))}function CountUpRounds(visualRound,options){generalConstructor(this,visualRound,"COUNT_UP_ROUNDS",options),generalInit(this,"rounddiv",visualRound.getText("round"))}function CountDownRounds(visualRound,options){generalConstructor(this,visualRound,"COUNT_DOWN_ROUNDS",options),generalInit(this,"rounddiv",visualRound.getText("roundLeft"))}function CompoundDisplayMode(visualRound,displayModes,options){this.visualRound=visualRound,this.displayModes=displayModes,this.name=displayModes.join("&"),this.options=options||{},this.displayDiv=null,this.init(options)}function setLayout(d,layout,lastDisplay){return"vertical"===layout||"multimode_vertical"===layout||"all_vertical"===layout?(d.displayDiv.style.float="none",d.titleDiv.style.float="none",d.titleDiv.style["margin-right"]="0px",d.contentDiv.style.float="none",!0):"horizontal"===layout?(d.displayDiv.style.float="none",d.titleDiv.style.float="left",d.titleDiv.style["margin-right"]="6px",d.contentDiv.style.float="right",!0):"multimode_horizontal"===layout?(d.displayDiv.style.float="left",d.titleDiv.style.float="none",d.titleDiv.style["margin-right"]="0px",d.contentDiv.style.float="none",lastDisplay||(d.displayDiv.style["margin-right"]="10px"),!0):"all_horizontal"===layout&&(d.displayDiv.style.float="left",d.titleDiv.style.float="left",d.titleDiv.style["margin-right"]="6px",d.contentDiv.style.float="right",lastDisplay||(d.displayDiv.style["margin-right"]="10px"),!0)}function generalConstructor(that,visualRound,name,options){options=options||{},that.visualRound=visualRound,that.name=name,options.toTotal&&(that.name+="_TO_TOTAL"),that.options=options,that.displayDiv=null,that.titleDiv=null,that.contentDiv=null,that.current=null,that.textDiv=null,that.total=null}function generalInit(that,containerName,title){that.displayDiv=W.get("div",{className:containerName}),that.titleDiv=W.add("div",that.displayDiv,{className:"title",innerHTML:title}),that.contentDiv=W.add("div",that.displayDiv,{className:"content"}),that.current=W.append("span",that.contentDiv,{className:"number"}),that.options.toTotal&&(that.textDiv=W.append("span",that.contentDiv,{className:"text",innerHTML:that.visualRound.separator}),that.total=W.append("span",that.contentDiv,{className:"number"})),that.updateDisplay()}node.widgets.register("VisualRound",VisualRound),VisualRound.version="0.9.0",VisualRound.description="Displays current/total/left round/stage/step. ",VisualRound.title=!1,VisualRound.className="visualround",VisualRound.texts={round:"Round",step:"Step",stage:"Stage",roundLeft:"Rounds Left",stepLeft:"Steps Left",stageLeft:"Stages Left"},VisualRound.dependencies={GamePlot:{}},VisualRound.prototype.init=function(options){if(options=options||{},J.mixout(options,this.options),this.options=options,this.stageOffset=this.options.stageOffset||0,this.totStageOffset=void 0===this.options.totStageOffset?this.stageOffset:this.options.totStageOffset,this.options.flexibleMode&&(this.curStage=this.options.curStage||1,this.curStage-=this.options.stageOffset||0,this.curStep=this.options.curStep||1,this.curRound=this.options.curRound||1,this.totStage=this.options.totStage,this.totRound=this.options.totRound,this.totStep=this.options.totStep,this.oldStageId=this.options.oldStageId),this.gamePlot||(this.gamePlot=node.game.plot),this.stager||(this.stager=this.gamePlot.stager),this.updateInformation(),!this.options.displayMode&&this.options.displayModeNames&&(console.log("***VisualTimer.init: options.displayModeNames is deprecated. Use options.displayMode instead.***"),this.options.displayMode=this.options.displayModeNames),this.options.displayMode?this.setDisplayMode(this.options.displayMode):this.setDisplayMode(["COUNT_UP_ROUNDS_TO_TOTAL_IFNOT1","COUNT_UP_STAGES_TO_TOTAL"]),void 0!==options.separator&&(this.separator=options.separator),void 0!==options.layout&&(this.layout=options.layout),void 0!==options.preprocess){if("function"!=typeof options.preprocess)throw new TypeError("VisualRound.init: preprocess must function or undefined. Found: "+options.preprocess);this.preprocess=options.preprocess}this.updateDisplay()},VisualRound.prototype.append=function(){this.activate(this.displayMode),this.updateDisplay()},VisualRound.prototype.updateDisplay=function(){this.displayMode&&this.displayMode.updateDisplay()},VisualRound.prototype.setDisplayMode=function(displayMode){var i,len,displayModes;if("string"==typeof displayMode)displayMode=[displayMode];else if(!J.isArray(displayMode))throw new TypeError("VisualRound.setDisplayMode: displayMode must be array or string. Found: "+displayMode);if(0===(len=displayMode.length))throw new Error("VisualRound.setDisplayMode: displayMode is empty");if(this.displayMode){if(displayMode.join("&")===this.displayMode.name)return;this.deactivate(this.displayMode)}for(displayModes=[],i=-1;++i<len;)switch(displayMode[i]){case"COUNT_UP_STAGES_TO_TOTAL":displayModes.push(new CountUpStages(this,{toTotal:!0}));break;case"COUNT_UP_STAGES":displayModes.push(new CountUpStages(this));break;case"COUNT_DOWN_STAGES":displayModes.push(new CountDownStages(this));break;case"COUNT_UP_STEPS_TO_TOTAL":displayModes.push(new CountUpSteps(this,{toTotal:!0}));break;case"COUNT_UP_STEPS_TO_TOTAL_IFNOT1":displayModes.push(new CountUpSteps(this,{toTotal:!0,ifNotOne:!0}));break;case"COUNT_UP_STEPS":displayModes.push(new CountUpSteps(this));break;case"COUNT_UP_STEPS_IFNOT1":displayModes.push(new CountUpSteps(this,{ifNotOne:!0}));break;case"COUNT_DOWN_STEPS":displayModes.push(new CountDownSteps(this));break;case"COUNT_UP_ROUNDS_TO_TOTAL":displayModes.push(new CountUpRounds(this,{toTotal:!0}));break;case"COUNT_UP_ROUNDS":displayModes.push(new CountUpRounds(this));break;case"COUNT_UP_ROUNDS_TO_TOTAL_IFNOT1":displayModes.push(new CountUpRounds(this,{toTotal:!0,ifNotOne:!0}));break;case"COUNT_UP_ROUNDS_IFNOT1":displayModes.push(new CountUpRounds(this,{ifNotOne:!0}));break;case"COUNT_DOWN_ROUNDS":displayModes.push(new CountDownRounds(this));break;default:throw new Error("VisualRound.setDisplayMode: unknown mode: "+displayMode[i])}this.displayMode=new CompoundDisplayMode(this,displayModes),this.activate(this.displayMode)},VisualRound.prototype.getDisplayModeName=function(){return this.displayMode.name},VisualRound.prototype.activate=function(displayMode){this.bodyDiv&&this.bodyDiv.appendChild(displayMode.displayDiv),displayMode.activate&&displayMode.activate()},VisualRound.prototype.deactivate=function(displayMode){this.bodyDiv.removeChild(displayMode.displayDiv),displayMode.deactivate&&displayMode.deactivate()},VisualRound.prototype.listeners=function(){var that;that=this,node.on("STEP_CALLBACK_EXECUTED",(function(){that.updateInformation()}))},VisualRound.prototype.updateInformation=function(){var stage,len,tmp;if(0===(stage=node.player.stage).stage)this.curStage=0,this.totStage=0,this.totRound=0;else if(this.options.flexibleMode)stage.id===this.oldStageId?this.curRound+=1:stage.id&&(this.curRound=1,this.curStage+=1),this.oldStageId=stage.id;else{if(this.curStage=stage.stage,"string"==typeof this.curStage&&(this.curStage=this.gamePlot.normalizeGameStage(stage).stage),this.curStage-=this.stageOffset,this.curStage<1)return;this.curStep=stage.step,this.curRound=stage.round,len=this.stager.sequence.length,this.totStage=len-this.totStageOffset,"gameover"===this.stager.sequence[len-1].type&&this.totStage--,tmp=this.stager.sequence[this.curStage-1],this.totRound=tmp.num||1,this.totStep=tmp.steps.length,this.preprocess&&(tmp={totRound:this.totRound,totStep:this.totStep,totStage:this.totStage,curStep:this.curStep,curStage:this.curStage,curRound:this.curRound},this.preprocess(tmp),this.curRound=tmp.curRound,this.curStep=tmp.curStep,this.curStage=tmp.curStage,this.totStage=tmp.totStage,this.totStep=tmp.totStep,this.totRound=tmp.totRound)}this.updateDisplay()},VisualRound.prototype.setLayout=function(layout){if("string"!=typeof layout||""===layout.trim())throw new TypeError("VisualRound.setLayout: layout must be a non-empty string. Found: "+layout);this.layout=layout,this.displayMode&&this.displayMode.setLayout(layout)},CountUpStages.prototype.updateDisplay=function(){this.current.innerHTML=this.visualRound.curStage,this.total&&(this.total.innerHTML=this.visualRound.totStage||"?")},CountDownStages.prototype.updateDisplay=function(){var v;(v=this.visualRound).totStage===v.curStage?this.current.innerHTML=0:this.current.innerHTML=v.totStage-v.curStage||"?"},CountUpSteps.prototype.updateDisplay=function(){this.options.ifNotOne&&1===this.visualRound.totStep?this.displayDiv.style.display="none":(this.current.innerHTML=this.visualRound.curStep,this.total&&(this.total.innerHTML=this.visualRound.totStep||"?"),this.displayDiv.style.display="")},CountDownSteps.prototype.updateDisplay=function(){var v;(v=this.visualRound).totStep===v.curStep?this.current.innerHTML=0:this.current.innerHTML=v.totStep-v.curStep||"?"},CountUpRounds.prototype.updateDisplay=function(){this.options.ifNotOne&&1===this.visualRound.totRound?this.displayDiv.style.display="none":(this.current.innerHTML=this.visualRound.curRound,this.total&&(this.total.innerHTML=this.visualRound.totRound||"?"),this.displayDiv.style.display="")},CountDownRounds.prototype.updateDisplay=function(){var v;(v=this.visualRound).totRound===v.curRound?this.current.innerHTML=0:this.current.innerHTML=v.totRound-v.curRound||"?"},CompoundDisplayMode.prototype.init=function(){var i,len;for(this.displayDiv=W.get("div"),i=-1,len=this.displayModes.length;++i<len;)this.displayDiv.appendChild(this.displayModes[i].displayDiv);this.updateDisplay()},CompoundDisplayMode.prototype.updateDisplay=function(){var i,len;for(i=-1,len=this.displayModes.length;++i<len;)this.displayModes[i].updateDisplay()},CompoundDisplayMode.prototype.activate=function(){var i,len,d,layout;for(layout=this.visualRound.layout,i=-1,len=this.displayModes.length;++i<len;)(d=this.displayModes[i]).activate&&this.displayModes[i].activate(),layout&&setLayout(d,layout,i===len-1)},CompoundDisplayMode.prototype.deactivate=function(){var i,len,d;for(i=-1,len=this.displayModes.length;++i<len;)(d=this.displayModes[i]).deactivate&&d.deactivate()},CompoundDisplayMode.prototype.setLayout=function(layout){var i,len;for(i=-1,len=this.displayModes.length;++i<len;)setLayout(this.displayModes[i],layout,i===len-1)}}(node),function(node){"use strict";var Table=W.Table;function VisualStage(){this.displayMode="inline",this.table=null,this.preprocess=null,this.order=["current","next","previous"],this.capitalize=!0,this.replaceUnderscore=!0,this.addRound=!0,this.showPrevious=!1,this.showCurrent=!0,this.showNext=!0}function capWord(word){return word.charAt(0).toUpperCase()+word.substr(1).toLowerCase()}function addRow(that,idx,order){var row,str,type,name,className,obj;type=that.order[idx],str=that.getText(type),(name=order[type])&&(obj={className:className="visualstage-"+type,content:name},row=!1===str?[obj]:"current"===type?[{content:name,colspan:2}]:[{className:className,content:str},obj],that.table.addRow(row))}function addSpan(that,idx,order){var str,tmp;(str=order[tmp=that.order[idx]])&&("current"!==tmp&&(str='<span class="strong">'+that.getText(tmp)+"</span>"+str),W.add("span",that.div,{innerHTML:str,className:"visualstage-"+tmp}))}node.widgets.register("VisualStage",VisualStage),VisualStage.version="0.11.0",VisualStage.description="Displays the name of the current, previous and next step of the game.",VisualStage.title=!1,VisualStage.className="visualstage",VisualStage.texts={miss:"",current:"Stage: ",previous:"Prev: ",next:"Next: "},VisualStage.dependencies={Table:{}},VisualStage.prototype.init=function(opts){var order,arr,i;if(void 0!==opts.displayMode){if("inline"!==opts.displayMode&&"table"!==opts.displayMode)throw new TypeError('VisualStage.init: displayMode must be "inline", "table" or undefined. Found: '+opts.displayMode);this.displayMode=opts.displayMode}if(void 0!==opts.addRound&&(this.addRound=!!opts.addRound),void 0!==opts.previous&&(this.showPrevious=!!opts.previous),void 0!==opts.next&&(this.showNext=!!opts.next),void 0!==opts.current&&(this.showCurrent=!!opts.current),void 0!==opts.order){if(!J.isArray(opts.order)||3!==opts.order.length)throw new TypeError("VisualStage.init: order must be an array of length 3 or undefined. Found: "+opts.order);if(order=opts.order,arr=this.order.slice(0),-1===(i=arr.indexOf(order[0]))?"unknown item: "+order[0]:(arr.splice(i,1),-1===(i=arr.indexOf(order[1]))?"unknown item: "+order[1]:(arr.splice(i,1),-1===(i=arr.indexOf(order[2]))?"unknown item: "+order[2]:(arr.splice(i,1),arr.length?"duplicated entry: "+arr[0]:void 0))))throw new TypeError("VisualStage.init: order contains errors: "+opts.order);this.order=opts.order}else"inline"===this.displayMode&&(this.order=["previous","current","next"]);if(void 0!==opts.preprocess){if("function"!=typeof opts.preprocess)throw new TypeError("VisualStage.init: preprocess must be function or undefined. Found: "+opts.preprocess);this.preprocess=opts.preprocess}void 0!==opts.capitalize&&(this.capitalize=!!opts.capitalize),void 0!==opts.replaceUnderscore&&(this.replaceUnderscore=!!opts.replaceUnderscore)},VisualStage.prototype.append=function(){"table"===this.displayMode?(this.table=new Table,this.bodyDiv.appendChild(this.table.table)):this.div=W.append("div",this.bodyDiv),this.updateDisplay()},VisualStage.prototype.listeners=function(){var that=this;node.on("STEP_CALLBACK_EXECUTED",(function(){that.updateDisplay()}))},VisualStage.prototype.updateDisplay=function(){var curStep,nextStep,prevStep,curStepName,nextStepName,prevStepName,order;order={},(curStep=node.game.getCurrentGameStage())&&(this.showCurrent&&(curStepName=this.getStepName(curStep,curStep,"current"),order.current=curStepName),this.showNext&&(nextStep=node.game.plot.next(curStep))&&(nextStepName=this.getStepName(nextStep,curStep,"next"),order.next=nextStepName),this.showPrevious&&(prevStep=node.game.plot.previous(curStep))&&(prevStepName=this.getStepName(prevStep,curStep,"previous"),order.previous=prevStepName)),"table"===this.displayMode?(this.table.clear(!0),addRow(this,0,order),addRow(this,1,order),addRow(this,2,order),this.table.selexec("y","=",0).addClass("strong"),this.table.parse()):(this.div.innerHTML="",addSpan(this,0,order),addSpan(this,1,order),addSpan(this,2,order))},VisualStage.prototype.getStepName=function(gameStage,curStage,mod){var name,round,preprocess,addRound;return"function"==typeof(name=node.game.plot.getProperty(gameStage,"name"))?(preprocess=name,name=null):"object"==typeof name&&null!==name&&(preprocess=name.preprocess,addRound=name.addRound,name=name.name),name||((name=node.game.plot.getStep(gameStage))?(name=name.id,this.replaceUnderscore&&(name=name.replace(/_/g," ")),this.capitalize&&(name=function(str){var tks,i,len;tks=str.split(" "),str=capWord(tks[0]),(len=tks.length)>1&&(str+=" "+capWord(tks[1]));if(len>2)for(i=2;i<len;i++)str+=" "+capWord(tks[i]);return str}(name))):name=this.getText("miss")),preprocess||(preprocess=this.preprocess),void 0===addRound&&(addRound=this.addRound),round=function(gameStage,curStage,mod){var round,totRounds;if(!gameStage.stage)return;if(!(totRounds=node.game.plot.stager.sequence[gameStage.stage-1].num))return;round=node.game.getRound(),curStage.stage===gameStage.stage?"next"===mod?round++:"previous"===mod&&round--:round=curStage.stage>gameStage.stage?totRounds:1;return round}(gameStage,curStage,mod),preprocess&&(name=preprocess.call(node.game,name,mod,round)),addRound&&round&&(name+=" "+round),name}}(node),function(node){"use strict";function VisualTimer(){this.gameTimer=null,this.mainBox=null,this.waitBox=null,this.activeBox=null,this.isInitialized=!1,this.options={},this.internalTimer=null}function TimerBox(options){this.boxDiv=null,this.titleDiv=null,this.bodyDiv=null,this.timeLeft=null,this.boxDiv=W.get("div"),this.titleDiv=W.add("div",this.boxDiv),this.bodyDiv=W.add("div",this.boxDiv),this.init(options)}function destroyTimer(that){that.internalTimer?(that.gameTimer.isDestroyed()||node.timer.destroyTimer(that.gameTimer),that.internalTimer=null):that.gameTimer.removeHook("VisualTimer_"+that.wid)}node.widgets.register("VisualTimer",VisualTimer),VisualTimer.version="0.9.3",VisualTimer.description="Display a configurable timer for the game. Can trigger events. Only for countdown smaller than 1h.",VisualTimer.title="Time Left",VisualTimer.className="visualtimer",VisualTimer.dependencies={GameTimer:{}},VisualTimer.prototype.init=function(options){var gameTimerOptions;if("object"!=typeof(options=options||{}))throw new TypeError("VisualTimer.init: options must be object or undefined. Found: "+options);if(gameTimerOptions={},void 0!==options.gameTimer){if(this.gameTimer)throw new Error("GameTimer.init: options.gameTimer cannot be set if a gameTimer is already existing: "+this.name);if("object"!=typeof options.gameTimer)throw new TypeError("VisualTimer.init: options.gameTimer must be object or undefined. Found: "+options.gameTimer);this.gameTimer=options.gameTimer}else this.isInitialized||(this.internalTimer=!0,this.gameTimer=node.timer.createTimer({name:options.name||"VisualTimer_"+J.randomInt(1e7)}));if(options.hooks){if(!this.internalTimer)throw new Error("VisualTimer.init: cannot add hooks on external gameTimer.");J.isArray(options.hooks)||(gameTimerOptions.hooks=[options.hooks])}else gameTimerOptions.hooks=[];this.isInitialized||gameTimerOptions.hooks.push({name:"VisualTimer_"+this.wid,hook:this.updateDisplay,ctx:this}),void 0!==options.milliseconds&&(gameTimerOptions.milliseconds=node.timer.parseInput("milliseconds",options.milliseconds)),void 0!==options.update?gameTimerOptions.update=node.timer.parseInput("update",options.update):gameTimerOptions.update=1e3,void 0!==options.timeup&&(gameTimerOptions.timeup=options.timeup),this.gameTimer.init(gameTimerOptions),this.gameTimer,this.options=gameTimerOptions,void 0===this.options.stopOnDone&&(this.options.stopOnDone=!0),void 0===this.options.startOnPlaying&&(this.options.startOnPlaying=!0),this.options.mainBoxOptions||(this.options.mainBoxOptions={}),this.options.waitBoxOptions||(this.options.waitBoxOptions={}),J.mixout(this.options.mainBoxOptions,{classNameBody:options.className,hideTitle:!0}),J.mixout(this.options.waitBoxOptions,{title:"Max. wait timer",classNameTitle:"waitTimerTitle",classNameBody:"waitTimerBody",hideBox:!0}),this.mainBox?this.mainBox.init(this.options.mainBoxOptions):this.mainBox=new TimerBox(this.options.mainBoxOptions),this.waitBox?this.waitBox.init(this.options.waitBoxOptions):this.waitBox=new TimerBox(this.options.waitBoxOptions),this.activeBox=this.options.activeBox||this.mainBox,this.isInitialized=!0},VisualTimer.prototype.append=function(){this.bodyDiv.appendChild(this.mainBox.boxDiv),this.bodyDiv.appendChild(this.waitBox.boxDiv),this.activeBox=this.mainBox,this.updateDisplay()},VisualTimer.prototype.clear=function(options){var oldOptions;return options=options||{},oldOptions=this.options,destroyTimer(this),this.gameTimer=null,this.activeBox=null,this.isInitialized=!1,this.init(options),oldOptions},VisualTimer.prototype.updateDisplay=function(){var time,minutes,seconds;this.gameTimer.milliseconds&&0!==this.gameTimer.milliseconds?(time=this.gameTimer.milliseconds-this.gameTimer.timePassed,minutes=(time=J.parseMilliseconds(time))[2]<10?"0"+time[2]:time[2],seconds=time[3]<10?"0"+time[3]:time[3],this.activeBox.bodyDiv.innerHTML=minutes+":"+seconds):this.activeBox.bodyDiv.innerHTML="00:00"},VisualTimer.prototype.start=function(){this.updateDisplay(),this.gameTimer.start()},VisualTimer.prototype.restart=function(options){this.stop(),"number"==typeof options&&(options={milliseconds:options}),this.init(options),this.start()},VisualTimer.prototype.stop=function(){this.gameTimer.isStopped()||(this.activeBox.timeLeft=this.gameTimer.timeLeft,this.gameTimer.stop())},VisualTimer.prototype.switchActiveBoxTo=function(box){this.activeBox.timeLeft=this.gameTimer.timeLeft||0,this.activeBox=box,this.updateDisplay()},VisualTimer.prototype.startWaiting=function(options){void 0===options&&(options={}),void 0===options.milliseconds&&(options.milliseconds=this.gameTimer.timeLeft),void 0===options.mainBoxOptions&&(options.mainBoxOptions={}),void 0===options.waitBoxOptions&&(options.waitBoxOptions={}),options.mainBoxOptions.classNameBody="strike",options.mainBoxOptions.timeLeft=this.gameTimer.timeLeft||0,options.activeBox=this.waitBox,options.waitBoxOptions.hideBox=!1,this.restart(options)},VisualTimer.prototype.startTiming=function(options){void 0===options&&(options={}),void 0===options.mainBoxOptions&&(options.mainBoxOptions={}),void 0===options.waitBoxOptions&&(options.waitBoxOptions={}),options.activeBox=this.mainBox,options.waitBoxOptions.timeLeft=this.gameTimer.timeLeft||0,options.waitBoxOptions.hideBox=!0,options.mainBoxOptions.classNameBody="",this.restart(options)},VisualTimer.prototype.resume=function(){this.gameTimer.resume()},VisualTimer.prototype.setToZero=function(){this.stop(),this.activeBox.bodyDiv.innerHTML="00:00",this.activeBox.setClassNameBody("strike")},VisualTimer.prototype.isTimeup=function(){return this.gameTimer.isTimeup()},VisualTimer.prototype.doTimeUp=function(){this.gameTimer.doTimeUp()},VisualTimer.prototype.listeners=function(){var that=this;this.internalTimer&&(node.on("PLAYING",(function(){var options;that.options.startOnPlaying&&((options=that.gameTimer.getStepOptions())?(options.update=that.update,options.timeup=void 0,that.startTiming(options)):that.gameTimer.isRunning()||that.setToZero())})),node.on("REALLY_DONE",(function(){that.options.stopOnDone&&(that.gameTimer.isStopped()||that.stop())})),this.on("destroyed",(function(){destroyTimer(that),that.bodyDiv.removeChild(that.mainBox.boxDiv),that.bodyDiv.removeChild(that.waitBox.boxDiv)})))},TimerBox.prototype.init=function(options){options&&(options.hideTitle?this.hideTitle():this.unhideTitle(),options.hideBody?this.hideBody():this.unhideBody(),options.hideBox?this.hideBox():this.unhideBox()),this.setTitle(options.title||""),this.setClassNameTitle(options.classNameTitle||""),this.setClassNameBody(options.classNameBody||""),options.timeLeft&&(this.timeLeft=options.timeLeft)},TimerBox.prototype.hideBox=function(){this.boxDiv.style.display="none"},TimerBox.prototype.unhideBox=function(){this.boxDiv.style.display=""},TimerBox.prototype.hideTitle=function(){this.titleDiv.style.display="none"},TimerBox.prototype.unhideTitle=function(){this.titleDiv.style.display=""},TimerBox.prototype.hideBody=function(){this.bodyDiv.style.display="none"},TimerBox.prototype.unhideBody=function(){this.bodyDiv.style.display=""},TimerBox.prototype.setTitle=function(title){this.titleDiv.innerHTML=title},TimerBox.prototype.setClassNameTitle=function(className){this.titleDiv.className=className},TimerBox.prototype.setClassNameBody=function(className){this.bodyDiv.className=className}}(node),function(node){"use strict";function WaitingRoom(){this.connected=0,this.poolSize=0,this.nGames=void 0,this.groupSize=0,this.waitTime=null,this.executionMode=null,this.startDate=null,this.timeoutId=null,this.execModeDiv=null,this.playerCount=null,this.startDateDiv=null,this.msgDiv=null,this.timerDiv=null,this.timer=null,this.dots=null,this.onTimeout=null,this.disconnectIfNotSelected=null,this.playWithBotOption=null,this.playBotBtn=null,this.selectTreatmentOption=null,this.selectedTreatment=null}node.widgets.register("WaitingRoom",WaitingRoom),WaitingRoom.version="1.3.0",WaitingRoom.description="Displays a waiting room for clients.",WaitingRoom.title="Waiting Room",WaitingRoom.className="waitingroom",WaitingRoom.dependencies={VisualTimer:{}},WaitingRoom.sounds={dispatch:"/sounds/doorbell.ogg"},WaitingRoom.texts={blinkTitle:"GAME STARTS!",waitingForConf:"Waiting to receive data",executionMode:function(w){return"WAIT_FOR_N_PLAYERS"===w.executionMode?"Waiting for All Players to Connect: ":"WAIT_FOR_DISPATCH"===w.executionMode?"Task will start soon. Please be patient.":"Task will start at: <br>"+w.startDate},disconnect:'<span style="color: red">You have been <strong>disconnected</strong>. Please try again later.</span><br><br>',waitedTooLong:"Waiting for too long. Please look for a HIT called <strong>Trouble Ticket</strong> and file a new trouble ticket reporting your experience.",notEnoughPlayers:'<h3 align="center" style="color: red">Thank you for your patience.<br>Unfortunately, there are not enough participants in your group to start the experiment.<br>',roomClosed:'<span style="color: red"> The waiting room is <strong>CLOSED</strong>. You have been disconnected. Please try again later.</span><br><br>',tooManyPlayers:function(widget,data){var str;return str="There are more players in this waiting room than playslots in the game. ",1===widget.poolSize?str+="Each player will play individually.":str+="Only "+data.nGames+" players will be selected to play the game.",str},notSelectedClosed:'<h3 align="center"><span style="color: red">Unfortunately, you were <strong>not selected</strong> to join the game this time. Thank you for your participation.</span></h3><br><br>',notSelectedOpen:'<h3 align="center"><span style="color: red">Unfortunately, you were <strong>not selected</strong> to join the game this time, but you may join the next one.</span><a class="hand" onclick=javascript:this.parentElement.innerHTML="">Ok, I got it.</a></h3><br><br>Thank you for your participation.</span></h3><br><br>',exitCode:function(widget,data){return"<br>You have been disconnected. "+(void 0!==data.exit?"Please report this exit code: "+data.exit:"")+"<br></h3>"},playBot:function(widget){return widget.poolSize===widget.groupSize&&1===widget.groupSize?"Play":2===widget.groupSize?"Play With Bot":"Play With Bots"},connectingBots:function(widget){return console.log(widget.poolSize,widget.groupSize),widget.poolSize===widget.groupSize&&1===widget.groupSize?"Starting, Please Wait...":2===widget.groupSize?"Connecting Bot, Please Wait...":"Connecting Bot/s, Please Wait..."},selectTreatment:"Select Treatment ",gameTreatments:"Game:",defaultTreatments:"Defaults:"},WaitingRoom.prototype.init=function(conf){var that=this;if("object"!=typeof conf)throw new TypeError("WaitingRoom.init: conf must be object. Found: "+conf);if(conf.executionMode){if(this.executionMode=conf.executionMode,conf.onTimeout){if("function"!=typeof conf.onTimeout)throw new TypeError("WaitingRoom.init: conf.onTimeout must be function, null or undefined. Found: "+conf.onTimeout);this.onTimeout=conf.onTimeout}if(conf.waitTime){if(null!==conf.waitTime&&"number"!=typeof conf.waitTime)throw new TypeError("WaitingRoom.init: conf.waitTime must be number, null or undefined. Found: "+conf.waitTime);this.waitTime=conf.waitTime}if(conf.startDate&&(this.startDate=new Date(conf.startDate).toString()),conf.poolSize){if(conf.poolSize&&"number"!=typeof conf.poolSize)throw new TypeError("WaitingRoom.init: conf.poolSize must be number or undefined. Found: "+conf.poolSize);this.poolSize=conf.poolSize}if(conf.groupSize){if(conf.groupSize&&"number"!=typeof conf.groupSize)throw new TypeError("WaitingRoom.init: conf.groupSize must be number or undefined. Found: "+conf.groupSize);this.groupSize=conf.groupSize}if(conf.nGames){if(conf.nGames&&"number"!=typeof conf.nGames)throw new TypeError("WaitingRoom.init: conf.nGames must be number or undefined. Found: "+conf.nGames);this.nGames=conf.nGames}if(conf.connected){if(conf.connected&&"number"!=typeof conf.connected)throw new TypeError("WaitingRoom.init: conf.connected must be number or undefined. Found: "+conf.connected);this.connected=conf.connected}if(conf.disconnectIfNotSelected){if("boolean"!=typeof conf.disconnectIfNotSelected)throw new TypeError("WaitingRoom.init: conf.disconnectIfNotSelected must be boolean or undefined. Found: "+conf.disconnectIfNotSelected);this.disconnectIfNotSelected=conf.disconnectIfNotSelected}else this.disconnectIfNotSelected=!1;conf.playWithBotOption?this.playWithBotOption=!0:this.playWithBotOption=!1,conf.selectTreatmentOption?this.selectTreatmentOption=!0:this.selectTreatmentOption=!1,this.displayExecMode(),this.playWithBotOption&&!document.getElementById("bot_btn")&&function(w){var btnGroup=document.createElement("div");btnGroup.role="group",btnGroup["aria-label"]="Play Buttons",btnGroup.className="btn-group";var playBotBtn=document.createElement("input");if(playBotBtn.className="btn btn-primary btn-lg",playBotBtn.value=w.getText("playBot"),playBotBtn.id="bot_btn",playBotBtn.type="button",playBotBtn.onclick=function(){w.playBotBtn.value=w.getText("connectingBots"),w.playBotBtn.disabled=!0,node.say("PLAYWITHBOT","SERVER",w.selectedTreatment),setTimeout((function(){w.playBotBtn.value=w.getText("playBot"),w.playBotBtn.disabled=!1}),5e3)},btnGroup.appendChild(playBotBtn),w.playBotBtn=playBotBtn,w.selectTreatmentOption){var btnGroupTreatments=document.createElement("div");btnGroupTreatments.role="group",btnGroupTreatments["aria-label"]="Select Treatment",btnGroupTreatments.className="btn-group";var btnTreatment=document.createElement("button");btnTreatment.className="btn btn-default btn-lg dropdown-toggle",btnTreatment["data-toggle"]="dropdown",btnTreatment["aria-haspopup"]="true",btnTreatment["aria-expanded"]="false",btnTreatment.innerHTML=w.getText("selectTreatment");var span=document.createElement("span");span.className="caret",btnTreatment.appendChild(span);var li,a,t,liT1,liT2,liT3,ul=document.createElement("ul");if(ul.className="dropdown-menu",ul.style["text-align"]="left",conf.availableTreatments){for(t in(li=document.createElement("li")).innerHTML=w.getText("gameTreatments"),li.className="dropdown-header",ul.appendChild(li),conf.availableTreatments)conf.availableTreatments.hasOwnProperty(t)&&((li=document.createElement("li")).id=t,(a=document.createElement("a")).href="#",a.innerHTML="<strong>"+t+"</strong>: "+conf.availableTreatments[t],li.appendChild(a),"treatment_latin_square"===t?liT3=li:"treatment_rotate"===t?liT1=li:"treatment_random"===t?liT2=li:ul.appendChild(li));(li=document.createElement("li")).role="separator",li.className="divider",ul.appendChild(li),(li=document.createElement("li")).innerHTML=w.getText("defaultTreatments"),li.className="dropdown-header",ul.appendChild(li),ul.appendChild(liT1),ul.appendChild(liT2),ul.appendChild(liT3)}btnGroupTreatments.appendChild(btnTreatment),btnGroupTreatments.appendChild(ul),btnGroup.appendChild(btnGroupTreatments),btnTreatment.onclick=function(){""===ul.style.display?ul.style.display="block":ul.style.display=""},ul.onclick=function(eventData){var t;t=eventData.target,ul.style.display="",(t=t.parentNode.id)||(t=eventData.target.parentNode.parentNode.id),t&&(btnTreatment.innerHTML=t+" ",btnTreatment.appendChild(span),w.selectedTreatment=t)},w.treatmentBtn=btnTreatment}w.bodyDiv.appendChild(document.createElement("br")),w.bodyDiv.appendChild(btnGroup)}(this),this.on("destroyed",(function(){that.dots&&that.dots.stop(),node.deregisterSetup("waitroom")}))}},WaitingRoom.prototype.startTimer=function(){var that=this;this.timer||this.waitTime&&(this.timerDiv||(this.timerDiv=document.createElement("div"),this.timerDiv.id="timer-div"),this.timerDiv.appendChild(document.createTextNode("Maximum Waiting Time: ")),this.timer=node.widgets.append("VisualTimer",this.timerDiv,{milliseconds:this.waitTime,timeup:function(){that.bodyDiv.innerHTML=that.getText("waitedTooLong")},update:1e3}),this.timer.setTitle(),this.timer.panelDiv.className="ng_widget visualtimer",this.bodyDiv.appendChild(this.timerDiv),this.timer.start())},WaitingRoom.prototype.clearTimeout=function(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)},WaitingRoom.prototype.updateState=function(update){update&&("number"==typeof update.connected&&(this.connected=update.connected),"number"==typeof update.poolSize&&(this.poolSize=update.poolSize),"number"==typeof update.groupSize&&(this.groupSize=update.groupSize))},WaitingRoom.prototype.updateDisplay=function(){var numberOfGameSlots,numberOfGames;this.connected>this.poolSize?(numberOfGames=Math.floor(this.connected/this.groupSize),void 0!==this.nGames&&(numberOfGames=numberOfGames>this.nGames?this.nGames:numberOfGames),numberOfGameSlots=numberOfGames*this.groupSize,this.playerCount.innerHTML='<span style="color:red">'+this.connected+"</span> / "+this.poolSize,this.playerCountTooHigh.style.display="",this.playerCountTooHigh.innerHTML=this.getText("tooManyPlayers",{nGames:numberOfGameSlots})):(this.playerCount.innerHTML=this.connected+" / "+this.poolSize,this.playerCountTooHigh.style.display="none")},WaitingRoom.prototype.displayExecMode=function(){this.bodyDiv.innerHTML="",this.execModeDiv=document.createElement("div"),this.execModeDiv.id="exec-mode-div",this.execModeDiv.innerHTML=this.getText("executionMode"),this.playerCount=document.createElement("p"),this.playerCount.id="player-count",this.execModeDiv.appendChild(this.playerCount),this.playerCountTooHigh=document.createElement("div"),this.playerCountTooHigh.style.display="none",this.execModeDiv.appendChild(this.playerCountTooHigh),this.startDateDiv=document.createElement("div"),this.startDateDiv.style.display="none",this.execModeDiv.appendChild(this.startDateDiv),this.dots=W.getLoadingDots(),this.execModeDiv.appendChild(this.dots.span),this.bodyDiv.appendChild(this.execModeDiv),this.msgDiv=document.createElement("div"),this.bodyDiv.appendChild(this.msgDiv),this.waitTime&&this.startTimer()},WaitingRoom.prototype.append=function(){this.bodyDiv.innerHTML=this.getText("waitingForConf")},WaitingRoom.prototype.listeners=function(){var that;that=this,node.registerSetup("waitroom",(function(conf){if(conf){if("object"==typeof conf)return conf.executionMode?that.init(conf):(that.setSounds(conf.sounds),that.setTexts(conf.texts)),conf;node.warn("waiting room widget: invalid setup object: "+conf)}})),node.on.data("PLAYERSCONNECTED",(function(msg){msg.data&&(that.connected=msg.data,that.updateDisplay())})),node.on.data("DISPATCH",(function(msg){var data,reportExitCode;data=(msg=msg||{}).data||{},that.dots&&that.dots.stop(),"allPlayersConnected"===data.action?that.alertPlayer():(reportExitCode=that.getText("exitCode",data),"notEnoughPlayers"===data.action?(that.bodyDiv.innerHTML=that.getText(data.action),that.onTimeout&&that.onTimeout(msg.data),that.disconnect(that.bodyDiv.innerHTML+reportExitCode)):"notSelected"===data.action?!1===data.shouldDispatchMoreGames||that.disconnectIfNotSelected?(that.bodyDiv.innerHTML=that.getText("notSelectedClosed"),that.disconnect(that.bodyDiv.innerHTML+reportExitCode)):that.msgDiv.innerHTML=that.getText("notSelectedOpen"):"disconnect"===data.action&&that.disconnect(that.bodyDiv.innerHTML+reportExitCode))})),node.on.data("TIME",(function(){node.info("waiting room: TIME IS UP!"),that.stopTimer()})),node.on.data("WAITTIME",(function(msg){that.updateState(msg.data),that.updateDisplay()})),node.on("SOCKET_DISCONNECT",(function(){that.stopTimer(),that.bodyDiv.innerHTML=that.getText("disconnect")})),node.on.data("ROOM_CLOSED",(function(){that.disconnect(that.getText("roomClosed"))}))},WaitingRoom.prototype.stopTimer=function(){this.timer&&(node.info("waiting room: STOPPING TIMER"),this.timer.destroy())},WaitingRoom.prototype.disconnect=function(msg){msg&&this.setText("disconnect",msg),node.socket.disconnect(),this.stopTimer()},WaitingRoom.prototype.alertPlayer=function(){var clearBlink,onFrame,blink,sound;blink=this.getText("blinkTitle"),(sound=this.getSound("dispatch"))&&J.playSound(sound),blink&&(document.hasFocus&&document.hasFocus()?J.blinkTitle(blink,{repeatFor:1}):(clearBlink=J.blinkTitle(blink,{stopOnFocus:!0,stopOnClick:window}),onFrame=function(){var frame;clearBlink(),(frame=W.getFrame())&&frame.removeEventListener("mouseover",onFrame,!1)},node.events.ng.once("FRAME_GENERATED",(function(frame){frame.addEventListener("mouseover",onFrame,!1)}))))}}(node);