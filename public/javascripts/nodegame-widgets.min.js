// nodegame-widgets

(function(e){function t(){this.root=null}e.Widget=t,t.prototype.dependencies={},t.prototype.defaults={},t.prototype.defaults.fieldset={legend:"Widget"},t.prototype.listeners=function(){},t.prototype.getRoot=function(){return this.root},t.prototype.getValues=function(){},t.prototype.append=function(){},t.prototype.init=function(){},t.prototype.getRoot=function(){},t.prototype.listeners=function(){},t.prototype.getAllValues=function(){},t.prototype.highlight=function(){}})("undefined"!=typeof node?node:module.parent.exports.node),function(e,t){function r(){this.widgets={},this.root=t.window.root||document.body}var n=t.JSUS;r.prototype.register=function(e,r){if(!e||!r)return t.err("Could not register widget: "+e,"nodegame-widgets: "),!1;for(var i in t.Widget.prototype)!r[i]&&!r.prototype[i]&&(!r.prototype.__proto__||!r.prototype.__proto__[i])&&(r.prototype[i]=n.clone(t.Widget.prototype[i]));return this.widgets[e]=r,this.widgets[e]},r.prototype.get=function(e,r){function s(e,t,n){if(!e||!t||!n)return;e.getRoot()[t]=function(){n.call(e)}}function o(e,t){if(!e||!t)return;var r=!1;for(var i in e)e.hasOwnProperty(i)&&(r=n.in_array(i,["onclick","onfocus","onblur","onchange","onsubmit","onload","onunload","onmouseover"]),r&&"function"==typeof e[i]&&s(t,i,e[i]))}if(!e)return;var i=this;r=r||{};var u=n.getNestedValue(e,this.widgets),a;if(!u){t.err("widget "+e+" not found.","node-widgets: ");return}t.info("registering "+u.name+" v."+u.version,"node-widgets: ");if(!this.checkDependencies(u))return!1;n.mixout(r,n.clone(u.defaults));try{a=new u(r),a.defaults=r,a.listeners.call(a),o(r,a)}catch(f){throw new Error("Error while loading widget "+u.name+": "+f)}return a},r.prototype.append=r.prototype.add=function(e,t,n){function i(e,t,n){if(!t)return e;var r=t.id||n.id+"_fieldset",i=t.legend||n.legend;return W.addFieldset(e,r,i,t.attributes)}if(!e)return;var r=this;return t=t||this.root,n=n||{},"object"!=typeof e&&(e=this.get(e,n)),e?(t=i(t,n.fieldset||e.defaults.fieldset,e),e.append(t),e):!1},r.prototype.checkDependencies=function(r,i){if(!r.dependencies)return!0;var s=function(e,n){var r=e.name||e.id;t.log(n+" not found. "+r+" cannot be loaded.","ERR")},o=[e,t,this.widgets,t.window],u=r.dependencies;for(var a in u)if(u.hasOwnProperty(a)){var f=!1;for(var l=0;l<o.length;l++)if(n.getNestedValue(a,o[l])){var f=!0;break}if(!f)return i||s(r,a),!1}return!0},t.widgets=new r}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){function t(e){this.id=e.id,this.text="Waiting for other players to be done...",this.waitingDiv=null}e.widgets.register("WaitScreen",t),t.defaults={},t.defaults.id="waiting",t.defaults.fieldset=!1,t.name="WaitingScreen",t.version="0.3.2",t.description="Show a standard waiting screen",t.prototype.append=function(e){return e},t.prototype.getRoot=function(){return this.waitingDiv},t.prototype.listeners=function(){var t=this;e.on("WAITING...",function(n){t.waitingDiv||(t.waitingDiv=e.window.addDiv(document.body,t.id)),t.waitingDiv.style.display==="none"&&(t.waitingDiv.style.display=""),t.waitingDiv.innerHTML=n||t.text,e.game.pause()}),e.on("LOADED",function(e){t.waitingDiv&&t.waitingDiv.style.display===""&&(t.waitingDiv.style.display="none")})}}(node),function(e){function t(n){this.id=n.id||t.id,this.event=n.event||"D3",this.svg=null;var r=this;e.on(this.event,function(e){r.tick.call(r,e)})}function n(e){t.call(this,e);var r=this.options=JSUS.merge(n.defaults,e),i=this.n=r.n;this.data=[0],this.margin=r.margin;var s=this.width=r.width-this.margin.left-this.margin.right,o=this.height=r.height-this.margin.top-this.margin.bottom,u=this.x=d3.scale.linear().domain(r.domain.x).range(r.range.x),a=this.y=d3.scale.linear().domain(r.domain.y).range(r.range.y);this.line=d3.svg.line().x(function(e,t){return u(t)}).y(function(e,t){return a(e)})}e.widgets.register("D3",t),e.widgets.register("D3ts",n),t.prototype.__proto__=e.Widget.prototype,t.prototype.constructor=t,t.defaults={},t.defaults.id="D3",t.defaults.fieldset={legend:"D3 plot"},t.name="D3",t.version="0.1",t.description="Real time plots for nodeGame with d3.js",t.dependencies={d3:{},JSUS:{}},t.prototype.append=function(e){return this.root=e,this.svg=d3.select(e).append("svg"),e},t.prototype.tick=function(){},n.id="D3ts",n.name="D3ts",n.version="0.1",n.description="Time series plot for nodeGame with d3.js",n.dependencies={D3:{},JSUS:{}},n.prototype.__proto__=t.prototype,n.prototype.constructor=n,n.defaults={},n.defaults.width=400,n.defaults.height=200,n.defaults.margin={top:10,right:10,bottom:20,left:40},n.defaults.domain={x:[0,10],y:[0,1]},n.defaults.range={x:[0,n.defaults.width],y:[n.defaults.height,0]},n.prototype.init=function(e){console.log("init!");var t=this.x,n=this.y,r=this.height,i=this.width,s=this.margin;this.svg.attr("width",i+s.left+s.right).attr("height",r+s.top+s.bottom).append("g").attr("transform","translate("+s.left+","+s.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",i).attr("height",r),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.svg.axis().scale(t).orient("bottom")),this.svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(n).orient("left")),this.path=this.svg.append("g").attr("clip-path","url(#clip)").append("path").data([this.data]).attr("class","line").attr("d",this.line)},n.prototype.tick=function(e){this.alreadyInit=this.alreadyInit||!1,this.alreadyInit||(this.init(),this.alreadyInit=!0);var t=this.x;console.log("tick!"),this.data.push(e),this.path.attr("d",this.line).attr("transform",null),this.data.length>this.n&&(this.path.transition().duration(500).ease("linear").attr("transform","translate("+t(-1)+")"),this.data.shift())}}(node),function(e){function i(e){this.options=e,this.nddb=null,this.commandsDiv=document.createElement("div"),this.id=e.id,"undefined"!=typeof this.id&&(this.commandsDiv.id=this.id),this.info=null,this.init(this.options)}e.widgets.register("NDDBBrowser",i);var t=e.JSUS,n=e.NDDB,r=e.TriggerManager;i.defaults={},i.defaults.id="nddbbrowser",i.defaults.fieldset=!1,i.name="NDDBBrowser",i.version="0.1.2",i.description="Provides a very simple interface to control a NDDB istance.",i.dependencies={JSUS:{},NDDB:{},TriggerManager:{}},i.prototype.init=function(t){function i(){var t=this.id;e.window.addEventButton(t+"_GO_TO_FIRST","<<",this.commandsDiv,"go_to_first"),e.window.addEventButton(t+"_GO_TO_PREVIOUS","<",this.commandsDiv,"go_to_previous"),e.window.addEventButton(t+"_GO_TO_NEXT",">",this.commandsDiv,"go_to_next"),e.window.addEventButton(t+"_GO_TO_LAST",">>",this.commandsDiv,"go_to_last"),e.window.addBreak(this.commandsDiv)}function s(){var e=this.commandsDiv.appendChild(document.createElement("span"));return e}i.call(this),this.info=s.call(this),this.tm=new r,this.tm.init(t.triggers),this.nddb=t.nddb||new n({auto_update_pointer:!0})},i.prototype.append=function(e){return this.root=e,e.appendChild(this.commandsDiv),e},i.prototype.getRoot=function(e){return this.commandsDiv},i.prototype.add=function(e){return this.nddb.insert(e)},i.prototype.sort=function(e){return this.nddb.sort(e)},i.prototype.addTrigger=function(e){return this.tm.addTrigger(e)},i.prototype.removeTrigger=function(e){return this.tm.removeTrigger(e)},i.prototype.resetTriggers=function(){return this.tm.resetTriggers()},i.prototype.listeners=function(){function r(t,r){t?(e.emit(n+"_GOT",t),this.writeInfo(this.nddb.nddb_pointer+1+"/"+this.nddb.length)):this.writeInfo("No element found")}var t=this,n=this.id;e.on(n+"_GO_TO_FIRST",function(){var e=t.tm.pullTriggers(t.nddb.first());r.call(t,e)}),e.on(n+"_GO_TO_PREVIOUS",function(){var e=t.tm.pullTriggers(t.nddb.previous());r.call(t,e)}),e.on(n+"_GO_TO_NEXT",function(){var e=t.tm.pullTriggers(t.nddb.next());r.call(t,e)}),e.on(n+"_GO_TO_LAST",function(){var e=t.tm.pullTriggers(t.nddb.last());r.call(t,e)})},i.prototype.writeInfo=function(e){this.infoTimeout&&clearTimeout(this.infoTimeout),this.info.innerHTML=e;var t=this;this.infoTimeout=setTimeout(function(){t.info.innerHTML=""},2e3)}}(node),function(e){function t(e){this.bar=null,this.root=null,this.recipient=null}e.widgets.register("DataBar",t),t.defaults={},t.defaults.id="databar",t.defaults.fieldset={legend:"Send DATA to players"},t.name="Data Bar",t.version="0.3",t.description="Adds a input field to send DATA messages to the players",t.prototype.append=function(t){var n,r,i;n=W.addButton(t),W.writeln("Text"),r=W.addTextInput(t,"data-bar-text"),W.writeln("Data"),i=W.addTextInput(t,"data-bar-data"),this.recipient=W.addRecipientSelector(t);var s=this;return n.onclick=function(){var t,n,o;t=s.recipient.value,o=r.value,n=i.value,e.log("Parsed Data: "+JSON.stringify(n)),e.say(n,o,t)},e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(s.recipient,e.game.pl)}),t}}(node),function(e){function t(e){this.id=e.id,this.root=null,this.div=document.createElement("div"),this.table=null,this.button=null}e.widgets.register("ServerInfoDisplay",t),t.defaults={},t.defaults.id="serverinfodisplay",t.defaults.fieldset={legend:"Server Info",id:"serverinfo_fieldset"},t.name="Server Info Display",t.version="0.3",t.prototype.init=function(t){var n=this;this.div||(this.div=document.createElement("div")),this.div.innerHTML="Waiting for the reply from Server...",this.table||(this.table=new e.window.Table(t)),this.table.clear(!0),this.button=document.createElement("button"),this.button.value="Refresh",this.button.appendChild(document.createTextNode("Refresh")),this.button.onclick=function(){n.getInfo()},this.root.appendChild(this.button),this.getInfo()},t.prototype.append=function(e){return this.root=e,e.appendChild(this.div),e},t.prototype.getInfo=function(){var t=this;e.get("INFO",function(n){e.window.removeChildrenFromNode(t.div),t.div.appendChild(t.processInfo(n))})},t.prototype.processInfo=function(e){this.table.clear(!0);for(var t in e)e.hasOwnProperty(t)&&this.table.addRow([t,e[t]]);return this.table.parse()},t.prototype.listeners=function(){var t=this;e.on("NODEGAME_READY",function(){t.init()})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.listRoot=null,this.fieldset=null,this.submit=null,this.changeEvent=this.id+"_change",this.init(e)}function r(e){n.call(this,e)}function i(e){n.call(this,e)}function s(t){n.call(this,t),this.groupName="undefined"!=typeof t.name?t.name:e.window.generateUniqueId()}e.widgets.register("Controls",n);var t={id:"controls"};n.defaults=t,n.Slider=r,n.jQuerySlider=i,n.Radio=s,n.name="Controls",n.version="0.2",n.description="Wraps a collection of user-inputs controls.",n.prototype.add=function(e,t,n){},n.prototype.getItem=function(e,t){},n.prototype.init=function(t){this.hasChanged=!1,"undefined"!=typeof t.change&&(t.change?this.changeEvent=t.change:this.changeEvent=!1),this.list=new e.window.List(t),this.listRoot=this.list.getRoot();if(!t.features)return;this.root||(this.root=this.listRoot),this.features=t.features,this.populate()},n.prototype.append=function(t){this.root=t;var n=this.listRoot;this.list.parse(),t.appendChild(this.listRoot);if(this.options.submit){var r="submit_"+this.id;this.options.submit.id&&(r=this.options.submit.id,delete this.options.submit.id),this.submit=e.window.addButton(t,r,this.options.submit,this.options.attributes);var i=this;this.submit.onclick=function(){i.options.change&&e.emit(i.options.change)}}return n},n.prototype.parse=function(){return this.list.parse()},n.prototype.populate=function(){var t=this;for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=this.features[n],i=n;r.id&&(i=r.id,delete r.id);var s=document.createElement("div"),o=this.add(s,i,r);this.changeEvent&&(o.onchange=function(){e.emit(t.changeEvent)}),r.label&&e.window.addLabel(s,o,null,r.label),this.list.addDT(s)}},n.prototype.listeners=function(){var t=this;e.on(this.changeEvent,function(){t.hasChanged=!0})},n.prototype.refresh=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);n&&(n.value=this.features[t].value)}return!0},n.prototype.getAllValues=function(){var t={};for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=e.window.getElementById(n);r&&(t[n]=Number(r.value))}return t},n.prototype.highlight=function(t){return e.window.highlight(this.listRoot,t)},r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="slidercontrols",r.name="Slider Controls",r.version="0.2",r.dependencies={Controls:{}},r.prototype.add=function(t,n,r){return e.window.addSlider(t,n,r)},r.prototype.getItem=function(t,n){return e.window.getSlider(t,n)},i.prototype.__proto__=n.prototype,i.prototype.constructor=i,i.id="jqueryslidercontrols",i.name="Experimental: jQuery Slider Controls",i.version="0.13",i.dependencies={jQuery:{},Controls:{}},i.prototype.add=function(e,t,n){var r=jQuery("<div/>",{id:t}).slider(),i=r.appendTo(e);return i[0]},i.prototype.getItem=function(e,t){var n=jQuery("<div/>",{id:e}).slider();return n},s.prototype.__proto__=n.prototype,s.prototype.constructor=s,s.id="radiocontrols",s.name="Radio Controls",s.version="0.1.1",s.dependencies={Controls:{}},s.prototype.add=function(t,n,r){return"undefined"==typeof r.name&&(r.name=this.groupName),e.window.addRadioButton(t,n,r)},s.prototype.getItem=function(t,n){return"undefined"==typeof n.name&&(n.name=this.groupName),e.window.getRadioButton(t,n)},s.prototype.getAllValues=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);if(n.checked)return n.value}return!1}}(node),function(e){function r(e){this.id=e.id,this.root=null,this.table=new n}e.widgets.register("VisualState",r);var t=e.JSUS,n=e.window.Table;r.defaults={},r.defaults.id="visualstate",r.defaults.fieldset={legend:"State",id:"visualstate_fieldset"},r.name="Visual State",r.version="0.2.1",r.description="Visually display current, previous and next state of the game.",r.dependencies={JSUS:{},Table:{}},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(e,t){var n=this,r=this.id+"_";return e.appendChild(this.table.table),this.writeState(),e},r.prototype.listeners=function(){var t=this;e.on("STATECHANGE",function(){t.writeState()})},r.prototype.writeState=function(){var t,n,r,i,s="-";e.game&&e.game.state?(i=e.game.gameLoop.getStep(e.game.state),t=i?i.name:s,i=e.game.gameLoop.getStep(e.game.previous()),n=i?i.name:s,i=e.game.gameLoop.getStep(e.game.next()),r=i?i.name:s):(t="Uninitialized",n=s,r=s),this.table.clear(!0),this.table.addRow(["Previous: ",n]),this.table.addRow(["Current: ",t]),this.table.addRow(["Next: ",r]);var o=this.table.select("y","=",2);o.addClass("strong"),o.select("x","=",0).addClass("underline"),this.table.parse()}}(node),function(e){function r(e){this.id=e.id,this.root=null,this.table=new t}var t=e.window.Table,n=e.GameStage;e.widgets.register("StateDisplay",r),r.defaults={},r.defaults.id="statedisplay",r.defaults.fieldset={legend:"State Display"},r.name="State Display",r.version="0.4.2",r.description="Display basic information about player's status.",r.prototype.init=function(){},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(t){var n=this,r=this.id+"_",i=r+"fieldset",s=r+"player",o=r+"state",u=setInterval(function(t,r){e.player&&e.player.id&&(clearInterval(u),n.updateAll())},100);return t.appendChild(this.table.table),this.root=t,t},r.prototype.updateAll=function(){var t=e.game?new n(e.game.state):new n,r=e.player?e.player.id:"-",i=e.player&&e.player.name?e.player.name:"-";this.table.clear(!0),this.table.addRow(["Name: ",i]),this.table.addRow(["State: ",t.toString()]),this.table.addRow(["Id: ",r]),this.table.parse()},r.prototype.listeners=function(){var t=this;e.on("STATECHANGE",function(){t.updateAll()})}}(node),function(e){function s(e,t){r.call(this,e,t),this.options=e,this.id=e.id,this.name=e.name||"Dynamic Table",this.fieldset={legend:this.name,id:this.id+"_fieldset"},this.root=null,this.bindings={},this.init(this.options)}var t=e.GameStage,n=e.PlayerList,r=e.window.Table,i=e.window.HTMLRenderer;e.widgets.register("DynamicTable",s),s.prototype=new r,s.prototype.constructor=r,s.id="dynamictable",s.name="Dynamic Table",s.version="0.3.1",s.dependencies={Table:{},JSUS:{},HTMLRenderer:{}},s.prototype.init=function(e){this.options=e,this.name=e.name||this.name,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!0,this.replace=e.replace||!1,this.htmlRenderer=new i({renderers:e.renderers}),this.c("state",t.compare),this.setLeft([]),this.parse(!0)},s.prototype.bind=function(t,n){if(!t||!n)return;var i=this;e.on(t,function(e){if(n.x||n.y){var t;i.replace?t=function(t,s){var o=i.get(t,s);if(o.length!==0)for(var u=0;u<o.length;u++)n.cell.call(i,e,o[u]);else{var a=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(a)}}:t=function(t,s){var o=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(o,t,s)};var s=n.x.call(i,e),o=n.y.call(i,e);if(s&&o){s=s instanceof Array?s:[s],o=o instanceof Array?o:[o];for(var u=0;u<s.length;u++)for(var a=0;a<o.length;a++)t.call(i,s[u],o[a])}}if(n.header){var f=n.header.call(i,e);f=f instanceof Array?f:[f],i.setHeader(f)}if(n.left){var l=n.left.call(i,e);JSUS.in_array(l,i.left)||i.header.push(l)}i.auto_update&&i.parse()})},s.prototype.append=function(e){return this.root=e,e.appendChild(this.table),e},s.prototype.listeners=function(){}}(node),function(e){function n(e){this.id=e.id||n.defaults.id,this.status_id=this.id+"_statusbar",this.board=null,this.status=null,this.root=null}e.widgets.register("GameBoard",n);var t=e.PlayerList;n.defaults={},n.defaults.id="gboard",n.defaults.fieldset={legend:"Game Board"},n.name="GameBoard",n.version="0.4.0",n.description="Offer a visual representation of the state of all players in the game.",n.prototype.append=function(t){return this.root=t,this.status=e.window.addDiv(t,this.status_id),this.board=e.window.addDiv(t,this.id),this.updateBoard(e.game.pl),t},n.prototype.listeners=function(){var t=this;e.on("UPDATED_PLIST",function(){t.updateBoard(e.game.pl)})},n.prototype.printLine=function(t){var n="["+(t.name||t.id)+"]> 	";n+="("+t.state.round+") "+t.state.state+"."+t.state.step,n+=" ";switch(t.state.is){case e.is.UNKNOWN:n+="(unknown)";break;case e.is.LOADING:n+="(loading)";break;case e.is.LOADED:n+="(loaded)";break;case e.is.PLAYING:n+="(playing)";break;case e.is.DONE:n+="(done)";break;default:n+="("+t.state.is+")"}return t.state.paused&&(n+=" (P)"),n},n.prototype.printSeparator=function(e){return W.getElement("hr",null,{style:"color: #CCC;"})},n.prototype.updateBoard=function(t){var n=this;this.status.innerHTML="Updating...";var r,i;t.length&&(n.board.innerHTML="",t.forEach(function(e){r=n.printLine(e),W.write(r,n.board),i=n.printSeparator(e),W.write(i,n.board)})),this.status.innerHTML="Connected players: "+e.game.pl.length}}(node),function(e){function n(n){this.options=n,this.id=n.id,this.table=new t({id:"cf_table"}),this.root=n.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.dims=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function r(t,r){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/n.defaults.canvas.width,this.scaleY=t.height/n.defaults.canvas.heigth}function i(e){var e=e||{};this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=i.defaults[t].value)}var t=e.window.Table;e.widgets.register("ChernoffFacesSimple",n),n.defaults={},n.defaults.id="ChernoffFaces",n.defaults.canvas={},n.defaults.canvas.width=100,n.defaults.canvas.heigth=100,n.name="Chernoff Faces",n.version="0.3",n.description="Display parametric data in the form of a Chernoff Face.",n.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},n.FaceVector=i,n.FacePainter=r,n.prototype.init=function(t){var s=this;this.id=t.id||this.id;var o=this.id+"_";this.features=t.features||this.features||i.random(),this.controls="undefined"!=typeof t.controls?t.controls:!0;var u=t.idCanvas?t.idCanvas:o+"canvas",a=t.idButton?t.idButton:o+"button";this.dims={width:t.width?t.width:n.defaults.canvas.width,height:t.height?t.height:n.defaults.canvas.heigth},this.canvas=e.window.getCanvas(u,this.dims),this.fp=new r(this.canvas),this.fp.draw(new i(this.features));var f={id:"cf_controls",features:JSUS.mergeOnKey(i.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof t.change?e.on(this.change,this.changeFunc):(t.change?e.on(t.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=t.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},n.prototype.getRoot=function(){return this.root},n.prototype.getCanvas=function(){return this.canvas},n.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},n.prototype.listeners=function(){},n.prototype.draw=function(e){if(!e)return;var t=new i(e);this.fp.redraw(t),this.sc.init({features:JSUS.mergeOnKey(i.defaults,e,"value")}),this.sc.refresh()},n.prototype.getAllValues=function(){return this.fp.face},n.prototype.randomize=function(){var e=i.random();this.fp.redraw(e);var t={features:JSUS.mergeOnKey(i.defaults,e,"value"),change:this.change};return this.sc.init(t),this.sc.refresh(),!0},r.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY);var t=t||this.canvas.centerX,n=n||this.canvas.centerY;this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},r.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},r.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},r.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}if(this.canvas.width>this.canvas.height)var t=this.canvas.width/e.head_radius*e.head_scale_x;else var t=this.canvas.height/e.head_radius*e.head_scale_y;e.scaleX=t/2,e.scaleY=t/2},r.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyes=function(e,t,n){var i=r.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawPupils=function(e,t,n){var i=e.pupil_radius,s=e.eye_spacing,o=r.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyebrow=function(e,t,n){var i=r.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:i,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:i,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawNose=function(e,t,n){var i=r.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=i+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,i),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},r.prototype.drawMouth=function(e,t,n){var i=r.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=i-e.mouth_top_y,a=i+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,u,o,i),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,a,o,i),this.canvas.ctx.stroke()},r.computeFaceOffset=function(e,t,n){var n=n||0,r=n-e.head_radius+e.head_radius*2*t;return r},r.computeEyebrowOffset=function(e,t){var t=t||0,n=2;return r.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},i.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},i.random=function(){var e={};for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(JSUS.in_array(t,["color","lineWidth","scaleX","scaleY"])||(e[t]=i.defaults[t].min+Math.random()*i.defaults[t].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new i(e)},i.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&i.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=i.defaults[e].min+Math.random()*i.defaults[e].max)},i.prototype.distance=function(e){return i.distance(this,e)},i.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},i.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.text="Send",this.button=document.createElement("button"),this.callback=null,this.init(this.options)}function r(e){e.event="DONE",e.text=e.text||"Done!",n.call(this,e)}var t=e.JSUS;e.widgets.register("EventButton",n),n.defaults={},n.defaults.id="eventbutton",n.defaults.fieldset=!1,n.name="Event Button",n.version="0.2",n.dependencies={JSUS:{}},n.prototype.init=function(t){t=t||this.options,this.button.id=t.id||this.id;var n=t.text||this.text;while(this.button.hasChildNodes())this.button.removeChild(this.button.firstChild);this.button.appendChild(document.createTextNode(n)),this.event=t.event||this.event,this.callback=t.callback||this.callback;var r=this;this.event&&(this.button.onclick=function(){var n=!0;this.callback&&(n=t.callback.call(e.game)),n&&e.emit(r.event)})},n.prototype.append=function(e){return this.root=e,e.appendChild(this.button),e},n.prototype.listeners=function(){},e.widgets.register("DoneButton",r),r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="donebutton",r.version="0.1",r.name="Done Button",r.dependencies={EventButton:{}}}(node),function(e){function r(t){this.options=t,this.id=t.id,this.table=new n({id:"cf_table"}),this.root=t.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function i(t,n){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/r.defaults.canvas.width,this.scaleY=t.height/r.defaults.canvas.heigth}function s(e){e=e||{},this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in s.defaults)s.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=s.defaults[t].value)}var t=e.JSUS,n=e.window.Table;e.widgets.register("ChernoffFaces",r),r.defaults={},r.defaults.id="ChernoffFaces",r.defaults.canvas={},r.defaults.canvas.width=100,r.defaults.canvas.heigth=100,r.name="Chernoff Faces",r.version="0.3",r.description="Display parametric data in the form of a Chernoff Face.",r.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},r.FaceVector=s,r.FacePainter=i,r.prototype.init=function(n){var r=this;this.id=n.id||this.id;var o=this.id+"_";this.features=n.features||this.features||s.random(),this.controls="undefined"!=typeof n.controls?n.controls:!0;var u=n.idCanvas?n.idCanvas:o+"canvas",a=n.idButton?n.idButton:o+"button";this.canvas=e.window.getCanvas(u,n.canvas),this.fp=new i(this.canvas),this.fp.draw(new s(this.features));var f={id:"cf_controls",features:t.mergeOnKey(s.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof n.change?e.on(this.change,this.changeFunc):(n.change?e.on(n.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=n.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},r.prototype.getCanvas=function(){return this.canvas},r.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},r.prototype.draw=function(e){if(!e)return;var n=new s(e);this.fp.redraw(n),this.sc.init({features:t.mergeOnKey(s.defaults,e,"value")}),this.sc.refresh()},r.prototype.getAllValues=function(){return this.fp.face},r.prototype.randomize=function(){var e=s.random();this.fp.redraw(e);var n={features:t.mergeOnValue(s.defaults,e),change:this.change};return this.sc.init(n),this.sc.refresh(),!0},i.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY),t=t||this.canvas.centerX,n=n||this.canvas.centerY,this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},i.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},i.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},i.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}var t;this.canvas.width>this.canvas.height?ratio=this.canvas.width/e.head_radius*e.head_scale_x:ratio=this.canvas.height/e.head_radius*e.head_scale_y,e.scaleX=ratio/2,e.scaleY=ratio/2},i.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyes=function(e,t,n){var r=i.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawPupils=function(e,t,n){var r=e.pupil_radius,s=e.eye_spacing,o=i.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyebrow=function(e,t,n){var r=i.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:r,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:r,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawNose=function(e,t,n){var r=i.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=r+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,r),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},i.prototype.drawMouth=function(e,t,n){var r=i.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=r-e.mouth_top_y,a=r+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,u,o,r),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,a,o,r),this.canvas.ctx.stroke()},i.computeFaceOffset=function(e,t,n){n=n||0;var r=n-e.head_radius+e.head_radius*2*t;return r},i.computeEyebrowOffset=function(e,t){t=t||0;var n=2;return i.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},s.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},s.random=function(){var e={};for(var n in s.defaults)s.defaults.hasOwnProperty(n)&&(t.in_array(n,["color","lineWidth","scaleX","scaleY"])||(e[n]=s.defaults[n].min+Math.random()*s.defaults[n].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new s(e)},s.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&s.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=s.defaults[e].min+Math.random()*s.defaults[e].max)},s.prototype.distance=function(e){return s.distance(this,e)},s.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},s.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function t(e){this.summaryDiv=null}e.widgets.register("GameSummary",t),t.defaults={},t.defaults.id="gamesummary",t.defaults.fieldset={legend:"Game Summary"},t.name="Game Summary",t.version="0.3",t.description="Show the general configuration options of the game.",t.prototype.append=function(t){return this.root=t,this.summaryDiv=e.window.addDiv(t),this.writeSummary(),t},t.prototype.writeSummary=function(t,n){var r=document.createTextNode("Name: "+e.game.name),i=document.createTextNode("Descr: "+e.game.description),s=document.createTextNode("Min Pl.: "+e.game.minPlayers),o=document.createTextNode("Max Pl.: "+e.game.maxPlayers);this.summaryDiv.appendChild(r),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(i),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(s),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(o),e.window.addDiv(this.root,this.summaryDiv,n)}}(node),function(e){function r(e){this.id=e.id||r.defaults.id,this.root=null,this.spanCurrency=document.createElement("span"),this.spanMoney=document.createElement("span"),this.currency="EUR",this.money=0,this.precision=2,this.init(e)}e.widgets.register("MoneyTalks",r);var t=e.JSUS;r.defaults={},r.defaults.id="moneytalks",r.defaults.fieldset={legend:"Earnings"},r.name="Money talks",r.version="0.1.0",r.description="Display the earnings of a player.",r.dependencies={JSUS:{}},r.prototype.init=function(e){this.currency=e.currency||this.currency,this.money=e.money||this.money,this.precision=e.precision||this.precision,this.spanCurrency.id=e.idCurrency||this.spanCurrency.id||"moneytalks_currency",this.spanMoney.id=e.idMoney||this.spanMoney.id||"moneytalks_money",this.spanCurrency.innerHTML=this.currency,this.spanMoney.innerHTML=this.money},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(e,t){var n=this.id+"_";return e.appendChild(this.spanMoney),e.appendChild(this.spanCurrency),e},r.prototype.listeners=function(){var t=this;e.on("MONEYTALKS",function(e){t.update(e)})},r.prototype.update=function(e){if("number"!=typeof e){e=parseInt(e);if(isNaN(n)||!isFinite(n))return}this.money+=e,this.spanMoney.innerHTML=this.money.toFixed(this.precision)}}(node),function(e){function r(e){this.id=e.id,this.recipient=null,this.actionSel=null,this.targetSel=null,this.table=new n,this.init()}var t=e.GameMsg,n=e.window.Table;e.widgets.register("MsgBar",r),r.defaults={},r.defaults.id="msgbar",r.defaults.fieldset={legend:"Send MSG"},r.name="Msg Bar",r.version="0.4",r.description="Send a nodeGame message to players",r.prototype.init=function(){var n=this,r=new t,i=0;for(var s in r)if(r.hasOwnProperty(s)){var o=this.id+"_"+s;this.table.add(s,0,i),this.table.add(e.window.getTextInput(o),1,i),s==="target"?(this.targetSel=e.window.getTargetSelector(this.id+"_targets"),this.table.add(this.targetSel,2,i),this.targetSel.onchange=function(){e.window.getElementById(n.id+"_target").value=n.targetSel.value}):s==="action"?(this.actionSel=e.window.getActionSelector(this.id+"_actions"),this.table.add(this.actionSel,2,i),this.actionSel.onchange=function(){e.window.getElementById(n.id+"_action").value=n.actionSel.value}):s==="to"&&(this.recipient=e.window.getRecipientSelector(this.id+"recipients"),this.table.add(this.recipient,2,i),this.recipient.onchange=function(){e.window.getElementById(n.id+"_to").value=n.recipient.value}),i++}this.table.parse()},r.prototype.append=function(t){var n=e.window.addButton(t),r=e.window.addButton(t,"stub","Add Stub"),i=this;return n.onclick=function(){var t=i.parse();e.gsc.send(t)},r.onclick=function(){i.addStub()},t.appendChild(this.table.table),this.root=t,t},r.prototype.getRoot=function(){return this.root},r.prototype.listeners=function(){var t=this;e.onPLIST(function(n){e.window.populateRecipientSelector(t.recipient,n.data)})},r.prototype.parse=function(){var n={},r=this,i=null,s=null;this.table.forEach(function(e){if(e.x===0)i=e.content,n[i]="";else if(e.x===1){s=e.content.value;if(i==="state"||i==="data")try{s=JSON.parse(e.content.value)}catch(t){s=e.content.value}n[i]=s}});var o=new t(n);return e.info(o,"MsgBar sent: "),o},r.prototype.addStub=function(){e.window.getElementById(this.id+"_from").value=e.player?e.player.id:"undefined",e.window.getElementById(this.id+"_to").value=this.recipient.value,e.window.getElementById(this.id+"_forward").value=0,e.window.getElementById(this.id+"_reliable").value=1,e.window.getElementById(this.id+"_priority").value=0,e.gsc&&e.gsc.session&&(e.window.getElementById(this.id+"_session").value=e.gsc.session),e.window.getElementById(this.id+"_state").value=JSON.stringify(e.state),e.window.getElementById(this.id+"_action").value=this.actionSel.value,e.window.getElementById(this.id+"_target").value=this.targetSel.value}}(node),function(e){function r(e){this.id=e.id||r.id,this.mode=e.mode||r.defaults.mode,this.root=null,this.textarea_id=e.textarea_id||r.defaults.textarea_id,this.chat_id=e.chat_id||r.defaults.chat_id,this.submit_id=e.submit_id||r.defaults.submit_id,this.chat_event=e.chat_event||r.defaults.chat_event,this.submit_text=e.submit_text||r.defaults.submit_text,this.submit=n.getEventButton(this.chat_event,this.submit_text,this.submit_id),this.textarea=n.getElement("textarea",this.textarea_id),this.chat=n.getElement("div",this.chat_id),"undefined"!=typeof e.displayName&&(this.displayName=e.displayName);switch(this.mode){case r.modes.RECEIVER_ONLY:this.recipient={value:"SERVER"};break;case r.modes.MANY_TO_ONE:this.recipient={value:"ALL"};break;case r.modes.ONE_TO_ONE:this.recipient={value:"SERVER"};break;default:this.recipient=n.getRecipientSelector()}}e.widgets.register("Chat",r);var t=e.JSUS,n=e.window;r.defaults={},r.defaults.id="chat",r.defaults.fieldset={legend:"Chat"},r.defaults.mode="MANY_TO_MANY",r.defaults.textarea_id="chat_textarea",r.defaults.chat_id="chat_chat",r.defaults.chat_event="CHAT",r.defaults.submit_id="chat_submit",r.defaults.submit_text="chat",r.modes={MANY_TO_MANY:"MANY_TO_MANY",MANY_TO_ONE:"MANY_TO_ONE",ONE_TO_ONE:"ONE_TO_ONE",RECEIVER_ONLY:"RECEIVER_ONLY"},r.name="Chat",r.version="0.4",r.description="Offers a uni / bi-directional communication interface between players, or between players and the experimenter.",r.dependencies={JSUS:{}},r.prototype.append=function(e){return this.root=e,e.appendChild(this.chat),this.mode!==r.modes.RECEIVER_ONLY&&(n.writeln("",e),e.appendChild(this.textarea),n.writeln("",e),e.appendChild(this.submit),this.mode===r.modes.MANY_TO_MANY&&e.appendChild(this.recipient)),e},r.prototype.getRoot=function(){return this.root},r.prototype.displayName=function(e){return e},r.prototype.readTA=function(){var e=this.textarea.value;return this.textarea.value="",e},r.prototype.writeTA=function(e,r){t.sprintf(e,r,this.chat),n.writeln("",this.chat),this.chat.scrollTop=this.chat.scrollHeight},r.prototype.listeners=function(){var t=this;e.on(this.chat_event,function(){var n=t.readTA();if(!n)return;var r=t.recipient.value,i={"%s":{"class":"chat_me"},"%msg":{"class":"chat_msg"},"!txt":n};t.writeTA("%sMe%s: %msg!txt%msg",i),e.say(n.trim(),t.chat_event,r)}),this.mode===r.modes.MANY_TO_MANY&&e.on("UPDATED_PLIST",function(){n.populateRecipientSelector(t.recipient,e.game.pl.fetch())}),e.onDATA(this.chat_event,function(n){if(n.from===e.player.id||n.from===e.player.sid)return;if(this.mode===r.modes.ONE_TO_ONE&&n.from===this.recipient.value)return;var i=t.displayName(n.from),s={"%s":{"class":"chat_others"},"%msg":{"class":"chat_msg"},"!txt":n.data,"!from":i};t.writeTA("%s!from%s: %msg!txt%msg",s)})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.gameTimer=null,this.timerDiv=null,this.root=null,this.init(this.options)}e.widgets.register("VisualTimer",n);var t=e.JSUS;n.defaults={},n.defaults.id="visualtimer",n.defaults.fieldset={legend:"Time left",id:"visualtimer_fieldset"},n.name="Visual Timer",n.version="0.3.3",n.description="Display a timer for the game. Timer can trigger events. Only for countdown smaller than 1h.",n.dependencies={GameTimer:{},JSUS:{}},n.prototype.init=function(t){t=t||this.options;var n=this;(function(){t.hooks?!t.hooks instanceof Array&&(t.hooks=[t.hooks]):t.hooks=[],t.hooks.push({hook:n.updateDisplay,ctx:n})})(),this.gameTimer=t.gameTimer||new e.GameTimer,this.gameTimer?this.gameTimer.init(t):e.log("GameTimer object could not be initialized. VisualTimer will not work properly.","ERR"),this.timerDiv&&(this.timerDiv.className=t.className||"")},n.prototype.getRoot=function(){return this.root},n.prototype.append=function(t){return this.root=t,this.timerDiv=e.window.addDiv(t,this.id+"_div"),this.updateDisplay(),t},n.prototype.updateDisplay=function(){if(!this.gameTimer.milliseconds||this.gameTimer.milliseconds===0){this.timerDiv.innerHTML="00:00";return}var e=this.gameTimer.milliseconds-this.gameTimer.timePassed;e=t.parseMilliseconds(e);var n=e[2]<10?"0"+e[2]:e[2],r=e[3]<10?"0"+e[3]:e[3];this.timerDiv.innerHTML=n+":"+r},n.prototype.start=function(){this.updateDisplay(),this.gameTimer.start()},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.stop=function(e){this.gameTimer.stop()},n.prototype.resume=function(e){this.gameTimer.resume()},n.prototype.listeners=function(){var n=this;e.on("LOADED",function(){var r=e.game.gameLoop.getAllParams(e.game.gameState).timer;if(r){r=t.clone(r),n.timerDiv.className="";var i={},s=typeof r;switch(s){case"number":i.milliseconds=r;break;case"object":i=r;break;case"function":i.milliseconds=r;break;case"string":i.milliseconds=Number(r)}if(!i.milliseconds)return;"function"==typeof i.milliseconds&&(i.milliseconds=i.milliseconds.call(e.game)),i.timeup||(i.timeup="DONE"),n.gameTimer.init(i),n.start()}}),e.on("DONE",function(){n.gameTimer.stop(),n.timerDiv.className="strike"})}}(node),function(e){function t(e){this.id=e.id}e.widgets.register("NextPreviousState",t),t.defaults={},t.defaults.id="nextprevious",t.defaults.fieldset={legend:"Rew-Fwd"},t.name="Next,Previous State",t.version="0.3.2",t.description="Adds two buttons to push forward or rewind the state of the game by one step.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_button",r=this.id+"_button",i=e.window.addButton(t,n,"<<"),s=e.window.addButton(t,r,">>"),o=this,u=function(t){if(t){var n=e.IN+e.action.SAY+".STATE",r=e.msg.createSTATE(n,t);e.emit(n,r),n=e.OUT+e.action.SAY+".STATE",e.emit(n,t,"ALL")}else e.log("No next/previous state. Not sent","ERR")};return s.onclick=function(){u(e.game.next())},i.onclick=function(){u(e.game.previous())},this.root=t,t}}(node),function(e){function n(t){this.id=t.id||n.id,this.name=t.name||this.name,this.buffer=[],this.counter=0,this.wall=e.window.getElement("pre",this.id)}e.widgets.register("Wall",n);var t=e.JSUS;n.defaults={},n.defaults.id="wall",n.defaults.fieldset={legend:"Game Log"},n.name="Wall",n.version="0.3",n.description="Intercepts all LOG events and prints them ",n.description+="into a DIV element with an ordinal number and a timestamp.",n.dependencies={JSUS:{}},n.prototype.init=function(e){e=e||{},this.counter=e.counter||this.counter},n.prototype.append=function(e){return e.appendChild(this.wall)},n.prototype.getRoot=function(){return this.wall},n.prototype.listeners=function(){var t=this;e.on("LOG",function(e){t.debuffer(),t.write(e)})},n.prototype.write=function(e){if(document.readyState!=="complete")this.buffer.push(s);else{var n=this.counter++ +") "+t.getTime()+" ";this.wall.innerHTML=n+e+"\n"+this.wall.innerHTML}},n.prototype.debuffer=function(){if(document.readyState==="complete"&&this.buffer.length>0){for(var e=0;e<this.buffer.length;e++)this.write(this.buffer[e]);this.buffer=[]}}}(node),function(e){function r(e){this.options=e,this.id=e.id,this.name=e.name||r.name,this.root=null,this.gtbl=null,this.plist=null,this.init(this.options)}var t=e.GameStage,n=e.PlayerList;e.widgets.register("GameTable",r),r.defaults={},r.defaults.id="gametable",r.defaults.fieldset={legend:"Game Table",id:"gametable_fieldset"},r.name="Game Table",r.version="0.2",r.dependencies={JSUS:{}},r.prototype.init=function(r){this.plist||(this.plist=new n),this.gtbl=new e.window.Table({auto_update:!0,id:r.id||this.id,render:r.render},e.game.memory.db),this.gtbl.c("state",t.compare),this.gtbl.setLeft([]),this.gtbl.parse(!0)},r.prototype.addRenderer=function(e){return this.gtbl.addRenderer(e)},r.prototype.resetRender=function(){return this.gtbl.resetRenderer()},r.prototype.removeRenderer=function(e){return this.gtbl.removeRenderer(e)},r.prototype.append=function(e){return this.root=e,e.appendChild(this.gtbl.table),e},r.prototype.listeners=function(){var t=this;e.onPLIST(function(e){if(!e.data.length)return;var r=new n({},e.data),i=r.diff(t.plist);i&&i.forEach(function(e){t.addPlayer(e)}),t.gtbl.parse(!0)}),e.on("in.set.DATA",function(n){t.addLeft(n.state,n.from);var r=t.player2x(n.from),i=t.state2y(e.game.state,n.text);t.gtbl.add(n.data,r,i),t.gtbl.parse(!0)})},r.prototype.addPlayer=function(e){this.plist.add(e);var t=this.plist.map(function(e){return e.name});this.gtbl.setHeader(t)},r.prototype.addLeft=function(e,n){if(!e)return;e=new t(e);if(!JSUS.in_array({content:e.toString(),type:"left"},this.gtbl.left))this.gtbl.add2Left(e.toString());else{var r=this.state2y(e),i=this.player2x(n);this.gtbl.select("y","=",r).select("x","=",i).count()>1&&this.gtbl.add2Left(e.toString())}},r.prototype.player2x=function(e){return e?this.plist.select("id","=",e).first().count:!1},r.prototype.x2Player=function(e){return e?this.plist.select("count","=",e).first().count:!1},r.prototype.state2y=function(t){return t?e.game.gameLoop.indexOf(t):!1},r.prototype.y2State=function(n){return n?e.game.gameLoop.jumpTo(new t,n):!1}}(node),function(e){function t(e){this.id=e.id,this.recipient=null}e.widgets.register("StateBar",t),t.defaults={},t.defaults.id="statebar",t.defaults.fieldset={legend:"Change Game State"},t.name="State Bar",t.version="0.3.2",t.description="Provides a simple interface to change the state of the game.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_",r=n+"sendButton",i=n+"stateSel",s=n+"recipient",o=e.window.addButton(t,r),u=e.window.addStateSelector(t,i);this.recipient=e.window.addRecipientSelector(t,s);var a=this;return e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(a.recipient,e.game.pl)}),o.onclick=function(){var t=a.recipient.value,n=/^(\d+)(?:\.(\d+))?(?::(\d+))?$/,r=n.exec(u.value),i,s,o,f,l;r!==null?(i=r[1],s=r[2]||1,o=r[3]||1,e.log("Parsed State: "+r.join("|")),i=new e.GameStage({state:i,step:s,round:o}),t==="ALL"&&(f=e.IN+e.action.SAY+".STATE",l=e.msg.createSTATE(f,i),e.emit(f,l)),f=e.OUT+e.action.SAY+".STATE",e.emit(f,i,t)):(e.err("Not valid state. Not sent."),e.socket.sendTXT("E: not valid state. Not sent"))},this.root=t,t}}(node)